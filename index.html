<!doctype html><html><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>多云熊聊天界面</title><style>:root{--scale-factor: 1;--base-desktop: 16px;--base-mobile: 14px;--base-small: 12px}html{font-size:calc(var(--base-desktop)*var(--scale-factor))}@media(max-width: 480px){html{font-size:calc(var(--base-mobile)*var(--scale-factor))}}@media(max-width: 360px){html{font-size:calc(var(--base-small)*var(--scale-factor))}}*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}body{display:flex;justify-content:center;align-items:center}.phone-container{width:min(100%,22.5rem);aspect-ratio:9/16.5;border:.75rem solid #363636;border-radius:2.25rem;background-image:url("https://files.catbox.moe/kyeqkf.jpg");background-size:cover;position:relative;margin:.9375rem;box-shadow:0 0 20px rgba(0,0,0,.1);display:flex}.phone-charm{position:absolute;top:-0.75rem;right:-2.8125rem;width:10.625rem;height:10.625rem;background-image:url("https://files.catbox.moe/7ozygy.gif");background-size:contain;background-repeat:no-repeat;z-index:1000;pointer-events:none}.phone-notch{position:absolute;top:0;left:50%;transform:translateX(-50%);width:10rem;height:.8125rem;background:#363636;border-bottom-left-radius:.75rem;border-bottom-right-radius:.75rem;z-index:999;display:flex;justify-content:center;align-items:center;gap:.5rem}.notch-camera,.notch-sensor{width:.5rem;height:.5rem;background:#222;border-radius:50%;border:2px solid #444}.notch-sensor{width:.375rem;height:.375rem;border:1px solid #444}.notch-speaker{width:2.5rem;height:.25rem;background:#222;border-radius:2px}.interface-container{width:100%;height:100%;border-radius:1.5rem;overflow:hidden;position:relative;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif}.chat-container{width:100%;height:100%;background-image:url("https://files.catbox.moe/ctdr65.jpeg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;display:flex;flex-direction:column}.chat-header{height:3.5rem;background:hsla(0,0%,100%,.95);padding:0 1rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,.05);-webkit-backdrop-filter:blur(0.625rem);backdrop-filter:blur(0.625rem);border-top-left-radius:1.5rem;border-top-right-radius:1.5rem}.chat-header h2{font-size:1rem;color:#333;font-weight:600;margin-bottom:.125rem}.header-info{display:flex;align-items:center;gap:.75rem}.header-avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1);cursor:pointer;transition:transform .2s}.header-avatar:hover{transform:scale(1.1)}.header-text{display:flex;flex-direction:column}.header-status{font-size:.75rem;color:#4caf50;display:flex;align-items:center;gap:.25rem}.status-dot{width:.375rem;height:.375rem;background:#4caf50;border-radius:50%}.header-icons{display:flex;gap:1rem;position:relative;z-index:2}.header-icon{width:1.5rem;height:1.5rem;color:#666;cursor:pointer;position:relative;z-index:2;transition:all .2s}.header-icon:hover{color:#6c8cd5;transform:scale(1.1)}.status-bar{height:2.75rem;background:#000;display:flex;justify-content:center;align-items:center;color:#fff;font-size:.875rem;font-weight:600}.nav-bar{height:3.75rem;background:#fff;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between;padding:0 1rem}.nav-bar .nav-title{font-size:1.125rem;font-weight:600;color:#333}.nav-bar .nav-button{width:2rem;height:2rem;border:none;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:1rem;transition:background-color .2s}.nav-bar .nav-button:hover{background-color:#f0f0f0}.chat-area{flex:1;overflow-y:auto;padding:1rem;background:#f5f5f5}.input-area{background:#fff;border-top:1px solid #e0e0e0;padding:.75rem 1rem;display:flex;align-items:center;gap:.5rem;min-height:3.75rem}.plus-button{width:2rem;height:2rem;border:none;background:#007aff;color:#fff;border-radius:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.125rem;transition:background-color .2s}.plus-button:hover{background:#0056cc}.message-input{flex:1;border:1px solid #e0e0e0;border-radius:1.25rem;padding:.5rem 1rem;font-size:1rem;outline:none;resize:none;min-height:2.25rem;max-height:6.25rem}.message-input:focus{border-color:#007aff}.send-button{width:2rem;height:2rem;border:none;background:#007aff;color:#fff;border-radius:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.send-button:hover{background:#0056cc}.send-button:disabled{background:#ccc;cursor:not-allowed}.chat-list{width:100%;height:100%;background:#fff;position:absolute;top:0;left:0;z-index:10;display:none}.chat-list.active{display:flex;flex-direction:column}.chat-list-item{padding:1rem;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;align-items:center;gap:.75rem;transition:background-color .2s}.chat-list-item:hover{background-color:#f8f8f8}.chat-list-item .chat-avatar{width:3.125rem;height:3.125rem;border-radius:1.5625rem;object-fit:cover}.chat-list-item .chat-info{flex:1}.chat-list-item .chat-info .chat-name{font-size:1rem;font-weight:600;color:#333;margin-bottom:.25rem}.chat-list-item .chat-info .chat-preview{font-size:.875rem;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.chat-list-item .chat-time{font-size:.75rem;color:#999}.plus-menu{position:absolute;bottom:3.5rem;left:1rem;transform:translateY(0.5rem) scale(0.9);background:#fff;border-radius:1.25rem;box-shadow:0 3px 15px rgba(0,0,0,.12);padding:.375rem .625rem;z-index:100;opacity:0;transition:all .25s ease-out;display:none;flex-direction:row;align-items:center;gap:.1875rem}.plus-menu.active{display:flex}.plus-menu.show{opacity:1;transform:translateY(0) scale(1)}.menu-item{display:flex;align-items:center;justify-content:center;width:2.375rem;height:2.375rem;cursor:pointer;border-radius:50%;transition:all .2s ease;position:relative;flex-shrink:0}.menu-item:hover{background-color:#f0f0f0;transform:scale(1.1)}.menu-item:active{transform:scale(0.95)}.menu-item .menu-icon{display:flex;align-items:center;justify-content:center;width:auto;height:auto;color:#666;transition:color .2s ease}.menu-item .menu-icon svg{width:1.125rem;height:1.125rem;display:block;margin:0}.menu-item[data-type=sticker] .menu-icon{color:#ff9800}.menu-item[data-type=image] .menu-icon{color:#2dbccf}.menu-item[data-type=voice] .menu-icon{color:#2196f3}.menu-item[data-type=transfer] .menu-icon{color:#f44336}.menu-item[data-type=location] .menu-icon{color:#4caf50}.menu-item:hover[data-type=sticker]{background-color:rgba(255,152,0,.1)}.menu-item:hover[data-type=image]{background-color:rgba(0,188,212,.1)}.menu-item:hover[data-type=voice]{background-color:rgba(33,150,243,.1)}.menu-item:hover[data-type=transfer]{background-color:rgba(244,67,54,.1)}.menu-item:hover[data-type=location]{background-color:rgba(76,175,80,.1)}.transfer-modal{position:relative;background:#fff;border-radius:1rem;padding:1.25rem;width:17.5rem;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:1000;animation:modalFadeIn .3s ease-out}.modal-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:999;display:flex;align-items:center;justify-content:center;border-radius:1.5rem;opacity:0;transition:opacity .3s ease;overflow:hidden;touch-action:none}.modal-overlay.show{opacity:1}.modal-container{background:#fff;border-radius:1rem;padding:1.5rem;width:18.75rem;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,.2);animation:modalFadeIn .3s ease-out;max-height:80%;overflow:hidden}.modal-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1rem;text-align:center}.modal-content{margin-bottom:1rem}.image-input-modal .modal-content,.voice-input-modal .modal-content,.location-input-modal .modal-content,.transfer-input-modal .modal-content{display:flex;flex-direction:column}.image-upload-section{margin-bottom:1rem}.upload-options{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem}.upload-options .upload-row{display:flex;align-items:center;gap:.5rem}.upload-btn{background:#f0f0f0;color:#666;border:1px solid #ddd;padding:.375rem .75rem;border-radius:.5rem;cursor:pointer;font-size:.75rem;transition:all .2s ease;white-space:nowrap;flex-shrink:0}.upload-btn:hover{background:#e8e8e8;border-color:#ccc;color:#555}.upload-btn:active{background:#ddd;transform:translateY(0.0625rem)}.upload-divider{color:#999;font-size:.75rem;flex-shrink:0}.url-input{flex:1;min-width:7.5rem;font-size:.875rem}.file-preview{margin-top:.75rem;padding:.75rem;border:1px dashed rgba(108,140,213,.2);border-radius:.5rem;background:rgba(108,140,213,.1);display:flex;align-items:center;gap:.75rem}.file-preview img{width:3.125rem;aspect-ratio:1;object-fit:cover;border-radius:.375rem;border:1px solid #ddd}.file-preview .file-info{flex:1;display:flex;align-items:center;justify-content:space-between}.file-preview .file-info span{color:#555;font-size:.8125rem;font-weight:500;word-break:break-all}.file-preview .remove-file-btn{background:#f5f5f5;color:#999;border:1px solid #ddd;width:1.25rem;aspect-ratio:1;border-radius:50%;cursor:pointer;font-size:.75rem;display:flex;align-items:center;justify-content:center;transition:all .2s ease}.file-preview .remove-file-btn:hover{background:#ff4757;color:#fff;border-color:#ff4757}#imageInputModalTemplate .modal-label,.image-input-modal .modal-label,.modal-container .modal-label,[id*=imageInput] .modal-label{display:block;margin-bottom:.5rem;font-weight:600;color:#333;font-size:.875rem}#imageInputModalTemplate .modal-label.modal-label-spaced,.image-input-modal .modal-label.modal-label-spaced,.modal-container .modal-label.modal-label-spaced,[id*=imageInput] .modal-label.modal-label-spaced{margin-top:1rem}.modal-input{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:.5rem;font-size:.875rem;margin-bottom:.75rem;outline:none;transition:border-color .2s}.modal-input:focus{border-color:#6c8cd5;box-shadow:0 0 0 .125rem rgba(108,140,213,.2)}.modal-input::placeholder{color:#999}.modal-input[type=number]{-moz-appearance:textfield}.modal-input[type=number]::-webkit-outer-spin-button,.modal-input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.modal-buttons{display:flex;gap:.75rem;justify-content:flex-end;margin-top:1rem}.modal-btn{padding:.625rem 1.25rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:600;cursor:pointer;transition:all .2s;min-width:5rem}.modal-btn.cancel-btn{background:#f0f0f0;color:#666;border:1px solid #ddd}.modal-btn.cancel-btn:hover{background:#e0e0e0}.modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.modal-btn.confirm-btn:hover{background:#5a7bc4}@keyframes modalFadeIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}.chat-area::-webkit-scrollbar{width:4px}.chat-area::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-area::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:2px}.chat-area::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.3)}.chat-messages{flex:1;padding:1rem;overflow-y:auto}.chat-messages::-webkit-scrollbar{width:0px}.chat-messages::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-messages::-webkit-scrollbar-thumb{background:rgba(0,0,0,0);border-radius:.1875rem}.chat-messages::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0)}.message{display:flex;margin-bottom:.5rem;align-items:flex-start;position:relative;animation:message-pop .3s ease-out}.message.sent{flex-direction:row-reverse}.message.sent .message-content{background:linear-gradient(135deg, #6c8cd5, #4a6fbf);color:#fff;border-bottom-right-radius:.25rem}.message.sent .message-time{text-align:right}.message.received .message-content{background:#fff;color:#333;box-shadow:0 2px 4px rgba(0,0,0,.05);border-bottom-left-radius:.25rem}.message.group-message.received .message-content{border-bottom-left-radius:1.125rem;border-top-left-radius:.25rem}@keyframes message-pop{0%{transform:translateY(0.625rem);opacity:0}100%{transform:translateY(0);opacity:1}}.avatar{width:2.25rem;height:2.25rem;border-radius:50%;margin-top:.25rem;box-shadow:0 2px 4px rgba(0,0,0,.1);border:2px solid #fff;transition:transform .2s;cursor:pointer;object-fit:cover}.avatar:hover{transform:scale(1.1)}.message-wrapper{max-width:70%;display:flex;flex-direction:column;margin:0 .625rem}.message-content,.message-bubble{padding:.625rem .875rem;border-radius:1.125rem;font-size:.875rem;line-height:1.4;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,.1);position:relative;transition:transform .2s;cursor:pointer;animation:messageSlideIn .3s ease-out}.message-content:hover,.message-bubble:hover{transform:translateY(-0.125rem)}.message-time{font-size:.6875rem;color:#888;margin-top:.25rem;margin-left:.25rem;margin-right:.25rem}.chat-input{height:3.25rem;background:hsla(0,0%,100%,.95);padding:.5rem 1rem;display:flex;align-items:center;gap:.5rem;border-top:1px solid rgba(0,0,0,.05);-webkit-backdrop-filter:blur(0.625rem);backdrop-filter:blur(0.625rem);position:relative;border-bottom-left-radius:1.5rem;border-bottom-right-radius:1.5rem}.plus-btn{width:2rem;height:2rem;border:none;border-radius:50%;background:#f5f5f5;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;color:#666;flex-shrink:0}.plus-btn:hover{background:#e0e0e0;transform:scale(1.1)}.input-field{flex:1;height:2.25rem;border:1px solid rgba(0,0,0,.1);border-radius:1.125rem;background:#fff;padding:0 1rem;outline:none;font-size:.875rem;color:#333;transition:all .2s;margin-right:.5rem;max-width:calc(100% - 6rem)}.input-field:focus{border-color:#6c8cd5;box-shadow:0 0 0 2px rgba(108,140,213,.2)}.input-field::placeholder{color:#999}.send-btn{width:2.25rem;height:2.25rem;border:none;border-radius:50%;background:#6c8cd5;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}.send-btn:hover{background:#4a6fbf;transform:scale(1.1)}@keyframes menuSlideUp{from{opacity:0;transform:translateY(0.625rem)}to{opacity:1;transform:translateY(0)}}@media screen and (max-width: 25rem){.phone-container{margin:.625rem;border-width:.5rem;width:calc(100% - 1.25rem)}.message-content{font-size:.8125rem}.input-field{max-width:calc(100% - 5.5rem)}}.user_avatar{background-size:cover;background-position:center}.message-image{max-width:9.375rem;max-height:9.375rem;border-radius:.5rem;display:block;margin:0 auto;object-fit:cover}.error-text{color:#999;font-style:italic}.random-image-container{display:inline-block;position:relative;min-width:6.25rem;max-width:100%;min-height:6.25rem;max-height:8.125rem;border:2px solid rgba(0,0,0,0);border-radius:.9375rem;margin:0 0 -0.375rem 0;overflow-y:auto;box-shadow:0 4px 8px rgba(255,182,193,.4);background-color:hsla(0,0%,100%,.8);-webkit-backdrop-filter:blur(0.3125rem);backdrop-filter:blur(0.3125rem);scrollbar-width:none;-ms-overflow-style:none}.random-image-container .random-image-container::-webkit-scrollbar{display:none}.random-image-container details{position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer}.random-image-container details summary{list-style:none;width:100%;height:100%}.random-image-container details .attachment-content{position:absolute;top:.125rem;left:.125rem;right:.125rem;background:linear-gradient(135deg, rgba(255, 192, 203, 0.4), rgba(255, 182, 193, 0.4));color:#333;padding:.5rem;border-radius:.75rem;text-align:center}.random-image-container details .attachment-content .attachment-text{border:1px solid rgba(255,192,203,.3);padding:.75rem .5rem;width:calc(100% - .1875rem);text-align:center;word-wrap:break-word;border-radius:.625rem;background:hsla(0,0%,100%,.98);box-shadow:inset 0 0 8px rgba(255,192,203,.2)}.random-image-container details .attachment-content .attachment-text p{margin:0;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;font-size:.6875rem}.message-sticker{max-width:6.25rem;max-height:6.25rem;width:auto;height:auto;object-fit:contain;border-radius:.5rem}.transfer-bubble{background:#f8f8f8;border-radius:.75rem;padding:.625rem;width:7.8125rem;cursor:pointer;transition:all .3s}.transfer-bubble:hover{background:#f0f0f0}.transfer-bubble .transfer-content{display:flex;align-items:center;gap:.5rem}.transfer-bubble .transfer-content .transfer-icon{width:1.75rem;height:1.75rem;background:#6c8cd5;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}.transfer-bubble .transfer-content .transfer-icon svg{width:.875rem;height:.875rem;stroke:#fff;stroke-width:2;fill:none}.transfer-bubble .transfer-content .transfer-info{flex:1;min-width:0}.transfer-bubble .transfer-content .transfer-info .transfer-amount{font-size:.9375rem;font-weight:600;color:#333;margin-bottom:.125rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.transfer-bubble .transfer-content .transfer-info .transfer-status{font-size:.6875rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#666}.transfer-bubble .transfer-content .transfer-info .transfer-status.waiting,.transfer-bubble .transfer-content .transfer-info .transfer-status.pending{color:#ff9800}.transfer-bubble .transfer-content .transfer-info .transfer-status.accepted,.transfer-bubble .transfer-content .transfer-info .transfer-status.completed{color:#4caf50}.transfer-bubble .transfer-content .transfer-info .transfer-status.rejected,.transfer-bubble .transfer-content .transfer-info .transfer-status.failed{color:#f44336}.voice-message{display:flex;align-items:center;gap:.5rem;cursor:pointer;transition:all .2s ease}.voice-message:hover{transform:scale(1.02)}.voice-message .voice-icon{width:1.25rem;height:1.25rem;color:#6c8cd5;flex-shrink:0;transition:color .2s ease;position:relative}.voice-message .voice-icon .mic-icon,.voice-message .voice-icon .pause-icon{transition:opacity .2s ease}.voice-message .voice-icon .pause-icon{display:none}.voice-message.expanded .voice-icon .mic-icon{display:none}.voice-message.expanded .voice-icon .pause-icon{display:block}.voice-message .voice-wave-container{display:flex;align-items:center;gap:.125rem;height:1.25rem;margin:0 .25rem}.voice-message .voice-wave{width:.1875rem;background:linear-gradient(to top, #6c8cd5, #8fa4e3);border-radius:2px;transform-origin:bottom}.voice-message .voice-wave:nth-child(1){height:.5rem;animation-delay:0s}.voice-message .voice-wave:nth-child(2){height:.75rem;animation-delay:.1s}.voice-message .voice-wave:nth-child(3){height:1rem;animation-delay:.2s}.voice-message .voice-wave:nth-child(4){height:.75rem;animation-delay:.3s}.voice-message .voice-wave:nth-child(5){height:.5rem;animation-delay:.4s}.voice-message .voice-duration{font-size:.875rem;color:inherit;font-weight:500}.voice-message.expanded .voice-wave{animation:voiceWave 1.5s ease-in-out infinite}.voice-message.expanded .voice-wave:nth-child(1){animation-delay:0s}.voice-message.expanded .voice-wave:nth-child(2){animation-delay:.1s}.voice-message.expanded .voice-wave:nth-child(3){animation-delay:.2s}.voice-message.expanded .voice-wave:nth-child(4){animation-delay:.3s}.voice-message.expanded .voice-wave:nth-child(5){animation-delay:.4s}.message.sent .voice-message .voice-icon{color:#fff}.message.sent .voice-message .voice-wave{background:linear-gradient(to top, #fff, rgba(255, 255, 255, 0.8))}.message.sent .voice-message .voice-duration{color:#fff}@keyframes voiceWave{0%,100%{transform:scaleY(0.3);opacity:.7}50%{transform:scaleY(1);opacity:1}}.voice-transcript{margin-top:.5rem;padding:.5rem .75rem;background:rgba(108,140,213,.1);border-radius:.75rem;font-size:.8125rem;color:#666;font-style:italic;display:none}.voice-transcript.show{display:block;animation:fadeIn .3s ease-out}.message.sent .voice-transcript{background:hsla(0,0%,100%,.2);color:hsla(0,0%,100%,.9)}@keyframes fadeIn{from{opacity:0;transform:translateY(-0.3125rem)}to{opacity:1;transform:translateY(0)}}.location-message{display:flex;align-items:center;gap:.5rem;cursor:pointer}.location-message .location-icon{width:1.25rem;height:1.25rem;color:#4caf50;flex-shrink:0}.location-message .location-text{font-size:.875rem;color:#666}.message.sent .location-message .location-icon{color:#4ac84e}.message.sent .location-message .location-text{color:#fff}.fade-in{animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0;transform:translateY(0.625rem)}to{opacity:1;transform:translateY(0)}}.message.editing .message-content{background:rgba(255,235,59,.2) !important;border:2px dashed #ffc107}.message.pending{opacity:.7}.message.pending .message-content{background:rgba(108,140,213,.5) !important}.hidden{display:none !important}.visible{display:block !important}.sticker-suggestions{position:absolute;bottom:3.75rem;right:1rem;width:12.5rem;max-width:calc(100% - 2rem);background:#fff;border-radius:.5rem;box-shadow:0 3px 15px rgba(0,0,0,.12);opacity:0;transform:translateY(0.5rem) scale(0.95);transition:all .2s ease-out;z-index:1000;border:1px solid rgba(0,0,0,.08)}.sticker-suggestions.show{opacity:1;transform:translateY(0) scale(1)}.sticker-suggestions .suggestions-header{display:flex;justify-content:space-between;align-items:center;padding:.375rem .5rem;border-bottom:1px solid #f0f0f0;background:#f8f9fa;border-radius:.5rem .5rem 0 0}.sticker-suggestions .suggestions-header .suggestions-title{font-size:.6875rem;font-weight:600;color:#666}.sticker-suggestions .suggestions-header .suggestions-count{font-size:.625rem;color:#999;background:#e9ecef;padding:.0625rem .25rem;border-radius:.5rem}.sticker-suggestions .suggestions-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:.25rem;padding:.375rem;max-height:5rem;overflow-y:auto}.sticker-suggestions .suggestions-grid .suggestion-item{aspect-ratio:1;border-radius:.25rem;overflow:hidden;cursor:pointer;transition:all .2s ease;border:1px solid rgba(0,0,0,0)}.sticker-suggestions .suggestions-grid .suggestion-item:hover{transform:scale(1.1);border-color:#6c8cd5;box-shadow:0 1px 4px rgba(108,140,213,.3)}.sticker-suggestions .suggestions-grid .suggestion-item:active{transform:scale(0.9)}.sticker-suggestions .suggestions-grid .suggestion-item img{width:100%;height:100%;object-fit:cover;display:block}.sticker-suggestions .suggestions-grid::-webkit-scrollbar{width:4px}.sticker-suggestions .suggestions-grid::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.sticker-suggestions .suggestions-grid::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2);border-radius:2px}.sticker-suggestions .suggestions-grid::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.3)}@media screen and (max-width: 25rem){.sticker-suggestions{width:10rem;right:.5rem}.sticker-suggestions .suggestions-grid{grid-template-columns:repeat(3, 1fr);gap:.1875rem}}.transfer-modal .modal-header{text-align:center;margin-bottom:1rem}.transfer-modal .modal-header .modal-title{font-size:1rem;font-weight:600;color:#333;margin-bottom:.25rem}.transfer-modal .modal-header .modal-subtitle{font-size:.8125rem;color:#666}.transfer-modal .modal-amount{text-align:center;font-size:1.75rem;font-weight:600;color:#333;margin:1.25rem 0}.transfer-modal .modal-details{background:#f8f8f8;border-radius:.75rem;padding:.75rem;margin-bottom:1.25rem}.transfer-modal .modal-details .detail-row{display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:.8125rem}.transfer-modal .modal-details .detail-row:last-child{margin-bottom:0}.transfer-modal .modal-details .detail-row .detail-label{color:#666}.transfer-modal .modal-details .detail-row .detail-value{color:#333;font-weight:500}.transfer-modal .modal-buttons{display:flex;gap:.75rem}.transfer-modal .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:600;cursor:pointer;transition:all .3s}.transfer-modal .modal-buttons .modal-btn.reject-btn{background:#f0f0f0;color:#666}.transfer-modal .modal-buttons .modal-btn.reject-btn:hover{background:#e0e0e0}.transfer-modal .modal-buttons .modal-btn.accept-btn{background:#6c8cd5;color:#fff}.transfer-modal .modal-buttons .modal-btn.accept-btn:hover{background:#4a6fbf}.transfer-bubble.user-transfer{cursor:default}.transfer-bubble.user-transfer:hover{background:#f8f8f8}.dynamic-bg{background-image:var(--bg-image);background-size:cover;background-position:center}.message-entering,.message-animation{opacity:0;transform:translateY(0.625rem);transition:opacity .3s ease,transform .3s ease}.message-entering.message-entered,.message-entering.show,.message-animation.message-entered,.message-animation.show{opacity:1;transform:translateY(0)}.click-feedback,.avatar-click-effect{transform:scale(0.98);transition:transform .1s ease}.avatar-click{transform:scale(0.9);transition:transform .1s ease}.sticker-animate,.sticker-animation{transform:scale(1.2) rotate(10deg);transition:transform .3s ease}.sticker-animate.sticker-animated,.sticker-animate.reset,.sticker-animation.sticker-animated,.sticker-animation.reset{transform:scale(1) rotate(0deg)}.toast-notification,.toast{position:fixed;top:1.25rem;left:50%;transform:translateX(-50%) translateY(-1.25rem);padding:.75rem 1.25rem;border-radius:.5rem;color:#fff;font-size:.875rem;z-index:10000;opacity:0;transition:all .3s ease;pointer-events:none;background:#333}.toast-notification.show,.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}.toast-notification.toast-error,.toast.toast-error{background:#ff4757}.toast-notification.toast-success,.toast.toast-success{background:#2ed573}.toast-notification.toast-warning,.toast.toast-warning{background:#ffa502}.toast-notification.toast-info,.toast.toast-info{background:#3742fa}@keyframes toastSlideIn{from{opacity:0;transform:translateX(-50%) translateY(-0.625rem)}to{opacity:1;transform:translateX(-50%) translateY(0)}}@keyframes toastFadeInOut{0%,100%{opacity:0;transform:translate(-50%, -50%) scale(0.9)}10%,90%{opacity:1;transform:translate(-50%, -50%) scale(1)}}.edit-overlay,.edit-modal-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;border-radius:1.5rem}.edit-dialog,.edit-modal-dialog{background:#fff;border-radius:.75rem;padding:1.25rem;width:18.75rem;max-width:90%;box-shadow:0 10px 25px rgba(0,0,0,.2);animation:modalFadeIn .3s ease-out}.edit-dialog .edit-title,.edit-dialog .edit-modal-title,.edit-modal-dialog .edit-title,.edit-modal-dialog .edit-modal-title{margin:0 0 .9375rem 0;font-size:1.125rem;color:#333;font-weight:600}.edit-dialog .edit-textarea,.edit-dialog .edit-modal-textarea,.edit-modal-dialog .edit-textarea,.edit-modal-dialog .edit-modal-textarea{width:100%;height:6.25rem;border:1px solid #ddd;border-radius:.5rem;padding:.625rem;font-size:.875rem;resize:vertical;outline:none;margin-bottom:.9375rem;font-family:inherit}.edit-dialog .edit-textarea:focus,.edit-dialog .edit-modal-textarea:focus,.edit-modal-dialog .edit-textarea:focus,.edit-modal-dialog .edit-modal-textarea:focus{border-color:#6c8cd5;box-shadow:0 0 0 2px rgba(108,140,213,.2)}.edit-dialog .edit-buttons,.edit-dialog .edit-modal-buttons,.edit-modal-dialog .edit-buttons,.edit-modal-dialog .edit-modal-buttons{display:flex;gap:.625rem;justify-content:flex-end;margin-top:.9375rem}.edit-dialog .edit-buttons .edit-btn,.edit-dialog .edit-buttons .edit-modal-cancel-btn,.edit-dialog .edit-buttons .edit-modal-confirm-btn,.edit-dialog .edit-modal-buttons .edit-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-buttons .edit-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-modal-buttons .edit-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn{padding:.5rem 1rem;border:none;border-radius:.375rem;font-size:.875rem;cursor:pointer;transition:all .2s}.edit-dialog .edit-buttons .edit-btn.cancel-btn,.edit-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn,.edit-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn,.edit-dialog .edit-modal-buttons .edit-btn.cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn,.edit-modal-dialog .edit-buttons .edit-btn.cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-btn.cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn{background:#f0f0f0;color:#666;border:1px solid #ddd}.edit-dialog .edit-buttons .edit-btn.cancel-btn:hover,.edit-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-btn.cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-btn.cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-btn.cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.cancel-btn:hover{background:#e0e0e0}.edit-dialog .edit-buttons .edit-btn.save-btn,.edit-dialog .edit-buttons .edit-modal-cancel-btn.save-btn,.edit-dialog .edit-buttons .edit-modal-confirm-btn.save-btn,.edit-dialog .edit-modal-buttons .edit-btn.save-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn,.edit-modal-dialog .edit-buttons .edit-btn.save-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.save-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.save-btn,.edit-modal-dialog .edit-modal-buttons .edit-btn.save-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn{background:#6c8cd5;color:#fff}.edit-dialog .edit-buttons .edit-btn.save-btn:hover,.edit-dialog .edit-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-dialog .edit-buttons .edit-modal-confirm-btn.save-btn:hover,.edit-dialog .edit-modal-buttons .edit-btn.save-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn:hover,.edit-modal-dialog .edit-buttons .edit-btn.save-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn.save-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-btn.save-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn.save-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn.save-btn:hover{background:#4a6fbf}.edit-dialog .edit-buttons .edit-modal-cancel-btn,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn{background:#f0f0f0;color:#666;border:1px solid #ddd}.edit-dialog .edit-buttons .edit-modal-cancel-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-cancel-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-cancel-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-cancel-btn:hover{background:#f5f5f5}.edit-dialog .edit-buttons .edit-modal-confirm-btn,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn{background:#6c8cd5;color:#fff}.edit-dialog .edit-buttons .edit-modal-confirm-btn:hover,.edit-dialog .edit-modal-buttons .edit-modal-confirm-btn:hover,.edit-modal-dialog .edit-buttons .edit-modal-confirm-btn:hover,.edit-modal-dialog .edit-modal-buttons .edit-modal-confirm-btn:hover{background:#5a7bc4}.accept-btn:hover{background:#5a7bc4 !important}.reject-btn:hover{background:#e0e0e0 !important}.sticker-selector{position:absolute;bottom:3.5rem;left:1rem;right:1rem;width:auto;background:hsla(0,0%,100%,.95);-webkit-backdrop-filter:blur(0.625rem);backdrop-filter:blur(0.625rem);border-radius:1rem;box-shadow:0 8px 32px rgba(0,0,0,.15);border:1px solid hsla(0,0%,100%,.2);padding:.75rem;z-index:1000;opacity:0;transform:translateY(1.25rem) scale(0.95);transition:all .3s cubic-bezier(0.25, 0.46, 0.45, 0.94);display:none;overflow:hidden;box-sizing:border-box}.sticker-selector.active{display:block}.sticker-selector.show{opacity:1;transform:translateY(0) scale(1)}.sticker-selector .sticker-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:.5rem;width:100%;height:10rem;overflow-y:auto;overflow-x:hidden;box-sizing:border-box}.sticker-selector .sticker-grid>*{min-width:0;max-width:100%;box-sizing:border-box}.sticker-selector .sticker-grid::-webkit-scrollbar{width:4px}.sticker-selector .sticker-grid::-webkit-scrollbar-track{background:rgba(0,0,0,.1);border-radius:.125rem}.sticker-selector .sticker-grid::-webkit-scrollbar-thumb{background:rgba(0,0,0,.3);border-radius:2px}.sticker-selector .sticker-grid::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.5)}.sticker-selector .sticker-item{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;cursor:pointer;transition:all .2s ease;border:2px solid rgba(0,0,0,0);border-radius:.5rem;padding:.25rem;position:relative;width:100%;min-width:0;box-sizing:border-box}.sticker-selector .sticker-item:hover{transform:scale(1.05);border-color:#6c8cd5;box-shadow:0 4px 12px rgba(108,140,213,.4);z-index:10}.sticker-selector .sticker-item:active{transform:scale(0.95)}.sticker-selector .sticker-item .sticker-image{width:2.5rem;height:2.5rem;border-radius:.375rem;overflow:hidden;position:relative;flex-shrink:0}.sticker-selector .sticker-item .sticker-image img{width:100%;height:100%;object-fit:cover;display:block}.sticker-selector .sticker-item .sticker-note{font-size:.625rem;color:#666;text-align:center;margin-top:.125rem;line-height:1.2;width:100%;max-width:100%;box-sizing:border-box;height:1.5rem;word-wrap:break-word;word-break:break-all;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;-webkit-box-align:start}.sticker-selector .sticker-item .delete-checkbox{position:absolute;top:-0.125rem;right:-0.125rem;width:1rem;height:1rem;background:#fff;border:2px solid #ff4757;border-radius:50%;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:5}.sticker-selector .sticker-item .delete-checkbox.checked{background:#ff4757}.sticker-selector .sticker-item .delete-checkbox.checked::after{content:"✓";color:#fff;font-size:.625rem;font-weight:bold}.sticker-selector .sticker-item.delete-mode .delete-checkbox{display:flex}.sticker-selector .sticker-item.selected{border-color:#ff4757;background:rgba(255,71,87,.1)}.sticker-selector .sticker-item.dragging{opacity:.5;transform:rotate(5deg)}.sticker-selector .sticker-item.drag-over{border-color:#2ed573;background:rgba(46,213,115,.1)}.sticker-selector .add-sticker-btn{display:flex;align-items:center;justify-content:center;width:100%;aspect-ratio:1;background:rgba(108,140,213,.1);color:#6c8cd5;border:1px solid rgba(108,140,213,.2);border-radius:.5rem;cursor:pointer;transition:all .2s;box-sizing:border-box}.sticker-selector .add-sticker-btn:hover{background:rgba(108,140,213,.2);border-color:rgba(108,140,213,.4);transform:scale(1.05)}.sticker-selector .add-sticker-btn:active{transform:scale(0.95)}.sticker-selector .add-sticker-btn .add-icon{font-size:1.125rem;font-weight:bold}.sticker-selector .delete-mode-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;aspect-ratio:1;background:rgba(255,71,87,.1);color:#ff4757;border:1px solid rgba(255,71,87,.2);border-radius:.5rem;cursor:pointer;transition:all .2s;padding:.25rem;box-sizing:border-box}.sticker-selector .delete-mode-btn:hover{background:rgba(255,71,87,.2);border-color:rgba(255,71,87,.4);transform:scale(1.05)}.sticker-selector .delete-mode-btn:active{transform:scale(0.95)}.sticker-selector .delete-mode-btn.active{background:rgba(255,71,87,.2);border-color:#ff4757}.sticker-selector .delete-mode-btn .delete-icon{font-size:1rem;margin-bottom:.125rem}.sticker-selector .delete-mode-btn .delete-text{font-size:.5625rem;line-height:1;text-align:center}.sticker-selector .delete-confirm-btn{display:none;flex-direction:column;align-items:center;justify-content:center;width:100%;aspect-ratio:1;background:#ff4757;color:#fff;border:none;border-radius:.5rem;cursor:pointer;transition:all .2s;padding:.25rem;box-sizing:border-box}.sticker-selector .delete-confirm-btn.show{display:flex}.sticker-selector .delete-confirm-btn:hover{background:#ff3742;transform:scale(1.05)}.sticker-selector .delete-confirm-btn:active{transform:scale(0.95)}.sticker-selector .delete-confirm-btn.disabled{background:#ccc;color:#999;cursor:not-allowed}.sticker-selector .delete-confirm-btn.disabled:hover{background:#ccc;transform:none}.sticker-selector .delete-confirm-btn.disabled:active{transform:none}.sticker-selector .delete-confirm-btn .confirm-icon{font-size:.875rem;margin-bottom:.125rem}.sticker-selector .delete-confirm-btn .confirm-text{font-size:.5625rem;line-height:1;text-align:center}.sticker-selector .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:.5rem;color:#666;grid-column:span 2;box-sizing:border-box;width:100%}.sticker-selector .empty-state .empty-icon{font-size:1.5rem;margin-bottom:.25rem;opacity:.5}.sticker-selector .empty-state .empty-text{font-size:.6875rem;line-height:1.2;word-wrap:break-word}@keyframes stickerSelectorSlideUp{from{opacity:0;transform:translateY(1.25rem) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}#addStickerModalTemplate .modal-content,.add-sticker-modal .modal-content,.modal-container:has(.input-help) .modal-content,[id*=addSticker] .modal-content{display:flex;flex-direction:column;max-width:25rem;width:auto}#addStickerModalTemplate .modal-label,.add-sticker-modal .modal-label,.modal-container:has(.input-help) .modal-label,[id*=addSticker] .modal-label{display:block;margin-bottom:.5rem;font-weight:600;color:#333;font-size:.875rem}#addStickerModalTemplate .modal-label.modal-label-spaced,.add-sticker-modal .modal-label.modal-label-spaced,.modal-container:has(.input-help) .modal-label.modal-label-spaced,[id*=addSticker] .modal-label.modal-label-spaced{margin-top:1rem}#addStickerModalTemplate .modal-input,.add-sticker-modal .modal-input,.modal-container:has(.input-help) .modal-input,[id*=addSticker] .modal-input{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:.5rem;font-size:.875rem;margin-bottom:.75rem;outline:none;transition:border-color .2s}#addStickerModalTemplate .modal-input:focus,.add-sticker-modal .modal-input:focus,.modal-container:has(.input-help) .modal-input:focus,[id*=addSticker] .modal-input:focus{border-color:#6c8cd5;box-shadow:0 0 0 2px rgba(108,140,213,.2)}#addStickerModalTemplate .modal-input::placeholder,.add-sticker-modal .modal-input::placeholder,.modal-container:has(.input-help) .modal-input::placeholder,[id*=addSticker] .modal-input::placeholder{color:#999}#addStickerModalTemplate .input-help,.add-sticker-modal .input-help,.modal-container:has(.input-help) .input-help,[id*=addSticker] .input-help{background:#f8f9fa;border:1px solid #e9ecef;border-radius:.5rem;padding:.75rem;margin-top:.5rem}#addStickerModalTemplate .input-help p,.add-sticker-modal .input-help p,.modal-container:has(.input-help) .input-help p,[id*=addSticker] .input-help p{margin:0 0 .5rem 0;font-weight:600;color:#495057;font-size:.75rem}#addStickerModalTemplate .input-help ul,.add-sticker-modal .input-help ul,.modal-container:has(.input-help) .input-help ul,[id*=addSticker] .input-help ul{margin:0;padding:0;list-style:none}#addStickerModalTemplate .input-help ul li,.add-sticker-modal .input-help ul li,.modal-container:has(.input-help) .input-help ul li,[id*=addSticker] .input-help ul li{position:relative;font-size:.6875rem;color:#6c757d;margin-bottom:.25rem;line-height:1.4;padding-left:.75rem}#addStickerModalTemplate .input-help ul li:before,.add-sticker-modal .input-help ul li:before,.modal-container:has(.input-help) .input-help ul li:before,[id*=addSticker] .input-help ul li:before{content:"•";color:#ff6b6b;position:absolute;left:0;top:0}#addStickerModalTemplate .input-help ul li:last-child,.add-sticker-modal .input-help ul li:last-child,.modal-container:has(.input-help) .input-help ul li:last-child,[id*=addSticker] .input-help ul li:last-child{margin-bottom:0}.message-sender{font-size:.75rem;font-family:-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN",sans-serif;color:#fff;margin-bottom:.25rem;font-weight:400;line-height:1.2}.group-management-modal .modal-container{width:85%;max-width:20rem;aspect-ratio:3/5;overflow-y:auto}.group-management-modal .modal-container::-webkit-scrollbar{width:4px}.group-management-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,.1);border-radius:.125rem}.group-management-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(0,0,0,.3);border-radius:.125rem;-webkit-transition:background .2s;transition:background .2s}.group-management-modal .modal-container::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.5)}.group-management-modal .modal-header{font-size:1rem;font-weight:600;color:#333;margin-bottom:1.25rem;text-align:center}.group-management-modal .group-info-section{margin-bottom:1.5rem}.group-management-modal .group-info-section .group-avatar-section{display:flex;flex-direction:column;align-items:center;margin-bottom:1rem}.group-management-modal .group-info-section .group-avatar-section .group-avatar-preview{width:5rem;height:5rem;border-radius:50%;object-fit:cover;margin-bottom:.75rem;border:.1875rem solid #f0f0f0}.group-management-modal .group-info-section .group-avatar-section .change-avatar-btn{background:#f8f9fa;border:1px solid #dee2e6;border-radius:.375rem;padding:.375rem .75rem;font-size:.75rem;color:#6c757d;cursor:pointer;transition:all .2s}.group-management-modal .group-info-section .group-avatar-section .change-avatar-btn:hover{background:#e9ecef;border-color:#adb5bd}.group-management-modal .group-info-section .group-name-section label{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.375rem}.group-management-modal .group-info-section .group-name-section .group-name-input{width:100%;padding:.625rem .75rem;border:1px solid #ddd;border-radius:.5rem;font-size:.875rem;outline:none;transition:border-color .2s}.group-management-modal .group-info-section .group-name-section .group-name-input:focus{border-color:#6c8cd5}.group-management-modal .group-members-section{margin-bottom:1.5rem}.group-management-modal .group-members-section .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.group-management-modal .group-members-section .section-header h4{font-size:1rem;font-weight:600;color:#333;margin:0}.group-management-modal .group-members-section .section-header .invite-member-btn{background:#6c8cd5;color:#fff;border:none;border-radius:.375rem;padding:.375rem .75rem;font-size:.75rem;cursor:pointer;transition:background-color .2s}.group-management-modal .group-members-section .section-header .invite-member-btn:hover{background:#5a7bc4}.group-management-modal .group-members-section .members-list{max-height:12.5rem;overflow-y:auto}.group-management-modal .group-members-section .members-list::-webkit-scrollbar{width:3px}.group-management-modal .group-members-section .members-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.group-management-modal .group-members-section .members-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.125rem}.group-management-modal .group-members-section .members-list::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.15)}.group-management-modal .group-members-section .member-item{display:flex;align-items:center;padding:.5rem 0;border-bottom:1px solid #f0f0f0}.group-management-modal .group-members-section .member-item:last-child{border-bottom:none}.group-management-modal .group-members-section .member-item .member-avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;margin-right:.75rem}.group-management-modal .group-members-section .member-item .member-info{flex:1}.group-management-modal .group-members-section .member-item .member-info .member-name{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.125rem}.group-management-modal .group-members-section .member-item .member-info .member-role{font-size:.75rem;color:#666}.group-management-modal .group-members-section .member-item .member-actions{display:flex;gap:.5rem}.group-management-modal .group-members-section .member-item .member-actions .kick-member-btn{background:#dc3545;color:#fff;border:none;border-radius:.25rem;padding:.25rem .375rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.group-management-modal .group-members-section .member-item .member-actions .kick-member-btn:hover{background:#c82333}.group-management-modal .group-members-section .member-item .member-actions .kick-member-btn svg{width:.875rem;height:.875rem}.group-management-modal .modal-footer{display:flex;gap:.75rem}.group-management-modal .modal-footer .cancel-btn,.group-management-modal .modal-footer .save-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s}.group-management-modal .modal-footer .cancel-btn{background:#f5f5f5;color:#666}.group-management-modal .modal-footer .cancel-btn:hover{background:#e0e0e0}.group-management-modal .modal-footer .save-btn{background:#6c8cd5;color:#fff}.group-management-modal .modal-footer .save-btn:hover{background:#4a6fbf}.group-management-modal .modal-footer .save-btn:disabled{background:#ccc;cursor:not-allowed}@media(max-width: 30rem){.group-management-modal .modal-container{width:85%;aspect-ratio:3/5}.group-management-modal .group-info-section .group-avatar-section .group-avatar-preview{width:3.75rem;height:3.75rem}.group-management-modal .group-members-section .members-list{max-height:9.375rem}.group-management-modal .group-members-section .member-item .member-avatar{width:2rem;height:2rem}}.profile-interface{position:absolute;top:0;left:0;width:100%;height:100%;background:#f5f7fa;border-radius:1.5rem;overflow:hidden;z-index:20;opacity:0;visibility:hidden;transition:all .3s ease}.profile-interface.active{opacity:1;visibility:visible}.interface-container .profile-interface.active{z-index:30}.chat-list-interface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;display:none}.chat-list-interface.active{display:block !important}.typing-indicator{display:inline-flex;gap:.125rem;align-items:center;padding:.125rem .25rem;margin-top:.125rem}.typing-dot{width:.25rem;height:.25rem;background:#666;border-radius:50%;animation:typing-bounce 1.4s infinite}.typing-dot:nth-child(2){animation-delay:.2s}.typing-dot:nth-child(3){animation-delay:.4s}@keyframes typing-bounce{0%,100%{transform:translateY(0);opacity:.5}50%{transform:translateY(-0.0625rem);opacity:.8}}.typing-message{animation:messageSlideIn .3s ease-out}@keyframes messageSlideIn{from{opacity:0;transform:translateY(0.625rem)}to{opacity:1;transform:translateY(0)}}.danger-section{margin-top:1.5rem;padding:1rem;border:1px solid #ffebee;border-radius:.5rem;background:#fafafa}.danger-section .disband-btn{width:100%;background:#ff4757;color:#fff;border:none;padding:.75rem 1rem;border-radius:.375rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}.danger-section .disband-btn:hover{background:#ff3838;transform:translateY(-0.0625rem);box-shadow:0 2px 8px rgba(255,71,87,.3)}.danger-section .disband-btn:active{transform:translateY(0)}.modal-footer{display:flex;justify-content:flex-end;align-items:center;padding:1rem;border-top:1px solid #e0e0e0;gap:.5rem}.modal-footer .cancel-btn{background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6;padding:.5rem 1rem;border-radius:.375rem;font-size:.875rem;cursor:pointer;transition:all .2s}.modal-footer .cancel-btn:hover{background:#e9ecef}.modal-footer .save-btn{background:#007bff;color:#fff;border:none;padding:.5rem 1rem;border-radius:.375rem;font-size:.875rem;cursor:pointer;transition:background-color .2s}.modal-footer .save-btn:hover{background:#0056b3}.invite-member-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1100;border-radius:1.5rem}.invite-modal-container{background:#fff;border-radius:.5rem;box-shadow:0 4px 20px rgba(0,0,0,.15);width:min(85%,17.5rem);aspect-ratio:3/4;overflow:hidden;display:flex;flex-direction:column;position:relative;margin:1rem}.invite-modal-header{padding:.75rem 1rem;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}.invite-modal-header h3{margin:0;font-size:1rem;font-weight:600;color:#333}.invite-close-btn{background:none;border:none;font-size:1.25rem;color:#999;cursor:pointer;padding:0;width:1.75rem;height:1.75rem;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}.invite-close-btn:hover{background:#f0f0f0;color:#666}.invite-modal-body{flex:1;overflow:auto}.invite-modal-footer{padding:.75rem 1rem;border-top:1px solid #e0e0e0;display:flex;justify-content:flex-end;gap:.5rem}.invite-cancel-btn,.invite-confirm-btn{padding:.375rem .75rem;border-radius:.375rem;font-size:.8125rem;cursor:pointer;transition:all .2s;min-width:3.125rem}.invite-cancel-btn{background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6}.invite-cancel-btn:hover{background:#e9ecef}.invite-confirm-btn{background:#6c8cd5;color:#fff;border:none}.invite-confirm-btn:hover{background:#6c8cd5}.invite-contacts-list{flex:1;overflow-y:auto;padding:.5rem 0}.invite-contacts-list .invite-contact-item{display:flex;align-items:center;padding:.625rem 1rem;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer;transition:background-color .2s}.invite-contacts-list .invite-contact-item:hover{background:#f8f9fa}.invite-contacts-list .invite-contact-item .invite-contact-avatar{width:2.5rem;height:2.5rem;border-radius:50%;object-fit:cover;margin-right:.75rem;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.invite-contacts-list .invite-contact-item .invite-contact-info{flex:1}.invite-contacts-list .invite-contact-item .invite-contact-info .invite-contact-name{font-size:.875rem;font-weight:500;color:#333}.invite-contacts-list .invite-contact-item .invite-contact-checkbox input[type=checkbox]{display:none}.invite-contacts-list .invite-contact-item .invite-contact-checkbox label{width:1.25rem;height:1.25rem;border:2px solid #6c8cd5;border-radius:.25rem;display:block;cursor:pointer;position:relative;transition:all .2s}.invite-contacts-list .invite-contact-item .invite-contact-checkbox label::after{content:"";position:absolute;left:.375rem;top:.125rem;width:.375rem;height:.625rem;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);opacity:0;transition:opacity .2s}.invite-contacts-list .invite-contact-item .invite-contact-checkbox input[type=checkbox]:checked+label{background:#6c8cd5;border-color:#6c8cd5}.invite-contacts-list .invite-contact-item .invite-contact-checkbox input[type=checkbox]:checked+label::after{opacity:1}.user-message-context-modal .modal-container{width:17.5rem;max-width:90vw}.user-message-context-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-bottom:.0625rem solid #e1e5e9}.user-message-context-modal .modal-header h3{margin:0;font-size:1rem;color:#333}.user-message-context-modal .modal-header .modal-close-btn{background:none;border:none;font-size:1.25rem;color:#666;cursor:pointer;padding:0;width:1.25rem;height:1.25rem;display:flex;align-items:center;justify-content:center}.user-message-context-modal .modal-header .modal-close-btn:hover{color:#333}.user-message-context-modal .modal-body{padding:1rem;display:flex;flex-direction:column;gap:.5rem}.user-message-context-modal .modal-body .modal-btn{width:100%;padding:.75rem 1rem;border-radius:.375rem;border:none;font-size:.875rem;cursor:pointer;transition:all .2s ease;font-weight:500}.user-message-context-modal .modal-body .modal-btn.delete-btn{background:#dc3545;color:#fff}.user-message-context-modal .modal-body .modal-btn.delete-btn:hover{background:#c82333;transform:translateY(-0.0625rem)}.user-message-context-modal .modal-body .modal-btn.reroll-btn{background:#6c8cd5;color:#fff}.user-message-context-modal .modal-body .modal-btn.reroll-btn:hover{background:#5a7bc4;transform:translateY(-0.0625rem)}@media(max-width: 30rem){.user-message-context-modal .modal-container{width:16.25rem}.user-message-context-modal .modal-header{padding:.625rem .875rem}.user-message-context-modal .modal-header h3{font-size:.9375rem}.user-message-context-modal .modal-body{padding:.875rem}.user-message-context-modal .modal-body .modal-btn{padding:.625rem .875rem;font-size:.8125rem}}.batch-delete-toolbar{height:3.5rem;position:absolute;top:0;left:0;right:0;background:#f8f9fa;border-bottom:1px solid #e1e5e9;padding:1rem 1rem .75rem 1rem;z-index:200}.batch-delete-toolbar .toolbar-content{display:flex;justify-content:space-between;align-items:center}.batch-delete-toolbar .selected-count{font-size:.875rem;color:#333;font-weight:500}.batch-delete-toolbar .toolbar-buttons{display:flex;gap:.5rem}.batch-delete-toolbar .toolbar-btn{padding:.25rem .75rem;border-radius:.25rem;border:none;font-size:.8125rem;cursor:pointer;transition:all .2s ease}.batch-delete-toolbar .toolbar-btn.cancel-btn{background:#6c757d;color:#fff}.batch-delete-toolbar .toolbar-btn.cancel-btn:hover{background:#5a6268}.batch-delete-toolbar .toolbar-btn.delete-btn{background:#dc3545;color:#fff}.batch-delete-toolbar .toolbar-btn.delete-btn:hover:not(:disabled){background:#c82333}.batch-delete-toolbar .toolbar-btn.delete-btn:disabled{background:#ccc;cursor:not-allowed}.batch-delete-mode .message.selectable{position:relative;cursor:pointer;transition:all .2s ease;padding-left:1.875rem}.batch-delete-mode .message.selectable:hover{background-color:rgba(108,140,213,.1);border-radius:.5rem}.batch-delete-mode .message.selectable.selected{background-color:rgba(255,107,107,.15);border-left:.1875rem solid #ff6b6b;border-radius:.5rem}.batch-delete-mode .message.selectable .message-checkbox{position:absolute;left:.375rem;top:50%;transform:translateY(-50%);width:1.125rem;height:1.125rem;z-index:10;pointer-events:none}.batch-delete-mode .message.selectable .message-checkbox .checkbox-inner{width:1.125rem;height:1.125rem;border:.125rem solid #ddd;border-radius:.1875rem;background:#fff;position:relative;transition:all .2s ease}.batch-delete-mode .message.selectable .message-checkbox .checkbox-inner::after{content:"";position:absolute;left:.3125rem;top:.125rem;width:.25rem;height:.5rem;border:solid #fff;border-width:0 .125rem .125rem 0;transform:rotate(45deg);opacity:0;transition:opacity .2s ease}.batch-delete-mode .message.selectable.selected .message-checkbox .checkbox-inner{background-color:#ff6b6b;border-color:#ff6b6b}.batch-delete-mode .message.selectable.selected .message-checkbox .checkbox-inner::after{opacity:1}.batch-delete-mode .chat-messages{padding-top:3.75rem}.delete-message-modal .modal-container{width:20rem;max-width:90vw;max-height:80%}.delete-message-modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid #e1e5e9}.delete-message-modal .modal-header h3{margin:0;font-size:1.125rem;color:#333}.delete-message-modal .modal-header .modal-close-btn{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:0;width:1.5rem;height:1.5rem;display:flex;align-items:center;justify-content:center}.delete-message-modal .modal-header .modal-close-btn:hover{color:#333}.delete-message-modal .modal-body{padding:1.25rem;max-height:50vh;overflow-y:auto}.delete-message-modal .delete-options{margin-bottom:1rem}.delete-message-modal .delete-options .delete-option{display:flex;align-items:center;margin-bottom:.5rem;cursor:pointer}.delete-message-modal .delete-options .delete-option input[type=radio]{margin-right:.5rem}.delete-message-modal .delete-options .delete-option span{font-size:.875rem;color:#333}.delete-message-modal .message-list{border:1px solid #e1e5e9;border-radius:.5rem;max-height:18.75rem;overflow-y:auto}.delete-message-modal .message-item{display:flex;align-items:center;padding:.75rem;border-bottom:1px solid #f0f2f5}.delete-message-modal .message-item:last-child{border-bottom:none}.delete-message-modal .message-item:hover{background-color:#f8f9fa}.delete-message-modal .message-item .message-checkbox{margin-right:.75rem;position:relative;cursor:pointer}.delete-message-modal .message-item .message-checkbox input[type=checkbox]{opacity:0;position:absolute;width:1.125rem;height:1.125rem}.delete-message-modal .message-item .message-checkbox .checkmark{display:inline-block;width:1.125rem;height:1.125rem;border:.125rem solid #ddd;border-radius:.1875rem;position:relative;transition:all .2s ease}.delete-message-modal .message-item .message-checkbox .checkmark::after{content:"";position:absolute;left:.3125rem;top:.125rem;width:.25rem;height:.5rem;border:solid #fff;border-width:0 .125rem .125rem 0;transform:rotate(45deg);opacity:0;transition:opacity .2s ease}.delete-message-modal .message-item .message-checkbox input[type=checkbox]:checked+.checkmark{background-color:#6c8cd5;border-color:#6c8cd5}.delete-message-modal .message-item .message-checkbox input[type=checkbox]:checked+.checkmark::after{opacity:1}.delete-message-modal .message-item .message-preview{flex:1}.delete-message-modal .message-item .message-preview .message-sender{font-size:.75rem;color:#666;margin-bottom:.125rem}.delete-message-modal .message-item .message-preview .message-content-preview{font-size:.875rem;color:#333;margin-bottom:.125rem;line-height:1.4}.delete-message-modal .message-item .message-preview .message-time{font-size:.6875rem;color:#999}.delete-message-modal .modal-footer{display:flex;justify-content:flex-end;gap:.75rem;padding:1rem 1.25rem;border-top:1px solid #e1e5e9}.delete-message-modal .modal-footer .modal-btn{padding:.5rem 1rem;border-radius:.375rem;border:none;font-size:.875rem;cursor:pointer;transition:all .2s ease}.delete-message-modal .modal-footer .modal-btn.cancel-btn{background:#f5f7fa;color:#666}.delete-message-modal .modal-footer .modal-btn.cancel-btn:hover{background:#e9ecef}.delete-message-modal .modal-footer .modal-btn.delete-btn{background:#dc3545;color:#fff}.delete-message-modal .modal-footer .modal-btn.delete-btn:hover{background:#c82333}@media(max-width: 30rem){.delete-message-modal .modal-container{width:95%}.delete-message-modal .message-item{padding:.5rem}.delete-message-modal .message-item .message-preview .message-content-preview{font-size:.8125rem}}.scale-control{margin-top:1rem}.scale-control .scale-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.scale-control .scale-info .scale-label{font-size:.875rem;color:#666;font-weight:500}.scale-control .scale-info .scale-value{font-size:.875rem;color:#6c8cd5;font-weight:600;background:#f0f4ff;padding:.25rem .5rem;border-radius:.375rem}.scale-control .scale-slider-container{position:relative}.scale-control .scale-slider-container .scale-slider{width:100%;height:.375rem;border-radius:.1875rem;background:#e0e0e0;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;margin:0;position:relative;z-index:2}.scale-control .scale-slider-container .scale-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;box-shadow:0 2px 4px rgba(108,140,213,.3);-webkit-transition:all .2s ease;transition:all .2s ease}.scale-control .scale-slider-container .scale-slider::-webkit-slider-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.scale-control .scale-slider-container .scale-slider::-moz-range-thumb{width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;border:none;box-shadow:0 2px 4px rgba(108,140,213,.3);-moz-transition:all .2s ease;transition:all .2s ease}.scale-control .scale-slider-container .scale-slider::-moz-range-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.scale-control .scale-slider-container .scale-slider::-webkit-slider-track{height:.375rem;border-radius:.1875rem;background:linear-gradient(to right, #6c8cd5 0%, #6c8cd5 var(--progress, 50%), #e0e0e0 var(--progress, 50%), #e0e0e0 100%)}.scale-control .scale-slider-container .scale-slider::-moz-range-track{height:.375rem;border-radius:.1875rem;background:#e0e0e0;border:none}.scale-control .scale-slider-container .scale-slider::-moz-range-progress{height:.375rem;border-radius:.1875rem;background:#6c8cd5}.scale-control .scale-slider-container .scale-marks{position:relative;margin-top:.5rem;height:1rem;margin-left:.625rem;margin-right:.625rem;z-index:1}.scale-control .scale-slider-container .scale-marks .scale-mark{font-size:.75rem;color:#999;position:absolute;transform:translateX(-50%);text-align:center;white-space:nowrap}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(1){left:0%;transform:translateX(0)}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(2){left:28.57%;transform:translateX(-50%)}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(3){left:57.14%;transform:translateX(-50%)}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(4){left:100%;transform:translateX(-100%)}.scale-control .scale-slider-container .scale-marks .scale-mark::before{content:"";position:absolute;top:-0.75rem;left:50%;transform:translateX(-50%);width:1px;height:.25rem;background:#ccc}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(1)::before{left:0;transform:none}.scale-control .scale-slider-container .scale-marks .scale-mark:nth-child(4)::before{left:auto;right:0;transform:none}.setting-group{margin-bottom:2rem}.setting-group:last-child{margin-bottom:0}.setting-group .group-title{display:flex;align-items:center;gap:.5rem;font-size:1rem;font-weight:600;color:#333;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid #f0f0f0}.setting-group .group-title svg{color:#007aff}.setting-group .setting-item{margin-bottom:1.5rem}.setting-group .setting-item:last-child{margin-bottom:0}.setting-group .setting-item .item-header{margin-bottom:.5rem}.setting-group .setting-item .item-header .item-title{font-size:.9375rem;font-weight:500;color:#333}.setting-group .setting-item .item-description{font-size:.8125rem;color:#666;line-height:1.4;margin-bottom:.75rem}.typing-speed-control{margin-top:1rem}.typing-speed-control .typing-speed-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}.typing-speed-control .typing-speed-info .typing-speed-label{font-size:.875rem;color:#666;font-weight:500}.typing-speed-control .typing-speed-info .typing-speed-value{font-size:.875rem;color:#6c8cd5;font-weight:600;background:#f0f4ff;padding:.25rem .5rem;border-radius:.375rem}.typing-speed-control .typing-speed-slider-container{position:relative}.typing-speed-control .typing-speed-slider-container .typing-speed-slider{width:100%;height:.375rem;border-radius:.1875rem;background:#e0e0e0;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;margin:0;position:relative;z-index:2}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;box-shadow:0 2px 4px rgba(108,140,213,.3);-webkit-transition:all .2s ease;transition:all .2s ease}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-webkit-slider-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-thumb{width:1.25rem;height:1.25rem;border-radius:50%;background:#6c8cd5;cursor:pointer;border:none;box-shadow:0 2px 4px rgba(108,140,213,.3);-moz-transition:all .2s ease;transition:all .2s ease}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-thumb:hover{transform:scale(1.1);box-shadow:0 3px 6px rgba(108,140,213,.4)}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-webkit-slider-track{height:.375rem;border-radius:.1875rem;background:linear-gradient(to right, #6c8cd5 0%, #6c8cd5 var(--typing-progress, 33%), #e0e0e0 var(--typing-progress, 33%), #e0e0e0 100%)}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-track{height:.375rem;border-radius:.1875rem;background:#e0e0e0;border:none}.typing-speed-control .typing-speed-slider-container .typing-speed-slider::-moz-range-progress{height:.375rem;border-radius:.1875rem;background:#6c8cd5}.typing-speed-control .typing-speed-slider-container .typing-speed-marks{position:relative;margin-top:.5rem;height:1rem;margin-left:.625rem;margin-right:.625rem;z-index:1}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark{font-size:.75rem;color:#999;position:absolute;transform:translateX(-50%);text-align:center;white-space:nowrap}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(1){left:0%;transform:translateX(0)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(2){left:33.33%;transform:translateX(-50%)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(3){left:66.67%;transform:translateX(-50%)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(4){left:100%;transform:translateX(-100%)}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark::before{content:"";position:absolute;top:-0.75rem;left:50%;transform:translateX(-50%);width:1px;height:.25rem;background:#ccc}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(1)::before{left:0;transform:none}.typing-speed-control .typing-speed-slider-container .typing-speed-marks .typing-speed-mark:nth-child(4)::before{left:auto;right:0;transform:none}
.chat-list-interface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;display:none;background-image:url("https://files.catbox.moe/o84j4n.jpg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden}.chat-list-interface.active{display:block}.chat-list-interface .status-bar{position:absolute;top:0;left:0;width:100%;height:1.5rem;background:rgba(0,0,0,.5);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#fff;font-size:.75rem;z-index:1}.chat-list-interface .status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}.chat-list-interface .status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}.chat-list-interface .status-bar .status-icon-svg{width:1rem;height:1rem;fill:#fff}.chat-list-interface .chat-list-content{width:100%;height:calc(100% - 1.5rem);background:hsla(0,0%,100%,.9);background-blend-mode:overlay;overflow-y:auto;position:relative;top:1.5rem}.chat-list-interface .chat-list-content::-webkit-scrollbar{width:6px}.chat-list-interface .chat-list-content::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-list-interface .chat-list-content::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.1875rem}.chat-list-interface .chat-list-item{padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;border-bottom:1px solid rgba(0,0,0,.05);cursor:pointer;transition:background .2s ease;position:relative;-webkit-user-select:none;user-select:none}.chat-list-interface .chat-list-item:hover{background:rgba(108,140,213,.1)}.chat-list-interface .chat-list-item.pinned{background:rgba(108,140,213,.1)}.chat-list-interface .chat-list-item.pinned::before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(to bottom, #6c8cd5, #4a6fbf);z-index:1}.chat-list-interface .chat-list-item.long-press-detecting{background:rgba(108,140,213,.15)}.chat-list-interface .chat-list-item.long-press-detecting::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(108,140,213,.1);animation:longPressRipple .8s ease-out;pointer-events:none}.chat-list-interface .chat-list-item.long-pressed{background:rgba(108,140,213,.2);transform:scale(0.98);box-shadow:0 .125rem .5rem rgba(0,0,0,.1)}.chat-list-interface .chat-avatar{width:3rem;height:3rem;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}.chat-list-interface .chat-info{flex:1;min-width:0}.chat-list-interface .chat-info .chat-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.25rem}.chat-list-interface .chat-info .chat-list-header .chat-name{font-size:1rem;font-weight:600;color:#333}.chat-list-interface .chat-info .chat-list-header .chat-time{font-size:.75rem;color:#999}.chat-list-interface .chat-info .chat-preview{font-size:.875rem;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.chat-list-interface .unread-badge{min-width:1.25rem;height:1.25rem;padding:0 .375rem;background:#6c8cd5;color:#fff;font-size:.75rem;border-radius:.625rem;display:flex;align-items:center;justify-content:center;margin-left:.5rem}.chat-list-interface .unread-badge.show{display:flex}@keyframes longPressRipple{0%{opacity:.3;transform:scale(1)}50%{opacity:.1;transform:scale(1.02)}100%{opacity:0;transform:scale(1)}}.context-menu-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000;background:rgba(0,0,0,0);pointer-events:auto}.context-menu{position:absolute;background:#fff;border-radius:.375rem;box-shadow:0 .125rem .5rem rgba(0,0,0,.12),0 .0625rem .1875rem rgba(0,0,0,.08);padding:0;min-width:auto;max-width:6rem;height:2rem;width:-moz-fit-content;width:fit-content;opacity:0;transform:scale(0.95);transition:all .12s ease-out;border:1px solid rgba(0,0,0,.05);display:flex;align-items:center}.context-menu.show{transform:scale(1);opacity:1}.context-menu.hiding{transform:scale(0.95);opacity:0}.context-menu .menu-arrow{position:absolute;width:.375rem;height:.375rem;background:#fff;border:1px solid rgba(0,0,0,.05);transform:rotate(45deg);z-index:-1}.context-menu .menu-arrow.arrow-right{left:-0.1875rem;top:50%;margin-top:-0.1875rem;border-right:none;border-bottom:none}.context-menu .menu-arrow.arrow-left{right:-0.1875rem;top:50%;margin-top:-0.1875rem;border-left:none;border-top:none}.context-menu .menu-arrow.arrow-bottom{bottom:-0.1875rem;left:50%;margin-left:-0.1875rem;border-top:none;border-left:none}.context-menu .menu-arrow.arrow-top{bottom:-0.1875rem;left:50%;margin-left:-0.1875rem;border-top:none;border-left:none}.context-menu .menu-content{display:flex;flex-direction:column;gap:.02rem;height:100%;padding:.05rem}.context-menu .menu-content.horizontal{flex-direction:row;gap:.05rem;align-items:stretch}.context-menu .menu-item{display:flex;align-items:center;gap:.15rem;padding:.1rem .35rem;border:none;background:rgba(0,0,0,0);border-radius:.2rem;cursor:pointer;transition:all .15s ease;font-size:.65rem;color:#333;text-align:left;height:100%;min-height:auto;white-space:nowrap}.context-menu .menu-item:hover{background:rgba(108,140,213,.1);transform:translateY(-0.0625rem)}.context-menu .menu-item:active{background:rgba(108,140,213,.2);transform:translateY(0) scale(0.98)}.context-menu .menu-item .menu-icon{font-size:.75rem;line-height:1;flex-shrink:0;width:.8rem;text-align:center}.context-menu .menu-item .menu-text{font-weight:600;line-height:1.1;flex:1;font-size:.65rem}.context-menu .menu-item.pin-item .menu-icon{color:#6c8cd5}.context-menu .menu-item.pin-item:hover{background:rgba(108,140,213,.15)}.context-menu .menu-item.pin-item:hover .menu-text{color:#4a6fbf}.context-menu .menu-item.delete-item .menu-icon{color:#e74c3c}.context-menu .menu-item.delete-item:hover{background:rgba(231,76,60,.1)}.context-menu .menu-item.delete-item:hover .menu-text{color:#c0392b}.context-menu .menu-content.horizontal .menu-item{flex:1;justify-content:center;min-width:0;padding:.2rem .3rem;max-width:2.5rem}.context-menu .menu-content.horizontal .menu-item .menu-text{text-align:center;font-size:.65rem;font-weight:600}@keyframes menuFadeIn{0%{opacity:0;transform:scale(0.8) translateY(-0.625rem)}100%{opacity:1;transform:scale(1) translateY(0)}}@keyframes menuFadeOut{0%{opacity:1;transform:scale(1) translateY(0)}100%{opacity:0;transform:scale(0.8) translateY(-0.625rem)}}@media(max-width: 30rem){.context-menu{min-width:8.75rem}.context-menu .menu-item{padding:.875rem 1.125rem;font-size:.9375rem;min-height:3rem}.context-menu .menu-item .menu-icon{font-size:1.125rem;width:1.375rem}}@media(prefers-contrast: high){.context-menu{border:2px solid #000;box-shadow:0 .25rem .75rem rgba(0,0,0,.3)}.context-menu .menu-arrow{border-color:#000}.context-menu .menu-item{border:1px solid rgba(0,0,0,0)}.context-menu .menu-item:hover{border-color:#000;background:#f0f0f0}}@media(prefers-reduced-motion: reduce){.context-menu{transition:opacity .1s ease}.context-menu.show{transform:scale(1) translateY(0)}.context-menu .menu-item{transition:background-color .1s ease}.context-menu .menu-item:hover{transform:none}.context-menu .menu-item:active{transform:none}}.bottom-nav{position:absolute;bottom:0;left:0;width:100%;height:3.125rem;background:#fff;border-top:1px solid rgba(255,105,180,.1);display:flex;justify-content:space-around;align-items:center;z-index:10;border-bottom-left-radius:1.5rem;border-bottom-right-radius:1.5rem}.bottom-nav .bottom-nav-item{display:flex;flex-direction:column;align-items:center;gap:.25rem;color:#666;font-size:.75rem;cursor:pointer;transition:all .3s ease;padding:.3125rem 0;flex:1}.bottom-nav .bottom-nav-item.active{color:hotpink}.bottom-nav .bottom-nav-item:hover{color:hotpink;transform:translateY(-0.125rem)}.bottom-nav .bottom-nav-item .nav-icon{width:1.6875rem;height:1.6875rem;background-size:contain;background-repeat:no-repeat;background-position:center;background-image:url("https://files.catbox.moe/zilfqn.png");transition:filter .3s ease}.bottom-nav .bottom-nav-item .bottom-nav-text{font-weight:500;transition:color .3s ease}.chat-list-content{width:100%;height:calc(100% - 1.5rem - 3.125rem);background:hsla(0,0%,100%,.9);background-blend-mode:overlay;overflow-y:auto;position:relative;top:1.5rem}.chat-list-content::-webkit-scrollbar{width:6px}.chat-list-content::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.chat-list-content::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.1875rem}.new-chat-btn{position:absolute;bottom:4.625rem;right:1.5rem;width:3rem;height:3rem;border-radius:50%;background:#6c8cd5;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 .25rem .5rem rgba(0,0,0,.2);transition:transform .2s;z-index:100}.new-chat-btn:hover{transform:scale(1.1)}.new-chat-btn svg{width:1.25rem;height:1.25rem}.empty-chat-list{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:2.5rem 1.25rem;text-align:center}.empty-chat-list .empty-icon{font-size:3rem;margin-bottom:1rem;opacity:.6}.empty-chat-list .empty-text{font-size:1.125rem;font-weight:600;color:#666;margin-bottom:.5rem}.empty-chat-list .empty-hint{font-size:.875rem;color:#999;line-height:1.4}.new-chat-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.new-chat-modal.show{opacity:1}.new-chat-modal .modal-container{width:18.75rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.new-chat-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333}.new-chat-modal .modal-container .chat-type-options{display:flex;gap:.75rem;margin-bottom:1.5rem}.new-chat-modal .modal-container .chat-type-options .chat-type-option{flex:1;padding:.75rem;border:2px solid #6c8cd5;border-radius:.75rem;text-align:center;cursor:pointer;color:#6c8cd5;font-weight:500;transition:all .2s}.new-chat-modal .modal-container .chat-type-options .chat-type-option:hover,.new-chat-modal .modal-container .chat-type-options .chat-type-option.selected{background:#6c8cd5;color:#fff}.new-chat-modal .modal-container .contact-list{max-height:12.5rem;overflow-y:auto}.new-chat-modal .modal-container .contact-list::-webkit-scrollbar{width:6px}.new-chat-modal .modal-container .contact-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.new-chat-modal .modal-container .contact-list::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:.1875rem}.new-chat-modal .modal-container .contact-list .contact-item{display:flex;align-items:center;gap:.75rem;padding:.5rem;cursor:pointer;border-radius:.5rem;transition:background .2s;position:relative}.new-chat-modal .modal-container .contact-list .contact-item:hover{background:rgba(108,140,213,.1)}.new-chat-modal .modal-container .contact-list .contact-item.selected{background:rgba(108,140,213,.2)}.new-chat-modal .modal-container .contact-list .contact-item .contact-avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover}.new-chat-modal .modal-container .contact-list .contact-item .contact-name{font-size:.875rem;color:#333;flex:1}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions{display:flex;gap:.375rem;margin-left:auto;margin-right:.5rem}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn,.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn{width:1.75rem;height:1.75rem;border:none;border-radius:.375rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;opacity:.7}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn:hover,.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn:hover{opacity:1;transform:scale(1.05)}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn svg,.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn svg{width:.875rem;height:.875rem}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn{background:#f0f4ff;color:#6c8cd5}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .edit-btn:hover{background:#6c8cd5;color:#fff}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn{background:#ffeaea;color:#e74c3c}.new-chat-modal .modal-container .contact-list .contact-item .contact-actions .delete-btn:hover{background:#e74c3c;color:#fff}.new-chat-modal .modal-container .contact-list .contact-item .checkbox{width:1.125rem;height:1.125rem;border:2px solid #6c8cd5;border-radius:4px;display:none;position:absolute;right:.75rem;transition:all .2s}.new-chat-modal .modal-container .contact-list .contact-item .checkbox:after{content:"";position:absolute;left:.3125rem;top:.125rem;width:.3125rem;height:.625rem;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);opacity:0}.new-chat-modal .modal-container .contact-list .contact-item.selected .checkbox{background:#6c8cd5}.new-chat-modal .modal-container .contact-list .contact-item.selected .checkbox:after{opacity:1}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item{margin-bottom:.5rem;color:#6c8cd5;font-weight:500}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item:hover{background:rgba(108,140,213,.1)}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item .add-friend-icon{width:2.25rem;height:2.25rem;border-radius:50%;background:#6c8cd5;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:bold;line-height:1 !important;text-align:center;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;margin:0;padding:0;vertical-align:baseline;position:relative}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item .add-friend-icon::before{content:none}.new-chat-modal .modal-container .contact-list .contact-item.add-friend-item .add-friend-icon::after{content:none}.new-chat-modal .modal-container .contact-list .empty-contacts-hint{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:1.25rem;color:#666}.new-chat-modal .modal-container .contact-list .empty-contacts-hint .empty-icon{font-size:2rem;margin-bottom:.5rem;opacity:.6}.new-chat-modal .modal-container .contact-list .empty-contacts-hint .empty-text{font-size:.875rem;font-weight:500;color:#666;margin-bottom:.25rem}.new-chat-modal .modal-container .contact-list .empty-contacts-hint .empty-hint{font-size:.75rem;color:#999;line-height:1.4}.new-chat-modal .modal-container.group-mode .contact-item .checkbox{display:block}.new-chat-modal .modal-container .modal-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.new-chat-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.new-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.new-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.new-chat-modal .modal-container .modal-buttons .modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.new-chat-modal .modal-container .modal-buttons .modal-btn.confirm-btn:hover{background:#4a6fbf}.new-chat-modal.group-mode .contact-actions .edit-btn,.new-chat-modal.group-mode .contact-actions .delete-btn{display:none !important}.add-friend-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.add-friend-modal.show{opacity:1}.add-friend-modal .modal-container{width:17.5rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.add-friend-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333}.add-friend-modal .modal-container .add-friend-form .form-group{margin-bottom:1rem}.add-friend-modal .modal-container .add-friend-form .form-group label{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.5rem}.add-friend-modal .modal-container .add-friend-form .form-group input[type=text],.add-friend-modal .modal-container .add-friend-form .form-group input[type=url]{width:100%;padding:.75rem;border:.125rem solid #e0e0e0;border-radius:.5rem;font-size:.875rem;transition:border-color .2s}.add-friend-modal .modal-container .add-friend-form .form-group input[type=text]:focus,.add-friend-modal .modal-container .add-friend-form .form-group input[type=url]:focus{outline:none;border-color:#6c8cd5}.add-friend-modal .modal-container .add-friend-form .form-group input[type=text]::placeholder,.add-friend-modal .modal-container .add-friend-form .form-group input[type=url]::placeholder{color:#999}.add-friend-modal .modal-container .add-friend-form .form-group input[type=file]{width:100%;padding:.5rem;border:.125rem dashed #e0e0e0;border-radius:.5rem;background:#f9f9f9;cursor:pointer}.add-friend-modal .modal-container .add-friend-form .form-group input[type=file]:hover{border-color:#6c8cd5;background:#f0f4ff}.add-friend-modal .modal-container .add-friend-form .form-group .error-message{color:#e74c3c;font-size:.75rem;margin-top:.25rem;display:none}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn{width:100%;padding:.75rem 1rem;border:.125rem solid #6c8cd5;border-radius:.5rem;background:#fff;color:#6c8cd5;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn:hover{background:#6c8cd5;color:#fff;transform:translateY(-0.0625rem);box-shadow:0 .125rem .5rem rgba(108,140,213,.3)}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn:active{transform:translateY(0)}.add-friend-modal .modal-container .add-friend-form .form-group .file-upload-btn svg{flex-shrink:0}.add-friend-modal .modal-container .add-friend-form .avatar-options{display:flex;gap:1rem;margin-bottom:.5rem}.add-friend-modal .modal-container .add-friend-form .avatar-options .avatar-option{display:flex;align-items:center;gap:.375rem}.add-friend-modal .modal-container .add-friend-form .avatar-options .avatar-option input[type=radio]{margin:0}.add-friend-modal .modal-container .add-friend-form .avatar-options .avatar-option label{margin:0;font-size:.875rem;cursor:pointer}.add-friend-modal .modal-container .add-friend-form .avatar-preview{display:flex;justify-content:center;align-items:center;margin-top:1rem}.add-friend-modal .modal-container .add-friend-form .avatar-preview img{width:5rem;height:5rem;border-radius:50%;object-fit:cover;border:.1875rem solid #6c8cd5;box-shadow:0 .125rem .5rem rgba(0,0,0,.1);display:block}.add-friend-modal .modal-container .modal-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.add-friend-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.add-friend-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.add-friend-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.add-friend-modal .modal-container .modal-buttons .modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.add-friend-modal .modal-container .modal-buttons .modal-btn.confirm-btn:hover{background:#4a6fbf}.edit-contact-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.edit-contact-modal.show{opacity:1}.edit-contact-modal .modal-container{width:17.5rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.edit-contact-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333}.edit-contact-modal .modal-container .edit-contact-form .form-group{margin-bottom:1rem}.edit-contact-modal .modal-container .edit-contact-form .form-group label{display:block;font-size:.875rem;font-weight:500;color:#333;margin-bottom:.5rem}.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=text],.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=url]{width:100%;padding:.75rem;border:.125rem solid #e0e0e0;border-radius:.5rem;font-size:.875rem;transition:border-color .2s}.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=text]:focus,.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=url]:focus{outline:none;border-color:#6c8cd5}.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=text]::placeholder,.edit-contact-modal .modal-container .edit-contact-form .form-group input[type=url]::placeholder{color:#999}.edit-contact-modal .modal-container .edit-contact-form .form-group .error-message{color:#e74c3c;font-size:.75rem;margin-top:.25rem;display:none}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn{width:100%;padding:.75rem 1rem;border:.125rem solid #6c8cd5;border-radius:.5rem;background:#fff;color:#6c8cd5;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:.5rem}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn:hover{background:#6c8cd5;color:#fff;transform:translateY(-0.0625rem);box-shadow:0 .125rem .5rem rgba(108,140,213,.3)}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn:active{transform:translateY(0)}.edit-contact-modal .modal-container .edit-contact-form .form-group .file-upload-btn svg{flex-shrink:0}.edit-contact-modal .modal-container .edit-contact-form .avatar-options{display:flex;gap:1rem;margin-bottom:.5rem}.edit-contact-modal .modal-container .edit-contact-form .avatar-options .avatar-option{display:flex;align-items:center;gap:.375rem}.edit-contact-modal .modal-container .edit-contact-form .avatar-options .avatar-option input[type=radio]{margin:0}.edit-contact-modal .modal-container .edit-contact-form .avatar-options .avatar-option label{margin:0;font-size:.875rem;cursor:pointer}.edit-contact-modal .modal-container .edit-contact-form .avatar-preview{display:flex;justify-content:center;align-items:center;margin-top:1rem}.edit-contact-modal .modal-container .edit-contact-form .avatar-preview img{width:5rem;height:5rem;border-radius:50%;object-fit:cover;border:.1875rem solid #6c8cd5;box-shadow:0 .125rem .5rem rgba(0,0,0,.1);display:block}.edit-contact-modal .modal-container .modal-buttons{display:flex;gap:.75rem;margin-top:1.5rem}.edit-contact-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.edit-contact-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.edit-contact-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.edit-contact-modal .modal-container .modal-buttons .modal-btn.confirm-btn{background:#6c8cd5;color:#fff}.edit-contact-modal .modal-container .modal-buttons .modal-btn.confirm-btn:hover{background:#4a6fbf}.delete-confirm-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;transition:opacity .3s ease}.delete-confirm-modal.show{opacity:1}.delete-confirm-modal .modal-container{width:18.75rem;max-width:85%;background:#fff;border-radius:1rem;padding:1.25rem;position:relative}.delete-confirm-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:#333;text-align:center}.delete-confirm-modal .modal-container .delete-confirm-content{text-align:center;margin-bottom:1.5rem}.delete-confirm-modal .modal-container .delete-confirm-content .warning-icon{font-size:3rem;margin-bottom:1rem}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message{margin-bottom:1.25rem}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message p{margin:0 0 .5rem 0;color:#333;line-height:1.4}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message .delete-note{font-size:.75rem;color:#666;font-style:italic}.delete-confirm-modal .modal-container .delete-confirm-content .delete-message strong{color:#e74c3c}.delete-confirm-modal .modal-container .delete-confirm-content .contact-preview{display:flex;align-items:center;justify-content:center;gap:.75rem;padding:.75rem;background:#f8f9fa;border-radius:.5rem;border:1px solid #e0e0e0}.delete-confirm-modal .modal-container .delete-confirm-content .contact-preview .preview-avatar{width:2.5rem;height:2.5rem;border-radius:50%;object-fit:cover}.delete-confirm-modal .modal-container .delete-confirm-content .contact-preview .preview-name{font-size:.875rem;font-weight:500;color:#333}.delete-confirm-modal .modal-container .modal-buttons{display:flex;gap:.75rem}.delete-confirm-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;transition:background .2s}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.delete-btn{background:#e74c3c;color:#fff}.delete-confirm-modal .modal-container .modal-buttons .modal-btn.delete-btn:hover{background:#c0392b}
.chat-time-container{position:relative;display:flex;flex-direction:column;align-items:flex-end;gap:.375rem}.unread-badge{position:absolute;top:1.375rem;right:.125rem;width:18px;height:18px;min-width:18px;background:linear-gradient(135deg, #ff4757, #ff3742);border-radius:50%;opacity:0;transform:scale(0.8);transition:all .2s cubic-bezier(0.34, 1.56, 0.64, 1);box-shadow:0 1px 3px rgba(255,71,87,.4);color:#fff;font-size:.625rem;font-weight:600;display:flex;align-items:center;justify-content:center;line-height:1;padding:0}.unread-badge.show{opacity:1;transform:scale(1)}.unread-badge.bounce{animation:unreadBadgeBounce .6s cubic-bezier(0.68, -0.55, 0.265, 1.55)}.unread-badge.pulse{animation:unreadBadgePulse 1s ease-in-out}@media(prefers-color-scheme: dark){.unread-badge{box-shadow:0 1px 3px rgba(255,71,87,.5)}}@media(max-width: 768px){.unread-badge{width:16px;height:16px;min-width:16px;font-size:9px}}@keyframes unreadBadgeBounce{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}@keyframes unreadBadgePulse{0%,100%{transform:scale(1);box-shadow:0 1px 3px rgba(255,71,87,.4)}50%{transform:scale(1.1);box-shadow:0 2px 6px rgba(255,71,87,.6)}}.chat-list-item{position:relative}.chat-list-item:has(.unread-badge.show) .chat-name{font-weight:600;color:#2c3e50}.chat-list-item:has(.unread-badge.show) .chat-preview{color:#34495e}@media(prefers-color-scheme: dark){.chat-list-item:has(.unread-badge.show) .chat-name{color:#ecf0f1}.chat-list-item:has(.unread-badge.show) .chat-preview{color:#bdc3c7}}
.profile-interface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;display:none;background-image:url("https://files.catbox.moe/o84j4n.jpg");background-size:cover;background-position:center;border-radius:1.5rem;overflow:hidden}.profile-interface.active{display:block}.profile-interface .status-bar{position:absolute;top:0;left:0;width:100%;height:1.5rem;background:rgba(0,0,0,.5);display:flex;justify-content:space-between;align-items:center;padding:0 1rem;color:#fff;font-size:.75rem;z-index:1}.profile-interface .status-bar .status-bar-left{display:flex;align-items:center;gap:.25rem}.profile-interface .status-bar .status-bar-right{display:flex;align-items:center;gap:.5rem}.profile-interface .status-bar .status-icon-svg{width:1rem;height:1rem;fill:#fff}.profile-interface .profile-content{width:100%;height:calc(100% - 1.5rem - 3.125rem);background:hsla(0,0%,100%,.9);background-blend-mode:overlay;position:relative;top:1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2.5rem 1.25rem;gap:2.5rem}.profile-interface .user-info-section{display:flex;flex-direction:column;align-items:center;gap:1.25rem;width:100%;max-width:18.75rem}.profile-interface .user-info-section .user-avatar{position:relative;width:7.5rem;height:7.5rem;border-radius:50%;overflow:hidden;border:4px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer;transition:all .3s ease}.profile-interface .user-info-section .user-avatar:hover{transform:scale(1.05);box-shadow:0 .375rem 1rem rgba(0,0,0,.2)}.profile-interface .user-info-section .user-avatar img{width:100%;height:100%;object-fit:cover}.profile-interface .user-info-section .user-avatar .avatar-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s ease;color:#fff;font-size:.875rem;font-weight:500}.profile-interface .user-info-section .user-avatar .avatar-overlay svg{width:1.5rem;height:1.5rem;margin-bottom:.25rem}.profile-interface .user-info-section .user-avatar:hover .avatar-overlay{opacity:1}.profile-interface .user-info-section .user-avatar.loading .avatar-overlay{opacity:1;background:rgba(108,140,213,.8)}.profile-interface .user-info-section .user-name{position:relative;text-align:center}.profile-interface .user-info-section .user-name .name-display{font-size:1.5rem;font-weight:600;color:#333;cursor:pointer;padding:.5rem 1rem;border-radius:.5rem;transition:all .2s ease;min-width:7.5rem;display:inline-block}.profile-interface .user-info-section .user-name .name-display:hover{background:rgba(108,140,213,.1)}.profile-interface .user-info-section .user-name .name-edit{display:none;flex-direction:column;gap:.75rem;align-items:center}.profile-interface .user-info-section .user-name .name-edit.active{display:flex}.profile-interface .user-info-section .user-name .name-edit input{font-size:1.125rem;font-weight:600;color:#333;text-align:center;border:2px solid #6c8cd5;border-radius:.5rem;padding:.5rem 1rem;background:#fff;width:100%;outline:none}.profile-interface .user-info-section .user-name .name-edit input:focus{border-color:#4a6fbf;box-shadow:0 0 0 .1875rem rgba(108,140,213,.1)}.profile-interface .user-info-section .user-name .name-edit .edit-buttons{display:flex;gap:.75rem}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn{padding:.5rem 1rem;border:none;border-radius:.375rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.confirm-btn{background:#6c8cd5;color:#fff}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.confirm-btn:hover{background:#4a6fbf;transform:translateY(-0.0625rem)}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.cancel-btn{background:#f5f5f5;color:#666}.profile-interface .user-info-section .user-name .name-edit .edit-buttons .btn.cancel-btn:hover{background:#e0e0e0}.profile-interface .settings-section{width:100%;max-width:18.75rem;display:flex;flex-direction:column;gap:.75rem}.profile-interface .settings-section .settings-button{width:100%;padding:1rem 1.5rem;background:#fff;border:2px solid #6c8cd5;border-radius:.75rem;color:#6c8cd5;font-size:1.125rem;font-weight:600;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:.75rem;box-shadow:0 .125rem .5rem rgba(0,0,0,.1)}.profile-interface .settings-section .settings-button:hover:not(:disabled){background:#6c8cd5;color:#fff;transform:translateY(-0.125rem);box-shadow:0 .25rem .75rem rgba(108,140,213,.3)}.profile-interface .settings-section .settings-button:disabled{opacity:.6;cursor:not-allowed;transform:none}.profile-interface .settings-section .settings-button svg{width:1.5rem;height:1.5rem}.profile-interface .settings-section .settings-button#extensionSettingsButton{border-color:#48bb78;color:#48bb78}.profile-interface .settings-section .settings-button#extensionSettingsButton:hover:not(:disabled){background:#48bb78;color:#fff;box-shadow:0 .25rem .75rem rgba(72,187,120,.3)}.settings-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;visibility:hidden;transition:all .3s ease}.settings-modal.show{opacity:1;visibility:visible}.settings-modal .modal-container{width:90%;max-width:25rem;max-height:80%;background:#fff;border-radius:1rem;padding:1.5rem;position:relative;overflow-y:auto;transform:scale(0.9) translateY(1.25rem);transition:transform .3s ease}.settings-modal .modal-container::-webkit-scrollbar{width:6px}.settings-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.settings-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:3px}.settings-modal.show .modal-container{transform:scale(1) translateY(0)}.settings-modal .modal-header{position:relative;text-align:center;margin-bottom:1.5rem;border-bottom:1px solid #f0f0f0}.settings-modal .modal-header .modal-title{font-size:1.125rem;font-weight:600;color:#333;line-height:1.5}.settings-modal .modal-header .close-btn{position:absolute;top:-0.75rem;right:-0.75rem;width:2rem;height:2rem;border:none;background:rgba(0,0,0,0);cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.settings-modal .modal-header .close-btn:hover{background:rgba(0,0,0,.05)}.settings-modal .modal-header .close-btn svg{width:1.25rem;height:1.25rem;color:#888}.settings-modal .modal-content .setting-group{margin-bottom:2rem}.settings-modal .modal-content .setting-group:last-child{margin-bottom:0}.settings-modal .modal-content .setting-group .group-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}.settings-modal .modal-content .setting-group .group-title svg{width:1.25rem;height:1.25rem;color:#6c8cd5}.settings-modal .modal-content .setting-group .setting-item{margin-bottom:1rem;padding:1rem;background:#f8f9fa;border-radius:.75rem;border:1px solid rgba(0,0,0,.05)}.settings-modal .modal-content .setting-group .setting-item:last-child{margin-bottom:0}.settings-modal .modal-content .setting-group .setting-item .item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.settings-modal .modal-content .setting-group .setting-item .item-header .item-title{font-size:1rem;font-weight:500;color:#333}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch{position:relative;width:3rem;height:1.5rem;background:#ccc;border-radius:.75rem;cursor:pointer;transition:background .3s ease}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch.active{background:#6c8cd5}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch .toggle-handle{position:absolute;top:.125rem;left:.125rem;width:1.25rem;height:1.25rem;background:#fff;border-radius:50%;transition:transform .3s ease;box-shadow:0 .125rem .25rem rgba(0,0,0,.2)}.settings-modal .modal-content .setting-group .setting-item .item-header .toggle-switch.active .toggle-handle{transform:translateX(1.5rem)}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn{display:flex;align-items:center;gap:.25rem;padding:.375rem .75rem;border:none;border-radius:.375rem;font-size:.75rem;font-weight:500;cursor:pointer;transition:all .2s ease;background:#6c8cd5;color:#fff;min-width:auto;height:auto}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn:hover{background:#5a7bc4;transform:translateY(-0.0625rem)}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn:active{transform:translateY(0)}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn.danger-btn{background:#e74c3c;color:#fff}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn.danger-btn:hover{background:#c0392b}.settings-modal .modal-content .setting-group .setting-item .item-header .action-btn svg{width:.875rem;height:.875rem;flex-shrink:0}.settings-modal .modal-content .setting-group .setting-item .item-description{font-size:.875rem;color:#666;line-height:1.4}.settings-modal .modal-content .setting-group .setting-item .upload-area{border:2px dashed #d9dde4;border-radius:8px;padding:1rem;cursor:pointer;transition:all .2s ease;background:linear-gradient(135deg, #fdfdff 0%, #f8faff 100%);display:flex !important;align-items:center;justify-content:center;gap:.75rem;height:5rem;margin-top:.75rem;position:relative;overflow:hidden}.settings-modal .modal-content .setting-group .setting-item .upload-area::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg, transparent 30%, rgba(108, 140, 213, 0.05) 50%, transparent 70%);opacity:0;transition:opacity .3s ease}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover{border-color:#6c8cd5;background:linear-gradient(135deg, #f7f9ff 0%, #f0f4ff 100%);transform:translateY(-1px);box-shadow:0 6px 20px rgba(108,140,213,.15)}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover::before{opacity:1}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover .upload-icon{transform:scale(1.1);color:#5a7bc8}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover .upload-text{color:#333}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-icon{width:1.5rem;height:1.5rem;color:#6c8cd5;flex-shrink:0;transition:all .2s ease;filter:drop-shadow(0 1px 2px rgba(108, 140, 213, 0.2))}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-info{display:flex;flex-direction:column;align-items:flex-start;gap:.125rem}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-text{font-size:.875rem;color:#555;font-weight:600;transition:color .2s ease;letter-spacing:.01em;line-height:1.2}.settings-modal .modal-content .setting-group .setting-item .upload-area .upload-hint{font-size:.75rem;color:#888;line-height:1.3;opacity:.8;transition:opacity .2s ease}.settings-modal .modal-content .setting-group .setting-item .upload-area:hover .upload-hint{opacity:1}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview{margin-top:.75rem;border-radius:8px;overflow:hidden;position:relative;transition:all .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview img{width:100%;height:5rem;object-fit:cover;display:block}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay{position:absolute;top:0;right:0;padding:4px;display:flex;gap:4px;opacity:0;transition:opacity .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn,.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn{width:24px;height:24px;border:none;color:#fff;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn svg,.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn svg{width:12px;height:12px}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn{background:rgba(0,0,0,.6)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .remove-btn:hover{background:rgba(231,76,60,.8)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn{background:rgba(46,204,113,.6)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview .preview-overlay .apply-all-btn:hover{background:rgba(46,204,113,.8)}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview:hover .preview-overlay{opacity:1}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview::after{content:"点击更换壁纸";position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);color:#fff;text-align:center;padding:4px;font-size:12px;opacity:0;transition:opacity .2s ease}.settings-modal .modal-content .setting-group .setting-item .wallpaper-preview:hover::after{opacity:1}.confirm-dialog-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:10;border-radius:1.5rem}.confirm-dialog-overlay .confirm-dialog{background:#fff;border-radius:.75rem;padding:1.5rem;max-width:20rem;width:90%;box-shadow:0 .5rem 2rem rgba(0,0,0,.3);position:relative;z-index:11;animation:dialogFadeIn .3s ease}.confirm-dialog-overlay .confirm-dialog .dialog-header{margin-bottom:1rem;text-align:center}.confirm-dialog-overlay .confirm-dialog .dialog-header h3{margin:0;font-size:1.125rem;font-weight:600;color:#e74c3c}.confirm-dialog-overlay .confirm-dialog .dialog-content{margin-bottom:1.5rem}.confirm-dialog-overlay .confirm-dialog .dialog-content p{margin:0;font-size:.875rem;line-height:1.5;color:#333;text-align:center}.confirm-dialog-overlay .confirm-dialog .dialog-buttons{display:flex;gap:.75rem;justify-content:center}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button{padding:.625rem 1.25rem;border:none;border-radius:.375rem;font-size:.875rem;cursor:pointer;font-weight:500;transition:all .2s}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.cancel-btn{background:#f0f0f0;color:#666}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.cancel-btn:hover{background:#e0e0e0}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn{background:#e74c3c;color:#fff}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn:hover{background:#c0392b}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn.danger{background:#e74c3c}.confirm-dialog-overlay .confirm-dialog .dialog-buttons button.confirm-btn.danger:hover{background:#c0392b}@keyframes dialogFadeIn{from{opacity:0;transform:scale(0.9) translateY(-1.25rem)}to{opacity:1;transform:scale(1) translateY(0)}}@media(max-width: 30rem){.profile-interface .profile-content{padding:1.25rem 1rem;gap:1.875rem}.profile-interface .user-info-section .user-avatar{width:6.25rem;height:6.25rem}.profile-interface .user-info-section .user-name .name-display{font-size:1.25rem}.profile-interface .settings-section{gap:.5rem}.profile-interface .settings-section .settings-button{font-size:1rem;padding:.875rem 1.25rem}.settings-modal .modal-container{width:95%;padding:1.25rem}}@keyframes fadeIn{from{opacity:0;transform:translateY(1.25rem)}to{opacity:1;transform:translateY(0)}}@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}.loading-spinner{width:1.25rem;height:1.25rem;border:2px solid #f3f3f3;border-top:2px solid #6c8cd5;border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.extension-settings-modal .migration-btn{position:relative}.extension-settings-modal .migration-btn .btn-status{position:absolute;top:1rem;right:1.25rem;font-size:.75rem;font-weight:500;padding:.25rem .5rem;border-radius:.375rem;transition:all .3s ease}.extension-settings-modal .migration-btn.enabled{background:linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(56, 161, 105, 0.1));border-color:rgba(72,187,120,.3)}.extension-settings-modal .migration-btn.enabled:hover:not(:disabled){background:linear-gradient(135deg, rgba(72, 187, 120, 0.15), rgba(56, 161, 105, 0.15));border-color:rgba(72,187,120,.5);transform:translateY(-2px);box-shadow:0 8px 25px rgba(72,187,120,.2)}.extension-settings-modal .migration-btn.enabled .btn-text{color:#2f855a}.extension-settings-modal .migration-btn.enabled .btn-status{background:rgba(72,187,120,.2);color:#2f855a}.extension-settings-modal .migration-btn.disabled{background:linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));border-color:rgba(0,0,0,.1)}.extension-settings-modal .migration-btn.disabled:hover:not(:disabled){background:linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));border-color:rgba(0,0,0,.15);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.extension-settings-modal .migration-btn.disabled .btn-text{color:#2d3748}.extension-settings-modal .migration-btn.disabled .btn-status{background:rgba(0,0,0,.1);color:#718096}
.extension-settings-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:1.5rem;opacity:0;visibility:hidden;transition:all .3s ease}.extension-settings-modal.show{opacity:1;visibility:visible}.extension-settings-modal .modal-container{width:90%;max-width:25rem;max-height:80%;background:#fff;border-radius:1rem;padding:1.5rem;position:relative;overflow-y:auto;transform:scale(0.9) translateY(1.25rem);transition:transform .3s ease}.extension-settings-modal .modal-container::-webkit-scrollbar{width:6px}.extension-settings-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.extension-settings-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:3px}.extension-settings-modal.show .modal-container{transform:scale(1) translateY(0)}.extension-settings-modal .modal-header{position:relative;text-align:center;margin-bottom:1.5rem;border-bottom:1px solid #f0f0f0}.extension-settings-modal .modal-header .modal-title{font-size:1.125rem;font-weight:600;color:#333;line-height:1.5}.extension-settings-modal .modal-header .close-btn{position:absolute;top:-0.75rem;right:-0.75rem;width:2rem;height:2rem;border:none;background:rgba(0,0,0,0);cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:background .2s ease}.extension-settings-modal .modal-header .close-btn:hover{background:rgba(0,0,0,.05)}.extension-settings-modal .modal-header .close-btn svg{width:1.25rem;height:1.25rem;color:#888}.extension-settings-modal .modal-content .setting-group{margin-bottom:2rem}.extension-settings-modal .modal-content .setting-group:last-child{margin-bottom:0}.extension-settings-modal .modal-content .setting-group .group-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}.extension-settings-modal .modal-content .setting-group .group-title svg{width:1.25rem;height:1.25rem;color:#6c8cd5}.extension-settings-modal .modal-content .setting-group .setting-item{margin-bottom:1rem;padding:1rem;background:#f8f9fa;border-radius:.75rem;border:1px solid rgba(0,0,0,.05)}.extension-settings-modal .modal-content .setting-group .setting-item:last-child{margin-bottom:0}.extension-settings-modal .extension-btn{width:100%;background:linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));border:1px solid rgba(0,0,0,.1);border-radius:.75rem;padding:1rem 1.25rem;cursor:pointer;transition:all .3s ease;display:flex;flex-direction:column;align-items:flex-start;text-align:left;position:relative;overflow:hidden}.extension-settings-modal .extension-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15);border-color:rgba(0,0,0,.2)}.extension-settings-modal .extension-btn:active:not(:disabled){transform:translateY(0)}.extension-settings-modal .extension-btn:disabled{opacity:.6;cursor:not-allowed}.extension-settings-modal .extension-btn .btn-text{font-size:1rem;font-weight:600;color:#2d3748;margin-bottom:.25rem;display:block}.extension-settings-modal .extension-btn .btn-desc{font-size:.875rem;color:#718096;line-height:1.4;display:block}.extension-settings-modal .extension-btn.summary-btn{background:linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(49, 130, 206, 0.1));border-color:rgba(66,153,225,.3)}.extension-settings-modal .extension-btn.summary-btn:hover:not(:disabled){background:linear-gradient(135deg, rgba(66, 153, 225, 0.15), rgba(49, 130, 206, 0.15));border-color:rgba(66,153,225,.5);transform:translateY(-2px);box-shadow:0 8px 25px rgba(66,153,225,.2)}.extension-settings-modal .extension-btn.summary-btn .btn-text{color:#2b6cb0}.extension-settings-modal .coming-soon{text-align:center;padding:1.25rem;color:#999;font-style:italic;background:#f8f9fa;border-radius:.75rem;border:1px solid rgba(0,0,0,.05)}.extension-confirm-dialog-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);display:flex;justify-content:center;align-items:center;z-index:1}.extension-confirm-dialog{background:#fff;border-radius:1rem;box-shadow:0 10px 30px rgba(0,0,0,.2);width:90%;max-width:25rem;overflow:hidden}.extension-confirm-dialog .dialog-header{padding:1.25rem 1.5rem 1rem;border-bottom:1px solid #f0f0f0}.extension-confirm-dialog .dialog-header h3{margin:0;font-size:1rem;font-weight:600;color:#333}.extension-confirm-dialog .dialog-content{padding:1rem 1.5rem 1.25rem}.extension-confirm-dialog .dialog-content p{margin:0;color:#666;line-height:1.5}.extension-confirm-dialog .dialog-buttons{display:flex;gap:.75rem;padding:0 1.5rem 1.25rem;justify-content:flex-end}.extension-confirm-dialog .dialog-buttons button{padding:.5rem 1rem;border-radius:.375rem;border:1px solid rgba(0,0,0,0);font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease;min-width:5rem}.extension-confirm-dialog .dialog-buttons button.cancel-btn{background:#f8f9fa;color:#666;border-color:rgba(0,0,0,.1)}.extension-confirm-dialog .dialog-buttons button.cancel-btn:hover{background:#e9ecef;border-color:rgba(0,0,0,.2)}.extension-confirm-dialog .dialog-buttons button.confirm-btn{background:#6c8cd5;color:#fff}.extension-confirm-dialog .dialog-buttons button.confirm-btn:hover{background:#5a7bc4}.extension-confirm-dialog .dialog-buttons button.confirm-btn.primary{background:#48bb78}.extension-confirm-dialog .dialog-buttons button.confirm-btn.primary:hover{background:#38a169}.extension-confirm-dialog .dialog-buttons button.confirm-btn.danger{background:#f56565}.extension-confirm-dialog .dialog-buttons button.confirm-btn.danger:hover{background:#e53e3e}@media screen and (max-width: 25rem){.extension-settings-modal .modal-container{width:calc(100% - 1.25rem);margin:.625rem}.extension-settings-modal .extension-btn{padding:.875rem}.extension-settings-modal .extension-btn .btn-text{font-size:.9375rem}.extension-settings-modal .extension-btn .btn-desc{font-size:.8125rem}.extension-confirm-dialog{width:calc(100% - 1.25rem);margin:.625rem}.extension-confirm-dialog .dialog-header{padding:1rem 1.25rem .75rem}.extension-confirm-dialog .dialog-header h3{font-size:.9375rem}.extension-confirm-dialog .dialog-content{padding:.75rem 1.25rem 1rem}.extension-confirm-dialog .dialog-content p{font-size:.875rem}.extension-confirm-dialog .dialog-buttons{padding:0 1.25rem 1rem}.extension-confirm-dialog .dialog-buttons button{padding:.375rem .75rem;font-size:.8125rem;min-width:4.375rem}}
.group-chat-modal{position:absolute;top:0;left:0;width:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1001;opacity:0;visibility:hidden;transition:all .3s ease}.group-chat-modal.show{opacity:1;visibility:visible}.group-chat-modal .modal-container{width:20rem;max-width:90%;background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 .5rem 2rem rgba(0,0,0,.3);position:relative;transform:scale(0.9);transition:transform .3s ease;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#c1c1c1 rgba(0,0,0,0)}.group-chat-modal .modal-container::-webkit-scrollbar{width:8px}.group-chat-modal .modal-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.group-chat-modal .modal-container::-webkit-scrollbar-thumb{background:rgba(193,193,193,.8);border-radius:4px;border:1px solid rgba(0,0,0,0);background-clip:content-box}.group-chat-modal .modal-container::-webkit-scrollbar-thumb:hover{background:rgba(168,168,168,.9);background-clip:content-box}.group-chat-modal .modal-container::-webkit-scrollbar-corner{background:rgba(0,0,0,0)}.group-chat-modal .modal-container .modal-title{font-size:1.125rem;font-weight:600;color:#333;margin-bottom:1.25rem;text-align:center}.group-chat-modal .modal-container .selected-members{margin-bottom:1.25rem}.group-chat-modal .modal-container .selected-members .members-label{font-size:.875rem;color:#666;margin-bottom:.5rem}.group-chat-modal .modal-container .selected-members .members-list{display:flex;flex-wrap:wrap;gap:.5rem}.group-chat-modal .modal-container .selected-members .members-list .member-tag{display:flex;align-items:center;gap:.375rem;background:#f0f4ff;color:#6c8cd5;padding:.25rem .5rem;border-radius:1rem;font-size:.75rem}.group-chat-modal .modal-container .selected-members .members-list .member-tag .member-avatar{width:1.25rem;height:1.25rem;border-radius:50%;object-fit:cover}.group-chat-modal .modal-container .form-group{margin-bottom:1.25rem}.group-chat-modal .modal-container .form-group .form-label{display:block;font-size:.875rem;color:#333;margin-bottom:.5rem;font-weight:500}.group-chat-modal .modal-container .form-group .form-input{width:100%;padding:.75rem;border:1px solid #e0e0e0;border-radius:.5rem;font-size:.875rem;transition:border-color .2s;box-sizing:border-box}.group-chat-modal .modal-container .form-group .form-input:focus{outline:none;border-color:#6c8cd5}.group-chat-modal .modal-container .form-group .form-input::placeholder{color:#999}.group-chat-modal .modal-container .form-group .avatar-input-container{position:relative}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group{display:flex;gap:.5rem;margin-bottom:.75rem}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group .form-input{flex:1}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group .upload-btn{padding:.75rem 1rem;background:#f0f4ff;color:#6c8cd5;border:none;border-radius:.5rem;cursor:pointer;font-size:.75rem;transition:all .2s}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-input-group .upload-btn:hover{background:#6c8cd5;color:#fff}.group-chat-modal .modal-container .form-group .avatar-input-container .avatar-preview{width:5rem;height:5rem;border-radius:50%;object-fit:cover;border:1px solid #e0e0e0;display:block;margin:0 auto}.group-chat-modal .modal-container .participation-group{margin-bottom:1.5rem}.group-chat-modal .modal-container .participation-group .participation-options{display:flex;gap:.75rem}.group-chat-modal .modal-container .participation-group .participation-options .participation-option{flex:1;padding:.5rem .75rem;border:1px solid #e0e0e0;border-radius:.5rem;text-align:center;cursor:pointer;transition:all .2s;background:#fff;min-width:0}.group-chat-modal .modal-container .participation-group .participation-options .participation-option.selected{border-color:#6c8cd5;background:#f0f4ff;color:#6c8cd5}.group-chat-modal .modal-container .participation-group .participation-options .participation-option:hover:not(.selected){border-color:#ccc}.group-chat-modal .modal-container .participation-group .participation-options .participation-option .option-title{font-weight:500;margin-bottom:.125rem;font-size:.875rem}.group-chat-modal .modal-container .participation-group .participation-options .participation-option .option-desc{font-size:.6875rem;color:#666;line-height:1.2;word-wrap:break-word;overflow-wrap:break-word}.group-chat-modal .modal-container .modal-buttons{display:flex;gap:.75rem}.group-chat-modal .modal-container .modal-buttons .modal-btn{flex:1;padding:.75rem;border:none;border-radius:.5rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s}.group-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn{background:#f5f5f5;color:#666}.group-chat-modal .modal-container .modal-buttons .modal-btn.cancel-btn:hover{background:#e0e0e0}.group-chat-modal .modal-container .modal-buttons .modal-btn.create-btn{background:#6c8cd5;color:#fff}.group-chat-modal .modal-container .modal-buttons .modal-btn.create-btn:hover{background:#4a6fbf}.group-chat-modal .modal-container .modal-buttons .modal-btn.create-btn:disabled{background:#ccc;cursor:not-allowed}.group-chat-modal.show .modal-container{transform:scale(1)}
</style></head><body><div class="phone-container"><div class="phone-charm"></div><div class="phone-notch"><div class="notch-sensor"></div><div class="notch-camera"></div><div class="notch-speaker"></div><div class="notch-sensor"></div></div><div class="interface-container"><div class="chat-list-interface" id="chatListInterface"><div class="chat-list-header"><div class="chat-list-title">聊天列表</div></div><div class="chat-list-content" id="chatListContent"></div></div><div class="profile-interface" id="profileInterface"><div class="status-bar"><div class="status-bar-left"><span id="profileStatusTime">12:00</span></div><div class="status-bar-right"><svg class="status-icon-svg" viewBox="0 0 24 24"><path d="M20,20h2v-2h-2V20z M18,20h-2v-4h2V20z M14,20h-2v-6h2V20z M10,20H8v-8h2V20z M6,20H4v-10h2V20z"></path></svg> <svg class="status-icon-svg" viewBox="0 0 24 24"><path d="M12,3C7.41,3,3.86,4.53,0.96,7.03L2.37,8.44C4.89,6.31,8.06,5,12,5s7.11,1.31,9.63,3.44l1.41-1.41C20.14,4.53,16.59,3,12,3z M12,7C9.3,7,6.81,7.89,4.8,9.4l1.4,1.4C7.6,9.67,9.69,9,12,9s4.4,0.67,5.8,1.8l1.4-1.4C17.19,7.89,14.7,7,12,7z M12,11c-1.94,0-3.5,0.5-4.7,1.3l1.4,1.4c0.8-0.5,2-0.7,3.3-0.7s2.5,0.2,3.3,0.7l1.4-1.4C15.5,11.5,13.94,11,12,11z M12,15c-0.85,0-1.5,0.15-2,0.4l2,2l2-2C13.5,15.15,12.85,15,12,15z"></path></svg> <svg class="status-icon-svg" viewBox="0 0 24 24"><path d="M15.67,4H14V2h-4v2H8.33C7.6,4,7,4.6,7,5.33v15.33C7,21.4,7.6,22,8.33,22h7.33c0.74,0,1.33-0.6,1.33-1.33V5.33C17,4.6,16.4,4,15.67,4z M15,20H9V6h6V20z"></path></svg></div></div><div class="profile-content"><div class="user-info-section"><div class="user-avatar" id="userAvatar"><img id="avatarImage" src="https://files.catbox.moe/u8ccy5.jpg" alt="用户头像"/><div class="avatar-overlay"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg><div>更换头像</div></div></div><div class="user-name"><div class="name-display" id="nameDisplay">用户名</div><div class="name-edit" id="nameEdit"><input id="nameInput" placeholder="请输入用户名"/><div class="edit-buttons"><button class="btn confirm-btn" id="nameConfirmBtn">确认</button> <button class="btn cancel-btn" id="nameCancelBtn">取消</button></div></div></div></div><div class="settings-section"><button class="settings-button" id="extensionSettingsButton"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.22,15.05 2.27,14.78 2.46,14.63L4.57,12.97C4.53,12.65 4.5,12.33 4.5,12C4.5,11.67 4.53,11.34 4.57,11L2.46,9.37C2.27,9.22 2.22,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.78,8.95 21.73,9.22 21.54,9.37L19.43,11C19.47,11.34 19.5,11.67 19.5,12C19.5,12.33 19.47,12.65 19.43,12.97L21.54,14.63C21.73,14.78 21.78,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.03 19.05,18.95L16.56,17.94C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.64L7.85,15.61C8.62,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.64L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z"/></svg> 扩展设置</button> <button class="settings-button" id="settingsButton"><svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg> 设置</button></div></div><div class="bottom-nav"><div class="bottom-nav-item" data-page="chat-list"><div class="nav-icon"></div><div class="bottom-nav-text">消息</div></div><div class="bottom-nav-item active" data-page="profile"><div class="nav-icon"></div><div class="bottom-nav-text">我的</div></div></div><div class="settings-modal" id="settingsModal"><div class="modal-container"><div class="modal-header"><div class="modal-title">设置</div><button class="close-btn" id="settingsCloseBtn"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button></div><div class="modal-content"><div class="setting-group"><div class="group-title"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/></svg> 界面设置</div><div class="setting-item"><div class="item-header"><div class="item-title">界面缩放</div></div><div class="scale-control"><div class="scale-info"><span class="scale-label">缩放比例</span> <span class="scale-value" id="scaleValue">100%</span></div><div class="scale-slider-container"><input type="range" class="scale-slider" id="scaleSlider" min="0.8" max="1.5" step="0.1" value="1.0"><div class="scale-marks"><span class="scale-mark">80%</span> <span class="scale-mark">100%</span> <span class="scale-mark">120%</span> <span class="scale-mark">150%</span></div></div></div></div><div class="setting-item"><div class="item-header"><div class="item-title">消息显示速度</div></div><div class="typing-speed-control"><div class="typing-speed-info"><span class="typing-speed-label">显示速度</span> <span class="typing-speed-value" id="typingSpeedValue">正常</span></div><div class="typing-speed-slider-container"><input type="range" class="typing-speed-slider" id="typingSpeedSlider" min="1" max="4" step="1" value="1"><div class="typing-speed-marks"><span class="typing-speed-mark">正常</span> <span class="typing-speed-mark">快速</span> <span class="typing-speed-mark">瞬间</span> <span class="typing-speed-mark">全部</span></div></div></div></div></div><div class="setting-group"><div class="group-title"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/></svg> 壁纸设置</div><div class="setting-item"><div class="item-header"><div class="item-title">聊天列表壁纸</div></div><div class="item-description">设置聊天列表页面的背景壁纸</div><div class="upload-area" id="chatListWallpaperUpload"><svg class="upload-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg><div class="upload-info"><div class="upload-text">点击上传壁纸</div><div class="upload-hint">支持 JPG、PNG、WebP 格式，最大 2MB</div></div></div><div class="wallpaper-preview" id="chatListWallpaperPreview" style="display:none"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ii8+PC9zdmc+" alt="壁纸预览"/><div class="preview-overlay"><button class="remove-btn" id="removeChatListWallpaper"><svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button></div></div></div><div class="setting-item"><div class="item-header"><div class="item-title">全局聊天壁纸</div></div><div class="item-description">设置所有聊天的默认背景壁纸</div><div class="upload-area" id="globalChatWallpaperUpload"><svg class="upload-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/></svg><div class="upload-info"><div class="upload-text">点击上传壁纸</div><div class="upload-hint">支持 JPG、PNG、WebP 格式，最大 2MB</div></div></div><div class="wallpaper-preview" id="globalChatWallpaperPreview" style="display:none"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ii8+PC9zdmc+" alt="壁纸预览"/><div class="preview-overlay"><button class="remove-btn" id="removeGlobalChatWallpaper"><svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></button> <button class="apply-all-btn" id="applyToAllChatsBtn" title="将此壁纸应用到所有聊天框"><svg viewBox="0 0 24 24" width="12" height="12"><path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z"/></svg></button></div></div></div></div><div class="setting-group"><div class="group-title"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2C6.477,2,2,6.477,2,12c0,5.523,4.477,10,10,10s10-4.477,10-10C22,6.477,17.523,2,12,2z M12,20c-4.418,0-8-3.582-8-8 s3.582-8,8-8s8,3.582,8,8S16.418,20,12,20z M15.5,11c0.828,0,1.5-0.672,1.5-1.5S16.328,8,15.5,8S14,8.672,14,9.5S14.672,11,15.5,11z M8.5,11c0.828,0,1.5-0.672,1.5-1.5S9.328,8,8.5,8S7,8.672,7,9.5S7.672,11,8.5,11z M12,17.5c2.33,0,4.31-1.46,5.11-3.5H6.89 C7.69,16.04,9.67,17.5,12,17.5z"/></svg> 功能设置</div><div class="setting-item"><div class="item-header"><div class="item-title">表情包建议</div><div class="toggle-switch" id="emojiSuggestionsToggle"><div class="toggle-handle"></div></div></div><div class="item-description">在输入时显示相关的表情包建议</div></div><div class="setting-item"><div class="item-header"><div class="item-title">跨聊天发送</div><div class="toggle-switch" id="crossChatSendToggle"><div class="toggle-handle"></div></div></div><div class="item-description">发送时包含所有聊天的待发送消息，而不仅限于当前聊天</div></div><div class="setting-item"><div class="item-header"><div class="item-title">清除用户缓存</div><button class="action-btn danger-btn" id="clearUserCacheBtn"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg> 清除</button></div><div class="item-description">恢复头像和名字为默认设置</div></div><div class="setting-item"><div class="item-header"><div class="item-title">清除世界书角色缓存</div><button class="action-btn danger-btn" id="clearLorebookCacheBtn"><svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M10,8H14V10H10V8M10,12H14V16H10V12Z"/></svg> 清除</button></div><div class="item-description">清除世界书中角色的自定义头像缓存</div></div></div></div></div></div></div><div class="chat-container" id="chatInterface"><div class="chat-header"><div class="header-info"><img src="https://files.catbox.moe/u8ccy5.jpg" class="header-avatar" id="headerAvatar"/><div class="header-text"><h2 id="chatTitle">多云熊</h2><div class="header-status"><div class="status-dot"></div>在线</div></div></div><div class="header-icons"><svg class="header-icon diary-btn" viewBox="0 0 24 24"><path fill="currentColor" d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5C3.9,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V5C21,3.9 20.1,3 19,3M12,3C12.55,3 13,3.45 13,4C13,4.55 12.55,5 12,5C11.45,5 11,4.55 11,4C11,3.45 11.45,3 12,3M7,7H17V5H19V19H5V5H7V7Z"/></svg> <svg class="header-icon home-btn" viewBox="0 0 24 24"><path fill="currentColor" d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg> <svg class="header-icon call-btn" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg></div></div><div class="chat-messages" id="chatMessages"></div><div class="chat-input"><button class="plus-btn" id="plusBtn"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg></button><div class="plus-menu" id="plusMenu"><div class="menu-item" data-type="sticker"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2C6.477,2,2,6.477,2,12c0,5.523,4.477,10,10,10s10-4.477,10-10C22,6.477,17.523,2,12,2z M12,20c-4.418,0-8-3.582-8-8 s3.582-8,8-8s8,3.582,8,8S16.418,20,12,20z M15.5,11c0.828,0,1.5-0.672,1.5-1.5S16.328,8,15.5,8S14,8.672,14,9.5S14.672,11,15.5,11z M8.5,11c0.828,0,1.5-0.672,1.5-1.5S9.328,8,8.5,8S7,8.672,7,9.5S7.672,11,8.5,11z M12,17.5c2.33,0,4.31-1.46,5.11-3.5H6.89 C7.69,16.04,9.67,17.5,12,17.5z"/></svg></div></div><div class="menu-item" data-type="image"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M8.5,13.5L11,16.5L14.5,12L19,18H5M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19Z"/></svg></div></div><div class="menu-item" data-type="voice"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg></div></div><div class="menu-item" data-type="transfer"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg></div></div><div class="menu-item" data-type="location"><div class="menu-icon"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,2C15.31,2 18,4.66 18,7.95C18,12.41 12,19 12,19S6,12.41 6,7.95C6,4.66 8.69,2 12,2M12,6A2,2 0 0,0 10,8A2,2 0 0,0 12,10A2,2 0 0,0 14,8A2,2 0 0,0 12,6Z"/></svg></div></div></div><div class="sticker-selector" id="stickerSelector"><div class="sticker-grid" id="stickerGrid"></div></div><input class="input-field" id="inputField" placeholder="请输入..."/> <button class="send-btn" id="sendBtn"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></div></div></div></div><input type="file" id="avatarFileInput" accept="image/*" style="display:none"/> <input type="file" id="chatListWallpaperInput" accept="image/*" style="display:none"/> <input type="file" id="globalChatWallpaperInput" accept="image/*" style="display:none"/><div id="iconTemplates" style="display:none"><div id="voiceIconTemplate"><svg class="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/></svg> <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M14,19H18V5H14M6,19H10V5H6V19Z"/></svg></div><div id="locationIconTemplate"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C15.31,2 18,4.66 18,7.95C18,12.41 12,19 12,19S6,12.41 6,7.95C6,4.66 8.69,2 12,2M12,6A2,2 0 0,0 10,8A2,2 0 0,0 12,10A2,2 0 0,0 14,8A2,2 0 0,0 12,6Z"/></svg></div><div id="transferIconTemplate"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg></div></div><div id="transferModalTemplate" class="transfer-modal" style="display:none"><div class="modal-header"><div class="modal-title">收到转账</div><div class="modal-subtitle">来自 <span class="sender-name"></span></div></div><div class="modal-amount">￥<span class="amount-value"></span></div><div class="modal-details"><div class="detail-row"><span class="detail-label">转账方式</span> <span class="detail-value">零钱</span></div><div class="detail-row"><span class="detail-label">转账留言</span> <span class="detail-value transfer-note"></span></div></div><div class="modal-buttons"><button class="modal-btn reject-btn">退回</button> <button class="modal-btn accept-btn">接收</button></div></div><div id="imageInputModalTemplate" class="image-input-modal" style="display:none"><div class="modal-content"><div class="image-upload-section"><label class="modal-label">选择图片：</label><div class="upload-options"><div class="upload-row"><button type="button" class="upload-btn local-upload-btn" id="localUploadBtn">选择本地文件</button> <span class="upload-divider">或</span></div><div class="upload-row"><input class="modal-input url-input" placeholder="输入图片链接（可选）..." id="imageUrlInput"/></div></div><div class="file-preview" id="filePreview" style="display:none"><img id="previewImage" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InRyYW5zcGFyZW50Ii8+PC9zdmc+" alt="预览图片"/><div class="file-info"><span id="fileName"></span> <button type="button" class="remove-file-btn" id="removeFileBtn">✕</button></div></div></div><label class="modal-label modal-label-spaced">图片描述：</label> <input class="modal-input" placeholder="请输入图片描述..." id="imageDescInput"/> <input type="file" id="fileInput" accept="image/*" style="display:none"/></div></div><div id="voiceInputModalTemplate" class="voice-input-modal" style="display:none"><div class="modal-content"><label class="modal-label">语音内容：</label> <input class="modal-input" placeholder="请输入语音内容..." id="voiceContentInput"/> <label class="modal-label modal-label-spaced">语音时长：</label> <input type="number" class="modal-input" placeholder="请输入时长（秒）..." id="voiceDurationInput" min="1" max="300"/></div></div><div id="locationInputModalTemplate" class="location-input-modal" style="display:none"><div class="modal-content"><label class="modal-label">位置描述：</label> <input class="modal-input" placeholder="请输入位置描述..." id="locationDescInput"/></div></div><div id="transferInputModalTemplate" class="transfer-input-modal" style="display:none"><div class="modal-content"><label class="modal-label">转账金额：</label> <input type="number" class="modal-input" placeholder="请输入转账金额..." id="transferAmountInput" min="0.01" step="0.01"/> <label class="modal-label modal-label-spaced">转账备注：</label> <input class="modal-input" placeholder="请输入转账备注（可选）..." id="transferNoteInput"/></div></div><div id="editStickerModalTemplate" style="display:none"><div class="modal-title">编辑表情包</div><div class="modal-content"><label class="modal-label">表情包URL：</label> <input class="modal-input" id="editStickerUrl" placeholder="请输入表情包链接..."/> <label class="modal-label modal-label-spaced">表情包备注：</label> <input class="modal-input" id="editStickerNote" placeholder="请输入表情包备注（可选）..."/></div><div class="modal-buttons"><button class="modal-btn cancel-btn">取消</button> <button class="modal-btn confirm-btn">保存</button></div></div><div id="addStickerModalTemplate" style="display:none"><div class="modal-content"><label class="modal-label">表情包内容：</label> <input class="modal-input" placeholder="输入URL、文件名或备注+文件名..." id="stickerContentInput"/> <label class="modal-label modal-label-spaced">表情包备注：</label> <input class="modal-input" placeholder="输入表情包备注（可选）..." id="stickerNoteInput"/><div class="input-help"><p>支持格式：</p><ul><li>完整URL：https://example.com/image.jpg</li><li>文件名：ei6coi.jpeg</li><li>备注+文件名：我是败犬ei6coi.jpeg</li></ul></div></div></div><div id="stickerEmptyStateTemplate" style="display:none"><div class="empty-icon">😊</div><div class="empty-text">还没有表情包</div></div><div id="deleteModeButtonTemplate" style="display:none"><span class="delete-icon">🗑</span> <span class="delete-text"></span></div><div id="confirmDeleteButtonTemplate" style="display:none"><span class="confirm-icon">✓</span> <span class="confirm-text">确认</span></div><div id="addStickerModalTemplate" class="add-sticker-modal" style="display:none"><div class="modal-content"><label class="modal-label">表情包内容：</label> <input class="modal-input" placeholder="输入URL、文件名或备注+文件名..." id="stickerContentInput"/> <label class="modal-label modal-label-spaced">表情包备注：</label> <input class="modal-input" placeholder="输入表情包备注（可选）..." id="stickerNoteInput"/><div class="input-help"><p>支持格式：</p><ul><li>完整URL：https://example.com/image.jpg</li><li>文件名：ei6coi.jpeg</li><li>备注+文件名：我是败犬ei6coi.jpeg</li></ul></div></div></div><div id="messageTemplates" style="display:none"><template id="messageTemplate"><div class="message"><div class="avatar-container"></div><div class="message-wrapper"><div class="message-content"></div><div class="message-time"></div></div></div></template><template id="voiceMessageTemplate"><div class="voice-message"><div class="voice-icon"></div><div class="voice-wave-container"><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div><div class="voice-wave"></div></div><span class="voice-duration"></span></div><div class="voice-transcript" style="display:none"></div></template><template id="locationMessageTemplate"><div class="location-message"><div class="location-icon"></div><span class="location-text"></span></div></template><template id="transferMessageTemplate"><div class="transfer-bubble"><div class="transfer-content"><div class="transfer-icon"></div><div class="transfer-info"><div class="transfer-amount"></div><div class="transfer-status"></div></div></div></div></template><template id="attachmentMessageTemplate"><div class="random-image-container dynamic-bg"><details><summary></summary><div class="attachment-content"><div class="attachment-text"><p></p></div></div></details></div></template></div><script>var e={8:(e,t,a)=>{a.d(t,{OK:()=>i,oE:()=>l});a(534);var s,n=a(791),r=a(329);!function(e){e.CACHE='cache',e.GLOBAL_USER_MANAGER='global_user_manager',e.TAVERN_HELPER='tavern_helper',e.DOM_DETECTION='dom_detection',e.GLOBAL_VARS='global_vars',e.DEFAULT='default'}(s||(s={}));class o{static instance;config;globalUserManager;userInfoRetrieval;cache=new Map;lastKnownAvatar='';constructor(e={}){this.config={debug:e.debug??!1,cacheTimeout:e.cacheTimeout??3e5,defaultAvatarUrl:e.defaultAvatarUrl??'https://files.catbox.moe/u8ccy5.jpg',enableDOMDetection:e.enableDOMDetection??!0},this.globalUserManager=r.GlobalUserManager.getInstance(),this.userInfoRetrieval=new n.UserInfoRetrieval({defaultAvatarUrl:this.config.defaultAvatarUrl,enableLogging:this.config.debug}),this.initializeService()}static getInstance(e){return o.instance||(o.instance=new o(e)),o.instance}async initializeService(){try{this.globalUserManager.addEventListener('avatar',e=>{this.log(`头像变更事件: ${e.oldValue} -> ${e.newValue}`),this.setCachedAvatar(e.newValue,s.GLOBAL_USER_MANAGER),this.lastKnownAvatar=e.newValue});const e=await this.getCurrentAvatar();this.lastKnownAvatar=e,this.log(`服务初始化完成，当前头像: ${e}`)}catch(e){this.log(`服务初始化失败: ${e}`)}}async getCurrentAvatar(){const e=[{source:s.GLOBAL_USER_MANAGER,method:()=>this.getAvatarFromGlobalUserManager()},{source:s.CACHE,method:()=>Promise.resolve(this.getCachedAvatar())},{source:s.TAVERN_HELPER,method:()=>this.getAvatarFromTavernHelper()},{source:s.DOM_DETECTION,method:()=>this.getAvatarFromDOM()},{source:s.GLOBAL_VARS,method:()=>this.getAvatarFromGlobalVars()},{source:s.DEFAULT,method:()=>Promise.resolve(this.config.defaultAvatarUrl)}];for(const t of e)try{const e=await t.method();if(e&&e.trim())return this.log(`从 ${t.source} 获取到头像: ${e}`),t.source!==s.CACHE&&this.setCachedAvatar(e,t.source),e}catch(e){this.log(`从 ${t.source} 获取头像失败: ${e}`)}return this.log(`所有策略都失败，使用默认头像: ${this.config.defaultAvatarUrl}`),this.config.defaultAvatarUrl}getCachedAvatar(){const e='user_avatar',t=this.cache.get(e);if(!t)return null;return Date.now()-t.timestamp>this.config.cacheTimeout?(this.cache.delete(e),this.log('缓存已过期，已清理'),null):(this.config.debug&&Math.random()<.1&&this.log(`从缓存获取头像: ${t.url} (来源: ${t.source})`),t.url)}setCachedAvatar(e,t){if(!e||!e.trim())return;const a={url:e.trim(),timestamp:Date.now(),source:t};this.cache.set('user_avatar',a),this.log(`头像已缓存: ${e} (来源: ${t})`)}async getAvatarFromGlobalUserManager(){try{const e=this.globalUserManager.getCurrentUserData();if(e?.isCustom&&e.avatar)return e.avatar;return await this.globalUserManager.getUserAvatar()||null}catch(e){return this.log(`从GlobalUserManager获取头像失败: ${e}`),null}}async getAvatarFromTavernHelper(){try{if(window.TavernHelper&&window.TavernHelper.substitudeMacros){const e=window.TavernHelper.substitudeMacros('{{userAvatarPath}}');if(e&&'{{userAvatarPath}}'!==e&&e.trim())return e.trim()}if('function'==typeof triggerSlash){const e=await triggerSlash('/pass {{userAvatarPath}}');if(e&&e.trim())return e.trim()}return null}catch(e){return this.log(`从TavernHelper获取头像失败: ${e}`),null}}getAvatarFromDOM(){return Promise.resolve(this.config.enableDOMDetection?(0,n.getSimpleUserAvatar)():null)}getAvatarFromGlobalVars(){try{const e=[()=>window.power_user?.avatar,()=>window.user_avatar,()=>window.settings?.user_avatar,()=>window.chat_metadata?.user_avatar,()=>window.persona?.avatar];for(const t of e)try{const e=t();if(e&&'string'==typeof e&&e.trim())return Promise.resolve(e.trim())}catch(e){}return Promise.resolve(null)}catch(e){return this.log(`从全局变量获取头像失败: ${e}`),Promise.resolve(null)}}async refreshCache(){this.log('强制刷新头像缓存'),this.cache.clear();const e=await this.getCurrentAvatar();return this.lastKnownAvatar=e,e}getLastKnownAvatar(){return this.lastKnownAvatar||this.config.defaultAvatarUrl}async hasAvatarChanged(){const e=await this.getCurrentAvatar(),t=e!==this.lastKnownAvatar;return t&&(this.log(`头像已变化: ${this.lastKnownAvatar} -> ${e}`),this.lastKnownAvatar=e),t}getStats(){const e=Array.from(this.cache.entries()).map(([e,t])=>({source:t.source,url:t.url,age:Date.now()-t.timestamp}));return{cacheSize:this.cache.size,lastKnownAvatar:this.lastKnownAvatar,cacheEntries:e}}cleanupExpiredCache(){const e=Date.now();let t=0;for(const[a,s]of this.cache.entries())e-s.timestamp>this.config.cacheTimeout&&(this.cache.delete(a),t++);return t>0&&this.log(`清理了 ${t} 个过期缓存条目`),t}updateConfig(e){this.config={...this.config,...e},this.userInfoRetrieval.updateOptions({defaultAvatarUrl:this.config.defaultAvatarUrl,enableLogging:this.config.debug}),this.log('配置已更新')}destroy(){this.cache.clear(),this.log('AvatarSourceService已销毁'),o.instance=null}log(e){this.config.debug&&console.log(`[AvatarSourceService] ${e}`)}}const i=o.getInstance({debug:!1});function l(){try{const{GlobalUserManager:e}=a(329),t=e.getInstance().getCurrentUserData();if(t?.isCustom&&t.avatar)return t.avatar;const s=i.getCachedAvatar();if(s)return s;const r=(0,n.getSimpleUserAvatar)();return r&&'https://files.catbox.moe/u8ccy5.jpg'!==r?r:(0,n.getUserAvatar)()}catch(e){return console.warn('[getUnifiedUserAvatarSync] 获取头像失败:',e),'https://files.catbox.moe/u8ccy5.jpg'}}},52:(e,t,a)=>{a.d(t,{StorageManager:()=>r});var s=a(832),n=a(179);class r{static instance;constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}saveUserData(e){try{const t=JSON.stringify({...e,lastUpdated:Date.now()});localStorage.setItem(n.d5.USER_DATA,t)}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'保存用户数据失败',details:e,timestamp:Date.now()}),e}}loadUserData(){try{const e=localStorage.getItem(n.d5.USER_DATA);if(!e)return null;const t=JSON.parse(e);return this.validateUserData(t)?t:(console.warn('用户数据格式无效，将使用默认数据'),this.clearUserData(),null)}catch(e){return this.handleError({type:n.By.STORAGE_ERROR,message:'加载用户数据失败',details:e,timestamp:Date.now()}),this.clearUserData(),null}}async getDefaultUserData(){try{const e=await triggerSlash('/pass {{user}}')||'用户';return{name:e,avatar:await triggerSlash('/pass {{userAvatarPath}}')||'',isCustom:!1,lastUpdated:Date.now()}}catch(e){return this.handleError({type:n.By.NETWORK_ERROR,message:'获取默认用户数据失败',details:e,timestamp:Date.now()}),{name:'用户',avatar:'',isCustom:!1,lastUpdated:Date.now()}}}clearUserData(){try{localStorage.removeItem(n.d5.USER_DATA)}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'清除用户数据失败',details:e,timestamp:Date.now()})}}saveSettings(e){try{(0,s.setCharacterItem)(n.d5.APP_SETTINGS,e),console.log('[StorageManager] 应用设置已保存到角色专用空间')}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'保存应用设置失败',details:e,timestamp:Date.now()}),e}}loadSettings(){try{const e=(0,s.getCharacterItem)(n.d5.APP_SETTINGS,null);if(!e)return console.log('[StorageManager] 未找到角色专用设置，使用默认设置'),{...n.a$};const t={...n.a$,...e};return console.log('[StorageManager] 从角色专用空间加载应用设置'),t}catch(e){return this.handleError({type:n.By.STORAGE_ERROR,message:'加载应用设置失败',details:e,timestamp:Date.now()}),{...n.a$}}}updateSettings(e){const t={...this.loadSettings(),...e};this.saveSettings(t)}clearSettings(){try{const{removeCharacterItem:e}=a(832);e(n.d5.APP_SETTINGS),console.log('[StorageManager] 角色专用应用设置已清除')}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'清除应用设置失败',details:e,timestamp:Date.now()})}}isStorageAvailable(){try{const e='__storage_test__';return localStorage.setItem(e,'test'),localStorage.removeItem(e),!0}catch{return!1}}getStorageUsage(){try{let e=0;for(let t in localStorage)localStorage.hasOwnProperty(t)&&(e+=localStorage[t].length+t.length);const t=5242880;return{used:e,total:t,percentage:e/t*100}}catch(e){return{used:0,total:0,percentage:0}}}validateUserData(e){return e&&'string'==typeof e.name&&'string'==typeof e.avatar&&'boolean'==typeof e.isCustom&&'number'==typeof e.lastUpdated}handleError(e){console.error(`[StorageManager] ${e.message}:`,e.details),window.TavernHelper?.errorCatched&&window.TavernHelper.errorCatched(e)}exportData(){return{userData:this.loadUserData(),settings:this.loadSettings()}}importData(e){try{e.userData&&this.validateUserData(e.userData)&&this.saveUserData(e.userData),e.settings&&this.saveSettings(e.settings)}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'导入数据失败',details:e,timestamp:Date.now()}),e}}}},179:(e,t,a)=>{a.d(t,{By:()=>i,TL:()=>r,a$:()=>s,d5:()=>n,nl:()=>o});const s={chatListWallpaper:'https://files.catbox.moe/o84j4n.jpg',globalChatWallpaper:'',individualChatWallpapers:{},emojiSuggestionsEnabled:!0,crossChatSendEnabled:!1,version:'1.0.0'},n={USER_DATA:'duoyunxiong_user_data',APP_SETTINGS:'duoyunxiong_app_settings'},r={maxSize:2097152,acceptedTypes:['image/jpeg','image/png','image/webp'],quality:.8};var o,i;!function(e){e.IDLE='idle',e.LOADING='loading',e.EDITING='editing',e.SAVING='saving',e.ERROR='error'}(o||(o={})),function(e){e.STORAGE_ERROR='storage_error',e.NETWORK_ERROR='network_error',e.FILE_ERROR='file_error',e.VALIDATION_ERROR='validation_error'}(i||(i={}))},329:(e,t,a)=>{a.r(t),a.d(t,{GlobalUserManager:()=>r});var s=a(52),n=a(179);class r{static instance;storageManager;currentUserData=null;eventListeners=new Map;constructor(){this.storageManager=s.StorageManager.getInstance()}static getInstance(){return r.instance||(r.instance=new r),r.instance}initialize(){return new Promise(async(e,t)=>{try{await this.loadUserData(),e()}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'初始化用户信息管理器失败',details:e,timestamp:Date.now()}),t(e)}})}async loadUserData(){try{let e=this.storageManager.loadUserData();return e||(e=await this.storageManager.getDefaultUserData()),this.currentUserData=e,e}catch(e){this.handleError({type:n.By.STORAGE_ERROR,message:'加载用户数据失败',details:e,timestamp:Date.now()});const t={name:'用户',avatar:'',isCustom:!1,lastUpdated:Date.now()};return this.currentUserData=t,t}}getCurrentUserData(){return this.currentUserData}async getUserName(){if(this.currentUserData?.isCustom)return this.currentUserData.name;try{return await triggerSlash('/pass {{user}}')||'用户'}catch(e){return this.handleError({type:n.By.NETWORK_ERROR,message:'获取用户名称失败',details:e,timestamp:Date.now()}),this.currentUserData?.name||'用户'}}async getUserAvatar(){if(this.currentUserData?.isCustom)return this.currentUserData.avatar;try{return await triggerSlash('/pass {{userAvatarPath}}')||''}catch(e){return this.handleError({type:n.By.NETWORK_ERROR,message:'获取用户头像失败',details:e,timestamp:Date.now()}),this.currentUserData?.avatar||''}}async updateUserName(e){const t=this.currentUserData?.name||'';try{const a={name:e,avatar:this.currentUserData?.avatar||'',isCustom:!0,lastUpdated:Date.now()};this.storageManager.saveUserData(a),this.currentUserData=a,this.emitUserInfoChange({type:'name',oldValue:t,newValue:e,timestamp:Date.now()})}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'更新用户名称失败',details:e,timestamp:Date.now()}),e}}async updateUserAvatar(e){const t=this.currentUserData?.avatar||'';try{const a={name:this.currentUserData?.name||'用户',avatar:e,isCustom:!0,lastUpdated:Date.now()};this.storageManager.saveUserData(a),this.currentUserData=a,this.emitUserInfoChange({type:'avatar',oldValue:t,newValue:e,timestamp:Date.now()})}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'更新用户头像失败',details:e,timestamp:Date.now()}),e}}async resetToDefault(){try{this.storageManager.clearUserData();const e=await this.storageManager.getDefaultUserData();this.currentUserData=e,this.emitUserInfoChange({type:'name',oldValue:this.currentUserData?.name||'',newValue:e.name,timestamp:Date.now()}),this.emitUserInfoChange({type:'avatar',oldValue:this.currentUserData?.avatar||'',newValue:e.avatar,timestamp:Date.now()})}catch(e){throw this.handleError({type:n.By.STORAGE_ERROR,message:'重置用户信息失败',details:e,timestamp:Date.now()}),e}}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){const a=this.eventListeners.get(e);if(a){const e=a.indexOf(t);e>-1&&a.splice(e,1)}}emitUserInfoChange(e){const t=this.eventListeners.get(e.type);t&&t.forEach(t=>{try{t(e)}catch(e){console.error('用户信息变更监听器执行失败:',e)}});const a=this.eventListeners.get('all');a&&a.forEach(t=>{try{t(e)}catch(e){console.error('用户信息变更监听器执行失败:',e)}})}handleError(e){console.error(`[GlobalUserManager] ${e.message}:`,e.details),window.TavernHelper?.errorCatched&&window.TavernHelper.errorCatched(e)}getUserInfoStats(){const e=this.currentUserData;return{isCustom:e?.isCustom||!1,lastUpdated:e?.lastUpdated||0,hasAvatar:Boolean(e?.avatar),nameLength:e?.name?.length||0}}validateUserData(e){const t=[];return void 0!==e.name&&('string'!=typeof e.name?t.push('用户名必须是字符串'):0===e.name.length?t.push('用户名不能为空'):e.name.length>50&&t.push('用户名长度不能超过50个字符')),void 0!==e.avatar&&'string'!=typeof e.avatar&&t.push('头像数据必须是字符串'),{isValid:0===t.length,errors:t}}}},534:(e,t,a)=>{a.r(t),a.d(t,{AvatarSync:()=>n,SimpleAvatarMixin:()=>r,autoRegisterAvatars:()=>l,avatarSync:()=>o,cleanupInvalidAvatarElements:()=>m,forceUpdateAvatars:()=>c,getAvatarSyncDebugInfo:()=>g,getMemberAvatarStats:()=>u,registerAvatarElement:()=>i,registerMemberAvatarElement:()=>d,syncAvatars:()=>h});var s=a(8);class n{static instance;currentAvatar='';registeredElements=new Map;memberElements=new Map;options;syncTimer=null;mutationObserver=null;discoveryDebounceTimer=null;isDestroyed=!1;isInternalOperation=!1;constructor(e={}){this.options={debug:e.debug??!1,syncInterval:e.syncInterval??1e3,enableMutationObserver:e.enableMutationObserver??!0,discoveryDebounceDelay:e.discoveryDebounceDelay??300,enablePeriodicSync:e.enablePeriodicSync??!1},this.log('增强的头像同步管理器已初始化'),this.initialize()}initialize(){this.options.enablePeriodicSync?this.startSync():this.sync(),this.setupMutationObserver(),this.performInitialDiscovery()}static getInstance(e){return n.instance||(n.instance=new n(e)),n.instance}registerElement(e,t='background'){if(this.isDestroyed)return;if(this.registeredElements.has(e))return void this.log(`元素已经注册，跳过: ${e.className||e.tagName}`);const a='string'==typeof t?{type:t}:t;if(a.validator&&!a.validator(e))return void this.log(`元素验证失败，跳过注册: ${e.className||e.tagName}`);this.withInternalOperation(()=>{e.setAttribute('data-avatar-sync','true'),e.setAttribute('data-avatar-type',a.type),a.memberId&&e.setAttribute('data-member-id',a.memberId)});const n={element:e,config:a,lastUpdate:Date.now(),isValid:!0};this.registeredElements.set(e,n),'member-avatar'===a.type&&a.memberId&&(this.memberElements.has(a.memberId)||this.memberElements.set(a.memberId,new Set),this.memberElements.get(a.memberId).add(e)),this.updateElement(e,a,this.currentAvatar||(0,s.oE)()),this.log(`已注册头像元素: ${e.className||e.tagName} (类型: ${a.type})`)}unregisterElement(e){const t=this.registeredElements.get(e);if(t&&'member-avatar'===t.config.type&&t.config.memberId){const a=this.memberElements.get(t.config.memberId);a&&(a.delete(e),0===a.size&&this.memberElements.delete(t.config.memberId))}this.withInternalOperation(()=>{e.removeAttribute('data-avatar-sync'),e.removeAttribute('data-avatar-type'),e.removeAttribute('data-member-id')}),this.registeredElements.delete(e),this.log(`已取消注册头像元素: ${e.className||e.tagName}`)}autoRegister(){if(this.isDestroyed)return;let e=0;e+=this.registerUserAvatarElements(),e+=this.registerMemberAvatarElements(),e+=this.registerSpecialAvatarElements(),e>0&&this.log(`自动注册了 ${e} 个头像元素`)}registerUserAvatarElements(){let e=0;return['.user_avatar.avatar.avatar-hover','.user-avatar','.user_avatar'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{const a=t;if(!a.hasAttribute('data-avatar-sync')&&this.isUserAvatarElement(a)){const t='IMG'===a.tagName?'img':'background';this.registerElement(a,{type:t}),e++}})}),e}isUserAvatarElement(e){if(e.closest('.chat-list, .chatlist, .contact-list'))return!1;if(e.closest('.group-avatar, .chat-avatar, .contact-avatar'))return!1;const t=e.className.toLowerCase();if(['character-avatar','char-avatar','contact-avatar','chat-avatar','group-avatar','bot-avatar','ai-avatar'].some(e=>t.includes(e)))return!1;const a=e.closest('[data-character], [data-char], [data-contact], .character-item, .contact-item, .chat-item');if(a){return a.hasAttribute('data-user')||a.classList.contains('user-item')||a.classList.contains('profile-item')}return!0}registerMemberAvatarElements(){const e=document.querySelectorAll('.member-avatar');let t=0;return e.forEach(e=>{const a=e;if(!a.hasAttribute('data-avatar-sync')){const e=a.getAttribute('data-member-id')||a.getAttribute('data-member')||this.extractMemberIdFromElement(a);if(this.isUserMemberId(e)){const s={type:'member-avatar',memberId:e,validator:e=>this.validateMemberAvatarElement(e)};this.registerElement(a,s),t++}}}),t}registerSpecialAvatarElements(){let e=0;return['#avatarImage','.profile-avatar'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{const a=t;if(!a.hasAttribute('data-avatar-sync')){const t='IMG'===a.tagName?'img':'background';this.registerElement(a,{type:t,priority:1}),e++}})}),e}extractMemberIdFromElement(e){const t=['data-member-id','data-member','data-user-id','data-user'];for(const a of t){const t=e.getAttribute(a);if(t)return t}const a=e.closest('[data-member-id], [data-member], [data-user-id], [data-user]');if(a)for(const e of t){const t=a.getAttribute(e);if(t)return t}return null}isUserMemberId(e){if(!e)return!1;return['{{user}}','user','User','USER'].includes(e)}validateMemberAvatarElement(e){if(!document.contains(e))return!1;const t=window.getComputedStyle(e);if('none'===t.display||'hidden'===t.visibility)return!1;const a=e.getAttribute('data-member-id')||this.extractMemberIdFromElement(e);return this.isUserMemberId(a)}sync(){if(this.isDestroyed)return;const e=(0,s.oE)();e!==this.currentAvatar&&(this.log(`头像已更新: ${this.currentAvatar} -> ${e}`),this.currentAvatar=e,this.updateAllElements(e))}forceUpdate(e){if(this.isDestroyed)return;const t=e??(0,s.oE)();this.currentAvatar=t,this.updateAllElements(t),this.log(`已强制更新所有头像元素 (URL: ${e?'provided':'fetched'})`)}updateElement(e,t,a){try{if('member-avatar'===t.type&&!this.isUserMemberId(t.memberId))return;switch(t.type){case'img':'IMG'===e.tagName&&(e.src=a);break;case'background':default:e.style.backgroundImage=`url(${a})`;break;case'member-avatar':'IMG'===e.tagName?e.src=a:e.style.backgroundImage=`url(${a})`}const s=this.registeredElements.get(e);s&&(s.lastUpdate=Date.now())}catch(t){this.log(`更新头像元素失败: ${t}`);const a=this.registeredElements.get(e);a&&(a.isValid=!1)}}updateAllElements(e){const t=[],a=[];this.registeredElements.forEach((e,s)=>{document.contains(s)&&e.isValid?e.config.validator&&!e.config.validator(s)?t.push(s):a.push({element:s,config:e.config}):t.push(s)}),a.sort((e,t)=>(e.config.priority||999)-(t.config.priority||999)),a.forEach(({element:t,config:a})=>{this.updateElement(t,a,e)}),t.forEach(e=>{this.unregisterElement(e)}),t.length>0&&this.log(`清理了 ${t.length} 个无效的头像元素`),a.length>0&&this.log(`更新了 ${a.length} 个头像元素`)}startSync(){this.isDestroyed||null!==this.syncTimer||(this.sync(),this.syncTimer=window.setInterval(()=>{this.sync(),this.performPeriodicMaintenance()},this.options.syncInterval),this.log('自动同步已启动'))}performPeriodicMaintenance(){this.cleanupInvalidElements(),this.debouncedAutoRegister()}debouncedAutoRegister(){null!==this.discoveryDebounceTimer&&clearTimeout(this.discoveryDebounceTimer),this.discoveryDebounceTimer=window.setTimeout(()=>{this.autoRegister(),this.discoveryDebounceTimer=null},this.options.discoveryDebounceDelay)}cleanupInvalidElements(){const e=[];this.registeredElements.forEach((t,a)=>{document.contains(a)&&t.isValid||e.push(a)}),e.forEach(e=>{this.unregisterElement(e)}),e.length>0&&this.log(`定期清理了 ${e.length} 个无效元素`)}performInitialDiscovery(){setTimeout(()=>{this.autoRegister()},100)}stopSync(){null!==this.syncTimer&&(clearInterval(this.syncTimer),this.syncTimer=null,this.log('自动同步已停止')),null!==this.discoveryDebounceTimer&&(clearTimeout(this.discoveryDebounceTimer),this.discoveryDebounceTimer=null)}setupMutationObserver(){this.options.enableMutationObserver&&'undefined'!=typeof MutationObserver&&(this.mutationObserver=new MutationObserver(e=>{if(this.isInternalOperation)return;let t=!1;e.forEach(e=>{'childList'===e.type&&e.addedNodes.length>0&&e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const a=e;this.containsAvatarElements(a)&&(t=!0)}})}),t&&this.debouncedAutoRegister()}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0}),this.log('DOM变化监听器已启动'))}containsAvatarElements(e){return['.user_avatar','.user-avatar','.member-avatar','.profile-avatar','.chat-avatar','[data-member-id]','#avatarImage'].some(t=>e.matches&&e.matches(t)||e.querySelector(t))}stopMutationObserver(){this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null,this.log('DOM变化监听器已停止'))}destroy(){this.isDestroyed=!0,this.stopSync(),this.stopMutationObserver(),this.registeredElements.forEach((e,t)=>{t.removeAttribute('data-avatar-sync'),t.removeAttribute('data-avatar-type'),t.removeAttribute('data-member-id')}),this.registeredElements.clear(),this.memberElements.clear(),this.log('增强的头像同步管理器已销毁'),n.instance=null}getDebugInfo(){const e={},t={};return this.registeredElements.forEach(t=>{const a=t.config.type;e[a]=(e[a]||0)+1}),this.memberElements.forEach((e,a)=>{t[a]=e.size}),{currentAvatar:this.currentAvatar,totalRegisteredElements:this.registeredElements.size,elementsByType:e,memberElementsCount:t,isDestroyed:this.isDestroyed,options:this.options,hasMutationObserver:!!this.mutationObserver,hasActiveTimer:!!this.syncTimer}}getRegisteredElements(){const e=[];return this.registeredElements.forEach((t,a)=>{e.push({element:a,config:t.config,lastUpdate:t.lastUpdate,isValid:t.isValid,className:a.className,tagName:a.tagName})}),e}getMemberAvatarStats(){const e={};return this.memberElements.forEach((t,a)=>{e[a]={count:t.size,elements:Array.from(t)}}),e}withInternalOperation(e){const t=this.isInternalOperation;this.isInternalOperation=!0;try{return e()}finally{this.isInternalOperation=t}}log(e){this.options.debug&&console.log(`[AvatarSync] ${e}`)}}class r{avatarSync;registeredElements=new Set;constructor(e){this.avatarSync=n.getInstance(e)}register(e,t){this.avatarSync.registerElement(e,t||'background'),this.registeredElements.add(e)}autoRegister(){this.avatarSync.autoRegister()}forceUpdate(){this.avatarSync.forceUpdate()}destroy(){this.registeredElements.forEach(e=>{this.avatarSync.unregisterElement(e)}),this.registeredElements.clear()}}const o=n.getInstance({debug:!1,enablePeriodicSync:!1});function i(e,t){o.registerElement(e,t)}function l(){o.autoRegister()}function c(e){o.forceUpdate(e)}function h(){o.sync()}function d(e,t){const a={type:'member-avatar',memberId:t,validator:e=>document.contains(e)};o.registerElement(e,a)}function g(){return o.getDebugInfo()}function u(){return o.getMemberAvatarStats()}function m(){o.sync()}},663:(e,t,a)=>{a.d(t,{GroupChatStorage:()=>n});var s=a(832);class n{static STORAGE_KEY='groups';static AVATAR_CACHE_KEY='group_avatars';static saveGroupChat(e){try{const t=this.getAllGroupChats().filter(t=>t.id!==e.id);t.unshift(e),(0,s.setCharacterItem)(this.STORAGE_KEY,t),console.log(`💾 群聊已保存到角色专用空间: ${e.name}`)}catch(e){console.error('保存群聊数据失败:',e)}}static getAllGroupChats(){try{return(0,s.getCharacterItem)(this.STORAGE_KEY,[])}catch(e){return console.error('读取群聊数据失败:',e),[]}}static getGroupChatById(e){return this.getAllGroupChats().find(t=>t.id===e)||null}static deleteGroupChat(e){try{const t=this.getAllGroupChats(),a=t.filter(t=>t.id!==e);return a.length<t.length&&((0,s.setCharacterItem)(this.STORAGE_KEY,a),console.log(`🗑️ 群聊已从角色专用空间删除: ${e}`),!0)}catch(e){return console.error('删除群聊数据失败:',e),!1}}static generateGroupId(e){return e?e.startsWith('群聊')?e:`群聊${e}`:`group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static async saveGroupAvatar(e,t){try{(0,s.setCharacterItem)(`group_avatar_${e}`,t);const a=(0,s.getCharacterItem)('group_avatar_index',{});a[e]={avatar:t,timestamp:Date.now(),size:t.length},(0,s.setCharacterItem)('group_avatar_index',a);const n=this.getGroupChatById(e);n&&(n.avatar=t,this.saveGroupChat(n)),console.log(`💾 群头像已保存到缓存: ${e}`)}catch(e){throw console.error('保存群头像到缓存失败:',e),e}}static loadGroupAvatar(e){try{return(0,s.getCharacterItem)(`group_avatar_${e}`,null)}catch(e){return console.error('从缓存加载群头像失败:',e),null}}static getGroupAvatarWithFallback(e,t){const a=this.loadGroupAvatar(e);if(a)return a;const s=this.getGroupChatById(e);return s&&s.avatar&&s.avatar!==t?s.avatar:t}static getDefaultGroupAvatar(e){const t=['https://files.catbox.moe/j2s4qj.jpg','https://files.catbox.moe/seoipi.jpg','https://files.catbox.moe/dq08mr.jpg','https://files.catbox.moe/yc3gv4.jpeg'],a=e.split('').reduce((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e,0);return t[Math.abs(a)%t.length]}static getGroupAvatarIndex(){try{return(0,s.getCharacterItem)('group_avatar_index',{})}catch(e){return console.error('获取群头像索引失败:',e),{}}}static cleanupOldAvatarCache(){try{const e=this.getGroupAvatarIndex(),t=Date.now()-2592e6,a=[];for(const[s,n]of Object.entries(e))n.timestamp<t&&(a.push(s),removeCharacterItem(`group_avatar_${s}`));a.forEach(t=>delete e[t]),(0,s.setCharacterItem)('group_avatar_index',e),a.length>0&&console.log(`🧹 已清理 ${a.length} 个过期群头像缓存`)}catch(e){console.error('清理头像缓存失败:',e)}}static fileToBase64(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})}}},790:(e,t,a)=>{a.d(t,{WallpaperManager:()=>n});var s=a(52);class n{static instance;storageManager;currentWallpaper='';defaultWallpaper='https://files.catbox.moe/o84j4n.jpg';constructor(){this.storageManager=s.StorageManager.getInstance(),this.initialize()}static getInstance(){return n.instance||(n.instance=new n),n.instance}initialize(){this.loadWallpaperFromSettings(),document.addEventListener('settingsChange',e=>{this.handleSettingsChange(e.detail.settings)}),document.addEventListener('characterChange',()=>{console.log('[WallpaperManager] 检测到角色切换，重新加载壁纸'),this.forceRefresh()}),this.applyWallpaper()}loadWallpaperFromSettings(){try{const e=this.storageManager.loadSettings();this.currentWallpaper=e.chatListWallpaper||this.defaultWallpaper,console.log('[WallpaperManager] 加载壁纸设置:',this.currentWallpaper?'自定义壁纸':'默认壁纸')}catch(e){console.error('[WallpaperManager] 加载壁纸设置失败:',e),this.currentWallpaper=this.defaultWallpaper}}handleSettingsChange(e){const t=e.chatListWallpaper||this.defaultWallpaper;t!==this.currentWallpaper&&(console.log('[WallpaperManager] 检测到壁纸变更，应用新壁纸'),this.currentWallpaper=t,this.applyWallpaper())}applyWallpaper(){const e=document.querySelector('.chat-list-interface');e?(e.style.backgroundImage=`url('${this.currentWallpaper}')`,e.style.backgroundSize='cover',e.style.backgroundPosition='center',e.style.backgroundRepeat='no-repeat',console.log('[WallpaperManager] 壁纸已应用到聊天列表界面')):(console.warn('[WallpaperManager] 未找到聊天列表界面元素，稍后重试'),setTimeout(()=>{this.applyWallpaper()},100))}setCustomWallpaper(e){try{this.currentWallpaper=e;const t=this.storageManager.loadSettings();t.chatListWallpaper=e,this.storageManager.saveSettings(t),this.applyWallpaper(),console.log('[WallpaperManager] 自定义壁纸设置成功')}catch(e){throw console.error('[WallpaperManager] 设置自定义壁纸失败:',e),e}}resetToDefault(){try{this.currentWallpaper=this.defaultWallpaper;const e=this.storageManager.loadSettings();e.chatListWallpaper='',this.storageManager.saveSettings(e),this.applyWallpaper(),console.log('[WallpaperManager] 已重置为默认壁纸')}catch(e){throw console.error('[WallpaperManager] 重置默认壁纸失败:',e),e}}getCurrentWallpaper(){return this.currentWallpaper}isUsingCustomWallpaper(){return this.currentWallpaper!==this.defaultWallpaper}preloadWallpaper(e){return new Promise((t,a)=>{const s=new Image;s.onload=()=>{console.log('[WallpaperManager] 壁纸预加载成功'),t()},s.onerror=e=>{console.error('[WallpaperManager] 壁纸预加载失败:',e),a(e)},s.src=e})}forceRefresh(){console.log('[WallpaperManager] 强制刷新壁纸'),this.loadWallpaperFromSettings(),this.applyWallpaper()}handleCharacterChange(){console.log('[WallpaperManager] 处理角色切换，重新加载壁纸设置'),this.forceRefresh()}clearWallpaperCache(){try{const e=this.storageManager.loadSettings();e.chatListWallpaper='',this.storageManager.saveSettings(e),this.currentWallpaper=this.defaultWallpaper,this.applyWallpaper(),console.log('[WallpaperManager] 壁纸缓存已清除，已恢复为默认壁纸')}catch(e){throw console.error('[WallpaperManager] 清除壁纸缓存失败:',e),e}}destroy(){document.removeEventListener('settingsChange',this.handleSettingsChange.bind(this));const e=document.querySelector('.chat-list-interface');e&&(e.style.backgroundImage=`url('${this.defaultWallpaper}')`),console.log('[WallpaperManager] 壁纸管理器已销毁')}}},791:(e,t,a)=>{a.r(t),a.d(t,{UserInfoRetrieval:()=>s,debugUserInfoEnvironment:()=>l,defaultUserInfoRetrieval:()=>n,getSimpleUserAvatar:()=>p,getUserAvatar:()=>c,getUserAvatarAsync:()=>h,getUserInfo:()=>r,getUserName:()=>o,getUserNameAsync:()=>i});class s{options;constructor(e={}){this.options={defaultUserName:e.defaultUserName||'User',defaultAvatarUrl:e.defaultAvatarUrl||'https://files.catbox.moe/u8ccy5.jpg',enableLogging:!1!==e.enableLogging}}getUserInfo(){return{id:'{{user}}',name:this.getUserName(),avatar:this.getUserAvatar()}}getUserName(){try{if(window.TavernHelper&&window.TavernHelper.substitudeMacros){const e=window.TavernHelper.substitudeMacros('{{user}}');if(e&&'{{user}}'!==e&&e.trim())return e.trim()}const e=[()=>window.power_user?.name,()=>window.name1,()=>window.user_name,()=>window.userName];for(const t of e)try{const e=t();if(e&&'string'==typeof e&&e.trim())return e.trim()}catch(e){}return this.options.defaultUserName}catch(e){return this.options.defaultUserName}}async getUserNameAsync(){try{if('function'==typeof triggerSlash)try{const e=await triggerSlash('/pass {{user}}');if(e&&'string'==typeof e&&e.trim()&&'{{user}}'!==e)return e.trim()}catch(e){}return this.getUserName()}catch(e){return this.options.defaultUserName}}getUserAvatar(){try{if(window.TavernHelper&&window.TavernHelper.substitudeMacros)try{const e=window.TavernHelper.substitudeMacros('{{userAvatarPath}}');if(e&&'{{userAvatarPath}}'!==e&&e.trim())return this.log('✅ 从 {{userAvatarPath}} 宏获取到用户头像:',e),e.trim()}catch(e){this.log('⚠️ 宏替换失败:',e)}if(window.power_user?.avatar)return this.log('✅ 从 power_user.avatar 获取到用户头像'),window.power_user.avatar;if(window.user_avatar){const e=window.user_avatar;if('string'==typeof e&&e.trim())return this.log('✅ 从 user_avatar 全局变量获取到用户头像:',e),e.trim()}const e=document.querySelector('.user-avatar, .user_avatar');if(e){this.log('🔍 找到 .user_avatar 元素，尝试获取头像');const t=window.getComputedStyle(e).backgroundImage;if(t&&'none'!==t){const e=t.match(/url\(["']?([^"']*)["']?\)/);if(e?.[1])return this.log('✅ 从 .user_avatar 元素的 background-image 获取到用户头像:',e[1]),e[1]}if('IMG'===e.tagName){const t=e.src;if(t)return this.log('✅ 从 .user_avatar img 元素的 src 获取到用户头像:',t),t}const a=e.querySelector('img');if(a&&a.src)return this.log('✅ 从 .user_avatar 内部 img 元素获取到用户头像:',a.src),a.src;const s=e.getAttribute('data-avatar')||e.getAttribute('data-src')||e.getAttribute('data-image');if(s)return this.log('✅ 从 .user_avatar 元素的 data 属性获取到用户头像:',s),s;this.log('⚠️ .user_avatar 元素存在但未找到头像信息')}else this.log('⚠️ 未找到 .user_avatar 元素');const t=[()=>window.settings?.user_avatar,()=>window.chat_metadata?.user_avatar,()=>window.persona?.avatar];for(const e of t)try{const t=e();if(t&&'string'==typeof t&&t.trim())return this.log('✅ 从其他全局变量获取到用户头像:',t),t.trim()}catch(e){}return this.log('⚠️ 无法获取用户头像，使用默认头像'),this.options.defaultAvatarUrl}catch(e){return this.log('❌ 获取用户头像失败，使用默认值:',e),this.options.defaultAvatarUrl}}isTavernHelperAvailable(){return!(!window.TavernHelper||!window.TavernHelper.substitudeMacros)}getAvailableGlobalVars(){const e={};try{const t=['power_user','name1','user_name','userName','user_avatar','settings','chat_metadata','characters','this_chid','TavernHelper','eventSource','main_api'];for(const a of t)try{const t=window[a];void 0!==t&&(e[a]=t)}catch(e){}}catch(e){this.log('获取全局变量时出错:',e)}return e}debugEnvironment(){this.log('=== 用户信息获取环境检查 ==='),this.log('triggerSlash 函数可用:','function'==typeof triggerSlash),this.log('TavernHelper 可用:',!!window.TavernHelper),this.log('power_user 可用:',!!window.power_user);const e=document.querySelector('.user_avatar');if(e){this.log('✅ .user_avatar 元素存在'),this.log('元素标签:',e.tagName),this.log('元素类名:',e.className);const t=window.getComputedStyle(e).backgroundImage;this.log('背景图片:',t),'IMG'===e.tagName&&this.log('img src:',e.src);const a=e.querySelector('img');a&&this.log('内部 img src:',a.src);['data-avatar','data-src','data-image'].forEach(t=>{const a=e.getAttribute(t);a&&this.log(`${t}:`,a)})}else this.log('❌ .user_avatar 元素不存在');this.log('=== 检查完成 ===')}log(e,t){this.options.enableLogging&&(void 0!==t?console.log(`[UserInfoRetrieval] ${e}`,t):console.log(`[UserInfoRetrieval] ${e}`))}updateOptions(e){this.options={...this.options,...e}}}const n=new s;function r(e){return(e?new s(e):n).getUserInfo()}function o(e){return(e?new s(e):n).getUserName()}async function i(e){return(e?new s(e):n).getUserNameAsync()}function l(e){(e?new s(e):n).debugEnvironment()}function c(e){return(e?new s(e):n).getUserAvatar()}async function h(e){try{return'undefined'!=typeof window&&window.avatarSourceService?await window.avatarSourceService.getCurrentAvatar():c(e)}catch(t){return console.warn('[getUserAvatarAsync] 异步获取失败，降级到同步方法:',t),c(e)}}let d=null,g=0;const u=1e3,m=!1;function p(e='https://files.catbox.moe/u8ccy5.jpg'){try{const t=Date.now();if(d&&t-g<u)return d;const a=document.querySelector('.user-avatar, .user_avatar');if(!a)return m&&d!==e&&console.log('[SimpleUserAvatar] 未找到 .user_avatar 元素'),d=e,g=t,e;const s=[()=>{const e=window.getComputedStyle(a).backgroundImage;if(e&&'none'!==e){const t=e.match(/url\(["']?([^"']*)["']?\)/);if(t?.[1])return m&&console.log('[SimpleUserAvatar] 从 background-image 获取头像:',t[1]),t[1]}return null},()=>{if('IMG'===a.tagName){const e=a.src;if(e)return m&&console.log('[SimpleUserAvatar] 从 img src 获取头像:',e),e}return null},()=>{const e=a.querySelector('img');return e&&e.src?(m&&console.log('[SimpleUserAvatar] 从内部 img 获取头像:',e.src),e.src):null},()=>{const e=['data-avatar','data-src','data-image','data-url'];for(const t of e){const e=a.getAttribute(t);if(e)return m&&console.log(`[SimpleUserAvatar] 从 ${t} 获取头像:`,e),e}return null},()=>{const e=a.getAttribute('style');if(e){const t=e.match(/background-image:\s*url\(["']?([^"']*)["']?\)/);if(t?.[1])return m&&console.log('[SimpleUserAvatar] 从 style 属性获取头像:',t[1]),t[1]}return null}];for(const e of s)try{const t=e();if(t)return t}catch(e){}return m&&console.log('[SimpleUserAvatar] 所有方法都失败，使用默认头像'),e}catch(t){return m&&console.error('[SimpleUserAvatar] 获取头像时发生错误:',t),e}}},832:(e,t,a)=>{a.r(t),a.d(t,{clearCharacterIdCache:()=>g,getCharacterItem:()=>h,removeCharacterItem:()=>d,setCharacterItem:()=>c});let s=null,n=null,r=0;const o=1e3;function i(){try{const e=Date.now();if(n&&e-r<o)return n;if('undefined'!=typeof TavernHelper&&'function'==typeof TavernHelper.getCharData)try{const t=TavernHelper.getCharData();if(t){const a=t.name||t.avatar||'default';return n=a,r=e,a!==s&&(console.log(`[CharacterStorage] ✅ 角色ID变更: ${s} → ${a}`),s=a),a}}catch(e){console.error('[CharacterStorage] TavernHelper.getCharData() 调用失败:',e)}if(window.TavernHelper&&'function'==typeof window.TavernHelper.getCharData)try{const t=window.TavernHelper.getCharData();if(t){const a=t.name||t.avatar||'default';return n=a,r=e,a!==s&&(console.log(`[CharacterStorage] ✅ 角色ID变更(window): ${s} → ${a}`),s=a),a}}catch(e){console.error('[CharacterStorage] window.TavernHelper.getCharData() 调用失败:',e)}if(void 0!==window.this_chid&&void 0!==window.characters){const t=window.this_chid,a=window.characters;if(a[t]){const o=a[t],i=o.name||o.avatar||`char_${t}`;return n=i,r=e,i!==s&&(console.log(`[CharacterStorage] ✅ 角色ID变更(传统): ${s} → ${i}`),s=i),i}}const t='default';return n=t,r=e,t!==s&&(console.log('[CharacterStorage] ⚠️ 所有方法都失败，使用默认角色ID'),s=t),t}catch(e){return console.error('[CharacterStorage] 获取角色ID失败:',e),'default'}}function l(e){return`bear_chat_isolated_${i()}_${e}`}function c(e,t){try{const a=l(e);localStorage.setItem(a,JSON.stringify(t))}catch(t){console.error(`[CharacterStorage] 存储失败 ${e}:`,t)}}function h(e,t=null){try{const a=l(e),s=localStorage.getItem(a);return s?JSON.parse(s):t}catch(a){return console.error(`[CharacterStorage] 获取失败 ${e}:`,a),t}}function d(e){try{const t=l(e);localStorage.removeItem(t)}catch(t){console.error(`[CharacterStorage] 删除失败 ${e}:`,t)}}function g(){n=null,r=0,s=null,console.log('[CharacterStorage] 角色ID缓存已清除')}}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,a),r.exports}a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};var s=a(832);class n{static CONTACT_REGEX=/\[姓名：([^头像]+)头像：([^\]]+)\]/g;static parseContacts(e){const t=[];try{let a;const s=new RegExp(this.CONTACT_REGEX.source,'g');for(;null!==(a=s.exec(e));){const e=a[1].trim(),s=a[2].trim();e&&s?(t.push({name:e,avatar:s}),console.log(`👤 [ContactParser] 解析到联系人: ${e} -> ${s.substring(0,50)}...`)):console.warn(`⚠️ [ContactParser] 跳过无效联系人条目: 姓名="${e}", 头像="${s}"`)}console.log(`✅ [ContactParser] 成功解析 ${t.length} 个联系人`)}catch(e){console.error('❌ [ContactParser] 解析联系人内容失败:',e)}return t}static validateContactFormat(e){return new RegExp(this.CONTACT_REGEX.source).test(e)}static formatContacts(e){return e.map(e=>`[姓名：${e.name} 头像：${e.avatar}]`).join('\n')}}class r{contactData=[];CONTACT_STORAGE_KEY='contact_avatars';async initialize(){try{console.log('🎯 [ContactLorebookManager] 开始初始化联系人世界书管理器...'),await this.loadContactsFromLorebook(),console.log(`✅ [ContactLorebookManager] 联系人世界书管理器初始化完成，加载了 ${this.contactData.length} 个联系人`)}catch(e){console.error('❌ [ContactLorebookManager] 初始化联系人世界书管理器失败:',e)}}async loadContactsFromLorebook(){try{if(console.log('🎯 开始从世界书加载联系人数据...'),'function'!=typeof window.getLorebookEntries)return void console.log('❌ 全局getLorebookEntries函数不存在，跳过世界书加载...');let e=null,t='';const a=await this.getCharacterLorebook();if(a){console.log(`📖 尝试从角色世界书搜索联系人: ${a}`);try{e=(await window.getLorebookEntries(a)).find(e=>'联系人'===e.comment||e.comment.includes('联系人')),e?(t=`角色世界书: ${a}`,console.log('✅ 在角色世界书中找到联系人条目')):console.log('❌ 角色世界书中未找到联系人条目')}catch(e){console.warn('⚠️ 访问角色世界书失败:',e)}}if(!e){const a=await this.getGlobalLorebooks();for(const s of a){console.log(`🌍 尝试从全局世界书搜索联系人: ${s}`);try{if(e=(await window.getLorebookEntries(s)).find(e=>'联系人'===e.comment||e.comment.includes('联系人')),e){t=`全局世界书: ${s}`,console.log('✅ 在全局世界书中找到联系人条目');break}console.log(`❌ 全局世界书 ${s} 中未找到联系人条目`)}catch(e){console.warn(`⚠️ 访问全局世界书 ${s} 失败:`,e)}}}e?(console.log(`📋 找到联系人条目，来源: ${t}`),this.parseContactEntry(e)):console.log('❌ 未在任何世界书中找到联系人条目')}catch(e){console.error('❌ 从世界书加载联系人失败:',e)}}parseContactEntry(e){try{const t=e.content||'';console.log('📝 开始解析联系人内容...'),this.contactData=n.parseContacts(t)}catch(e){console.error('❌ 解析联系人条目失败:',e),this.contactData=[]}}async getCharacterLorebook(){try{if('function'==typeof window.getCurrentCharPrimaryLorebook)return window.getCurrentCharPrimaryLorebook();console.warn('getCurrentCharPrimaryLorebook 函数不可用')}catch(e){console.warn('⚠️ 获取角色世界书失败:',e)}return null}async getGlobalLorebooks(){try{if('function'==typeof window.getLorebookSettings){return window.getLorebookSettings().selected_global_lorebooks||[]}return console.warn('getLorebookSettings 函数不可用'),[]}catch(e){console.warn('⚠️ 获取全局世界书设置失败:',e)}return[]}getContactAvatar(e){const t=this.getCharacterSpecificAvatar(e);if(t)return console.log(`🎨 [ContactLorebookManager] 使用角色专用头像: ${e}`),t;const a=this.contactData.find(t=>t.name===e);return a?.avatar?(console.log(`📖 [ContactLorebookManager] 使用世界书默认头像: ${e}`),a.avatar):(console.log(`🔧 [ContactLorebookManager] 使用系统默认头像: ${e}`),'./User Avatars/user-default.png')}getCharacterSpecificAvatar(e){try{return(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{})[e]||null}catch(e){return console.warn('⚠️ [ContactLorebookManager] 获取角色专用头像失败:',e),null}}setCharacterSpecificAvatar(e,t){try{const a=(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{});a[e]=t,(0,s.setCharacterItem)(this.CONTACT_STORAGE_KEY,a),console.log(`💾 [ContactLorebookManager] 保存角色专用头像: ${e}`),this.triggerAvatarSync(e,t)}catch(e){console.error('❌ [ContactLorebookManager] 保存角色专用头像失败:',e)}}triggerAvatarSync(e,t){try{const{forceUpdateAvatars:s}=a(534);s(t),console.log(`🔄 [ContactLorebookManager] 已触发头像同步: ${e}`)}catch(e){console.warn('⚠️ [ContactLorebookManager] 触发头像同步失败:',e)}}getContactData(){return[...this.contactData]}hasContact(e){return this.contactData.some(t=>t.name===e)}async reload(){console.log('🔄 [ContactLorebookManager] 角色切换，重新加载联系人数据...'),await this.loadContactsFromLorebook()}async clearLorebookCharacterCache(){try{await this.loadContactsFromLorebook();const e=this.contactData.map(e=>e.name);if(0===e.length)return console.log('📋 [ContactLorebookManager] 世界书中没有联系人，无需清除缓存'),{cleared:0,total:0};const t=(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{});let a=0;return e.forEach(e=>{t[e]&&(delete t[e],a++,console.log(`🗑️ [ContactLorebookManager] 清除世界书角色缓存: ${e}`))}),(0,s.setCharacterItem)(this.CONTACT_STORAGE_KEY,t),console.log(`✅ [ContactLorebookManager] 世界书角色缓存清除完成: 清除了 ${a} 个角色，世界书共有 ${e.length} 个角色`),{cleared:a,total:e.length}}catch(e){return console.error('❌ [ContactLorebookManager] 清除世界书角色缓存失败:',e),{cleared:0,total:0}}}getLorebookCacheStats(){try{const e=(0,s.getCharacterItem)(this.CONTACT_STORAGE_KEY,{}),t=new Set(this.contactData.map(e=>e.name)),a=Object.keys(e).filter(e=>t.has(e)).length;return{worldbookContacts:this.contactData.length,cachedContacts:Object.keys(e).length,cachedWorldbookContacts:a}}catch(e){return console.error('❌ [ContactLorebookManager] 获取缓存统计失败:',e),{worldbookContacts:0,cachedContacts:0,cachedWorldbookContacts:0}}}}class o{contacts=[];groups=[];STORAGE_KEY='contacts';contactLorebookManager;constructor(){this.contactLorebookManager=new r,this.initialize()}async initialize(){try{console.log('🚀 [ContactManager] 开始初始化联系人管理器...'),await this.contactLorebookManager.initialize(),this.loadContacts(),this.mergeLorebookContacts(),console.log(`✅ [ContactManager] 联系人管理器初始化完成，共 ${this.contacts.length} 个联系人`)}catch(e){console.error('❌ [ContactManager] 初始化失败:',e),this.loadContacts()}}loadContacts(){try{const e=(0,s.getCharacterItem)(this.STORAGE_KEY,null);e?(this.contacts=e.contacts||[],this.groups=e.groups||[],console.log(`📋 从角色专用空间加载联系人: ${this.contacts.length} 个`)):this.initializeDefaultContacts()}catch(e){console.warn('加载联系人数据失败:',e),this.initializeDefaultContacts()}}mergeLorebookContacts(){try{const e=this.contactLorebookManager.getContactData();console.log(`🔄 [ContactManager] 开始合并 ${e.length} 个世界书联系人...`),e.forEach(e=>{if(this.contacts.find(t=>t.name===e.name))console.log(`⏭️ [ContactManager] 联系人已存在，跳过: ${e.name}`);else{this.addContact({name:e.name,avatar:this.getContactAvatar(e.name),type:'character',isOnline:!1,tags:['世界书']});console.log(`➕ [ContactManager] 从世界书添加联系人: ${e.name}`)}}),console.log('✅ [ContactManager] 世界书联系人合并完成')}catch(e){console.error('❌ [ContactManager] 合并世界书联系人失败:',e)}}async reloadContacts(){console.log('🔄 [ContactManager] 角色切换，重新加载联系人数据...'),await this.contactLorebookManager.reload(),this.loadContacts(),this.mergeLorebookContacts()}getContactAvatar(e){return this.contactLorebookManager.getContactAvatar(e)}async clearLorebookCharacterCache(){return this.contactLorebookManager?await this.contactLorebookManager.clearLorebookCharacterCache():{cleared:0,total:0}}getLorebookCacheStats(){return this.contactLorebookManager?this.contactLorebookManager.getLorebookCacheStats():{worldbookContacts:0,cachedContacts:0,cachedWorldbookContacts:0}}saveContacts(){try{const e={contacts:this.contacts,groups:this.groups,lastUpdated:Date.now()};(0,s.setCharacterItem)(this.STORAGE_KEY,e),console.log(`💾 联系人数据已保存到角色专用空间: ${this.contacts.length} 个`)}catch(e){console.error('保存联系人数据失败:',e)}}initializeDefaultContacts(){this.contacts=[],this.groups=[],this.saveContacts()}getAllContacts(){return[...this.contacts]}getContactById(e){return this.contacts.find(t=>t.id===e)||null}searchContacts(e){const t=e.toLowerCase();return this.contacts.filter(e=>e.name.toLowerCase().includes(t)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(t)))}addContact(e){const t={...e,id:this.generateContactId()};return this.contacts.push(t),this.saveContacts(),t}updateContact(e,t){const a=this.contacts.find(t=>t.id===e);return!!a&&(t.avatar&&this.contactLorebookManager.setCharacterSpecificAvatar(a.name,t.avatar),Object.assign(a,t),this.saveContacts(),!0)}deleteContact(e){const t=this.contacts.findIndex(t=>t.id===e);return-1!==t&&(this.contacts.splice(t,1),this.saveContacts(),!0)}getAllGroups(){return[...this.groups]}createGroup(e,t,a){const s={id:this.generateGroupId(),name:e,avatar:this.getDefaultGroupAvatar(),members:t,createdAt:(new Date).toISOString(),description:a};return this.groups.push(s),this.saveContacts(),s}updateGroup(e,t){const a=this.groups.findIndex(t=>t.id===e);return-1!==a&&(this.groups[a]={...this.groups[a],...t},this.saveContacts(),!0)}deleteGroup(e){const t=this.groups.findIndex(t=>t.id===e);return-1!==t&&(this.groups.splice(t,1),this.saveContacts(),!0)}generateContactId(){return'contact_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}generateGroupId(){return'group_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}getDefaultGroupAvatar(){const e=['https://files.catbox.moe/group1.jpg','https://files.catbox.moe/group2.jpg','https://files.catbox.moe/group3.jpg'];return e[Math.floor(Math.random()*e.length)]}getOnlineContacts(){return this.contacts.filter(e=>e.isOnline)}getContactsByTag(e){return this.contacts.filter(t=>t.tags&&t.tags.includes(e))}getAllTags(){const e=new Set;return this.contacts.forEach(t=>{t.tags&&t.tags.forEach(t=>e.add(t))}),Array.from(e)}async validateAvatarUrl(e){try{const t=await fetch(e,{method:'HEAD'}),a=t.headers.get('content-type');return t.ok&&!!a&&a.startsWith('image/')}catch{return!1}}async processAvatarFile(e){return new Promise((t,a)=>{if(!e.type.startsWith('image/'))return void a(new Error('请选择图片文件'));if(e.size>2097152)return void a(new Error('图片文件大小不能超过2MB'));const s=new FileReader;s.onload=e=>{const a=e.target?.result;t(a)},s.onerror=()=>{a(new Error('读取文件失败'))},s.readAsDataURL(e)})}getDefaultAvatar(e){return'https://files.catbox.moe/u8ccy5.jpg'}extractContactsFromChatData(e){const t=new Set;e.forEach(e=>{e.messages&&Array.isArray(e.messages)&&e.messages.forEach(e=>{e.sender&&'{{user}}'!==e.sender&&'user'!==e.sender&&t.add(e.sender)})}),t.forEach(t=>{if(!this.contacts.find(e=>e.name===t)){const a=this.getAvatarFromChatData(t,e);this.addContact({name:t,avatar:a||this.getDefaultAvatar(t),type:'character',isOnline:!0,tags:['聊天记录']})}})}getAvatarFromChatData(e,t){let a=null;return t.forEach(t=>{if(!a&&t.messages&&Array.isArray(t.messages)){const s=t.messages.find(t=>t.sender===e&&t.avatar);s&&s.avatar&&(a=this.processAvatarUrl(s.avatar))}}),a}processAvatarUrl(e){if(!e)return'';if(e.startsWith('http://')||e.startsWith('https://'))return e;const t=e.match(/([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);if(t){return`https://files.catbox.moe/${t[1]}`}return`https://files.catbox.moe/${e}`}validateContactName(e){return e&&0!==e.trim().length?e.trim().length>20?{valid:!1,error:'联系人名称不能超过20个字符'}:this.contacts.some(t=>t.name===e.trim())?{valid:!1,error:'该联系人名称已存在'}:{valid:!0}:{valid:!1,error:'请输入联系人名称'}}getCurrentCharacterId(){try{if(window.TavernHelper&&window.TavernHelper.getCharData){const e=window.TavernHelper.getCharData();if(e)return e.avatar||e.name||'default'}return'default'}catch(e){return console.error('[ContactManager] 获取角色ID失败:',e),'default'}}}class i{element=null;overlay=null;currentChatId=null;isVisible=!1;globalClickHandler=null;showTime=0;ignoreClickDuration=800;constructor(){this.bindOtherGlobalEvents()}show(e,t,a=!1){this.hide(),this.currentChatId=e,this.createMenuElements(a),this.positionMenu(t),this.showMenu(),this.showTime=Date.now(),this.bindGlobalClickEvent()}hide(){if(!this.isVisible)return;this.isVisible=!1,this.element&&(console.log('🎭 菜单隐藏动画开始：就地渐隐 scale(1) → scale(0.95)'),this.element.classList.remove('show'),this.element.classList.add('hiding'),setTimeout(()=>{this.overlay&&this.overlay.parentNode&&(this.overlay.parentNode.removeChild(this.overlay),console.log('🎭 菜单DOM元素已移除')),this.element=null,this.overlay=null},120));document.querySelectorAll('.chat-list-item.long-pressed').forEach(e=>{e.classList.remove('long-pressed')});const e=new CustomEvent('contextMenuHidden');document.dispatchEvent(e),this.currentChatId=null}isMenuVisible(){return this.isVisible}createMenuElements(e){this.overlay=document.createElement('div'),this.overlay.className='context-menu-overlay',this.element=document.createElement('div'),this.element.className='context-menu',this.element.dataset.chatId=this.currentChatId,this.element.innerHTML=`\n      <div class="menu-arrow"></div>\n      <div class="menu-content horizontal">\n        <button class="menu-item pin-item" data-action="${e?'unpin':'pin'}">\n          <span class="menu-text">${e?'取消置顶':'置顶'}</span>\n        </button>\n        <button class="menu-item delete-item" data-action="delete">\n          <span class="menu-text">删除</span>\n        </button>\n      </div>\n    `,this.bindMenuEvents(),this.overlay.appendChild(this.element),document.body.appendChild(this.overlay)}bindMenuEvents(){if(!this.element)return;this.element.querySelectorAll('.menu-item').forEach(e=>{e.addEventListener('click',t=>{t.stopPropagation();const a=e.dataset.action;this.handleMenuAction(a)})}),this.element.addEventListener('click',e=>{e.stopPropagation()})}bindGlobalClickEvent(){this.globalClickHandler&&document.removeEventListener('click',this.globalClickHandler),this.globalClickHandler=e=>{if(!this.isVisible)return;const t=Date.now()-this.showTime;if(t<this.ignoreClickDuration)return void console.log(`🔍 [ContextMenu] 菜单显示后${t}ms内，忽略点击事件`);const a=e.target;if(this.element&&this.element.contains(a))return;a.closest('.chat-list-item.long-pressed')||(console.log('🔍 [ContextMenu] 点击菜单外区域，隐藏菜单'),this.hide())},document.addEventListener('click',this.globalClickHandler,{capture:!0})}bindOtherGlobalEvents(){document.addEventListener('scroll',()=>{this.hide()},!0),window.addEventListener('resize',()=>{this.hide()}),document.addEventListener('keydown',e=>{'Escape'===e.key&&this.hide()})}positionMenu(e){if(!this.element)return;const t=document.querySelector(`[data-chat-id="${this.currentChatId}"]`);if(!t)return;const a=t.getBoundingClientRect();this.element.style.transition='none';const s=a.left+(a.width-90)/2+5,n=a.top-24-8;this.element.style.left=`${s}px`,this.element.style.top=`${n}px`,this.element.style.visibility='visible',this.element.offsetHeight,this.element.style.transition='all 0.12s ease-out',this.setArrowDirection('bottom')}calculateOptimalPosition(e,t,a){const s=12,n=[{x:e.x+20,y:e.y-t.height/2,placement:'right'},{x:e.x-t.width-20,y:e.y-t.height/2,placement:'left'},{x:e.x-t.width/2,y:e.y+20,placement:'bottom'},{x:e.x-t.width/2,y:e.y-t.height-20,placement:'top'}];for(const e of n)if(e.x>=s&&e.x+t.width<=a.width-s&&e.y>=s&&e.y+t.height<=a.height-s)return e;return{x:Math.max(s,Math.min(e.x+20,a.width-t.width-s)),y:Math.max(s,Math.min(e.y-t.height/2,a.height-t.height-s)),placement:'right'}}setArrowDirection(e){if(!this.element)return;const t=this.element.querySelector('.menu-arrow');t&&(t.className='menu-arrow',t.classList.add(`arrow-${e}`))}showMenu(){this.element&&this.overlay&&(this.isVisible=!0,this.element.classList.remove('hiding','show'),this.element.offsetHeight,requestAnimationFrame(()=>{this.element&&(this.element.classList.add('show'),console.log('🎭 菜单显示动画开始：就地渐显 scale(0.95) → scale(1)'))}))}handleMenuAction(e){if(!this.currentChatId)return;const t=new CustomEvent('contextMenuAction',{detail:{action:e,chatId:this.currentChatId}});document.dispatchEvent(t),this.hide()}}class l{config;activeElement=null;startTime=0;startPosition={x:0,y:0};longPressTimer=null;isLongPressing=!1;isMoving=!1;constructor(e={}){this.config={duration:400,moveThreshold:10,enableVibration:!0,...e}}init(){this.bindEvents()}destroy(){this.cleanup(),this.unbindEvents()}unbindEvents(){document.removeEventListener('mousedown',this.handleStart.bind(this)),document.removeEventListener('touchstart',this.handleStart.bind(this)),document.removeEventListener('mousemove',this.handleMove.bind(this)),document.removeEventListener('touchmove',this.handleMove.bind(this)),document.removeEventListener('mouseup',this.handleEnd.bind(this)),document.removeEventListener('touchend',this.handleEnd.bind(this)),document.removeEventListener('contextmenu',this.handleContextMenu.bind(this)),document.removeEventListener('contextMenuHidden',this.handleMenuHidden.bind(this))}bindEvents(){document.addEventListener('mousedown',this.handleStart.bind(this)),document.addEventListener('touchstart',this.handleStart.bind(this),{passive:!1}),document.addEventListener('mousemove',this.handleMove.bind(this)),document.addEventListener('touchmove',this.handleMove.bind(this),{passive:!1}),document.addEventListener('mouseup',this.handleEnd.bind(this)),document.addEventListener('touchend',this.handleEnd.bind(this)),document.addEventListener('contextmenu',this.handleContextMenu.bind(this)),document.addEventListener('contextMenuHidden',this.handleMenuHidden.bind(this))}handleStart(e){const t=e.target.closest('.chat-list-item');if(t&&t.dataset.chatId)if('mousedown'!==e.type||2!==e.button){if(this.activeElement&&this.cleanup(),this.activeElement=t,this.startTime=Date.now(),this.isLongPressing=!1,this.isMoving=!1,'touchstart'===e.type){const t=e.touches[0];this.startPosition={x:t.clientX,y:t.clientY}}else{const t=e;this.startPosition={x:t.clientX,y:t.clientY}}this.longPressTimer=setTimeout(()=>{this.activeElement&&!this.isMoving&&this.triggerLongPress()},this.config.duration),t.classList.add('long-press-detecting')}else e.preventDefault()}handleMove(e){if(!this.activeElement||this.isLongPressing)return;let t,a;if('touchmove'===e.type){const s=e.touches[0];t=s.clientX,a=s.clientY}else{const s=e;t=s.clientX,a=s.clientY}const s=Math.abs(t-this.startPosition.x),n=Math.abs(a-this.startPosition.y);Math.sqrt(s*s+n*n)>this.config.moveThreshold&&(this.isMoving=!0,this.cancelLongPress())}handleEnd(e){if(!this.activeElement)return;Date.now()-this.startTime<this.config.duration&&!this.isMoving&&!this.isLongPressing?(this.triggerClick(),this.cleanup()):this.isLongPressing?(this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.activeElement&&this.activeElement.classList.remove('long-press-detecting'),this.isMoving=!1):this.cleanup()}handleContextMenu(e){e.target.closest('.chat-list-item')&&e.preventDefault()}triggerLongPress(){if(!this.activeElement)return;this.isLongPressing=!0;const e=this.activeElement.dataset.chatId,t=this.activeElement.getBoundingClientRect(),a={x:t.left+t.width/2,y:t.top+t.height/2};this.activeElement.classList.add('long-pressed'),this.activeElement.classList.remove('long-press-detecting'),this.config.enableVibration&&'vibrate'in navigator&&navigator.vibrate(50);const s=new CustomEvent('chatItemLongPress',{detail:{chatId:e,element:this.activeElement,position:a}});document.dispatchEvent(s)}triggerClick(){if(!this.activeElement)return;const e=this.activeElement.dataset.chatId,t=new CustomEvent('chatListItemClick',{detail:{chatId:e}});document.dispatchEvent(t)}cancelLongPress(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.activeElement&&this.activeElement.classList.remove('long-press-detecting')}cleanup(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.activeElement&&(this.activeElement.classList.remove('long-press-detecting','long-pressed'),this.activeElement=null),this.isLongPressing=!1,this.isMoving=!1}handleMenuHidden(){this.cleanup()}resetState(){document.querySelectorAll('.chat-list-item.long-pressed').forEach(e=>{e.classList.remove('long-pressed')}),this.cleanup()}}class c{static STORAGE_KEY='bear_pinned_chats';pinnedChats=new Map;constructor(){this.loadPinnedChats()}pin(e){const t={chatId:e,pinnedAt:Date.now()};this.pinnedChats.set(e,t),this.savePinnedChats(),console.log(`📌 置顶聊天: ${e}`)}unpin(e){this.pinnedChats.has(e)&&(this.pinnedChats.delete(e),this.savePinnedChats(),console.log(`📌 取消置顶聊天: ${e}`))}isPinned(e){return this.pinnedChats.has(e)}getPinnedChatIds(){const e=Array.from(this.pinnedChats.values());return e.sort((e,t)=>t.pinnedAt-e.pinnedAt),e.map(e=>e.chatId)}getPinnedCount(){return this.pinnedChats.size}cleanup(e){const t=new Set(e);let a=!1;for(const e of this.pinnedChats.keys())t.has(e)||(this.pinnedChats.delete(e),a=!0,console.log(`🧹 清理不存在的置顶聊天: ${e}`));a&&this.savePinnedChats()}getPinnedChatData(e){return this.pinnedChats.get(e)||null}setPinnedChats(e){this.pinnedChats.clear();const t=Date.now();e.forEach((e,a)=>{this.pinnedChats.set(e,{chatId:e,pinnedAt:t-1e3*a})}),this.savePinnedChats()}loadPinnedChats(){try{const e=localStorage.getItem(c.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(Array.isArray(t)){const e=Date.now();return t.forEach((t,a)=>{this.pinnedChats.set(t,{chatId:t,pinnedAt:e-1e3*a})}),void this.savePinnedChats()}Array.isArray(t)&&t.forEach(e=>{e.chatId&&'number'==typeof e.pinnedAt&&this.pinnedChats.set(e.chatId,e)})}catch(e){console.error('加载置顶聊天数据失败:',e),localStorage.removeItem(c.STORAGE_KEY)}}savePinnedChats(){try{const e=Array.from(this.pinnedChats.values());localStorage.setItem(c.STORAGE_KEY,JSON.stringify(e))}catch(e){console.error('保存置顶聊天数据失败:',e)}}exportData(){return Array.from(this.pinnedChats.values())}importData(e){this.pinnedChats.clear(),e.forEach(e=>{e.chatId&&'number'==typeof e.pinnedAt&&this.pinnedChats.set(e.chatId,e)}),this.savePinnedChats()}getStats(){const e=Array.from(this.pinnedChats.values());return 0===e.length?{totalPinned:0,oldestPinned:null,newestPinned:null}:(e.sort((e,t)=>e.pinnedAt-t.pinnedAt),{totalPinned:e.length,oldestPinned:e[0],newestPinned:e[e.length-1]})}}class h{STORAGE_KEY='unread_messages_data';unreadData=new Map;messageParser;constructor(e){this.messageParser=e,this.loadFromStorage()}setMessageParser(e){this.messageParser=e}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.unreadData=new Map(Object.entries(t).map(([e,t])=>[e,{chatId:e,lastViewedMessageFingerprints:new Set(t.lastViewedMessageFingerprints||[]),unreadCount:t.unreadCount||0}]))}}catch(e){console.warn('加载未读消息数据失败:',e),this.unreadData=new Map}}saveToStorage(){try{const e={};for(const[t,a]of this.unreadData)e[t]={chatId:t,lastViewedMessageFingerprints:Array.from(a.lastViewedMessageFingerprints),unreadCount:a.unreadCount};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn('保存未读消息数据失败:',e)}}generateMessageFingerprint(e){return`${e.chatId}_${e.sender}_${e.content}_${e.timestamp}`}calculateUnreadCount(e,t){try{if(!t)return this.getUnreadCount(e);const a=t.get(e);if(!a||!a.messages)return 0;const s=this.unreadData.get(e),n=s?.lastViewedMessageFingerprints||new Set;let r=0;for(const e of a.messages){if('{{user}}'===e.sender||'user'===e.sender)continue;const t=this.generateMessageFingerprint(e);n.has(t)||r++}return s?s.unreadCount=r:this.unreadData.set(e,{chatId:e,lastViewedMessageFingerprints:new Set,unreadCount:r}),r}catch(t){return console.warn(`计算未读消息数量失败 (${e}):`,t),0}}markAsRead(e,t){try{if(!t){const t=this.unreadData.get(e);return void(t&&(t.unreadCount=0,this.saveToStorage(),this.dispatchUnreadUpdateEvent(e,0)))}const a=t.get(e);if(!a||!a.messages)return;const s=new Set;for(const e of a.messages){const t=this.generateMessageFingerprint(e);s.add(t)}this.unreadData.set(e,{chatId:e,lastViewedMessageFingerprints:s,unreadCount:0}),this.saveToStorage(),this.dispatchUnreadUpdateEvent(e,0)}catch(t){console.warn(`标记聊天为已读失败 (${e}):`,t)}}getUnreadCount(e){const t=this.unreadData.get(e);return t?.unreadCount||0}getAllUnreadCounts(){const e=new Map;for(const[t,a]of this.unreadData)e.set(t,a.unreadCount);return e}refreshUnreadCounts(e,t){const a=t||Array.from(e.keys());for(const t of a){const a=this.calculateUnreadCount(t,e);this.dispatchUnreadUpdateEvent(t,a)}this.saveToStorage()}onNewMessage(e,t){if(!t)return;const a=this.calculateUnreadCount(e,t);this.dispatchUnreadUpdateEvent(e,a),this.saveToStorage()}onNewMessages(e,t,a){if(!e.length||!t)return;const s=new Map;for(const t of e)if(t.chatId&&'{{user}}'!==t.sender&&'user'!==t.sender){if(a&&t.chatId===a){console.log(`📖 用户正在聊天 ${a} 中，新消息不计入未读`);continue}const e=s.get(t.chatId)||0;s.set(t.chatId,e+1)}for(const[e,t]of s){const a=this.getUnreadCount(e)+t,s=this.unreadData.get(e);s?s.unreadCount=a:this.unreadData.set(e,{chatId:e,lastViewedMessageFingerprints:new Set,unreadCount:a}),console.log(`📊 聊天 ${e} 新增 ${t} 条未读消息，总计 ${a} 条`),this.dispatchUnreadUpdateEvent(e,a)}this.saveToStorage()}dispatchUnreadUpdateEvent(e,t){const a=new CustomEvent('unreadCountUpdated',{detail:{chatId:e,unreadCount:t}});document.dispatchEvent(a)}clearUnreadData(e){this.unreadData.delete(e),this.saveToStorage(),this.dispatchUnreadUpdateEvent(e,0)}clearAllUnreadData(){this.unreadData.clear(),this.saveToStorage();const e=new CustomEvent('allUnreadCountsCleared');document.dispatchEvent(e)}getTotalUnreadCount(){let e=0;for(const t of this.unreadData.values())e+=t.unreadCount;return e}destroy(){this.saveToStorage(),this.unreadData.clear()}}var d=a(790);class g{soundManager;contactManager;groupChatManager=null;config;newChatModalData;statusTimeInterval=null;currentChatDataMap=void 0;longPressHandler;contextMenu;pinManager;wallpaperManager;unreadMessageManager;constructor(e,t,a){this.soundManager=e,this.contactManager=new o,t?this.groupChatManager=t:console.warn('⚠️ ChatListManager: 未传入GroupChatManager实例，群聊功能可能不可用'),this.longPressHandler=new l,this.contextMenu=new i,this.pinManager=new c,this.wallpaperManager=d.WallpaperManager.getInstance(),this.unreadMessageManager=new h(a),this.config={maxRecentChats:50,showUnreadBadge:!0,enableGroupChat:!0,defaultAvatars:['https://files.catbox.moe/u8ccy5.jpg','https://files.catbox.moe/j2s4qj.jpg','https://files.catbox.moe/seoipi.jpg','https://files.catbox.moe/dq08mr.jpg','https://files.catbox.moe/yc3gv4.jpeg','https://files.catbox.moe/y4vvp0.jpg']},this.newChatModalData={type:'single',selectedContacts:new Set},this.setupEventListeners()}showChatListInterface(e){e&&(this.currentChatDataMap=e);let t=document.getElementById('chatListInterface');if(t)this.setupExistingContainer(t);else{t=this.createChatListContainer();const e=document.querySelector('.interface-container');e&&e.appendChild(t)}t.classList.add('active'),t.style.display='block',this.wallpaperManager.applyWallpaper(),e&&(this.contactManager.extractContactsFromChatData(e),this.renderChatList(e)),this.startStatusTimeUpdate(),this.initializeLongPressHandler()}hideChatListInterface(){const e=document.getElementById('chatListInterface');e&&(e.classList.remove('active'),e.style.display='none'),this.stopStatusTimeUpdate(),this.destroyLongPressHandler(),this.contextMenu.hide()}refreshChatList(e){const t=e||this.currentChatDataMap;this.renderChatList(t)}async reloadContacts(){console.log('🔄 ChatListManager: 重新加载联系人数据'),await this.contactManager.reloadContacts();const e=document.getElementById('chatListInterface');e&&e.classList.contains('active')&&this.refreshChatList()}setupEventListeners(){document.addEventListener('chatListChanged',e=>{console.log('📱 收到聊天列表变化事件:',e.detail),this.refreshChatList(this.currentChatDataMap)}),document.addEventListener('chatItemLongPress',e=>{this.handleLongPress(e.detail)}),document.addEventListener('contextMenuAction',e=>{this.handleContextMenuAction(e.detail)}),document.addEventListener('chatListItemClick',e=>{this.onChatItemClick(e.detail.chatId)}),document.addEventListener('unreadCountUpdated',e=>{this.onUnreadCountUpdated(e.detail.chatId,e.detail.unreadCount)}),document.addEventListener('allUnreadCountsCleared',()=>{this.refreshChatList(this.currentChatDataMap)})}setupExistingContainer(e){e.querySelector('#newChatBtn')||(e.innerHTML=`\n        <div class="status-bar">\n          <div class="status-bar-left">\n            <span id="chatListStatusTime">${this.getCurrentTime()}</span>\n          </div>\n          <div class="status-bar-right">\n            <svg class="status-icon-svg" viewBox="0 0 24 24">\n              <path d="M20,20h2v-2h-2V20z M18,20h-2v-4h2V20z M14,20h-2v-6h2V20z M10,20H8v-8h2V20z M6,20H4v-10h2V20z"></path>\n            </svg>\n            <svg class="status-icon-svg" viewBox="0 0 24 24">\n              <path d="M12,3C7.41,3,3.86,4.53,0.96,7.03L2.37,8.44C4.89,6.31,8.06,5,12,5s7.11,1.31,9.63,3.44l1.41-1.41C20.14,4.53,16.59,3,12,3z M12,7C9.3,7,6.81,7.89,4.8,9.4l1.4,1.4C7.6,9.67,9.69,9,12,9s4.4,0.67,5.8,1.8l1.4-1.4C17.19,7.89,14.7,7,12,7z M12,11c-1.94,0-3.5,0.5-4.7,1.3l1.4,1.4c0.8-0.5,2-0.7,3.3-0.7s2.5,0.2,3.3,0.7l1.4-1.4C15.5,11.5,13.94,11,12,11z M12,15c-0.85,0-1.5,0.15-2,0.4l2,2l2-2C13.5,15.15,12.85,15,12,15z"></path>\n            </svg>\n            <svg class="status-icon-svg" viewBox="0 0 24 24">\n              <path d="M15.67,4H14V2h-4v2H8.33C7.6,4,7,4.6,7,5.33v15.33C7,21.4,7.6,22,8.33,22h7.33c0.74,0,1.33-0.6,1.33-1.33V5.33C17,4.6,16.4,4,15.67,4z M15,20H9V6h6V20z"></path>\n            </svg>\n          </div>\n        </div>\n        <div class="chat-list-content" id="chatListContent">\n          \x3c!-- 聊天列表项将在这里动态生成 --\x3e\n        </div>\n        <button class="new-chat-btn" id="newChatBtn">\n          <svg viewBox="0 0 24 24">\n            <path fill="currentColor" d="M19,13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/>\n          </svg>\n        </button>\n        <div class="bottom-nav">\n          <div class="bottom-nav-item active" data-nav="messages">\n            <div class="nav-icon"></div>\n            <div class="bottom-nav-text">消息</div>\n          </div>\n          <div class="bottom-nav-item" data-nav="profile">\n            <div class="nav-icon"></div>\n            <div class="bottom-nav-text">我的</div>\n          </div>\n        </div>\n      `,this.bindChatListEvents(e))}createChatListContainer(){const e=document.createElement('div');return e.id='chatListInterface',e.className='chat-list-interface',e.innerHTML=`\n      <div class="status-bar">\n        <div class="status-bar-left">\n          <span id="chatListStatusTime">${this.getCurrentTime()}</span>\n        </div>\n        <div class="status-bar-right">\n          <svg class="status-icon-svg" viewBox="0 0 24 24">\n            <path d="M20,20h2v-2h-2V20z M18,20h-2v-4h2V20z M14,20h-2v-6h2V20z M10,20H8v-8h2V20z M6,20H4v-10h2V20z"></path>\n          </svg>\n          <svg class="status-icon-svg" viewBox="0 0 24 24">\n            <path d="M12,3C7.41,3,3.86,4.53,0.96,7.03L2.37,8.44C4.89,6.31,8.06,5,12,5s7.11,1.31,9.63,3.44l1.41-1.41C20.14,4.53,16.59,3,12,3z M12,7C9.3,7,6.81,7.89,4.8,9.4l1.4,1.4C7.6,9.67,9.69,9,12,9s4.4,0.67,5.8,1.8l1.4-1.4C17.19,7.89,14.7,7,12,7z M12,11c-1.94,0-3.5,0.5-4.7,1.3l1.4,1.4c0.8-0.5,2-0.7,3.3-0.7s2.5,0.2,3.3,0.7l1.4-1.4C15.5,11.5,13.94,11,12,11z M12,15c-0.85,0-1.5,0.15-2,0.4l2,2l2-2C13.5,15.15,12.85,15,12,15z"></path>\n          </svg>\n          <svg class="status-icon-svg" viewBox="0 0 24 24">\n            <path d="M15.67,4H14V2h-4v2H8.33C7.6,4,7,4.6,7,5.33v15.33C7,21.4,7.6,22,8.33,22h7.33c0.74,0,1.33-0.6,1.33-1.33V5.33C17,4.6,16.4,4,15.67,4z M15,20H9V6h6V20z"></path>\n          </svg>\n        </div>\n      </div>\n      <div class="chat-list-content" id="chatListContent">\n        \x3c!-- 聊天列表项将在这里动态生成 --\x3e\n      </div>\n      <button class="new-chat-btn" id="newChatBtn">\n        <svg viewBox="0 0 24 24">\n          <path fill="currentColor" d="M19,13h-6v6h-2v-6H5v-2h6V5h2v6h6V13z"/>\n        </svg>\n      </button>\n      <div class="bottom-nav">\n        <div class="bottom-nav-item active" data-nav="messages">\n          <div class="nav-icon"></div>\n          <div class="bottom-nav-text">消息</div>\n        </div>\n        <div class="bottom-nav-item" data-nav="profile">\n          <div class="nav-icon"></div>\n          <div class="bottom-nav-text">我的</div>\n        </div>\n      </div>\n    `,this.bindChatListEvents(e),e}bindChatListEvents(e){const t=e.querySelector('#newChatBtn');t&&t.addEventListener('click',()=>{this.soundManager.playSound('click'),this.showNewChatModal()});const a=e.querySelectorAll('.bottom-nav-item');a.forEach(e=>{e.addEventListener('click',()=>{this.soundManager.playSound('click'),a.forEach(e=>{e.classList.remove('active')}),e.classList.add('active');const t=e.getAttribute('data-nav');this.handleBottomNavClick(t)})})}handleBottomNavClick(e){switch(e){case'messages':console.log('📱 切换到消息界面');break;case'profile':console.log('👤 切换到个人主页'),this.showProfilePage();break;default:console.warn('未知的导航类型:',e)}}showProfilePage(){const e=new CustomEvent('showProfilePage',{detail:{source:'bottomNav'}});document.dispatchEvent(e)}renderChatList(e){const t=document.getElementById('chatListContent');if(!t)return;t.innerHTML='';const a=this.generateChatListItems(e);0!==a.length?a.forEach(e=>{const a=this.renderChatListItem(e);t.appendChild(a)}):t.innerHTML='\n        <div class="empty-chat-list">\n          <div class="empty-icon">💬</div>\n          <div class="empty-text">暂无聊天记录</div>\n          <div class="empty-hint">点击右下角 + 开始新的聊天</div>\n        </div>\n      '}generateChatListItems(e){const t=[];return console.log('🔍 [DEBUG] 生成聊天列表，不使用localStorage中的群聊数据'),e?(e.forEach((a,s)=>{const n='group'===a.type;if(!(a.messages&&a.messages.some(e=>!(!e.type||'S'!==e.type&&'G'!==e.type)||!(!e.content||!e.content.includes('[群聊')))||n||a.chatId&&a.chatName))return;const r=this.getLastMessage(a.messages||[]),o=r?this.formatAbsoluteTime(r.timestamp):'',i=this.extractDisplayName(a.chatName);let l=a.avatar||this.getDefaultAvatar(a.chatName);if(!n&&i){const e=this.contactManager.getAllContacts().find(e=>e.name===i);e&&e.avatar&&(l=e.avatar)}const c=this.unreadMessageManager.calculateUnreadCount(s,e);t.push({chatId:s,name:i,avatar:l,lastMessage:r?this.formatMessagePreview(r):'暂无消息',lastTime:o,unreadCount:c,type:n?'G':'S'})}),t.sort((t,a)=>{const s=this.pinManager.isPinned(t.chatId),n=this.pinManager.isPinned(a.chatId);if(s&&!n)return-1;if(!s&&n)return 1;if(s&&n){const e=this.pinManager.getPinnedChatData(t.chatId),s=this.pinManager.getPinnedChatData(a.chatId);if(e&&s)return s.pinnedAt-e.pinnedAt}const r=this.getLastMessageTimestamp(t.chatId,e);return this.getLastMessageTimestamp(a.chatId,e)-r}),t.slice(0,this.config.maxRecentChats)):t}renderChatListItem(e){const t=document.createElement('div'),a=this.pinManager.isPinned(e.chatId);return t.className='chat-list-item'+(a?' pinned':''),t.dataset.chatId=e.chatId,t.dataset.type=e.type,t.innerHTML=`\n      <img src="${e.avatar}" class="chat-avatar" alt="${e.name}" onerror="this.src='${this.getDefaultAvatar(e.name)}'">\n      <div class="chat-info">\n        <div class="chat-list-header">\n          <span class="chat-name">${e.name}</span>\n          <div class="chat-time-container">\n            <span class="chat-time">${e.lastTime}</span>\n            ${e.unreadCount>0?`<div class="unread-badge show">${this.formatUnreadCount(e.unreadCount)}</div>`:''}\n          </div>\n        </div>\n        <div class="chat-preview">${e.lastMessage}</div>\n      </div>\n    `,t}onChatItemClick(e){console.log(`🖱️ 聊天列表项被点击: ${e}`),this.unreadMessageManager.markAsRead(e,this.currentChatDataMap);const t=new CustomEvent('chatSwitchRequest',{detail:{chatId:e}});document.dispatchEvent(t)}showNewChatModal(){this.newChatModalData={type:'single',selectedContacts:new Set};const e=this.createNewChatModal(),t=document.querySelector('.interface-container');t?t.appendChild(e):document.body.appendChild(e),setTimeout(()=>{e.classList.add('show')},10)}createNewChatModal(){const e=document.createElement('div');e.className='modal-overlay new-chat-modal',e.id='newChatModal';const t=this.contactManager.getAllContacts(),a=t.map(e=>`\n      <div class="contact-item" data-contact-id="${e.id}">\n        <img src="${e.avatar}" class="contact-avatar" alt="${e.name}">\n        <span class="contact-name">${e.name}</span>\n        <div class="contact-actions">\n          <button class="edit-btn" data-action="edit" data-contact-id="${e.id}" title="编辑联系人">\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />\n            </svg>\n          </button>\n          <button class="delete-btn" data-action="delete" data-contact-id="${e.id}" title="删除联系人">\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />\n            </svg>\n          </button>\n        </div>\n        <div class="checkbox"></div>\n      </div>\n    `).join(''),s=0===t.length?'\n      <div class="empty-contacts-hint">\n        <div class="empty-hint">点击上方"添加朋友"开始添加</div>\n      </div>\n    ':'';return e.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">新建聊天</div>\n        <div class="chat-type-options">\n          <div class="chat-type-option selected" data-type="single">单人聊天</div>\n          <div class="chat-type-option" data-type="group">群聊</div>\n        </div>\n        <div class="contact-list">\n          \n      <div class="contact-item add-friend-item" data-action="add-friend">\n        <div class="add-friend-icon">+</div>\n        <span class="contact-name">添加朋友</span>\n      </div>\n    \n          ${a}\n          ${s}\n        </div>\n        <div class="modal-buttons">\n          <button class="modal-btn cancel-btn">取消</button>\n          <button class="modal-btn confirm-btn">确认</button>\n        </div>\n      </div>\n    `,this.bindNewChatModalEvents(e),e}bindNewChatModalEvents(e){const t=e.querySelectorAll('.chat-type-option');t.forEach(a=>{a.addEventListener('click',()=>{t.forEach(e=>e.classList.remove('selected')),a.classList.add('selected'),this.newChatModalData.type=a.getAttribute('data-type'),'group'===this.newChatModalData.type?e.classList.add('group-mode'):(e.classList.remove('group-mode'),this.newChatModalData.selectedContacts.clear(),e.querySelectorAll('.contact-item').forEach(e=>{e.classList.remove('selected')})),this.soundManager.playSound('click')})});const a=e.querySelectorAll('.contact-item');a.forEach(e=>{e.addEventListener('click',t=>{const s=t.target,n=e.getAttribute('data-action'),r=e.getAttribute('data-contact-id'),o=s.closest('.edit-btn'),i=s.closest('.delete-btn');if(o){t.stopPropagation();const e=o.getAttribute('data-contact-id');return void(e&&(this.soundManager.playSound('click'),this.handleEditContact(e)))}if(i){t.stopPropagation();const e=i.getAttribute('data-contact-id');return void(e&&(this.soundManager.playSound('click'),this.handleDeleteContact(e)))}if('add-friend'===n)return this.soundManager.playSound('click'),this.hideNewChatModal(),void this.showAddFriendModal();r&&('single'===this.newChatModalData.type?(a.forEach(e=>e.classList.remove('selected')),e.classList.add('selected'),this.newChatModalData.selectedContacts.clear(),this.newChatModalData.selectedContacts.add(r)):(e.classList.toggle('selected'),e.classList.contains('selected')?this.newChatModalData.selectedContacts.add(r):this.newChatModalData.selectedContacts.delete(r)),this.soundManager.playSound('click'))})});const s=e.querySelector('.cancel-btn');s&&s.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideNewChatModal()});const n=e.querySelector('.confirm-btn');n&&n.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleCreateNewChat()}),e.addEventListener('click',t=>{t.target===e&&this.hideNewChatModal()})}hideNewChatModal(){const e=document.getElementById('newChatModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}showAddFriendModal(){const e=this.createAddFriendModal(),t=document.querySelector('.interface-container');t?t.appendChild(e):document.body.appendChild(e),setTimeout(()=>{e.classList.add('show')},10)}createAddFriendModal(){const e=document.createElement('div');return e.className='modal-overlay add-friend-modal',e.id='addFriendModal',e.innerHTML='\n      <div class="modal-container">\n        <div class="modal-title">添加朋友</div>\n        <form class="add-friend-form">\n          <div class="form-group">\n            <label for="friendName">角色名称</label>\n            <input type="text" id="friendName" placeholder="请输入角色真名" maxlength="20" required>\n            <div class="error-message" id="nameError"></div>\n          </div>\n          \n          <div class="form-group">\n            <label>头像设置</label>\n            <div class="avatar-options">\n              <div class="avatar-option" data-type="url">\n                <input type="radio" name="avatarType" value="url" id="avatarUrl" checked>\n                <label for="avatarUrl">图片链接</label>\n              </div>\n              <div class="avatar-option" data-type="upload">\n                <input type="radio" name="avatarType" value="upload" id="avatarUpload">\n                <label for="avatarUpload">本地上传</label>\n              </div>\n            </div>\n          </div>\n\n          <div class="form-group" id="urlGroup">\n            <input type="url" id="avatarUrlInput" placeholder="请输入图片URL">\n            <div class="error-message" id="urlError"></div>\n          </div>\n\n          <div class="form-group" id="uploadGroup" style="display: none;">\n            <button type="button" class="file-upload-btn" id="fileUploadBtn">\n              <svg viewBox="0 0 24 24" width="16" height="16">\n                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n              </svg>\n              选择本地文件\n            </button>\n            <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">\n            <div class="error-message" id="fileError"></div>\n          </div>\n\n          <div class="avatar-preview">\n            <img id="avatarPreview" src="" alt="头像预览" style="display: none;">\n          </div>\n        </form>\n        \n        <div class="modal-buttons">\n          <button type="button" class="modal-btn cancel-btn">取消</button>\n          <button type="button" class="modal-btn confirm-btn">添加</button>\n        </div>\n      </div>\n    ',this.bindAddFriendModalEvents(e),e}bindAddFriendModalEvents(e){const t=e.querySelector('#friendName'),a=e.querySelector('#avatarUrl'),s=e.querySelector('#avatarUpload'),n=e.querySelector('#avatarUrlInput'),r=e.querySelector('#avatarFileInput'),o=e.querySelector('#fileUploadBtn'),i=e.querySelector('#urlGroup'),l=e.querySelector('#uploadGroup'),c=e.querySelector('#avatarPreview'),h=e.querySelector('.cancel-btn'),d=e.querySelector('.confirm-btn');a.addEventListener('change',()=>{a.checked&&(i.style.display='block',l.style.display='none')}),s.addEventListener('change',()=>{s.checked&&(i.style.display='none',l.style.display='block')}),n.addEventListener('blur',async()=>{const e=n.value.trim();if(e){await this.contactManager.validateAvatarUrl(e)?(c.src=e,c.style.display='block',this.clearError('urlError')):(this.showError('urlError','无效的图片URL'),c.style.display='none')}}),o.addEventListener('click',()=>{r.click()}),r.addEventListener('change',async e=>{const t=e.target.files?.[0];if(t)try{const e=await this.contactManager.processAvatarFile(t);c.src=e,c.style.display='block',this.clearError('fileError'),o.innerHTML=`\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n            </svg>\n            ${t.name.length>15?t.name.substring(0,15)+'...':t.name}\n          `}catch(e){this.showError('fileError',e.message),c.style.display='none'}}),t.addEventListener('blur',()=>{const e=this.contactManager.validateContactName(t.value);e.valid?this.clearError('nameError'):this.showError('nameError',e.error)}),h.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideAddFriendModal()}),d.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleAddFriend(e)}),e.addEventListener('click',t=>{t.target===e&&this.hideAddFriendModal()})}hideAddFriendModal(){const e=document.getElementById('addFriendModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}async handleAddFriend(e){const t=e.querySelector('#friendName'),a=e.querySelector('#avatarUrl'),s=e.querySelector('#avatarUrlInput'),n=e.querySelector('#avatarFileInput'),r=(e.querySelector('#avatarPreview'),this.contactManager.validateContactName(t.value));if(!r.valid)return void this.showError('nameError',r.error);let o='';if(a.checked){const e=s.value.trim();if(e){if(!await this.contactManager.validateAvatarUrl(e))return void this.showError('urlError','无效的图片URL');o=e}}else{const e=n.files?.[0];if(e)try{o=await this.contactManager.processAvatarFile(e)}catch(e){return void this.showError('fileError',e.message)}}o||(o=this.contactManager.getDefaultAvatar(t.value.trim()));try{const e=this.contactManager.addContact({name:t.value.trim(),avatar:o,type:'character',isOnline:!0,tags:['朋友']});this.showToast(`成功添加朋友：${e.name}`,'info'),this.hideAddFriendModal(),setTimeout(()=>{this.showNewChatModal()},300)}catch(e){this.showToast('添加朋友失败','error')}}showError(e,t){const a=document.getElementById(e);a&&(a.textContent=t,a.style.display='block')}clearError(e){const t=document.getElementById(e);t&&(t.textContent='',t.style.display='none')}handleCreateNewChat(){if(0===this.newChatModalData.selectedContacts.size)return void this.showToast('请选择联系人','warning');const e=Array.from(this.newChatModalData.selectedContacts);if('group'===this.newChatModalData.type){if(e.length<2)return void this.showToast('群聊至少需要选择2个联系人','warning');this.hideNewChatModal(),this.groupChatManager.createGroupChat(e)}else{const t=new CustomEvent('createNewChat',{detail:{type:this.newChatModalData.type,contactIds:e}});document.dispatchEvent(t),this.hideNewChatModal()}}getGroupChatData(){return console.log('🔍 [DEBUG] getGroupChatData - 不再从localStorage读取群聊数据'),[]}getLastMessage(e){return e.length>0?e[e.length-1]:null}extractDisplayName(e){const t=e.match(/^和(.+)的聊天$/);if(t)return t[1];const a=e.match(/^(.+)的群聊$/);return a?a[1]:e}formatMessagePreview(e){let t='';switch(e.messageType){case'text':default:t=e.content;break;case'image':t='[图片]';break;case'voice':t='[语音]';break;case'sticker':t='[表情包]';break;case'location':t='[位置]';break;case'transfer':t='[转账]'}if('G'===e.type){t=`${'{{user}}'===e.sender?'我':e.senderDisplayName||e.sender}: ${t}`}return t.length>30?t.substring(0,30)+'...':t}formatAbsoluteTime(e){const t=new Date,a=new Date;if(!e.includes(':'))return e;{const[t,s]=e.split(':');a.setHours(parseInt(t),parseInt(s),0,0)}const s=t.getTime()-a.getTime(),n=Math.floor(s/864e5);return n<0||0===n?e:1===n?'昨天':n<7?`${n}天前`:a.toLocaleDateString('zh-CN',{month:'short',day:'numeric'})}getLastMessageTimestamp(e,t){const a=t.get(e);if(!a||0===a.messages.length)return 0;const s=a.messages[a.messages.length-1];new Date;if(s.timestamp.includes(':')){const[e,t]=s.timestamp.split(':'),a=new Date;return a.setHours(parseInt(e),parseInt(t),0,0),a.getTime()}return 0}getDefaultAvatar(e){return'https://files.catbox.moe/u8ccy5.jpg'}getCurrentTime(){return(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}showToast(e,t='info'){'undefined'!=typeof toastr?toastr[t](e):console.log(`[${t.toUpperCase()}] ${e}`)}startStatusTimeUpdate(){this.updateStatusTime(),this.statusTimeInterval=setInterval(()=>{this.updateStatusTime()},1e3)}stopStatusTimeUpdate(){this.statusTimeInterval&&(clearInterval(this.statusTimeInterval),this.statusTimeInterval=null)}updateStatusTime(){const e=document.getElementById('chatListStatusTime');if(e){const t=(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});e.textContent=t}}getContactManager(){return this.contactManager}handleEditContact(e){const t=this.contactManager.getContactById(e);t&&(this.hideNewChatModal(),this.showEditContactModal(t))}handleDeleteContact(e){const t=this.contactManager.getContactById(e);t&&(this.hideNewChatModal(),this.showDeleteConfirmModal(t))}showEditContactModal(e){const t=this.createEditContactModal(e),a=document.querySelector('.interface-container');a?a.appendChild(t):document.body.appendChild(t),setTimeout(()=>{t.classList.add('show')},10)}createEditContactModal(e){const t=document.createElement('div');return t.className='modal-overlay edit-contact-modal',t.id='editContactModal',t.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">编辑联系人</div>\n        <form class="edit-contact-form">\n          <div class="form-group">\n            <label for="editContactName">角色名称</label>\n            <input type="text" id="editContactName" value="${e.name}" placeholder="请输入角色真名" maxlength="20" required>\n            <div class="error-message" id="editNameError"></div>\n          </div>\n          \n          <div class="form-group">\n            <label>头像设置</label>\n            <div class="avatar-options">\n              <div class="avatar-option" data-type="url">\n                <input type="radio" name="editAvatarType" value="url" id="editAvatarUrl" ${e.avatar.startsWith('http')?'checked':''}>\n                <label for="editAvatarUrl">图片链接</label>\n              </div>\n              <div class="avatar-option" data-type="upload">\n                <input type="radio" name="editAvatarType" value="upload" id="editAvatarUpload" ${e.avatar.startsWith('data:')?'checked':''}>\n                <label for="editAvatarUpload">本地上传</label>\n              </div>\n            </div>\n          </div>\n\n          <div class="form-group" id="editUrlGroup" ${e.avatar.startsWith('data:')?'style="display: none;"':''}>\n            <input type="url" id="editAvatarUrlInput" value="${e.avatar.startsWith('http')?e.avatar:''}" placeholder="请输入图片URL">\n            <div class="error-message" id="editUrlError"></div>\n          </div>\n\n          <div class="form-group" id="editUploadGroup" ${e.avatar.startsWith('http')?'style="display: none;"':''}>\n            <button type="button" class="file-upload-btn" id="editFileUploadBtn">\n              <svg viewBox="0 0 24 24" width="16" height="16">\n                <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n              </svg>\n              选择本地文件\n            </button>\n            <input type="file" id="editAvatarFileInput" accept="image/*" style="display: none;">\n            <div class="error-message" id="editFileError"></div>\n          </div>\n\n          <div class="avatar-preview">\n            <img id="editAvatarPreview" src="${e.avatar}" alt="头像预览">\n          </div>\n        </form>\n        \n        <div class="modal-buttons">\n          <button type="button" class="modal-btn cancel-btn">取消</button>\n          <button type="button" class="modal-btn confirm-btn">保存</button>\n        </div>\n      </div>\n    `,this.bindEditContactModalEvents(t,e),t}bindEditContactModalEvents(e,t){const a=e.querySelector('#editContactName'),s=e.querySelector('#editAvatarUrl'),n=e.querySelector('#editAvatarUpload'),r=e.querySelector('#editAvatarUrlInput'),o=e.querySelector('#editAvatarFileInput'),i=e.querySelector('#editFileUploadBtn'),l=e.querySelector('#editUrlGroup'),c=e.querySelector('#editUploadGroup'),h=e.querySelector('#editAvatarPreview'),d=e.querySelector('.cancel-btn'),g=e.querySelector('.confirm-btn');s.addEventListener('change',()=>{s.checked&&(l.style.display='block',c.style.display='none')}),n.addEventListener('change',()=>{n.checked&&(l.style.display='none',c.style.display='block')}),r.addEventListener('blur',async()=>{const e=r.value.trim();if(e){await this.contactManager.validateAvatarUrl(e)?(h.src=e,this.clearError('editUrlError')):this.showError('editUrlError','无效的图片URL')}}),i.addEventListener('click',()=>{o.click()}),o.addEventListener('change',async e=>{const t=e.target.files?.[0];if(t)try{const e=await this.contactManager.processAvatarFile(t);h.src=e,this.clearError('editFileError'),i.innerHTML=`\n            <svg viewBox="0 0 24 24" width="16" height="16">\n              <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />\n            </svg>\n            ${t.name.length>15?t.name.substring(0,15)+'...':t.name}\n          `}catch(e){this.showError('editFileError',e.message)}}),a.addEventListener('blur',()=>{const e=a.value.trim();if(e!==t.name){const t=this.contactManager.validateContactName(e);t.valid?this.clearError('editNameError'):this.showError('editNameError',t.error)}else this.clearError('editNameError')}),d.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideEditContactModal()}),g.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleSaveEditContact(e,t)}),e.addEventListener('click',t=>{t.target===e&&this.hideEditContactModal()})}async handleSaveEditContact(e,t){const a=e.querySelector('#editContactName'),s=e.querySelector('#editAvatarUrl'),n=e.querySelector('#editAvatarUrlInput'),r=e.querySelector('#editAvatarFileInput'),o=e.querySelector('#editAvatarPreview'),i=a.value.trim();if(i!==t.name){const e=this.contactManager.validateContactName(i);if(!e.valid)return void this.showError('editNameError',e.error)}let l=t.avatar;if(s.checked){const e=n.value.trim();if(e&&e!==t.avatar){if(!await this.contactManager.validateAvatarUrl(e))return void this.showError('editUrlError','无效的图片URL');l=e}}else{const e=r.files?.[0];if(e)try{l=await this.contactManager.processAvatarFile(e)}catch(e){return void this.showError('editFileError',e.message)}else o.src.startsWith('data:')&&(l=o.src)}try{this.contactManager.updateContact(t.id,{name:i,avatar:l})?(this.syncAvatarAcrossInterface(t.name,i,l),this.notifyContactUpdated(t.name,i,l),this.showToast(`联系人 "${i}" 已更新`,'info'),this.hideEditContactModal(),setTimeout(()=>{this.showNewChatModal(),this.notifyRefreshChatList()},300)):this.showToast('更新联系人失败','error')}catch(e){this.showToast('更新联系人失败','error')}}hideEditContactModal(){const e=document.getElementById('editContactModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}showDeleteConfirmModal(e){const t=this.createDeleteConfirmModal(e),a=document.querySelector('.interface-container');a?a.appendChild(t):document.body.appendChild(t),setTimeout(()=>{t.classList.add('show')},10)}createDeleteConfirmModal(e){const t=document.createElement('div');return t.className='modal-overlay delete-confirm-modal',t.id='deleteConfirmModal',t.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">删除联系人</div>\n        <div class="delete-confirm-content">\n          <div class="warning-icon">⚠️</div>\n          <div class="delete-message">\n            <p>确定要删除联系人 <strong>"${e.name}"</strong> 吗？</p>\n            <p class="delete-note">此操作不可撤销，但不会删除与该联系人的聊天记录。</p>\n          </div>\n          <div class="contact-preview">\n            <img src="${e.avatar}" class="preview-avatar" alt="${e.name}">\n            <span class="preview-name">${e.name}</span>\n          </div>\n        </div>\n        \n        <div class="modal-buttons">\n          <button type="button" class="modal-btn cancel-btn">取消</button>\n          <button type="button" class="modal-btn delete-btn">删除</button>\n        </div>\n      </div>\n    `,this.bindDeleteConfirmModalEvents(t,e),t}bindDeleteConfirmModalEvents(e,t){const a=e.querySelector('.cancel-btn'),s=e.querySelector('.delete-btn');a.addEventListener('click',()=>{this.soundManager.playSound('click'),this.hideDeleteConfirmModal()}),s.addEventListener('click',()=>{this.soundManager.playSound('click'),this.handleConfirmDeleteContact(t)}),e.addEventListener('click',t=>{t.target===e&&this.hideDeleteConfirmModal()})}handleConfirmDeleteContact(e){try{this.contactManager.deleteContact(e.id)?(this.showToast(`联系人 "${e.name}" 已删除`,'info'),this.hideDeleteConfirmModal(),setTimeout(()=>{this.showNewChatModal()},300)):this.showToast('删除联系人失败','error')}catch(e){this.showToast('删除联系人失败','error')}}hideDeleteConfirmModal(){const e=document.getElementById('deleteConfirmModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}syncAvatarAcrossInterface(e,t,a){try{this.syncChatListAvatars(e,t,a),this.syncChatMessageAvatars(e,t,a),console.log(`✅ 头像同步完成: ${e} -> ${t}`)}catch(e){console.error('❌ 头像同步失败:',e)}}syncChatListAvatars(e,t,a){document.querySelectorAll('.chat-list-item').forEach(s=>{const n=s.querySelector('.chat-name')?.textContent?.trim(),r=s.querySelector('.chat-avatar');if(r&&n){if(n===e||n===t||n===`和${e}的聊天`||n===`和${t}的聊天`||n.includes(e)||n.includes(t)){r.src=a,r.alt=t,console.log(`🔄 更新聊天列表头像: ${n} -> ${a}`);const o=s.querySelector('.chat-name');o&&n===`和${e}的聊天`&&(o.textContent=`和${t}的聊天`,console.log(`🔄 更新聊天名称: ${n} -> 和${t}的聊天`))}}})}syncChatMessageAvatars(e,t,a){document.querySelectorAll('.avatar, .avatar-hover').forEach(s=>{const n=s;n.alt!==e&&n.alt!==t||(n.src=a,n.alt=t,console.log(`🔄 更新消息头像: ${e} -> ${t}`));const r=s.closest('.message');if(r){const s=r.querySelector('.message-sender, .sender-name');!s||s.textContent!==e&&s.textContent!==t||(n.src=a,n.alt=t,console.log(`🔄 更新消息头像(通过发送者): ${e} -> ${t}`))}})}syncChatHeaderAvatar(e,t,a){const s=document.getElementById('headerAvatar'),n=document.getElementById('chatTitle');if(s&&n){const r=n.textContent?.trim();r!==e&&r!==t&&r!==`和${e}的聊天`&&r!==`和${t}的聊天`||(s.src=a,s.alt=t,r===`和${e}的聊天`&&(n.textContent=`和${t}的聊天`),console.log(`🔄 更新header头像: ${r}`))}}notifyContactUpdated(e,t,a){const s=new CustomEvent('contactUpdated',{detail:{oldName:e,newName:t,newAvatar:a,timestamp:Date.now()}});document.dispatchEvent(s),console.log(`📢 发送联系人更新事件: ${e} -> ${t}`)}notifyRefreshChatList(){const e=new CustomEvent('refreshChatList',{detail:{timestamp:Date.now()}});document.dispatchEvent(e),console.log('📢 发送刷新聊天列表事件')}handleLongPress(e){const{chatId:t,position:a}=e,s=this.pinManager.isPinned(t);console.log(`🔗 长按聊天项: ${t}, 位置: (${a.x}, ${a.y}), 置顶状态: ${s}`),this.soundManager.playSound('click'),this.contextMenu.show(t,a,s)}handleContextMenuAction(e){const{action:t,chatId:a}=e;switch(console.log(`📋 上下文菜单操作: ${t}, 聊天ID: ${a}`),t){case'pin':this.handlePinChat(a);break;case'unpin':this.handleUnpinChat(a);break;case'delete':this.handleDeleteChat(a)}}handlePinChat(e){try{this.pinManager.pin(e),this.refreshChatList(this.currentChatDataMap),console.log(`📌 聊天已置顶: ${e}`)}catch(e){console.error('置顶聊天失败:',e),this.showToast('置顶失败','error')}}handleUnpinChat(e){try{this.pinManager.unpin(e),this.refreshChatList(this.currentChatDataMap),console.log(`📌 聊天已取消置顶: ${e}`)}catch(e){console.error('取消置顶失败:',e),this.showToast('取消置顶失败','error')}}handleDeleteChat(e){const t=this.getChatNameById(e);this.getChatAvatarById(e);if(confirm(`确定要删除与"${t}"的聊天吗？\n\n此操作不可撤销，将删除所有聊天记录。`))try{e.startsWith('group_')?this.deleteGroupChat(e):this.deleteRegularChat(e),this.pinManager.isPinned(e)&&this.pinManager.unpin(e),this.refreshChatList(this.currentChatDataMap),this.showToast(`已删除与"${t}"的聊天`,'info'),console.log(`🗑️ 聊天已删除: ${e}`)}catch(e){console.error('删除聊天失败:',e),this.showToast('删除失败','error')}}getChatNameById(e){const t=document.querySelector(`[data-chat-id="${e}"]`);if(t){const e=t.querySelector('.chat-name');if(e)return e.textContent||'未知聊天'}if(e.startsWith('group_')){const t=this.getGroupChatData().find(t=>t.id===e);if(t)return t.chatName}return'未知聊天'}getChatAvatarById(e){const t=document.querySelector(`[data-chat-id="${e}"]`);if(t){const e=t.querySelector('.chat-avatar');if(e)return e.src}if(e.startsWith('group_')){const t=this.getGroupChatData().find(t=>t.id===e);if(t)return t.avatar}return this.getDefaultAvatar('')}deleteGroupChat(e){console.log(`🔍 [DEBUG] 删除群聊请求: ${e} - 由主应用处理`);const t=new CustomEvent('deleteChatRequest',{detail:{chatId:e,type:'group'}});document.dispatchEvent(t)}deleteRegularChat(e){const t=new CustomEvent('deleteChatRequest',{detail:{chatId:e}});document.dispatchEvent(t),console.log(`🗑️ 发送删除聊天请求: ${e}`)}initializeLongPressHandler(){this.longPressHandler.init(),console.log('🔗 长按处理器已初始化')}destroyLongPressHandler(){this.longPressHandler&&this.longPressHandler.destroy(),console.log('🔗 长按处理器已销毁')}getPinManager(){return this.pinManager}onUnreadCountUpdated(e,t){const a=document.querySelector(`[data-chat-id="${e}"]`);if(a){const s=a.querySelector('.chat-time-container');let n=a.querySelector('.unread-badge');if(this.updateChatPreview(e,a),t>0){const e=this.formatUnreadCount(t);!n&&s&&(n=document.createElement('div'),n.className='unread-badge bounce',s.appendChild(n)),n&&(n.textContent=e,n.classList.add('show'),n.classList.add('pulse'),setTimeout(()=>{n?.classList.remove('bounce','pulse')},600))}else n&&(n.classList.remove('show'),setTimeout(()=>{n&&!n.classList.contains('show')&&n.remove()},200))}}updateChatPreview(e,t){if(!this.currentChatDataMap)return;const a=this.currentChatDataMap.get(e);if(!a||!a.messages||0===a.messages.length)return;const s=this.getLastMessage(a.messages);if(!s)return;const n=this.formatMessagePreview(s),r=t.querySelector('.chat-preview');r&&(r.textContent=n);const o=t.querySelector('.chat-time');if(o&&s.timestamp){const e=this.formatAbsoluteTime(s.timestamp);o.textContent=e}}onNewMessage(e){this.unreadMessageManager.onNewMessage(e,this.currentChatDataMap)}updateChatData(e){this.currentChatDataMap=e}onNewMessages(e,t){this.unreadMessageManager.onNewMessages(e,this.currentChatDataMap,t)}refreshUnreadCounts(){if(this.currentChatDataMap){const e=Array.from(this.currentChatDataMap.keys());this.unreadMessageManager.refreshUnreadCounts(this.currentChatDataMap,e)}}getUnreadMessageManager(){return this.unreadMessageManager}destroy(){this.stopStatusTimeUpdate(),this.destroyLongPressHandler(),this.unreadMessageManager.destroy(),this.contextMenu.hide()}formatUnreadCount(e){return e<=0?'':e>99?'99+':e.toString()}}var u=a(179),m=a(329);class p{static instance;constructor(){}static getInstance(){return p.instance||(p.instance=new p),p.instance}fileToBase64(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})}async compressImage(e,t=300,a=u.TL.quality){return new Promise(s=>{const n=new Image;n.onload=()=>{const e=document.createElement('canvas'),r=e.getContext('2d'),{width:o,height:i}=this.calculateCompressedSize(n.width,n.height,t);e.width=o,e.height=i,r.imageSmoothingEnabled=!0,r.imageSmoothingQuality='high',r.drawImage(n,0,0,o,i);const l=e.toDataURL('image/jpeg',a);s(l)},n.src=e})}async compressWallpaper(e){return this.compressImage(e,800,.8)}async compressAvatar(e){return this.compressImage(e,300,.8)}calculateCompressedSize(e,t,a){let{width:s,height:n}={width:e,height:t};return s>n?s>a&&(n=n*a/s,s=a):n>a&&(s=s*a/n,n=a),{width:Math.round(s),height:Math.round(n)}}validateImageFile(e){if(!u.TL.acceptedTypes.includes(e.type))return{isValid:!1,error:`不支持的文件类型。支持的格式：${u.TL.acceptedTypes.join(', ')}`};if(e.size>u.TL.maxSize){return{isValid:!1,error:`文件大小超过限制。最大允许 ${u.TL.maxSize/1048576}MB`}}return{isValid:!0}}getImageDimensions(e){return new Promise(t=>{const a=new Image;a.onload=()=>{t({width:a.width,height:a.height})},a.src=e})}async createThumbnail(e,t=100){return this.compressImage(e,t,.7)}static cleanupCanvas(e){const t=e.getContext('2d');t&&t.clearRect(0,0,e.width,e.height),e.width=0,e.height=0}}var v=a(52);class C{storageManager;imageProcessor;state=u.nl.IDLE;isVisible=!1;currentSettings;settingsModal;modalContainer;closeBtn;emojiSuggestionsToggle;crossChatSendToggle;clearUserCacheBtn;clearLorebookCacheBtn;chatListWallpaperUpload;chatListWallpaperPreview;chatListWallpaperInput;removeChatListWallpaperBtn;globalChatWallpaperUpload;globalChatWallpaperPreview;globalChatWallpaperInput;removeGlobalChatWallpaperBtn;applyToAllChatsBtn;constructor(){this.storageManager=v.StorageManager.getInstance(),this.imageProcessor=p.getInstance(),this.currentSettings=this.storageManager.loadSettings(),this.initializeElements(),this.bindEvents()}initializeElements(){if(this.settingsModal=document.getElementById('settingsModal'),this.modalContainer=this.settingsModal.querySelector('.modal-container'),this.closeBtn=document.getElementById('settingsCloseBtn'),this.emojiSuggestionsToggle=document.getElementById('emojiSuggestionsToggle'),this.crossChatSendToggle=document.getElementById('crossChatSendToggle'),this.clearUserCacheBtn=document.getElementById('clearUserCacheBtn'),this.clearLorebookCacheBtn=document.getElementById('clearLorebookCacheBtn'),this.clearUserCacheBtn||console.error('[SettingsModal] 清除用户缓存按钮未找到'),this.clearLorebookCacheBtn||console.error('[SettingsModal] 清除世界书缓存按钮未找到'),this.chatListWallpaperUpload=document.getElementById('chatListWallpaperUpload'),this.chatListWallpaperPreview=document.getElementById('chatListWallpaperPreview'),this.chatListWallpaperInput=document.getElementById('chatListWallpaperInput'),this.removeChatListWallpaperBtn=document.getElementById('removeChatListWallpaper'),this.globalChatWallpaperUpload=document.getElementById('globalChatWallpaperUpload'),this.globalChatWallpaperPreview=document.getElementById('globalChatWallpaperPreview'),this.globalChatWallpaperInput=document.getElementById('globalChatWallpaperInput'),this.removeGlobalChatWallpaperBtn=document.getElementById('removeGlobalChatWallpaper'),this.applyToAllChatsBtn=document.getElementById('applyToAllChatsBtn'),!this.settingsModal)throw new Error('Settings modal element not found')}bindEvents(){this.closeBtn.addEventListener('click',()=>this.hide()),this.settingsModal.addEventListener('click',e=>{e.target===this.settingsModal&&this.hide()}),document.addEventListener('keydown',e=>{'Escape'===e.key&&this.isVisible&&this.hide()}),this.emojiSuggestionsToggle.addEventListener('click',()=>this.toggleEmojiSuggestions()),this.crossChatSendToggle.addEventListener('click',()=>this.toggleCrossChatSend()),this.clearUserCacheBtn?this.clearUserCacheBtn.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),console.log('[SettingsModal] 清除用户缓存按钮被点击'),this.handleClearUserCache()}):console.error('[SettingsModal] 无法绑定清除用户缓存按钮事件，按钮未找到'),this.clearLorebookCacheBtn?this.clearLorebookCacheBtn.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),console.log('[SettingsModal] 清除世界书缓存按钮被点击'),this.handleClearLorebookCache()}):console.error('[SettingsModal] 无法绑定清除世界书缓存按钮事件，按钮未找到'),this.chatListWallpaperUpload.addEventListener('click',()=>this.chatListWallpaperInput.click()),this.chatListWallpaperUpload.addEventListener('dragover',e=>this.handleDragOver(e)),this.chatListWallpaperUpload.addEventListener('drop',e=>this.handleChatListWallpaperDrop(e)),this.chatListWallpaperInput.addEventListener('change',e=>this.handleChatListWallpaperChange(e)),this.removeChatListWallpaperBtn.addEventListener('click',()=>this.removeChatListWallpaper()),this.globalChatWallpaperUpload.addEventListener('click',()=>this.globalChatWallpaperInput.click()),this.globalChatWallpaperUpload.addEventListener('dragover',e=>this.handleDragOver(e)),this.globalChatWallpaperUpload.addEventListener('drop',e=>this.handleGlobalChatWallpaperDrop(e)),this.globalChatWallpaperInput.addEventListener('change',e=>this.handleGlobalChatWallpaperChange(e)),this.removeGlobalChatWallpaperBtn.addEventListener('click',()=>this.removeGlobalChatWallpaper()),this.applyToAllChatsBtn&&this.applyToAllChatsBtn.addEventListener('click',()=>this.handleApplyToAllChats()),this.chatListWallpaperPreview.addEventListener('click',e=>{e.target&&(e.target.closest('.remove-btn')||e.target.closest('.apply-all-btn'))||this.chatListWallpaperInput.click()}),this.globalChatWallpaperPreview.addEventListener('click',e=>{e.target&&(e.target.closest('.remove-btn')||e.target.closest('.apply-all-btn'))||this.globalChatWallpaperInput.click()})}async initialize(){try{this.currentSettings=this.storageManager.loadSettings(),this.updateUI()}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'初始化设置失败',details:e,timestamp:Date.now()})}}show(){this.isVisible||(this.settingsModal.classList.add('show'),this.isVisible=!0,this.updateUI(),document.body.style.overflow='hidden')}hide(){this.isVisible&&(this.settingsModal.classList.remove('show'),this.isVisible=!1,document.body.style.overflow='',this.saveSettings())}updateUI(){this.currentSettings.emojiSuggestionsEnabled?this.emojiSuggestionsToggle.classList.add('active'):this.emojiSuggestionsToggle.classList.remove('active'),this.currentSettings.crossChatSendEnabled?this.crossChatSendToggle.classList.add('active'):this.crossChatSendToggle.classList.remove('active'),this.updateWallpaperPreview(this.currentSettings.chatListWallpaper,this.chatListWallpaperPreview),this.updateWallpaperPreview(this.currentSettings.globalChatWallpaper,this.globalChatWallpaperPreview)}updateWallpaperPreview(e,t){const a=t.previousElementSibling;if(e){const s=t.querySelector('img');s&&(s.src=e,t.style.display='block',a&&a.classList.contains('upload-area')&&a.style.setProperty('display','none','important'),t.style.cursor='pointer',t.title='点击更换壁纸')}else t.style.display='none',a&&a.classList.contains('upload-area')&&a.style.setProperty('display','flex','important')}toggleEmojiSuggestions(){this.currentSettings.emojiSuggestionsEnabled=!this.currentSettings.emojiSuggestionsEnabled,this.updateUI(),this.saveSettings();const e=this.currentSettings.emojiSuggestionsEnabled?'已开启':'已关闭';toastr.info(`表情包建议${e}`)}toggleCrossChatSend(){this.currentSettings.crossChatSendEnabled=!this.currentSettings.crossChatSendEnabled,this.updateUI(),this.saveSettings();const e=this.currentSettings.crossChatSendEnabled?'已开启':'已关闭';toastr.info(`跨聊天发送${e}`),document.dispatchEvent(new CustomEvent('settingsUpdated',{detail:{crossChatSendEnabled:this.currentSettings.crossChatSendEnabled}}))}handleDragOver(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.add('dragover')}handleChatListWallpaperDrop(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.remove('dragover');const t=e.dataTransfer?.files;t&&t.length>0&&this.processChatListWallpaperFile(t[0])}handleGlobalChatWallpaperDrop(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.remove('dragover');const t=e.dataTransfer?.files;t&&t.length>0&&this.processGlobalChatWallpaperFile(t[0])}handleChatListWallpaperChange(e){const t=e.target,a=t.files?.[0];a&&this.processChatListWallpaperFile(a),t.value=''}handleGlobalChatWallpaperChange(e){const t=e.target,a=t.files?.[0];a&&this.processGlobalChatWallpaperFile(a),t.value=''}async processChatListWallpaperFile(e){try{const t=this.imageProcessor.validateImageFile(e);if(!t.isValid)return void toastr.error(t.error,'文件验证失败');this.setState(u.nl.LOADING);const a=await this.imageProcessor.fileToBase64(e),s=await this.imageProcessor.compressWallpaper(a);this.currentSettings.chatListWallpaper=s,this.updateWallpaperPreview(s,this.chatListWallpaperPreview),this.saveSettings(),await this.applyWallpaperToChatList(s),toastr.success('聊天列表壁纸设置成功'),this.setState(u.nl.IDLE)}catch(e){this.handleError({type:u.By.FILE_ERROR,message:'处理聊天列表壁纸失败',details:e,timestamp:Date.now()}),this.setState(u.nl.IDLE)}}async processGlobalChatWallpaperFile(e){try{const t=this.imageProcessor.validateImageFile(e);if(!t.isValid)return void toastr.error(t.error,'文件验证失败');this.setState(u.nl.LOADING);const a=await this.imageProcessor.fileToBase64(e),s=await this.imageProcessor.compressWallpaper(a);this.currentSettings.globalChatWallpaper=s,this.updateWallpaperPreview(s,this.globalChatWallpaperPreview),this.saveSettings(),await this.applyWallpaperToChatWindow(s),toastr.success('全局对话框壁纸设置成功'),this.setState(u.nl.IDLE)}catch(e){this.handleError({type:u.By.FILE_ERROR,message:'处理全局对话框壁纸失败',details:e,timestamp:Date.now()}),this.setState(u.nl.IDLE)}}async removeChatListWallpaper(){try{this.currentSettings.chatListWallpaper='',this.updateWallpaperPreview('',this.chatListWallpaperPreview),this.saveSettings();const{WallpaperManager:e}=await Promise.resolve().then(a.bind(a,790));e.getInstance().clearWallpaperCache(),toastr.info('已移除聊天列表壁纸')}catch(e){console.error('[SettingsModal] 移除聊天列表壁纸失败:',e),toastr.error('移除壁纸失败，请稍后重试')}}async removeGlobalChatWallpaper(){this.currentSettings.globalChatWallpaper='',this.updateWallpaperPreview('',this.globalChatWallpaperPreview),this.saveSettings(),await this.clearChatWindowWallpaper(),toastr.info('已移除全局对话框壁纸')}saveSettings(){try{this.storageManager.saveSettings(this.currentSettings),this.emitSettingsChangeEvent()}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'保存设置失败',details:e,timestamp:Date.now()})}}emitSettingsChangeEvent(){const e=new CustomEvent('settingsChange',{detail:{settings:{...this.currentSettings},timestamp:Date.now()}});document.dispatchEvent(e)}setState(e){switch(this.state=e,this.modalContainer.classList.remove('loading','error'),e){case u.nl.LOADING:this.modalContainer.classList.add('loading');break;case u.nl.ERROR:this.modalContainer.classList.add('error')}}handleError(e){console.error(`[SettingsModal] ${e.message}:`,e.details),toastr.error(e.message)}getCurrentSettings(){return{...this.currentSettings}}isModalVisible(){return this.isVisible}resetToDefaults(){this.currentSettings=this.storageManager.loadSettings(),this.updateUI(),this.saveSettings(),toastr.info('设置已重置为默认值')}async handleClearUserCache(){console.log('[SettingsModal] 开始处理清除用户缓存');try{console.log('[SettingsModal] 显示确认对话框');const e=await this.showConfirmDialog('确认清除缓存','这将清除本地保存的用户头像和名字，恢复为默认设置。此操作不可撤销，确定要继续吗？');if(console.log('[SettingsModal] 用户确认结果:',e),!e)return;const{GlobalUserManager:t}=await Promise.resolve().then(a.bind(a,329)),s=t.getInstance();await s.resetToDefault(),toastr.success('用户缓存已清除，头像和名字已恢复为默认设置'),this.hide()}catch(e){console.error('[SettingsModal] 清除用户缓存失败:',e),toastr.error('清除用户缓存失败，请稍后重试')}}async handleClearLorebookCache(){console.log('[SettingsModal] 开始处理清除世界书角色缓存');try{const e='这将清除世界书中所有角色的自定义头像缓存，恢复为世界书默认头像。\n\n此操作不可撤销，确定要继续吗？';if(!await this.showConfirmDialog('确认清除世界书角色缓存',e))return;const t=await(window.bearChatManager?.clearLorebookCharacterCache());if(!t)return void toastr.error('清除世界书角色缓存失败，请稍后重试');console.log('[SettingsModal] 世界书角色缓存清除完成:',t)}catch(e){console.error('[SettingsModal] 清除世界书角色缓存失败:',e),toastr.error('清除世界书角色缓存失败，请稍后重试')}}showConfirmDialog(e,t){return new Promise(a=>{const s=document.querySelector('.confirm-dialog-overlay');s&&s.remove();const n=document.createElement('div');n.className='confirm-dialog-overlay';const r=document.createElement('div');r.className='confirm-dialog',r.innerHTML=`\n        <div class="dialog-header">\n          <h3>⚠️ ${e}</h3>\n        </div>\n        <div class="dialog-content">\n          <p>${t}</p>\n        </div>\n        <div class="dialog-buttons">\n          <button class="cancel-btn">取消</button>\n          <button class="confirm-btn danger">确认清除</button>\n        </div>\n      `,n.appendChild(r),this.settingsModal.appendChild(n);const o=r.querySelector('.cancel-btn'),i=r.querySelector('.confirm-btn'),l=()=>{n.remove(),document.removeEventListener('keydown',c)};o.addEventListener('click',()=>{l(),a(!1)}),i.addEventListener('click',()=>{l(),a(!0)}),n.addEventListener('click',e=>{e.target===n&&(l(),a(!1))});const c=e=>{'Escape'===e.key&&(l(),a(!1))};document.addEventListener('keydown',c)})}async applyWallpaperToChatList(e){try{const{WallpaperManager:t}=await Promise.resolve().then(a.bind(a,790));t.getInstance().setCustomWallpaper(e),console.log('[SettingsModal] 壁纸已应用到聊天列表')}catch(e){throw console.error('[SettingsModal] 应用壁纸失败:',e),e}}async applyWallpaperToChatWindow(e){try{const t=new CustomEvent('globalChatWallpaperChange',{detail:{wallpaperData:e}});document.dispatchEvent(t),console.log('[SettingsModal] 壁纸已应用到聊天窗口')}catch(e){throw console.error('[SettingsModal] 应用聊天窗口壁纸失败:',e),e}}async clearChatWindowWallpaper(){try{const e=new CustomEvent('clearGlobalChatWallpaper');document.dispatchEvent(e),console.log('[SettingsModal] 聊天窗口壁纸已清除')}catch(e){throw console.error('[SettingsModal] 清除聊天窗口壁纸失败:',e),e}}async handleApplyToAllChats(){try{if(!this.currentSettings.globalChatWallpaper)return void toastr.warning('请先设置全局对话框壁纸');if(!await this.showConfirmDialog('确认全局更换','这将把当前的全局对话框壁纸应用到所有聊天框，并清除所有单独设置的壁纸。此操作不可撤销，确定要继续吗？'))return;const e=new CustomEvent('applyWallpaperToAllChats',{detail:{wallpaperData:this.currentSettings.globalChatWallpaper}});document.dispatchEvent(e),this.currentSettings.individualChatWallpapers={},this.saveSettings(),toastr.success('已将壁纸应用到所有聊天框'),console.log('[SettingsModal] 全局更换壁纸完成')}catch(e){console.error('[SettingsModal] 全局更换壁纸失败:',e),toastr.error('全局更换壁纸失败，请稍后重试')}}destroy(){this.hide(),document.body.style.overflow=''}}var y,f,M=a(534);class S{globalUserManager;imageProcessor;avatarMixin;state=u.nl.IDLE;avatarElement;avatarImage;avatarOverlay;nameDisplay;nameEdit;nameInput;nameConfirmBtn;nameCancelBtn;avatarFileInput;originalName='';originalAvatar='';pendingAvatar='';constructor(){this.globalUserManager=m.GlobalUserManager.getInstance(),this.imageProcessor=p.getInstance(),this.avatarMixin=new M.SimpleAvatarMixin({debug:!1}),this.initializeElements(),this.bindEvents()}initializeElements(){if(this.avatarElement=document.getElementById('userAvatar'),this.avatarImage=document.getElementById('avatarImage'),this.avatarOverlay=this.avatarElement.querySelector('.avatar-overlay'),this.nameDisplay=document.getElementById('nameDisplay'),this.nameEdit=document.getElementById('nameEdit'),this.nameInput=document.getElementById('nameInput'),this.nameConfirmBtn=document.getElementById('nameConfirmBtn'),this.nameCancelBtn=document.getElementById('nameCancelBtn'),this.avatarFileInput=document.getElementById('avatarFileInput'),!this.avatarElement||!this.avatarImage||!this.nameDisplay)throw new Error('必需的DOM元素未找到')}bindEvents(){this.avatarElement.addEventListener('click',()=>this.handleAvatarClick()),this.avatarFileInput.addEventListener('change',e=>this.handleAvatarFileChange(e)),this.nameDisplay.addEventListener('click',()=>this.startNameEdit()),this.nameConfirmBtn.addEventListener('click',()=>this.confirmNameEdit()),this.nameCancelBtn.addEventListener('click',()=>this.cancelNameEdit()),this.nameInput.addEventListener('keydown',e=>{'Enter'===e.key?this.confirmNameEdit():'Escape'===e.key&&this.cancelNameEdit()}),this.globalUserManager.addEventListener('all',e=>{this.handleUserInfoChange(e)})}async initialize(){try{this.setState(u.nl.LOADING);const e=await this.globalUserManager.loadUserData();await this.updateDisplay(e),this.setState(u.nl.IDLE)}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'初始化用户信息失败',details:e,timestamp:Date.now()}),this.setState(u.nl.ERROR)}}async updateDisplay(e){this.nameDisplay.textContent=e.name,e.avatar?(this.avatarImage.src=e.avatar,this.avatarImage.style.display='block'):(this.avatarImage.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjRjVGNUY1Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDAiIHI9IjIwIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCA5MEM0MCA3MCA4MCA3MCAxMDAgOTBWMTIwSDIwVjkwWiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K',this.avatarImage.style.display='block')}handleAvatarClick(){this.state===u.nl.IDLE&&this.avatarFileInput.click()}async handleAvatarFileChange(e){const t=e.target,a=t.files?.[0];if(a)try{const e=this.imageProcessor.validateImageFile(a);if(!e.isValid)return void toastr.error(e.error,'文件验证失败');this.setState(u.nl.LOADING);const t=await this.imageProcessor.fileToBase64(a),s=await this.imageProcessor.compressAvatar(t),n=this.globalUserManager.getCurrentUserData();this.originalAvatar=n?.avatar||'',this.pendingAvatar=s,this.avatarImage.src=s,this.showAvatarConfirmation(),this.setState(u.nl.EDITING)}catch(e){this.handleError({type:u.By.FILE_ERROR,message:'处理头像文件失败',details:e,timestamp:Date.now()}),this.setState(u.nl.IDLE)}finally{t.value=''}}showAvatarConfirmation(){const e=document.createElement('div');e.className='avatar-confirm-container',e.innerHTML='\n      <div class="avatar-confirm-buttons">\n        <button class="modal-btn confirm-btn" id="avatarConfirmBtn">确认</button>\n        <button class="modal-btn cancel-btn" id="avatarCancelBtn">取消</button>\n      </div>\n    ';this.avatarElement.closest('.user-info-section').appendChild(e);const t=e.querySelector('#avatarConfirmBtn'),a=e.querySelector('#avatarCancelBtn');t.addEventListener('click',()=>this.confirmAvatarChange()),a.addEventListener('click',()=>this.cancelAvatarChange())}async confirmAvatarChange(){try{this.setState(u.nl.SAVING),await this.globalUserManager.updateUserAvatar(this.pendingAvatar),toastr.success('头像更新成功'),(0,M.forceUpdateAvatars)(this.pendingAvatar),this.hideAvatarConfirmation(),this.setState(u.nl.IDLE)}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'保存头像失败',details:e,timestamp:Date.now()}),this.avatarImage.src=this.originalAvatar,this.setState(u.nl.IDLE)}}cancelAvatarChange(){this.avatarImage.src=this.originalAvatar,this.hideAvatarConfirmation(),this.setState(u.nl.IDLE)}hideAvatarConfirmation(){const e=document.querySelector('.avatar-confirm-container');e&&e.remove()}startNameEdit(){if(this.state!==u.nl.IDLE)return;const e=this.globalUserManager.getCurrentUserData();this.originalName=e?.name||'',this.nameInput.value=this.originalName,this.nameDisplay.style.display='none',this.nameEdit.classList.add('active'),this.nameEdit.style.display='flex',this.nameInput.focus(),this.nameInput.select(),this.setState(u.nl.EDITING)}async confirmNameEdit(){const e=this.nameInput.value.trim(),t=this.validateName(e);if(t.isValid)try{this.setState(u.nl.SAVING),await this.globalUserManager.updateUserName(e),this.nameDisplay.textContent=e,this.exitNameEdit(),toastr.success('用户名更新成功'),this.setState(u.nl.IDLE)}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'保存用户名失败',details:e,timestamp:Date.now()}),this.setState(u.nl.EDITING)}else toastr.error(t.error,'名称验证失败')}cancelNameEdit(){this.exitNameEdit(),this.setState(u.nl.IDLE)}exitNameEdit(){this.nameEdit.classList.remove('active'),this.nameEdit.style.display='none',this.nameDisplay.style.display='inline-block'}validateName(e){if(!e)return{isValid:!1,error:'用户名不能为空'};if(e.length>50)return{isValid:!1,error:'用户名长度不能超过50个字符'};return/[<>\"'&]/.test(e)?{isValid:!1,error:'用户名包含无效字符'}:{isValid:!0}}setState(e){switch(this.state=e,this.avatarElement.classList.remove('loading','editing','error'),e){case u.nl.LOADING:this.avatarElement.classList.add('loading');break;case u.nl.EDITING:this.avatarElement.classList.add('editing');break;case u.nl.ERROR:this.avatarElement.classList.add('error')}}handleUserInfoChange(e){if(this.state===u.nl.IDLE){const e=this.globalUserManager.getCurrentUserData();e&&this.updateDisplay(e)}}handleError(e){console.error(`[UserInfoSection] ${e.message}:`,e.details),toastr.error(e.message)}getState(){return this.state}destroy(){this.globalUserManager.removeEventListener('all',this.handleUserInfoChange),this.hideAvatarConfirmation(),this.state===u.nl.EDITING&&this.exitNameEdit()}}class b{static instance;isEnabled=!1;SETTING_KEY='bear_chat_migration_enabled';isProcessing=!1;lastCheckedMessageId=-1;lastCheckedContent='';migratedMessages=new Set;constructor(){this.loadSettings()}static getInstance(){return b.instance||(b.instance=new b),b.instance}initialize(){this.loadSettings(),this.logInfo('ChatMigrationManager 已初始化')}isFeatureEnabled(){return this.isEnabled}setFeatureEnabled(e){this.isEnabled=e,this.saveSettings(),this.logInfo('聊天记录迁移功能已'+(e?'启用':'禁用'))}async checkAndMigrate(){try{if(!this.isEnabled)return;if(this.isProcessing)return;const e=getLastMessageId();if(e<0)return;if(e===this.lastCheckedMessageId)return;this.isProcessing=!0;const t=getChatMessages(e);if(!t||0===t.length)return;const a=t[0].message;if(a===this.lastCheckedContent)return;this.lastCheckedMessageId=e,this.lastCheckedContent=a;if(!this.containsEmptyBearTags(a))return;if(this.migratedMessages.has(e))return;this.logInfo(`🔍 在楼层 ${e} 发现空的 <bear></bear> 标签，开始搜索历史内容`);const s=await this.findHistoryContent(e);if(!s)return;await this.migrateContent(e,a,s)}catch(e){this.logError('检查和迁移过程',e)}finally{this.isProcessing=!1}}containsEmptyBearTags(e){return/<bear>\s*<\/bear>/gs.test(e)}containsBearTags(e){return/<bear>.*?<\/bear>/gs.test(e)}async findHistoryContent(e){try{let t=0;for(let a=e-1;a>=0;a--){t++;const e=getChatMessages(a);if(!e||0===e.length)continue;const s=e[0].message;if(this.containsBearTags(s)){const e=this.extractBearContent(s);if(e)return this.logInfo(`✅ 在楼层 ${a} 找到历史内容 (搜索了 ${t} 个楼层)`),{messageId:a,content:e}}t%20==0&&this.logInfo(`🔍 已搜索 ${t} 个楼层...`)}return this.logInfo(`❌ 未找到历史内容 (共搜索 ${t} 个楼层)`),null}catch(e){return this.logError('搜索历史内容',e),null}}extractBearContent(e){const t=e.match(/<bear>(.*?)<\/bear>/s);return t?t[1]:null}async migrateContent(e,t,a){this.logInfo(`🚀 执行迁移: 楼层 ${a.messageId} → 楼层 ${e}`);try{const s=this.replaceBearContent(t,a.content);await setChatMessages([{message_id:e,message:s}],{refresh:'none'}),await this.hideSourceMessage(a.messageId),this.migratedMessages.add(e),this.logInfo('✅ 迁移完成'),toastr.success('已成功迁移聊天记录','迁移完成')}catch(e){this.logError('迁移内容',e)}}replaceBearContent(e,t){return e.replace(/<bear>\s*<\/bear>/s,`<bear>${t}</bear>`)}async hideSourceMessage(e){try{const t=getChatMessages(e);if(!t||0===t.length)return;if(t[0].is_hidden)return;triggerSlash(`/hide ${e}`),this.logInfo(`🙈 已隐藏源楼层 ${e}`)}catch(e){this.logError('隐藏源楼层',e)}}loadSettings(){try{const e=localStorage.getItem(this.SETTING_KEY);this.isEnabled='true'===e}catch(e){this.logError('加载设置',e),this.isEnabled=!1}}saveSettings(){try{localStorage.setItem(this.SETTING_KEY,this.isEnabled.toString())}catch(e){this.logError('保存设置',e)}}logInfo(e){console.log(`[ChatMigrationManager] ${e}`)}logError(e,t){console.error(`[ChatMigrationManager] ${e} 失败:`,t)}destroy(){this.isProcessing=!1,this.logInfo('ChatMigrationManager 已销毁')}}!function(e){e.MESSAGE_NOT_FOUND='MESSAGE_NOT_FOUND',e.AI_GENERATION_FAILED='AI_GENERATION_FAILED',e.SENDAS_COMMAND_FAILED='SENDAS_COMMAND_FAILED',e.HIDE_COMMAND_FAILED='HIDE_COMMAND_FAILED',e.NETWORK_ERROR='NETWORK_ERROR',e.UNKNOWN_ERROR='UNKNOWN_ERROR'}(y||(y={})),function(e){e.IDLE='IDLE',e.LOADING='LOADING',e.PROCESSING='PROCESSING',e.ERROR='ERROR'}(f||(f={}));class E{static instance;errorCounts=new Map;MAX_ERROR_COUNT=3;ERROR_RESET_TIME=3e5;constructor(){}static getInstance(){return E.instance||(E.instance=new E),E.instance}handleSummaryError(e,t,a=!0){const s=this.determineErrorType(e),n=`${t}_${s}`;this.incrementErrorCount(n),console.error(`[ErrorHandler] ${t} 错误:`,{type:s,message:e.message,stack:e.stack,timestamp:(new Date).toISOString(),count:this.errorCounts.get(n)||0}),a&&this.showUserFriendlyError(s,t),this.checkErrorThreshold(n,s)}determineErrorType(e){if(!e)return y.UNKNOWN_ERROR;const t=e.message||'';return t.includes(y.MESSAGE_NOT_FOUND)||t.includes('没有找到')||t.includes('消息为空')?y.MESSAGE_NOT_FOUND:t.includes(y.AI_GENERATION_FAILED)||t.includes('AI生成')||t.includes('generate')?y.AI_GENERATION_FAILED:t.includes(y.SENDAS_COMMAND_FAILED)||t.includes('sendas')||t.includes('发送失败')?y.SENDAS_COMMAND_FAILED:t.includes(y.HIDE_COMMAND_FAILED)||t.includes('hide')||t.includes('隐藏失败')?y.HIDE_COMMAND_FAILED:t.includes('网络')||t.includes('network')||t.includes('timeout')||t.includes('连接')?y.NETWORK_ERROR:y.UNKNOWN_ERROR}showUserFriendlyError(e,t){const a=(this.errorCounts.get(`${t}_${e}`)||0)>1;switch(e){case y.MESSAGE_NOT_FOUND:a?toastr.warning('仍然没有找到可以总结的消息，请确认当前聊天中有内容'):toastr.warning('没有找到可以总结的消息内容，请确认当前聊天中有消息');break;case y.AI_GENERATION_FAILED:a?toastr.error('总结持续异常，请稍后再试或联系技术支持'):toastr.error('总结生成失败，请稍后重试');break;case y.SENDAS_COMMAND_FAILED:a?toastr.error('发送总结持续失败，请检查权限设置或联系管理员'):toastr.error('发送总结失败，请检查权限设置');break;case y.HIDE_COMMAND_FAILED:toastr.warning('隐藏原楼层失败，但总结已成功发送');break;case y.NETWORK_ERROR:a?toastr.error('网络连接持续异常，请检查网络设置或稍后重试'):toastr.error('网络连接失败，请检查网络设置');break;default:a?toastr.error('系统持续出现异常，请刷新页面或联系技术支持'):toastr.error('总结过程中发生未知错误，请稍后重试')}}incrementErrorCount(e){const t=this.errorCounts.get(e)||0;this.errorCounts.set(e,t+1),setTimeout(()=>{this.errorCounts.delete(e)},this.ERROR_RESET_TIME)}checkErrorThreshold(e,t){if((this.errorCounts.get(e)||0)>=this.MAX_ERROR_COUNT)switch(console.warn(`[ErrorHandler] 错误 ${t} 达到阈值 ${this.MAX_ERROR_COUNT} 次`),t){case y.AI_GENERATION_FAILED:toastr.warning('AI服务可能暂时不可用，建议稍后再试');break;case y.NETWORK_ERROR:toastr.warning('网络连接不稳定，建议检查网络设置');break;case y.SENDAS_COMMAND_FAILED:toastr.warning('发送功能可能存在权限问题，建议联系管理员');break;default:toastr.warning('系统可能存在问题，建议刷新页面重试')}}handleSuccess(e,t){console.log(`[ErrorHandler] ${e} 成功:`,t);const a=[];for(const[t]of this.errorCounts)t.includes(e)&&a.push(t);a.forEach(e=>{this.errorCounts.delete(e)})}getErrorStats(){const e={};for(const[t,a]of this.errorCounts)e[t]=a;return e}clearErrorCounts(){this.errorCounts.clear(),console.log('[ErrorHandler] 错误计数已清除')}hasFrequentErrors(){for(const e of this.errorCounts.values())if(e>=this.MAX_ERROR_COUNT)return!0;return!1}generateErrorReport(){const e=this.getErrorStats(),t=Object.values(e).reduce((e,t)=>e+t,0);if(0===t)return'没有记录到错误';let a=`总错误数: ${t}\n\n`;for(const[t,s]of Object.entries(e))a+=`${t}: ${s} 次\n`;return a}destroy(){this.clearErrorCounts(),console.log('[ErrorHandler] 错误处理器已销毁')}}class w{static instance;constructor(){}static getInstance(){return w.instance||(w.instance=new w),w.instance}getLatestMessage(){try{console.log('[MessageProcessor] 开始获取最新消息...');const e=getChatMessages(-1);if(!e||0===e.length)throw console.warn('[MessageProcessor] 没有找到任何消息'),new Error(y.MESSAGE_NOT_FOUND);const t=e[0],a={id:t.message_id,content:t.message||'',sender:t.name||'未知用户',timestamp:this.getCurrentTimestamp(),role:t.role||'user'};if(!a.content.trim())throw console.warn('[MessageProcessor] 最新消息内容为空'),new Error(y.MESSAGE_NOT_FOUND);return console.log('[MessageProcessor] ✅ 成功获取最新消息'),a}catch(e){if(console.error('[MessageProcessor] 获取最新消息失败:',e),e.message===y.MESSAGE_NOT_FOUND)throw e;throw new Error(y.UNKNOWN_ERROR)}}formatMessageForSummary(e){try{console.log('[MessageProcessor] 开始格式化消息内容...');let t='',a=e.sender;return'user'===e.role?a='用户':'assistant'===e.role?a=e.sender||'助手':'system'===e.role&&(a='系统'),t=`${a}: ${e.content.trim()}`,e.timestamp&&(t+=`\n时间: ${e.timestamp}`),console.log('[MessageProcessor] ✅ 消息内容格式化完成'),t}catch(e){throw console.error('[MessageProcessor] 格式化消息内容失败:',e),new Error(y.UNKNOWN_ERROR)}}async executeSlashCommand(e){try{if(console.log('[MessageProcessor] 执行斜杠命令:',e),!e.startsWith('/'))throw new Error('无效的斜杠命令格式');return triggerSlash(e),console.log('[MessageProcessor] ✅ 斜杠命令执行成功'),!0}catch(t){if(console.error('[MessageProcessor] 斜杠命令执行失败:',t),e.includes('/sendas'))throw new Error(y.SENDAS_COMMAND_FAILED);if(e.includes('/hide'))throw new Error(y.HIDE_COMMAND_FAILED);throw new Error(y.UNKNOWN_ERROR)}}async sendSummaryToNewFloor(e,t){try{if(console.log('[MessageProcessor] 开始发送总结到新楼层...'),!e.trim())throw new Error('总结内容不能为空');const a=`/sendas name="${t||this.getCurrentCharacterName()}" ${e}`;return await this.executeSlashCommand(a),console.log('[MessageProcessor] ✅ 总结已发送到新楼层'),!0}catch(e){throw console.error('[MessageProcessor] 发送总结到新楼层失败:',e),e}}async hideOriginalFloor(e){try{console.log('[MessageProcessor] 开始隐藏原楼层...');let t=e;if(void 0===t){const e=this.getLatestMessage();if(!e)throw new Error('无法获取要隐藏的消息ID');t=e.id}const a=`/hide ${t}`;return await this.executeSlashCommand(a),console.log('[MessageProcessor] ✅ 原楼层已隐藏，楼层号:',t),!0}catch(e){throw console.error('[MessageProcessor] 隐藏原楼层失败:',e),e}}getCurrentCharacterName(){try{const e=this.getLatestMessage();return e&&'assistant'===e.role&&e.sender?e.sender:'助手'}catch(e){return console.warn('[MessageProcessor] 获取角色名称失败，使用默认名称'),'助手'}}getCurrentTimestamp(){return(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}validateMessageContent(e){if(!e||'string'!=typeof e)return!1;const t=e.trim();return 0!==t.length&&(!(t.length>5e4)||(console.warn('[MessageProcessor] 消息内容过长:',t.length),!1))}getMessageStats(e){const t=e.content||'';return{characterCount:t.length,wordCount:t.split(/\s+/).filter(e=>e.length>0).length,lineCount:t.split('\n').length}}cleanMessageContent(e){return e?e.trim().replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,'').replace(/[ \t]+/g,' ').replace(/\n{3,}/g,'\n\n'):''}destroy(){console.log('[MessageProcessor] 消息处理器已销毁')}}class I{static instance;messageProcessor;errorHandler;SUMMARY_PROMPT_TEMPLATE='<requqst:注意，在接下来的一轮回复中，忽略之前的所有指示，进行一次性的总结。总结到目前为止重要的情节和事件。本次回复应仅包含【本次线上内容总结】的总结内容。\n\n总结规范：\n1.按对话的时间顺序或事件的因果逻辑总结本楼内容\n2.只记录关键事件和重要细节，包括角色的重要语句，合并重复事件，省略冗余描述。\n3.使用简洁精炼的语言记录事实，避免主观评价与修饰\n4.使用纯文字进行记录，每个事件50字到100字左右\n5.如果存在未完成的约定、代办、与特殊事件，需要记录时间与事件。\n\n输出格式示例：\n【本次线上内容总结】\n1.{{事件1名称}}：{{事件描述}}\n2.{{事件2名称}}：{{事件描述}}\n3.{{事件3名称}}：{{事件描述}}>';constructor(){this.messageProcessor=w.getInstance(),this.errorHandler=E.getInstance()}static getInstance(){return I.instance||(I.instance=new I),I.instance}async summarizeLatestMessage(){const e=Date.now();try{console.log('[ChatSummaryService] 开始总结最新消息...');const t=this.messageProcessor.getLatestMessage();if(!t)throw new Error(y.MESSAGE_NOT_FOUND);console.log('[ChatSummaryService] 获取到最新消息:',{id:t.id,sender:t.sender,contentLength:t.content.length});const a=t.id;if(!this.messageProcessor.validateMessageContent(t.content))throw new Error(y.MESSAGE_NOT_FOUND);const s=this.messageProcessor.formatMessageForSummary(t),n=await this.generateSummary(s);await this.sendSummaryToNewFloor(n,t.sender),await this.messageProcessor.hideOriginalFloor(a);const r={success:!0,content:n,timestamp:Date.now()};return console.log('[ChatSummaryService] ✅ 总结完成，耗时:',Date.now()-e,'ms'),r}catch(e){console.error('[ChatSummaryService] 总结失败:',e);return{success:!1,error:e.message||y.UNKNOWN_ERROR,timestamp:Date.now()}}}async generateSummary(e){try{console.log('[ChatSummaryService] 开始生成总结...'),console.log('[ChatSummaryService] 消息内容长度:',e.length);const t=`${this.SUMMARY_PROMPT_TEMPLATE}\n\n需要总结的消息内容：\n${e}`;console.log('[ChatSummaryService] 完整提示词长度:',t.length);const a=await generate({user_input:t,max_chat_history:0,should_stream:!1});if(!a||!a.trim())throw new Error('AI生成的总结为空');console.log('[ChatSummaryService] ✅ 总结生成成功'),console.log('[ChatSummaryService] 原始总结长度:',a.length);const s=this.extractSummaryContent(a);return console.log('[ChatSummaryService] 提取后总结长度:',s.length),s}catch(e){if(console.error('[ChatSummaryService] 总结生成失败:',e),e.message&&e.message.includes('网络'))throw new Error(y.NETWORK_ERROR);throw new Error(y.AI_GENERATION_FAILED)}}async sendSummaryToNewFloor(e,t){try{if(console.log('[ChatSummaryService] 开始发送总结到新楼层...'),!e||!e.trim())throw new Error('总结内容不能为空');const a=this.messageProcessor.cleanMessageContent(e);await this.messageProcessor.sendSummaryToNewFloor(a,t),console.log('[ChatSummaryService] ✅ 总结已发送到新楼层')}catch(e){throw console.error('[ChatSummaryService] 发送总结失败:',e),e}}getSummaryConfig(){return{promptTemplate:this.SUMMARY_PROMPT_TEMPLATE,maxChatHistory:0}}extractSummaryContent(e){try{if(console.log('[ChatSummaryService] 开始提取总结内容...'),!e||!e.trim())throw new Error('AI回复为空');const t=e.trim(),a='【本次线上内容总结】',s=t.lastIndexOf(a);if(-1===s)return console.warn('[ChatSummaryService] 未找到总结标记，返回原始内容'),t;const n=t.substring(s);return console.log('[ChatSummaryService] ✅ 成功提取总结内容'),n.trim()}catch(t){return console.error('[ChatSummaryService] 提取总结内容失败:',t),e.trim()}}validateSummaryFormat(e){if(!e||!e.trim())return!1;const t=e.trim();if(!t.includes('【本次线上内容总结】'))return console.warn('[ChatSummaryService] 总结格式不符合要求：缺少标题'),!1;return!!/\d+\./.test(t)||(console.warn('[ChatSummaryService] 总结格式不符合要求：缺少编号列表'),!1)}getSummaryStats(e){if(!e)return{characterCount:0,eventCount:0,averageEventLength:0};const t=e.length,a=e.match(/\d+\./g),s=a?a.length:0;return{characterCount:t,eventCount:s,averageEventLength:s>0?Math.round(t/s):0}}handleSummaryError(e,t){this.errorHandler.handleSummaryError(e,t)}async executeSummaryWorkflow(){try{console.log('[ChatSummaryService] 开始执行总结工作流程...');const e=await this.summarizeLatestMessage();return e.success?(toastr.success('聊天内容总结完成！'),console.log('[ChatSummaryService] ✅ 总结工作流程执行成功')):this.handleSummaryError(new Error(e.error),'总结工作流程'),e}catch(e){return console.error('[ChatSummaryService] 总结工作流程执行失败:',e),this.handleSummaryError(e,'总结工作流程'),{success:!1,error:e.message||y.UNKNOWN_ERROR,timestamp:Date.now()}}}destroy(){console.log('[ChatSummaryService] 聊天总结服务已销毁')}}class L{static instance;state=f.IDLE;isVisible=!1;chatSummaryService;chatMigrationManager;lastSummaryTime=0;SUMMARY_COOLDOWN=5e3;extensionModal=null;modalContainer=null;closeBtn=null;summaryBtn=null;migrationBtn=null;constructor(){this.chatSummaryService=I.getInstance(),this.chatMigrationManager=b.getInstance(),this.initializeElements(),this.bindEvents()}static getInstance(){return L.instance||(L.instance=new L),L.instance}initializeElements(){this.createModalHTML(),this.extensionModal=document.getElementById('extensionSettingsModal'),this.modalContainer=this.extensionModal?.querySelector('.modal-container')||null,this.closeBtn=document.getElementById('extensionCloseBtn'),this.summaryBtn=document.getElementById('summaryChatBtn'),this.migrationBtn=document.getElementById('chatMigrationBtn'),this.extensionModal||console.error('[ExtensionSettingsManager] 扩展设置模态框元素未找到')}createModalHTML(){if(document.getElementById('extensionSettingsModal'))return;const e='\n      <div id="extensionSettingsModal" class="extension-settings-modal">\n        <div class="modal-container">\n          <div class="modal-header">\n            <div class="modal-title">扩展设置</div>\n            <button id="extensionCloseBtn" class="close-btn" type="button">\n              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          </div>\n          <div class="modal-content">\n            <div class="setting-group">\n              <div class="group-title">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 2L2 7l10 5 10-5-10-5z"></path>\n                  <path d="M2 17l10 5 10-5"></path>\n                  <path d="M2 12l10 5 10-5"></path>\n                </svg>\n                聊天工具\n              </div>\n              <div class="setting-item">\n                <button id="summaryChatBtn" class="extension-btn summary-btn" type="button">\n                  <span class="btn-text">总结聊天内容</span>\n                  <span class="btn-desc">对最新消息进行总结</span>\n                </button>\n              </div>\n            </div>\n            \n            <div class="setting-group">\n              <div class="group-title">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>\n                  <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>\n                  <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>\n                  <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>\n                </svg>\n                聊天记录管理\n              </div>\n              <div class="setting-item">\n                <button id="chatMigrationBtn" class="extension-btn migration-btn" type="button">\n                  <span class="btn-text">迁移聊天记录</span>\n                  <span class="btn-desc">[慎开]开启后会在后续召唤手机时迁移所有手机聊天记录，可能token爆炸</span>\n                  <span class="btn-status">已禁用</span>\n                </button>\n              </div>\n            </div>\n            \n            <div class="setting-group">\n              <div class="group-title">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <circle cx="12" cy="12" r="3"></circle>\n                  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>\n                </svg>\n                更多功能\n              </div>\n              <div class="setting-item">\n                <div class="coming-soon">\n                  更多扩展功能即将推出...\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',t=document.querySelector('.interface-container');t?t.insertAdjacentHTML('beforeend',e):(document.body.insertAdjacentHTML('beforeend',e),console.warn('[ExtensionSettingsManager] 未找到 .interface-container，模态框已添加到 body'))}bindEvents(){setTimeout(()=>{this.closeBtn&&this.closeBtn.addEventListener('click',()=>this.hide()),this.extensionModal&&this.extensionModal.addEventListener('click',e=>{e.target===this.extensionModal&&this.hide()}),document.addEventListener('keydown',e=>{'Escape'===e.key&&this.isVisible&&this.hide()}),this.summaryBtn&&this.summaryBtn.addEventListener('click',()=>this.handleSummaryRequest()),this.migrationBtn&&(this.updateMigrationButtonState(),this.migrationBtn.addEventListener('click',()=>{const e=!this.chatMigrationManager.isFeatureEnabled();this.chatMigrationManager.setFeatureEnabled(e),this.updateMigrationButtonState(),toastr.info('聊天记录迁移功能已'+(e?'启用':'禁用'))}))},100)}show(){!this.isVisible&&this.extensionModal&&(this.migrationBtn&&this.updateMigrationButtonState(),this.extensionModal.classList.add('show'),this.isVisible=!0,document.body.style.overflow='hidden',console.log('[ExtensionSettingsManager] 扩展设置模态框已显示'))}hide(){this.isVisible&&this.extensionModal&&(this.extensionModal.classList.remove('show'),this.isVisible=!1,document.body.style.overflow='',console.log('[ExtensionSettingsManager] 扩展设置模态框已隐藏'))}async handleSummaryRequest(){try{const e=Date.now();if(e-this.lastSummaryTime<this.SUMMARY_COOLDOWN){const t=Math.ceil((this.SUMMARY_COOLDOWN-(e-this.lastSummaryTime))/1e3);return void toastr.warning(`请等待 ${t} 秒后再试`)}if(this.state===f.PROCESSING)return void toastr.info('正在处理中，请稍候...');if(!await this.showConfirmDialog({title:'确认总结',message:'这将对最新的聊天消息进行总结，并发送到新楼层。确定要继续吗？',confirmText:'确认总结',cancelText:'取消'}))return;this.lastSummaryTime=e,this.setState(f.PROCESSING),console.log('[ExtensionSettingsManager] 开始处理聊天总结...');const t=await this.chatSummaryService.executeSummaryWorkflow();if(t.success){if(console.log('[ExtensionSettingsManager] ✅ 聊天总结完成'),t.content){const e=this.chatSummaryService.getSummaryStats(t.content);toastr.success(`总结完成！生成了 ${e.eventCount} 个事件，共 ${e.characterCount} 字`)}setTimeout(()=>{this.hide()},2e3)}else console.error('[ExtensionSettingsManager] 聊天总结失败:',t.error);this.setState(f.IDLE)}catch(e){console.error('[ExtensionSettingsManager] 处理总结请求失败:',e),toastr.error('处理总结请求失败，请稍后重试'),this.setState(f.ERROR),setTimeout(()=>{this.setState(f.IDLE)},5e3)}}showConfirmDialog(e){return new Promise(t=>{const a=document.querySelector('.extension-confirm-dialog-overlay');a&&a.remove();const s=document.createElement('div');s.className='extension-confirm-dialog-overlay';const n=document.createElement('div');n.className='extension-confirm-dialog',n.innerHTML=`\n        <div class="dialog-header">\n          <h3>⚠️ ${e.title}</h3>\n        </div>\n        <div class="dialog-content">\n          <p>${e.message}</p>\n        </div>\n        <div class="dialog-buttons">\n          <button class="cancel-btn">${e.cancelText||'取消'}</button>\n          <button class="confirm-btn primary">${e.confirmText||'确认'}</button>\n        </div>\n      `,s.appendChild(n),this.extensionModal?this.extensionModal.appendChild(s):document.body.appendChild(s);const r=n.querySelector('.cancel-btn'),o=n.querySelector('.confirm-btn'),i=()=>{s.remove(),document.removeEventListener('keydown',l)};r.addEventListener('click',()=>{i(),t(!1)}),o.addEventListener('click',()=>{i(),t(!0)}),s.addEventListener('click',e=>{e.target===s&&(i(),t(!1))});const l=e=>{'Escape'===e.key&&(i(),t(!1))};document.addEventListener('keydown',l)})}setState(e){if(this.state=e,this.modalContainer)switch(this.modalContainer.classList.remove('loading','processing','error'),e){case f.LOADING:this.modalContainer.classList.add('loading');break;case f.PROCESSING:this.modalContainer.classList.add('processing');break;case f.ERROR:this.modalContainer.classList.add('error')}if(this.summaryBtn)switch(this.summaryBtn.disabled=e===f.PROCESSING||e===f.LOADING,e){case f.PROCESSING:this.summaryBtn.innerHTML='\n            <span class="btn-text">处理中...</span>\n            <span class="btn-desc">正在生成总结</span>\n          ';break;case f.LOADING:this.summaryBtn.innerHTML='\n            <span class="btn-text">加载中...</span>\n            <span class="btn-desc">正在初始化</span>\n          ';break;case f.ERROR:this.summaryBtn.innerHTML='\n            <span class="btn-text">总结聊天内容</span>\n            <span class="btn-desc">点击重试</span>\n          ';break;default:this.summaryBtn.innerHTML='\n            <span class="btn-text">总结聊天内容</span>\n            <span class="btn-desc">对最新消息进行总结</span>\n          '}}getCurrentState(){return this.state}isModalVisible(){return this.isVisible}updateMigrationButtonState(){if(!this.migrationBtn)return;const e=this.chatMigrationManager.isFeatureEnabled(),t=this.migrationBtn.querySelector('.btn-status');t&&(t.textContent=e?'已启用':'已禁用'),e?(this.migrationBtn.classList.add('enabled'),this.migrationBtn.classList.remove('disabled')):(this.migrationBtn.classList.add('disabled'),this.migrationBtn.classList.remove('enabled'))}destroy(){this.hide(),this.chatSummaryService&&this.chatSummaryService.destroy(),this.extensionModal&&this.extensionModal.remove(),document.body.style.overflow='',console.log('[ExtensionSettingsManager] 组件已销毁')}}class T{state=u.nl.IDLE;isActive=!1;userInfoSection;settingsModal;globalUserManager;profileInterface;statusTimeElement;settingsButton;extensionSettingsButton;bottomNavItems;constructor(){this.globalUserManager=m.GlobalUserManager.getInstance(),this.initializeElements(),this.initializeComponents(),this.bindEvents()}initializeElements(){if(this.profileInterface=document.getElementById('profileInterface'),this.statusTimeElement=document.getElementById('profileStatusTime'),this.settingsButton=document.getElementById('settingsButton'),this.extensionSettingsButton=document.getElementById('extensionSettingsButton'),this.bottomNavItems=document.querySelectorAll('.bottom-nav-item'),!this.profileInterface)throw new Error('Profile interface element not found')}initializeComponents(){this.userInfoSection=new S,this.settingsModal=new C}bindEvents(){this.settingsButton.addEventListener('click',()=>this.openSettings()),this.extensionSettingsButton.addEventListener('click',()=>this.openExtensionSettings()),this.bottomNavItems.forEach(e=>{e.addEventListener('click',e=>this.handleBottomNavClick(e))}),document.addEventListener('visibilitychange',()=>this.handleVisibilityChange())}async initialize(){try{this.setState(u.nl.LOADING),await this.globalUserManager.initialize(),await this.userInfoSection.initialize(),await this.settingsModal.initialize(),this.updateStatusTime(),this.startTimeUpdater(),this.setState(u.nl.IDLE)}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'初始化我的页面失败',details:e,timestamp:Date.now()}),this.setState(u.nl.ERROR)}}show(){this.isActive||(this.profileInterface.classList.add('active'),this.isActive=!0,this.updateBottomNavState('profile'),this.updateStatusTime(),this.onPageShow())}hide(){this.isActive&&(this.profileInterface.classList.remove('active'),this.isActive=!1,this.settingsModal.hide(),this.onPageHide())}openSettings(){this.state===u.nl.IDLE&&this.settingsModal.show()}openExtensionSettings(){if(this.state!==u.nl.IDLE)return;L.getInstance().show()}handleBottomNavClick(e){const t=e.currentTarget.dataset.page;t&&'profile'!==t&&this.emitPageChangeEvent(t)}updateBottomNavState(e){this.bottomNavItems.forEach(t=>{t.dataset.page===e?t.classList.add('active'):t.classList.remove('active')})}updateStatusTime(){const e=(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',hour12:!1});this.statusTimeElement&&(this.statusTimeElement.textContent=e)}startTimeUpdater(){setInterval(()=>{this.isActive&&this.updateStatusTime()},6e4)}handleVisibilityChange(){!document.hidden&&this.isActive&&this.updateStatusTime()}onPageShow(){this.refreshUserInfo()}onPageHide(){this.saveCurrentState()}async refreshUserInfo(){try{await this.userInfoSection.initialize()}catch(e){console.warn('刷新用户信息失败:',e)}}saveCurrentState(){try{const e={timestamp:Date.now(),isActive:this.isActive};sessionStorage.setItem('profile_page_state',JSON.stringify(e))}catch(e){console.warn('保存页面状态失败:',e)}}restorePageState(){try{const e=sessionStorage.getItem('profile_page_state');if(e){const t=JSON.parse(e);console.log('恢复页面状态:',t)}}catch(e){console.warn('恢复页面状态失败:',e)}}emitPageChangeEvent(e){const t=new CustomEvent('pageChange',{detail:{from:'profile',to:e,timestamp:Date.now()}});document.dispatchEvent(t)}setState(e){switch(this.state=e,this.profileInterface.classList.remove('loading','error'),e){case u.nl.LOADING:this.profileInterface.classList.add('loading'),this.settingsButton.disabled=!0,this.extensionSettingsButton.disabled=!0;break;case u.nl.ERROR:this.profileInterface.classList.add('error'),this.settingsButton.disabled=!0,this.extensionSettingsButton.disabled=!0;break;case u.nl.IDLE:this.settingsButton.disabled=!1,this.extensionSettingsButton.disabled=!1}}handleError(e){console.error(`[ProfileInterface] ${e.message}:`,e.details),toastr.error(e.message)}getState(){return this.state}isPageActive(){return this.isActive}getUserInfoSection(){return this.userInfoSection}getSettingsModal(){return this.settingsModal}destroy(){this.userInfoSection.destroy(),this.settingsModal.destroy(),this.hide(),this.setState(u.nl.IDLE);try{sessionStorage.removeItem('profile_page_state')}catch(e){console.warn('清理会话存储失败:',e)}}async reload(){try{this.setState(u.nl.LOADING),await this.userInfoSection.initialize(),await this.settingsModal.initialize(),this.setState(u.nl.IDLE),toastr.success('页面重新加载成功')}catch(e){this.handleError({type:u.By.STORAGE_ERROR,message:'重新加载页面失败',details:e,timestamp:Date.now()}),this.setState(u.nl.ERROR)}}}let D=null;async function A(){if(D)return D;try{console.log('[Profile Module] 开始初始化...');const e=['profileInterface','profileStatusTime','settingsButton','extensionSettingsButton'];for(const t of e){if(!document.getElementById(t))throw new Error(`必需的DOM元素未找到: ${t}`);console.log(`[Profile Module] ✅ 找到元素: ${t}`)}return D=new T,await D.initialize(),console.log('[Profile Module] 初始化成功'),D}catch(e){throw console.error('[Profile Module] 初始化失败:',e),console.error('[Profile Module] 错误详情:',e.message,e.stack),e}}$(()=>{A().catch(e=>{console.error('[Profile Module] 自动初始化失败:',e)})}),$(window).on('unload',()=>{D&&(D.destroy(),D=null,console.log('[Profile Module] 已销毁'))});class k{static instance;storageManager;currentGlobalWallpaper='';individualWallpapers={};defaultWallpaper='https://files.catbox.moe/o84j4n.jpg';currentChatId='';constructor(){this.storageManager=v.StorageManager.getInstance(),this.initialize()}static getInstance(){return k.instance||(k.instance=new k),k.instance}initialize(){this.loadWallpaperFromSettings(),document.addEventListener('settingsChange',e=>{this.handleSettingsChange(e.detail.settings)}),document.addEventListener('characterChange',()=>{console.log('[ChatWallpaperManager] 检测到角色切换，重新加载壁纸'),this.forceRefresh()}),document.addEventListener('chatChange',e=>{const t=e.detail.chatId;console.log('[ChatWallpaperManager] 检测到聊天切换:',t),this.handleChatChange(t)}),document.addEventListener('globalChatWallpaperChange',e=>{const t=e.detail.wallpaperData;console.log('[ChatWallpaperManager] 检测到全局壁纸变更'),this.setGlobalWallpaper(t)}),document.addEventListener('clearGlobalChatWallpaper',()=>{console.log('[ChatWallpaperManager] 检测到清除全局壁纸'),this.clearGlobalWallpaper()}),document.addEventListener('applyWallpaperToAllChats',e=>{const t=e.detail.wallpaperData;console.log('[ChatWallpaperManager] 检测到应用壁纸到所有聊天框'),this.applyWallpaperToAll(t)})}loadWallpaperFromSettings(){try{const e=this.storageManager.loadSettings();this.currentGlobalWallpaper=e.globalChatWallpaper||'',this.individualWallpapers=e.individualChatWallpapers||{},console.log('[ChatWallpaperManager] 加载壁纸设置:',{globalWallpaper:this.currentGlobalWallpaper?'已设置':'未设置',individualCount:Object.keys(this.individualWallpapers).length})}catch(e){console.error('[ChatWallpaperManager] 加载壁纸设置失败:',e),this.currentGlobalWallpaper='',this.individualWallpapers={}}}handleSettingsChange(e){const t=e.globalChatWallpaper||'',a=e.individualChatWallpapers||{};let s=!1;t!==this.currentGlobalWallpaper&&(console.log('[ChatWallpaperManager] 检测到全局壁纸变更'),this.currentGlobalWallpaper=t,s=!0),JSON.stringify(a)!==JSON.stringify(this.individualWallpapers)&&(console.log('[ChatWallpaperManager] 检测到单独壁纸变更'),this.individualWallpapers=a,s=!0),s&&this.applyCurrentWallpaper()}handleChatChange(e){this.currentChatId=e,this.applyCurrentWallpaper()}applyCurrentWallpaper(){const e=document.getElementById('chatInterface'),t=document.querySelector('.chat-container'),a=document.getElementById('chatMessages'),s=e||t||a;if(!s)return console.warn('[ChatWallpaperManager] 未找到聊天界面元素，稍后重试'),void setTimeout(()=>{this.applyCurrentWallpaper()},100);const n=this.getCurrentWallpaperUrl();n?(s.style.backgroundImage=`url('${n}')`,s.style.backgroundSize='cover',s.style.backgroundPosition='center center',s.style.backgroundRepeat='no-repeat',s.style.backgroundAttachment='scroll',''!==s.style.position&&'static'!==s.style.position||(s.style.position='relative')):(s.style.backgroundImage='',s.style.backgroundSize='',s.style.backgroundPosition='',s.style.backgroundRepeat='',s.style.backgroundAttachment=''),console.log('[ChatWallpaperManager] 壁纸已应用到聊天界面:',n?'自定义壁纸':'无壁纸')}getCurrentWallpaperUrl(){return this.currentChatId&&this.individualWallpapers[this.currentChatId]?this.individualWallpapers[this.currentChatId]:this.currentGlobalWallpaper?this.currentGlobalWallpaper:''}setGlobalWallpaper(e){try{this.currentGlobalWallpaper=e;const t=this.storageManager.loadSettings();t.globalChatWallpaper=e,this.storageManager.saveSettings(t),this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] 全局聊天壁纸设置成功')}catch(e){throw console.error('[ChatWallpaperManager] 设置全局聊天壁纸失败:',e),e}}setIndividualWallpaper(e,t){try{this.individualWallpapers[e]=t;const a=this.storageManager.loadSettings();a.individualChatWallpapers={...this.individualWallpapers},this.storageManager.saveSettings(a),this.currentChatId===e&&this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] 单独聊天壁纸设置成功:',e)}catch(e){throw console.error('[ChatWallpaperManager] 设置单独聊天壁纸失败:',e),e}}removeIndividualWallpaper(e){try{delete this.individualWallpapers[e];const t=this.storageManager.loadSettings();t.individualChatWallpapers={...this.individualWallpapers},this.storageManager.saveSettings(t),this.currentChatId===e&&this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] 单独聊天壁纸已移除:',e)}catch(e){throw console.error('[ChatWallpaperManager] 移除单独聊天壁纸失败:',e),e}}clearGlobalWallpaper(){try{this.currentGlobalWallpaper='';const e=this.storageManager.loadSettings();e.globalChatWallpaper='',this.storageManager.saveSettings(e),this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] 全局聊天壁纸已清除')}catch(e){throw console.error('[ChatWallpaperManager] 清除全局聊天壁纸失败:',e),e}}applyWallpaperToAll(e){try{this.currentGlobalWallpaper=e,this.individualWallpapers={};const t=this.storageManager.loadSettings();t.globalChatWallpaper=e,t.individualChatWallpapers={},this.storageManager.saveSettings(t),this.applyCurrentWallpaper(),console.log('[ChatWallpaperManager] 壁纸已应用到所有聊天框')}catch(e){throw console.error('[ChatWallpaperManager] 全局更换壁纸失败:',e),e}}getCurrentGlobalWallpaper(){return this.currentGlobalWallpaper}getChatWallpaper(e){return this.individualWallpapers[e]||''}getAllIndividualWallpapers(){return{...this.individualWallpapers}}hasGlobalWallpaper(){return!!this.currentGlobalWallpaper}hasIndividualWallpaper(e){return!!this.individualWallpapers[e]}preloadWallpaper(e){return new Promise((t,a)=>{const s=new Image;s.onload=()=>{console.log('[ChatWallpaperManager] 壁纸预加载成功'),t()},s.onerror=e=>{console.error('[ChatWallpaperManager] 壁纸预加载失败:',e),a(e)},s.src=e})}forceRefresh(){console.log('[ChatWallpaperManager] 强制刷新壁纸'),this.loadWallpaperFromSettings(),this.applyCurrentWallpaper()}handleCharacterChange(){console.log('[ChatWallpaperManager] 处理角色切换，重新加载壁纸设置'),this.forceRefresh()}clearAllWallpaperCache(){try{this.currentGlobalWallpaper='',this.individualWallpapers={};const e=this.storageManager.loadSettings();e.globalChatWallpaper='',e.individualChatWallpapers={},this.storageManager.saveSettings(e);const t=document.getElementById('chatInterface'),a=document.querySelector('.chat-container'),s=document.getElementById('chatMessages'),n=t||a||s;n&&(n.style.backgroundImage=''),console.log('[ChatWallpaperManager] 所有壁纸缓存已清除')}catch(e){throw console.error('[ChatWallpaperManager] 清除壁纸缓存失败:',e),e}}setCurrentChatId(e){this.currentChatId!==e&&(this.currentChatId=e,this.applyCurrentWallpaper())}destroy(){document.removeEventListener('settingsChange',this.handleSettingsChange.bind(this)),document.removeEventListener('characterChange',this.handleCharacterChange.bind(this));const e=document.getElementById('chatInterface'),t=document.querySelector('.chat-container'),a=document.getElementById('chatMessages'),s=e||t||a;s&&(s.style.backgroundImage=''),console.log('[ChatWallpaperManager] 聊天壁纸管理器已销毁')}}class N{static STORAGE_KEY='bear_group_name_overrides';static CURRENT_VERSION='1.0.0';static CACHE_TTL=3e5;static cache=null;static cacheTimestamp=0;static memoryOverrides=null;static initialize(){try{this.migrateData(),console.log('✅ GroupNameOverrideManager 初始化完成')}catch(e){console.error('❌ GroupNameOverrideManager 初始化失败:',e)}}static saveGroupNameOverride(e,t){if(e&&t&&'string'==typeof t)try{const a=this.getGroupNameOverrides();a[e]=t.trim();const s={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:a};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),this.setCachedOverrides(a),console.log(`📝 已保存群名覆盖: ${e} -> ${t}`)}catch(a){this.handleStorageError(a,'save'),this.memoryOverrides=this.memoryOverrides||{},this.memoryOverrides[e]=t.trim(),console.log(`💾 已保存到内存: ${e} -> ${t}`)}else console.warn('⚠️ 无效的群名覆盖参数:',{groupId:e,newName:t})}static getGroupNameOverrides(){const e=this.getCachedOverrides();if(e)return{...e};try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e).overrides||{};return this.setCachedOverrides(t),{...t}}}catch(e){this.handleStorageError(e,'get')}return{...this.memoryOverrides||{}}}static getGroupNameOverride(e){return this.getGroupNameOverrides()[e]||null}static removeGroupNameOverride(e){try{const t=this.getGroupNameOverrides();if(!(e in t))return!1;delete t[e];const a={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:t};return localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),this.setCachedOverrides(t),this.memoryOverrides&&e in this.memoryOverrides&&delete this.memoryOverrides[e],console.log(`🗑️ 已移除群名覆盖: ${e}`),!0}catch(t){return this.handleStorageError(t,'remove'),!(!this.memoryOverrides||!(e in this.memoryOverrides))&&(delete this.memoryOverrides[e],console.log(`💾 已从内存移除: ${e}`),!0)}}static clearAllGroupNameOverrides(){try{localStorage.removeItem(this.STORAGE_KEY),this.clearCache(),this.memoryOverrides=null,console.log('🧹 已清除所有群名覆盖')}catch(e){this.handleStorageError(e,'clear')}}static applyOverridesToChatData(e){const t=this.getGroupNameOverrides();if(0===Object.keys(t).length)return;let a=0;for(const[s,n]of e)if('group'===n.type&&t[s]){const e=n.chatName;n.chatName=t[s],a++,console.log(`🔄 应用群名覆盖: ${e} -> ${n.chatName}`)}a>0&&console.log(`✅ 已应用 ${a} 个群名覆盖`)}static validateAndCleanOverrides(e){try{const t=this.getGroupNameOverrides(),a={};let s=!1;for(const[n,r]of Object.entries(t))e.includes(n)&&'string'==typeof r&&r.trim().length>0?a[n]=r:(s=!0,console.log(`🧹 清理无效的群名覆盖: ${n} -> ${r}`));if(s){const e={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:a};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),this.setCachedOverrides(a);const s=Object.keys(t).length-Object.keys(a).length;console.log(`🧹 已清理 ${s} 个无效的群名覆盖`)}}catch(e){this.handleStorageError(e,'validate')}}static batchUpdateOverrides(e){try{const t=this.getGroupNameOverrides();Object.assign(t,e);const a={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:t};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),this.setCachedOverrides(t),console.log(`📦 批量更新 ${Object.keys(e).length} 个群名覆盖`)}catch(t){this.handleStorageError(t,'batchUpdate'),this.memoryOverrides=this.memoryOverrides||{},Object.assign(this.memoryOverrides,e)}}static getDebugInfo(){return{storageKey:this.STORAGE_KEY,version:this.CURRENT_VERSION,cacheStatus:{hasCache:!!this.cache,cacheAge:this.cache?Date.now()-this.cacheTimestamp:0,cacheTTL:this.CACHE_TTL},overrideCount:Object.keys(this.getGroupNameOverrides()).length,storageSize:this.getStorageSize(),memoryFallback:!!this.memoryOverrides,memoryOverrideCount:this.memoryOverrides?Object.keys(this.memoryOverrides).length:0}}static hasOverrides(){const e=this.getGroupNameOverrides();return Object.keys(e).length>0}static hasOverride(e){return null!==this.getGroupNameOverride(e)}static getCachedOverrides(){const e=Date.now();return this.cache&&e-this.cacheTimestamp<this.CACHE_TTL?this.cache:null}static setCachedOverrides(e){this.cache={...e},this.cacheTimestamp=Date.now()}static clearCache(){this.cache=null,this.cacheTimestamp=0}static handleStorageError(e,t){if(console.warn(`⚠️ 群名覆盖存储操作失败 (${t}):`,e),'QuotaExceededError'===e.name&&(console.log('💾 存储配额超出，尝试清理旧数据...'),this.cleanupOldData()),'get'===t||'validate'===t)try{localStorage.removeItem(this.STORAGE_KEY),this.clearCache(),console.log('🧹 已清理损坏的覆盖数据')}catch(e){console.error('❌ 清理覆盖数据失败:',e)}}static cleanupOldData(){try{localStorage.removeItem(this.STORAGE_KEY),this.clearCache(),console.log('🧹 已清理旧的群名覆盖数据')}catch(e){console.error('❌ 清理旧数据失败:',e)}}static getStorageSize(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?new Blob([e]).size:0}catch{return-1}}static migrateData(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(!t.version){const e={version:this.CURRENT_VERSION,timestamp:Date.now(),overrides:'object'==typeof t?t:{}};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),console.log('🔄 已迁移群名覆盖数据到新版本')}}catch(e){console.error('❌ 数据迁移失败:',e),localStorage.removeItem(this.STORAGE_KEY)}}}var B=a(791);class _{modalData;contacts;onConfirm;onCancel;avatarMixin;constructor(e,t,a,s){this.modalData={selectedContactIds:e,settings:{name:'',avatar:'https://files.catbox.moe/u8ccy5.jpg',userJoins:!0}},this.contacts=t,this.onConfirm=a,this.onCancel=s,this.avatarMixin=new M.SimpleAvatarMixin({debug:!1})}async show(){console.log('🚀 [GroupChatModal] 开始显示群聊设置模态框...');const e=this.createModal(),t=document.querySelector('.interface-container');t?(t.appendChild(e),console.log('✅ [GroupChatModal] 模态框已添加到 interface-container')):(document.body.appendChild(e),console.log('✅ [GroupChatModal] 模态框已添加到 body')),setTimeout(()=>{e.classList.add('show'),console.log('✅ [GroupChatModal] 模态框显示动画已触发')},10),console.log('🏷️ [GroupChatModal] 生成默认群名...'),this.generateDefaultGroupName(),console.log('🔧 [GroupChatModal] 调试环境信息...');(new((await Promise.resolve().then(a.bind(a,791))).UserInfoRetrieval)).debugEnvironment(),console.log('🔄 [GroupChatModal] 开始异步更新用户信息...'),this.updateUserInfoAsync(),console.log('🖼️ [GroupChatModal] 初始化头像同步...'),this.initializeAvatarSync(),console.log('🔄 [GroupChatModal] 强制更新头像...'),this.avatarMixin.forceUpdate(),console.log('✅ [GroupChatModal] 群聊设置模态框显示完成')}createModal(){const e=document.createElement('div');e.className='modal-overlay group-chat-modal',e.id='groupChatModal';const t=this.getSelectedMembers(),a=this.getAllMembers();console.log('🏗️ [GroupChatModal] 创建模态框DOM:'),console.log('  - 选中成员数:',t.length),console.log('  - 总成员数:',a.length),console.log('  - 成员列表:',a.map(e=>`${e.name}(${e.id})`));const s=a.map(e=>(console.log(`🏷️ [GroupChatModal] 生成成员HTML: ${e.name} - 头像: ${e.avatar}`),`\n        <div class="member-tag" data-member-id="${e.id}">\n          <img src="${e.avatar}" class="member-avatar" alt="${e.name}" data-member-id="${e.id}">\n          <span>${e.name}</span>\n        </div>\n      `)).join('');return e.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-title">创建群聊</div>\n        \n        <div class="selected-members">\n          <div class="members-label" id="membersLabel">群聊成员 (${a.length}人)</div>\n          <div class="members-list" id="membersList">\n            ${s}\n          </div>\n        </div>\n\n        <div class="form-group">\n          <label class="form-label">群聊名称</label>\n          <input type="text" class="form-input" id="groupNameInput" placeholder="请输入群聊名称">\n        </div>\n\n        <div class="form-group">\n          <label class="form-label">群聊头像</label>\n          <div class="avatar-input-container">\n            <div class="avatar-input-group">\n              <input type="text" class="form-input" id="avatarUrlInput" placeholder="请输入头像URL" value="${this.modalData.settings.avatar}">\n              <button class="upload-btn" id="uploadAvatarBtn">上传</button>\n              <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">\n            </div>\n            <img src="${this.modalData.settings.avatar}" class="avatar-preview" id="avatarPreview" alt="群头像预览">\n          </div>\n        </div>\n\n        <div class="participation-group">\n          <label class="form-label">您的参与方式</label>\n          <div class="participation-options">\n            <div class="participation-option selected" data-value="member">\n              <div class="option-title">加入群聊</div>\n              <div class="option-desc">作为成员参与对话</div>\n            </div>\n            <div class="participation-option" data-value="observer">\n              <div class="option-title">观察模式</div>\n              <div class="option-desc">只能查看不能发言</div>\n            </div>\n          </div>\n        </div>\n\n        <div class="modal-buttons">\n          <button class="modal-btn cancel-btn">取消</button>\n          <button class="modal-btn create-btn">创建群聊</button>\n        </div>\n      </div>\n    `,this.bindEvents(e),e}bindEvents(e){const t=e.querySelector('#groupNameInput');t&&t.addEventListener('input',e=>{this.modalData.settings.name=e.target.value});const a=e.querySelector('#avatarUrlInput'),s=e.querySelector('#avatarPreview');a&&s&&(a.addEventListener('input',e=>{const t=e.target.value;this.modalData.settings.avatar=t,s.src=t}),s.addEventListener('error',()=>{s.src='https://files.catbox.moe/u8ccy5.jpg'}));const n=e.querySelector('#uploadAvatarBtn'),r=e.querySelector('#avatarFileInput');n&&r&&(n.addEventListener('click',()=>{r.click()}),r.addEventListener('change',e=>{const t=e.target.files?.[0];if(t)if(t.type.startsWith('image/')){const e=new FileReader;e.onload=e=>{const t=e.target?.result;this.modalData.settings.avatar=t,s&&(s.src=t),a&&(a.value='本地上传的图片')},e.readAsDataURL(t)}else toastr.error('请选择图片文件')}));const o=e.querySelectorAll('.participation-option');e.querySelector('#membersLabel');o.forEach(e=>{e.addEventListener('click',()=>{o.forEach(e=>e.classList.remove('selected')),e.classList.add('selected'),this.modalData.settings.userJoins='member'===e.getAttribute('data-value'),this.updateUserInfoAsync()})});const i=e.querySelector('.cancel-btn');i&&i.addEventListener('click',()=>{this.hide(),this.onCancel()});const l=e.querySelector('.create-btn');l&&l.addEventListener('click',()=>{this.validateSettings()&&(this.hide(),this.onConfirm(this.modalData.settings))}),e.addEventListener('click',t=>{t.target===e&&(this.hide(),this.onCancel())})}getSelectedMembers(){return this.contacts.filter(e=>this.modalData.selectedContactIds.includes(e.id))}getAllMembers(){const e=this.getSelectedMembers();if(this.modalData.settings.userJoins){const t=(0,B.getUserName)(),a=(0,B.getUserAvatar)();console.log('🔍 [GroupChatModal] 获取用户信息（同步）:'),console.log('  - 用户名:',t),console.log('  - 用户头像:',a);return[{id:'{{user}}',name:t,avatar:a},...e]}return e}async getAllMembersAsync(){const e=this.getSelectedMembers();if(this.modalData.settings.userJoins){const t=await(0,B.getUserNameAsync)(),a=(0,B.getUserAvatar)();console.log('🔍 [GroupChatModal] 获取用户信息（异步）:'),console.log('  - 用户名:',t),console.log('  - 用户头像:',a);return[{id:'{{user}}',name:t,avatar:a},...e]}return e}async updateUserInfoAsync(){try{console.log('🔄 [GroupChatModal] 开始异步更新用户信息...');const e=await this.getAllMembersAsync();console.log('📋 [GroupChatModal] 更新后的成员列表:'),e.forEach((e,t)=>{console.log(`  ${t+1}. ${e.name} (${e.id}) - 头像: ${e.avatar}`)});const t=document.querySelector('#membersLabel');t&&(t.textContent=`群聊成员 (${e.length}人)`,console.log('✅ [GroupChatModal] 已更新成员人数显示:',e.length));const a=document.querySelector('#membersList');if(a){const t=e.map(e=>`\n            <div class="member-tag" data-member-id="${e.id}">\n              <img src="${e.avatar}" class="member-avatar" alt="${e.name}" data-member-id="${e.id}">\n              <span>${e.name}</span>\n            </div>\n          `).join('');a.innerHTML=t,console.log('✅ [GroupChatModal] 已更新成员列表HTML')}this.generateDefaultGroupNameAsync()}catch(e){console.error('❌ [GroupChatModal] 异步更新用户信息失败:',e)}}generateDefaultGroupName(){const e=this.getAllMembers().map(e=>e.name);let t='';t=e.length<=3?e.join('、')+'的群聊':e.slice(0,2).join('、')+`等${e.length}人的群聊`,this.modalData.settings.name=t;const a=document.querySelector('#groupNameInput');a&&(a.value=t)}async generateDefaultGroupNameAsync(){try{const e=(await this.getAllMembersAsync()).map(e=>e.name);let t='';t=e.length<=3?e.join('、')+'的群聊':e.slice(0,2).join('、')+`等${e.length}人的群聊`,this.modalData.settings.name=t;const a=document.querySelector('#groupNameInput');a&&(a.value=t)}catch(e){console.log('❌ 异步生成默认群名失败:',e)}}validateSettings(){return this.modalData.settings.name.trim()?!!this.modalData.settings.avatar.trim()||(toastr.error('请设置群聊头像'),!1):(toastr.error('请输入群聊名称'),!1)}async initializeAvatarSync(){try{this.avatarMixin.autoRegister(),setTimeout(()=>{this.registerUserAvatarElements()},100),console.log('[GroupChatModal] 头像同步已初始化')}catch(e){console.error('[GroupChatModal] 头像同步初始化失败:',e)}}registerUserAvatarElements(){console.log('🔍 [GroupChatModal] 开始注册用户头像元素...');const e=document.querySelectorAll('.member-avatar');console.log(`🔍 [GroupChatModal] 找到 ${e.length} 个成员头像元素`);let t=0;e.forEach((e,a)=>{const s=e.closest('.member-tag');if(s){const n=s.getAttribute('data-member-id');console.log(`🔍 [GroupChatModal] 头像元素 ${a+1}: memberId = "${n}"`),'{{user}}'!==n&&'user'!==n||(this.avatarMixin.register(e,'img'),t++,console.log('✅ [GroupChatModal] 已注册用户头像元素:',{element:e,src:e.src,alt:e.alt}))}else console.log(`⚠️ [GroupChatModal] 头像元素 ${a+1} 没有找到 .member-tag 父元素`)}),console.log(`✅ [GroupChatModal] 头像注册完成，共注册 ${t} 个用户头像元素`)}hide(){this.avatarMixin.destroy();const e=document.getElementById('groupChatModal');e&&(e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}}var U=a(663);class R{contactManager=null;constructor(){console.log('🔧 GroupChatManager 已初始化')}setContactManager(e){this.contactManager=e,console.log('🔗 GroupChatManager 已连接到 ContactManager')}getContacts(){return this.contactManager?this.contactManager.getAllContacts().map(e=>({id:e.id,name:e.name,avatar:e.avatar})):(console.warn('⚠️ ContactManager 未设置，返回空联系人列表'),[])}createGroupChat(e){if(e.length<2)return void toastr.error('至少需要选择2个联系人才能创建群聊');const t=this.getContacts();new _(e,t,t=>this.handleGroupChatCreation(e,t),()=>console.log('用户取消了群聊创建')).show()}handleGroupChatCreation(e,t){try{let a=[...e];t.userJoins&&a.push('{{user}}');const s={id:U.GroupChatStorage.generateGroupId(t.name),name:t.name,avatar:t.avatar,members:a,userParticipation:t.userJoins?'member':'observer',createdAt:Date.now(),messages:[],type:'group'};try{U.GroupChatStorage.saveGroupChat(s),console.log('✅ 群聊数据已保存到localStorage')}catch(e){console.warn('⚠️ 保存群聊数据到localStorage失败，但继续执行:',e)}toastr.success(`群聊"${t.name}"创建成功！`,'创建成功'),this.emitChatChangedEvent(s),console.log('✅ 群聊创建成功:',s)}catch(e){console.error('创建群聊失败:',e),toastr.error('创建群聊失败，请重试')}}addToChatList(e){try{const t=this.getChatListData(),a={id:e.id,chatName:e.name,avatar:e.avatar,lastMessage:'群聊已创建',lastMessageTime:(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}),unreadCount:0,type:'group',members:e.members,userParticipation:e.userParticipation};t.unshift(a),this.saveChatListData(t),console.log('📋 群聊已添加到聊天列表')}catch(e){console.error('添加群聊到聊天列表失败:',e)}}getChatListData(){try{return(0,s.getCharacterItem)('chat_list',[])}catch(e){return console.error('读取聊天列表数据失败:',e),[]}}saveChatListData(e){try{(0,s.setCharacterItem)('chat_list',e),console.log('📋 聊天列表已保存到角色专用空间')}catch(e){console.error('保存聊天列表数据失败:',e)}}emitChatChangedEvent(e){try{const t=new CustomEvent('chatListChanged',{detail:{type:'groupChatCreated',groupChatData:e}});document.dispatchEvent(t),'function'==typeof eventEmit&&eventEmit('CHAT_LIST_CHANGED')}catch(e){console.error('触发聊天变化事件失败:',e)}}getAllGroupChats(){return U.GroupChatStorage.getAllGroupChats()}getGroupChatById(e){return U.GroupChatStorage.getGroupChatById(e)}deleteGroupChat(e){const t=U.GroupChatStorage.deleteGroupChat(e);return t&&this.emitChatChangedEvent(),t}}var G=a(8);class O{sounds=new Map;isEnabled=!0;volume=1;loadingPromises=new Map;transferResponses=new Map;SOUND_CONFIG={click:'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',send:'https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3',emoji:'https://files.catbox.moe/gb0so5.mp3',bubble:'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',avatar:'https://assets.mixkit.co/active_storage/sfx/2575/2575-preview.mp3',notification:'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3',typing:'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',error:'https://assets.mixkit.co/active_storage/sfx/2577/2577-preview.mp3',newMessage:'https://files.catbox.moe/b4amzm.mp3'};constructor(){this.preloadAllSounds(),this.loadUserPreferences()}async preloadAllSounds(){const e=[];for(const[t,a]of Object.entries(this.SOUND_CONFIG)){const s=this.loadSound(t,a);this.loadingPromises.set(t,s),e.push(s)}try{await Promise.all(e),console.log('所有音效预加载完成')}catch(e){console.warn('部分音效预加载失败:',e)}}async loadSound(e,t){return new Promise((a,s)=>{const n=new Audio(t);n.volume=this.volume,n.preload='auto';const r=()=>{this.sounds.set(e,n),n.removeEventListener('canplaythrough',r),n.removeEventListener('error',o),a()},o=s=>{console.warn(`音效加载失败: ${e} - ${t}`,s),n.removeEventListener('canplaythrough',r),n.removeEventListener('error',o),a()};n.addEventListener('canplaythrough',r),n.addEventListener('error',o),n.load()})}async playSound(e,t={}){if(this.isEnabled)try{const a=this.loadingPromises.get(e);a&&await a;const s=this.sounds.get(e);if(!s)return void console.warn(`音效不存在: ${e}`);s.currentTime=0,s.volume=void 0!==t.volume?t.volume:this.volume,s.loop=t.loop||!1,await s.play()}catch(t){console.warn(`音效播放失败: ${e}`,t),this.handlePlaybackError(e,t)}}stopSound(e){const t=this.sounds.get(e);t&&(t.pause(),t.currentTime=0)}stopAllSounds(){for(const e of this.sounds.values())e.pause(),e.currentTime=0}setVolume(e){this.volume=Math.max(0,Math.min(1,e));for(const e of this.sounds.values())e.volume=this.volume;this.saveUserPreferences()}getVolume(){return this.volume}setEnabled(e){this.isEnabled=e,e||this.stopAllSounds(),this.saveUserPreferences()}isEnabledState(){return this.isEnabled}isSoundLoaded(e){return this.sounds.has(e)}getAvailableSounds(){return Object.keys(this.SOUND_CONFIG)}handlePlaybackError(e,t){const a=`sound_error_${e}`,s=parseInt(localStorage.getItem(a)||'0')+1;localStorage.setItem(a,s.toString()),s>5&&console.warn(`音效 ${e} 错误次数过多，建议检查音频文件`)}loadUserPreferences(){try{const e=localStorage.getItem('sound_volume');null!==e&&(this.volume=parseFloat(e));const t=localStorage.getItem('sound_enabled');null!==t&&(this.isEnabled='true'===t)}catch(e){console.warn('加载音效偏好设置失败:',e)}}saveUserPreferences(){try{localStorage.setItem('sound_volume',this.volume.toString()),localStorage.setItem('sound_enabled',this.isEnabled.toString())}catch(e){console.warn('保存音效偏好设置失败:',e)}}destroy(){this.stopAllSounds(),this.sounds.clear(),this.loadingPromises.clear()}}class x{currentScale=1;MIN_SCALE=.8;MAX_SCALE=1.5;STEP=.1;STORAGE_KEY='ui-scale';constructor(){this.loadScale(),this.initializeScaleControl()}setScale(e){e=Math.max(this.MIN_SCALE,Math.min(this.MAX_SCALE,e)),e=Math.round(10*e)/10,this.currentScale=e,document.documentElement.style.setProperty('--scale-factor',e.toString()),this.updateSliderProgress(e),this.updateScaleDisplay(e),this.saveScale(),console.log(`🔍 界面缩放已设置为: ${Math.round(100*e)}%`)}getCurrentScale(){return this.currentScale}loadScale(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=parseFloat(e);if(!isNaN(t)&&t>=this.MIN_SCALE&&t<=this.MAX_SCALE)return void this.setScale(t)}}catch(e){console.warn('加载缩放设置失败:',e)}this.setScale(1)}saveScale(){try{localStorage.setItem(this.STORAGE_KEY,this.currentScale.toString())}catch(e){console.warn('保存缩放设置失败:',e)}}initializeScaleControl(){'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>this.setupScaleControl()):this.setupScaleControl()}setupScaleControl(){const e=document.getElementById('scaleSlider');e?(e.value=this.currentScale.toString(),this.updateSliderProgress(this.currentScale),this.updateScaleDisplay(this.currentScale),e.addEventListener('input',this.handleSliderInput),e.addEventListener('change',this.handleSliderChange)):setTimeout(()=>this.setupScaleControl(),100)}updateSliderProgress(e){const t=(e-this.MIN_SCALE)/(this.MAX_SCALE-this.MIN_SCALE)*100,a=document.getElementById('scaleSlider');a&&a.style.setProperty('--progress',`${t}%`)}updateScaleDisplay(e){const t=document.getElementById('scaleValue');t&&(t.textContent=`${Math.round(100*e)}%`)}resetScale(){this.setScale(1)}destroy(){const e=document.getElementById('scaleSlider');e&&(e.removeEventListener('input',this.handleSliderInput),e.removeEventListener('change',this.handleSliderChange))}handleSliderInput=e=>{const t=e.target,a=parseFloat(t.value);this.setScale(a)};handleSliderChange=()=>{}}class P{currentSpeed=1;MIN_SPEED=1;MAX_SPEED=4;STORAGE_KEY='typing-speed';SPEED_CONFIG={1:{name:'正常',typingTime:[1e3,3e3],messageDelay:[500,1500]},2:{name:'快速',typingTime:[200,1e3],messageDelay:[200,500]},3:{name:'瞬间',typingTime:0,messageDelay:[500,1e3],noTyping:!0},4:{name:'全部',typingTime:0,messageDelay:0,showAll:!0}};constructor(){this.loadSpeed(),this.initializeSpeedControl()}setSpeed(e){e=Math.max(this.MIN_SPEED,Math.min(this.MAX_SPEED,Math.round(e))),this.currentSpeed=e,this.updateSliderProgress(e),this.updateSpeedDisplay(e),this.saveSpeed(),console.log(`⚡ 打字速度已设置为: ${this.SPEED_CONFIG[e].name}`)}getCurrentSpeedConfig(){return this.SPEED_CONFIG[this.currentSpeed]}getCurrentSpeed(){return this.currentSpeed}getTypingTime(){const e=this.SPEED_CONFIG[this.currentSpeed];if(0===e.typingTime)return 0;const[t,a]=e.typingTime;return Math.floor(Math.random()*(a-t+1)+t)}getMessageDelay(){const e=this.SPEED_CONFIG[this.currentSpeed];if(0===e.messageDelay)return 0;const[t,a]=e.messageDelay;return Math.floor(Math.random()*(a-t+1)+t)}shouldShowAll(){return this.SPEED_CONFIG[this.currentSpeed].showAll||!1}shouldSkipTyping(){return this.SPEED_CONFIG[this.currentSpeed].noTyping||!1}loadSpeed(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=parseInt(e);if(!isNaN(t)&&t>=this.MIN_SPEED&&t<=this.MAX_SPEED)return void this.setSpeed(t)}}catch(e){console.warn('加载打字速度设置失败:',e)}this.setSpeed(1)}saveSpeed(){try{localStorage.setItem(this.STORAGE_KEY,this.currentSpeed.toString())}catch(e){console.warn('保存打字速度设置失败:',e)}}initializeSpeedControl(){'loading'===document.readyState?document.addEventListener('DOMContentLoaded',()=>this.setupSpeedControl()):this.setupSpeedControl()}setupSpeedControl(){const e=document.getElementById('typingSpeedSlider');e?(e.value=this.currentSpeed.toString(),this.updateSliderProgress(this.currentSpeed),this.updateSpeedDisplay(this.currentSpeed),e.addEventListener('input',this.handleSpeedSliderInput),e.addEventListener('change',this.handleSpeedSliderChange)):setTimeout(()=>this.setupSpeedControl(),100)}updateSliderProgress(e){const t=(e-this.MIN_SPEED)/(this.MAX_SPEED-this.MIN_SPEED)*100,a=document.getElementById('typingSpeedSlider');a&&a.style.setProperty('--typing-progress',`${t}%`)}updateSpeedDisplay(e){const t=document.getElementById('typingSpeedValue');t&&(t.textContent=this.SPEED_CONFIG[e].name)}handleSpeedSliderInput=e=>{const t=e.target,a=parseInt(t.value);this.setSpeed(a)};handleSpeedSliderChange=()=>{};resetSpeed(){this.setSpeed(1)}destroy(){const e=document.getElementById('typingSpeedSlider');e&&(e.removeEventListener('input',this.handleSpeedSliderInput),e.removeEventListener('change',this.handleSpeedSliderChange))}}class W{MAIN_REGEX=/<bear>([\s\S]*?)<\/bear>/g;MESSAGE_REGEX=/\[([SG])_[^|]*\|[^|]*\|[^|]*\|[^\]]*\]/g;CHAT_BLOCK_REGEX=/\[([^\/][^\]]*?)\]([\s\S]*?)\[\/\1\]/g;GROUP_CHAT_REGEX=/\[群聊([^\]]+)\]\s*\n?\s*\[成员[：:]([^\]]+)\]\s*\n?([\s\S]*?)\n?\s*\[\/群聊\1\]/g;GROUP_MESSAGE_REGEX=/\[G_[^|]*\|([^|]+)\|([^|]+)\|([^\]]+)\]/g;MEMBER_LIST_REGEX=/\[成员[：:]([^\]]+)\]/;MESSAGE_TYPE_REGEX=/^([^：:]+)[：:](.*)$/;contactManager;validator;errorStats;constructor(e){this.contactManager=e,this.validator=new q,this.errorStats=new z}normalizeColons(e){return e.replace(/：/g,':')}parseMessageTypeAndContent(e){const t=e.match(this.MESSAGE_TYPE_REGEX);return t?{type:t[1],content:t[2]}:{type:'text',content:e}}async parseBearContent(e){const t=new Map;(await this.parseGroupChats(e)).forEach(e=>{t.set(e.chatId,e)});return this.parseSingleChats(e).forEach(e=>{t.set(e.chatId,e)}),t}async parseGroupChats(e){const t=[],a=[...e.matchAll(this.GROUP_CHAT_REGEX)];for(const e of a){const a=e[1],s=e[2],n=e[3],r=this.normalizeColons(n),o=await this.buildGroupChatData(a,s,r);o&&t.push(o)}return t}parseSingleChats(e){const t=[];let a=e;const s=[...e.matchAll(this.GROUP_CHAT_REGEX)];for(const e of s)a=a.replace(e[0],'');const n=[...a.matchAll(this.CHAT_BLOCK_REGEX)];if(0===n.length)return console.warn('没有匹配到任何聊天块'),t;for(let e=0;e<n.length;e++){const a=n[e],s=a[1],r=a[2],o=this.generateChatId(s),i={chatId:o,chatName:s,avatar:this.getDefaultAvatar(s),messages:[]},l=this.parseMessages(r,o);i.messages=l,l.length>0&&(i.lastMessage=l[l.length-1].content),t.push(i)}return t}generateGroupChatId(e){return e.startsWith('群聊')?e:`群聊${e}`}async buildGroupChatData(e,t,s){try{const n=this.parseGroupMembers(t),r=this.parseGroupMessages(s,e),o=this.generateGroupChatId(e),{GroupChatStorage:i}=await Promise.resolve().then(a.bind(a,663)),l=i.getDefaultGroupAvatar(e),c={chatId:o,chatName:e,avatar:i.getGroupAvatarWithFallback(o,l),messages:r,lastMessage:r.length>0?this.formatGroupLastMessage(r[r.length-1]):'',type:'group',members:n.map(e=>({id:e,name:e,avatar:this.getDefaultAvatar(e),role:'{{user}}'===e||'user'===e?'owner':'member',joinedAt:(new Date).toISOString()}))};return console.log(`✅ 解析群聊成功: ${c.chatName}, chatId: ${o}, 成员: ${n.length}, 消息: ${r.length}`),c}catch(t){return console.error(`❌ 解析群聊失败: ${e}`,t),null}}parseGroupMembers(e){return this.normalizeColons(e).split(/[，,]/).map(e=>e.trim()).filter(e=>e.length>0)}parseGroupMessages(e,t){const a=[],s=[...e.matchAll(this.GROUP_MESSAGE_REGEX)];for(const e of s){const s=this.parseGroupMessage(e,t);s&&a.push(s)}return a}parseGroupMessage(e,t){try{const a=e[0],s=a.slice(1,-1).split('|');if(s.length<4)return console.warn('群聊消息格式无效 (部分太少):',a),null;s[0].split('_')[0];const n=s[1],r=s[2]||'',o=s[3],{type:i,content:l}=this.parseMessageTypeAndContent(r);let c=l,h='';if('transfer'===i)5===s.length?(h=s[3],c=`${l}|${h}`):(h='等待接收',c=`${l}|等待接收`);else if('voice'===i)if(5===s.length){c=`${l}|${s[3]||'0'}`}else c=`${l}|0`;return{id:this.generateMessageId(),type:'G',chatId:this.generateGroupChatId(t),sender:n||'未知用户',avatar:this.getDefaultAvatar(n),messageType:i,content:c,timestamp:o||(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}),senderDisplayName:n,...'transfer'===i?{data:{originalNote:h}}:{}}}catch(t){return console.error('解析群聊消息时出错:',t,e),null}}parseMessages(e,t){const a=[],s=[...e.matchAll(this.MESSAGE_REGEX)];if(0===s.length)return console.warn(`没有匹配到任何消息: ${t}`),a;for(const e of s){const s=this.parseMessage(e,t);s&&a.push(s)}return a}parseMessage(e,t){try{const a=e[0],s=a.slice(1,-1).split('|');if(s.length<4)return console.warn('消息格式无效 (部分太少):',a),null;const n=s[0].split('_')[0],r=s[1],o=s[s.length-1],i=5===s.length;let l='text',c='',h='';const d=s[2]||'';if(d.startsWith('transfer:'))if(l='transfer',i){const e=d.substring(9),t=s[3]||'等待接收';h=t,c=`${e}|${t}`}else{const e=d.substring(9);h='等待接收',c=`${e}|等待接收`}else if(d.startsWith('voice:'))if(l='voice',i){const e=d.substring(6);c=`${e}|${s[3]||'0'}`}else{c=`${d.substring(6)}|0`}else if(d.includes(':')){const[e,...t]=d.split(':');l=e,c=t.join(':')}else l='text',c=d;return{id:this.generateMessageId(),type:n,chatId:t,sender:r||'未知用户',avatar:this.getDefaultAvatar(r),messageType:l,content:c,timestamp:o||(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'}),...'transfer'===l?{data:{originalNote:h}}:{}}}catch(t){return console.error('解析消息时出错:',t,e),null}}extractBearContent(e){for(const t of e){const e=(t.message||'').match(this.MAIN_REGEX);if(e&&e[0])return e[0]}return console.warn('未找到Bear内容'),null}isValidMessageType(e){return!!['text','image','voice','sticker','location','transfer'].includes(e)||!!e.startsWith('transfer:')&&/^transfer:\d+(?:\.\d+)?$/.test(e)}getDefaultAvatar(e){if('{{user}}'===e||'user'===e)return(0,G.oE)();if(this.contactManager){const t=this.contactManager.getAllContacts().find(t=>t.name===e);if(t&&t.avatar)return t.avatar}return'https://files.catbox.moe/u8ccy5.jpg'}processImageUrl(e){if(!e)return'';if(e.startsWith('http://')||e.startsWith('https://'))return e;if(e.startsWith('data:image/'))return e;if(e.startsWith('temp://')){const t=e.replace('temp://',''),a=localStorage.getItem(`temp_image_${t}`);return a||(console.warn('临时图片数据未找到:',t),'')}const t=e.match(/([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);if(t){return`https://files.catbox.moe/${t[1]}`}return`https://files.catbox.moe/${e}`}generateMessageId(){return'msg_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}handleParseError(e,t){console.error(`群聊解析错误 [${t}]:`,e),this.errorStats.increment(`parse_error_${t}`),document.dispatchEvent(new CustomEvent('groupChatParseError',{detail:{error:e,context:t}}))}validateGroupFormat(e){const t=/\[群聊[^\]]+\]/.test(e),a=/\[成员[：:][^\]]+\]/.test(e),s=/\[\/群聊[^\]]+\]/.test(e);return t&&a&&s}getErrorStats(){return this.errorStats.getStats()}resetErrorStats(){this.errorStats.reset()}buildBearContent(e){let t='<bear>\n';for(const[,a]of e)if('group'===a.type)t+=this.buildGroupChatBlock(a);else{t+=`[${a.chatName}]\n`;for(const e of a.messages){t+=this.buildMessageString(e)+'\n'}t+=`[/${a.chatName}]\n`}return t+='</bear>',t}buildSingleChatBearContent(e){const t=new Map;t.set(e.chatId,e);const a=this.buildBearContent(t),s=a.match(/<bear>([\s\S]*?)<\/bear>/);return s&&s[1]?`<bear>${s[1]}</bear>`:a}buildGroupChatBlock(e){if('group'!==e.type)return'';const t=e.chatName;let a=`[群聊${t}]\n`;a+=`[成员：${(e.members||[]).map(e=>e.name).join('，')}]\n`;for(const t of e.messages){const e=this.buildGroupMessageString(t);e&&(a+=e+'\n')}return a+=`[/群聊${t}]\n`,a}buildGroupMessageString(e){if('G'!==e.type)return'';const t=e.chatId.replace(/^群聊/,'');let a='';return a='text'===e.messageType?e.content:`${e.messageType}:${e.content}`,`[G_${t}|${e.sender}|${a}|${e.timestamp}]`}buildMessageString(e){return`[${e.type}_${e.chatId}|${e.sender}|${e.messageType}:${e.content}|${e.timestamp}]`}formatLastMessage(e){const t='{{user}}'===e.sender?'我':e.sender;let a='';switch(e.messageType){case'text':default:a=e.content;break;case'image':a='[图片]';break;case'voice':a='[语音]';break;case'sticker':a='[表情包]';break;case'location':a='[位置]';break;case'transfer':a='[转账]'}return`${t}: ${a}`}formatGroupLastMessage(e){const t='{{user}}'===e.sender?'我':e.senderDisplayName||e.sender;let a='';switch(e.messageType){case'text':default:a=e.content;break;case'image':a='[图片]';break;case'voice':a='[语音]';break;case'sticker':a='[表情包]';break;case'location':a='[位置]';break;case'transfer':a='[转账]'}return`${t}: ${a}`}generateChatId(e){return e.replace(/\s+/g,'_').toLowerCase()}generateMessageId(){return'msg_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}}class F{currentChat='';chatData=new Map;avatarMixin;sendQueue=[];currentInterface='list';messageParser;soundManager;isMenuVisible=!1;isStickerSelectorVisible=!1;isRenderingMessages=!1;shouldStopRendering=!1;isSending=!1;crossChatSendEnabled=!1;stickerData=[];stickerOrder={};stickerLorebookName='';stickerCache=new Map;stickerSelectorClickOutsideHandler=null;isDeleteMode=!1;selectedStickers=new Set;isBatchDeleteMode=!1;selectedMessages=new Set;batchDeleteToolbar=null;characterChangeTimeout=null;isSuggestionVisible=!1;suggestionContainer=null;inputChangeTimer=null;lastBearContent='';chatListManager;groupChatManager;profileInterface=null;settingsModal;chatWallpaperManager;scaleManager;typingSpeedManager;constructor(){this.soundManager=new O,this.scaleManager=new x,this.typingSpeedManager=new P,this.groupChatManager=new R,this.chatListManager=new g(this.soundManager,this.groupChatManager,this.messageParser),this.groupChatManager.setContactManager(this.chatListManager.getContactManager()),this.messageParser=new W(this.chatListManager.getContactManager()),this.avatarMixin=new M.SimpleAvatarMixin({debug:!1}),this.initializeApplication().catch(e=>{console.error('❌ 应用初始化失败:',e)})}async initializeApplication(){console.log('🚀 应用初始化开始...'),this.initializeEventListeners(),await m.GlobalUserManager.getInstance().initialize(),await this.initializeProfileModule(),this.initializeExtensionsModule(),this.initializeChatMigrationManager(),await this.initializeChatWallpaperManager(),await this.initializeStickerSystem(),await this.initializeGroupNameOverrideManager(),this.initializeFromExistingData(),this.initializeChatListEvents(),this.initializeAvatarSync(),console.log('应用初始化完成'),console.log('🎯 [主应用] 应用初始化完成，准备触发聊天迁移检查'),await this.triggerChatMigrationCheck()}initializeAvatarSync(){try{const e=m.GlobalUserManager.getInstance(),t=e.getCurrentUserData();if(t?.isCustom&&t.avatar){console.log('[BearChatManager] 发现自定义头像，立即同步:',t.avatar);const{forceUpdateAvatars:e}=a(534);e(t.avatar)}this.avatarMixin.autoRegister(),this.avatarMixin.forceUpdate(),e.addEventListener('avatar',e=>{console.log('[BearChatManager] 检测到头像变更，同步到所有地方:',e.newValue);const{forceUpdateAvatars:t}=a(534);t(e.newValue)}),console.log('[BearChatManager] 头像同步已初始化')}catch(e){console.error('[BearChatManager] 头像同步初始化失败:',e)}}async getCurrentLorebook(){try{let e=null;console.log('📖 尝试获取角色主要世界书...');try{'function'==typeof getCurrentCharPrimaryLorebook?(console.log('✅ 全局函数 getCurrentCharPrimaryLorebook 可用'),e=getCurrentCharPrimaryLorebook(),console.log('📖 角色主要世界书获取结果:',JSON.stringify(e))):console.log('❌ 全局函数 getCurrentCharPrimaryLorebook 不可用')}catch(e){console.log(`❌ 获取角色世界书异常: ${e}`)}if(e)return console.log('✅ 使用角色主要世界书:',e),e;console.log('🌍 尝试获取全局世界书...');try{if('function'==typeof getLorebookSettings){console.log('✅ 全局函数 getLorebookSettings 可用');const e=getLorebookSettings();console.log('🌍 全局世界书设置:',e);const t=e.selected_global_lorebooks;if(t&&t.length>0)return console.log('✅ 使用全局世界书:',t[0]),t[0];console.log('❌ 没有启用的全局世界书')}else console.log('❌ 全局函数 getLorebookSettings 不可用')}catch(e){console.log(`❌ 获取全局世界书异常: ${e}`)}return console.warn('❌ 没有找到可用的世界书'),null}catch(e){return console.error('❌ 获取世界书失败:',e),null}}initializeEventListeners(){$(()=>{this.setupEventListeners()})}setupEventListeners(){const e=document.getElementById('plusBtn'),t=document.getElementById('plusMenu');e&&t&&e.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation(),this.togglePlusMenu(),this.soundManager.playSound('emoji')});document.querySelectorAll('.menu-item').forEach(e=>{e.addEventListener('click',e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.type;t&&this.handleMenuItemClick(t)})});const a=document.getElementById('inputField');a&&(a.addEventListener('keypress',e=>{'Enter'===e.key&&this.handleEnterKey()}),a.addEventListener('input',e=>{this.handleInputChange(e)}),a.addEventListener('blur',()=>{setTimeout(()=>{this.hideStickerSuggestions()},200)}));const s=document.getElementById('sendBtn');s&&s.addEventListener('click',()=>{this.handleSendClick()});const n=document.querySelector('.home-btn'),r=document.querySelector('.diary-btn'),o=document.querySelector('.call-btn');n&&n.addEventListener('click',()=>{this.showChatList(),this.soundManager.playSound('click')}),r&&r.addEventListener('click',()=>{this.showDiaryInterface(),this.soundManager.playSound('click')}),o&&o.addEventListener('click',()=>{this.showCallInterface(),this.soundManager.playSound('click')});const i=document.getElementById('headerAvatar');i&&i.addEventListener('click',async()=>{await this.handleAvatarClick(),this.soundManager.playSound('avatar')}),document.addEventListener('click',a=>{const s=a.target,n=document.getElementById('stickerSelector');setTimeout(()=>{e?.contains(s)||t?.contains(s)||n?.contains(s)||this.hidePlusMenu()},0)}),this.initializeDoubleClickHandlers(),document.addEventListener('showProfilePage',e=>{const t=e;console.log('📱 接收到显示个人主页事件:',t.detail),this.handleShowProfilePage(t.detail)}),this.initializeBottomNavigation(),this.initializeCharacterChangeListener(),this.initializeSettings().catch(e=>{console.error('设置初始化失败:',e)})}initializeCharacterChangeListener(){const e=this.getCurrentCharacterId();console.log(`🔄 角色切换监听已初始化，当前角色: ${e}`);try{'undefined'!=typeof eventSource&&eventSource.on&&(eventSource.on('CHARACTER_CHANGED',()=>{console.log('🔄 检测到角色切换事件 (CHARACTER_CHANGED)'),this.handleCharacterChange()}),console.log('✅ 已监听 CHARACTER_CHANGED 事件')),document.addEventListener('characterChanged',()=>{console.log('🔄 检测到角色切换事件 (characterChanged)'),this.handleCharacterChange()}),document.addEventListener('character_loaded',()=>{console.log('🔄 检测到角色加载事件 (character_loaded)'),this.handleCharacterChange()}),console.log('✅ 角色切换事件监听已设置')}catch(e){console.error('设置角色切换监听失败:',e)}}getCurrentCharacterId(){try{if('undefined'!=typeof TavernHelper&&TavernHelper.getCharData){const e=TavernHelper.getCharData();if(e)return e.name||e.avatar||'default'}if('function'==typeof getCharData){const e=getCharData();if(e)return e.name||e.avatar||'default'}return'default'}catch(e){return console.error('获取角色ID失败:',e),'default'}}handleCharacterChange(){this.characterChangeTimeout&&clearTimeout(this.characterChangeTimeout),this.characterChangeTimeout=setTimeout(async()=>{console.log('🔄 处理角色切换，重新加载联系人数据...');try{const{clearCharacterIdCache:e}=a(832);e()}catch(e){console.error('清除角色ID缓存失败:',e)}await this.chatListManager.reloadContacts();try{const{WallpaperManager:e}=await Promise.resolve().then(a.bind(a,790));e.getInstance().handleCharacterChange(),console.log('🖼️ 聊天列表壁纸设置已重新加载')}catch(e){console.error('重新加载聊天列表壁纸设置失败:',e)}try{this.chatWallpaperManager&&(this.chatWallpaperManager.handleCharacterChange(),console.log('🖼️ 聊天窗口壁纸设置已重新加载'))}catch(e){console.error('重新加载聊天窗口壁纸设置失败:',e)}const e=document.getElementById('chatListInterface');e&&e.classList.contains('active')&&(console.log('📋 刷新聊天列表显示'),this.chatListManager.refreshChatList()),console.log('✅ 角色切换处理完成')},300)}initializeBottomNavigation(){document.querySelectorAll('.bottom-nav-item').forEach(e=>{e.addEventListener('click',e=>{const t=e.currentTarget.dataset.page;t&&(this.switchToPage(t),this.soundManager.playSound('click'))})}),document.addEventListener('pageChange',e=>{const t=e,{to:a}=t.detail;this.switchToPage(a)})}async initializeSettings(){try{const{StorageManager:e}=await Promise.resolve().then(a.bind(a,52)),t=e.getInstance().loadSettings();this.crossChatSendEnabled=t.crossChatSendEnabled,console.log('🔄 跨聊天发送设置已加载:',this.crossChatSendEnabled)}catch(e){console.error('加载跨聊天发送设置失败:',e),this.crossChatSendEnabled=!1}document.addEventListener('settingsUpdated',e=>{const{crossChatSendEnabled:t}=e.detail;'boolean'==typeof t&&(this.crossChatSendEnabled=t,console.log('🔄 跨聊天发送设置已同步:',t))})}switchToPage(e){switch(console.log(`🔄 切换到页面: ${e}`),this.hideAllInterfaces(),this.updateBottomNavState(e),e){case'chat-list':this.showChatList();break;case'dynamics':console.log('动态页面暂未实现');break;case'profile':this.showProfileInterface();break;default:console.warn(`未知页面: ${e}`)}}hideAllInterfaces(){const e=document.getElementById('chatInterface');e&&(e.style.display='none'),this.chatListManager.hideChatListInterface(),this.profileInterface&&this.profileInterface.hide()}updateBottomNavState(e){document.querySelectorAll('.bottom-nav-item').forEach(t=>{t.dataset.page===e?t.classList.add('active'):t.classList.remove('active')})}showProfileInterface(){if(console.log('👤 准备显示个人主页界面...'),this.profileInterface)try{this.profileInterface.show(),console.log('✅ 个人主页界面显示成功')}catch(e){console.error('显示个人主页界面失败:',e),this.soundManager.playSound('error'),this.switchToPage('chat-list')}else console.error('❌ 我的页面模块未初始化'),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('个人主页模块未初始化，请刷新页面重试'),this.switchToPage('chat-list')}handleShowProfilePage(e){console.log(`👤 显示个人主页 - 来源: ${e.source}`);try{this.soundManager.playSound('click'),this.switchToPage('profile')}catch(e){console.error('显示个人主页失败:',e),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('无法打开个人主页，请稍后重试')}}async clearLorebookCharacterCache(){try{const e=this.chatListManager.getContactManager(),t=await e.clearLorebookCharacterCache();return console.log(`🗑️ [BearChatManager] 世界书角色缓存清除完成: ${t.cleared}/${t.total}`),this.soundManager.playSound('success'),'undefined'!=typeof toastr&&(t.cleared>0?toastr.success(`已清除 ${t.cleared} 个世界书角色的缓存`):t.total>0?toastr.info(`世界书中有 ${t.total} 个角色，但没有自定义头像缓存需要清除`):toastr.info('世界书中没有找到联系人')),t}catch(e){return console.error('❌ [BearChatManager] 清除世界书角色缓存失败:',e),this.soundManager.playSound('error'),'undefined'!=typeof toastr&&toastr.error('清除世界书角色缓存失败，请稍后重试'),{cleared:0,total:0}}}getLorebookCacheStats(){try{return this.chatListManager.getContactManager().getLorebookCacheStats()}catch(e){return console.error('❌ [BearChatManager] 获取世界书缓存统计失败:',e),{worldbookContacts:0,cachedContacts:0,cachedWorldbookContacts:0}}}initializeFromExistingData(){if('function'==typeof getChatMessages)try{const e=getChatMessages('0-{{lastMessageId}}');this.parseExistingMessages(e)}catch(e){console.error('获取现有消息失败:',e),this.initializeDefaultData()}else console.warn('getChatMessages函数不可用，使用默认数据'),this.initializeDefaultData()}async parseExistingMessages(e){const t=this.messageParser.extractBearContent(e);if(t){this.chatData=await this.messageParser.parseBearContent(t),N.applyOverridesToChatData(this.chatData);const e=Array.from(this.chatData.keys()).filter(e=>'group'===this.chatData.get(e)?.type);N.validateAndCleanOverrides(e);Array.from(this.chatData.values()).filter(e=>'group'===e.type);if(this.chatData.size>0){const e=this.chatData.keys().next().value;e&&(this.currentChat=e),this.showChatList()}}0===this.chatData.size&&this.initializeDefaultData()}initializeDefaultData(){this.showChatList()}togglePlusMenu(){const e=document.getElementById('plusMenu');e&&(this.hideStickerSelector(),this.isMenuVisible=!this.isMenuVisible,this.isMenuVisible?(e.classList.add('active'),setTimeout(()=>{e.classList.add('show')},10)):this.hidePlusMenu())}hidePlusMenu(){const e=document.getElementById('plusMenu');e&&(e.classList.remove('active','show'),this.isMenuVisible=!1)}handleMenuItemClick(e){switch(this.soundManager.playSound('emoji'),this.hidePlusMenu(),e){case'sticker':this.handleStickerMenuClick();break;case'image':this.handleImageMenuClick();break;case'voice':this.handleVoiceMenuClick();break;case'location':this.handleLocationMenuClick();break;case'transfer':this.handleTransferMenuClick();break;default:console.warn(`未知的菜单项类型: ${e}`),this.showToast(`功能 "${e}" 暂未实现`,'warning')}}handleStickerMenuClick(){this.showStickerSelector()}handleImageMenuClick(){this.showImageInputModal()}handleVoiceMenuClick(){this.showVoiceInputModal()}handleLocationMenuClick(){this.showLocationInputModal()}handleTransferMenuClick(){this.showTransferInputModal()}handleEnterKey(){if(this.isSending)return void console.log('🚫 正在发送中，请等待发送完成');const e=document.getElementById('inputField');if(!e)return;const t=e.value.trim();if(!t)return;const a={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'text',content:t,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(a),e.value='',this.addNewMessageToInterface(a),this.soundManager.playSound('send')}updateSendButtonState(e){const t=document.getElementById('sendBtn');t&&(t.disabled=e,e?(t.style.opacity='0.6',t.style.cursor='not-allowed'):(t.style.opacity='1',t.style.cursor='pointer'))}async handleSendClick(){if(this.isSending)return void console.log('🚫 正在发送中，请勿重复点击');console.log('🔄 跨聊天发送模式: '+(this.crossChatSendEnabled?'开启':'关闭'));const e=this.crossChatSendEnabled?this.sendQueue:this.getPendingMessagesForCurrentChat();if(0!==e.length){if(this.isSending=!0,this.updateSendButtonState(!0),console.log(`📤 实际发送 ${e.length} 条消息`),this.crossChatSendEnabled&&this.sendQueue.length>0){const t={};for(const a of e)t[a.chatId]=(t[a.chatId]||0)+1;console.log('📊 跨聊天发送统计:',t)}this.soundManager.playSound('send');try{await this.processSendQueue(e),this.isSending=!1,this.updateSendButtonState(!1),console.log('✅ 发送完成，按钮状态已恢复')}catch(e){throw this.isSending=!1,this.updateSendButtonState(!1),console.error('❌ 发送失败，按钮状态已恢复:',e),e}}else console.log('没有待发送的消息')}async processSendQueue(e){if(0!==e.length)try{console.log(`🚀 开始批量发送 ${e.length} 条消息`),this.crossChatSendEnabled?await this.processCrossChatSend(e):await this.processSingleChatSend(e),this.clearSentMessages(e),this.crossChatSendEnabled&&this.sendQueue.length>0&&console.log(`📝 跨聊天发送完成，队列中还有 ${this.sendQueue.length} 条消息`),console.log('✅ 批量消息发送成功')}catch(e){console.error('❌ 批量消息发送失败:',e),this.showErrorToast(`消息发送失败: ${e.message||'未知错误'}`)}else console.log('📭 发送队列为空')}async processCrossChatSend(e){const t=new Map;for(const a of e)t.has(a.chatId)||t.set(a.chatId,[]),t.get(a.chatId).push(a);console.log(`📤 跨聊天发送：将向 ${t.size} 个聊天发送消息`);const a=this.buildCrossChatPrompt(t);console.log('📝 跨聊天合并提示词:',a);let s=null;try{s=this.showTypingIndicator();let e=null;for(const[a,s]of t)if(e=this.extractImageFileFromMessages(s),e)break;console.log('📡 调用 generate 函数（跨聊天合并发送）...');const n={user_input:a,should_stream:!1};e&&(n.image=e,console.log('📷 跨聊天包含图片文件:',e.name)),console.log('🚀 跨聊天调用generate');const r=await generate(n);console.log('🤖 收到AI回复:',r),this.hideTypingIndicator(await s),await this.handleCrossChatAIResponse(r,t)}catch(e){throw s&&this.hideTypingIndicator(await s),e}}async processSingleChatSend(e){let t=null;try{console.log('📤 开始处理单个聊天发送，消息数量:',e.length),console.log('📤 处理消息:',e.length,'条');const a=this.extractImageFileFromMessages(e);console.log('🔍 [DEBUG] 提取到的图片数据:',a?{type:typeof a,isFile:a instanceof File,isString:'string'==typeof a,fileName:a instanceof File?a.name:void 0,fileSize:a instanceof File?a.size:void 0,isBase64:'string'==typeof a&&a.startsWith('data:image/'),base64Length:'string'==typeof a?a.length:void 0}:null);const s=this.buildCombinedPrompt(e,null!==a);if(console.log('📝 构建提示词完成'),t=this.showTypingIndicator(),console.log('📡 调用 generate 函数...'),'string'!=typeof s)throw console.error('🚨 [ERROR] combinedPrompt不是字符串:',typeof s,s),new Error('combinedPrompt必须是字符串，但收到了: '+typeof s);const n={user_input:s,should_stream:!1};a&&(n.image=a,a instanceof File?console.log('📷 包含图片文件:',a.name,'类型:',a.type):console.log('📷 包含base64图片数据')),console.log('🔍 [DEBUG] 最终的generate配置:',{user_input:n.user_input.substring(0,200)+(n.user_input.length>200?'...':''),should_stream:n.should_stream,hasImage:!!n.image,imageInfo:n.image?n.image instanceof File?{type:'File',name:n.image.name,size:n.image.size,fileType:n.image.type}:{type:'String',isUrl:n.image.startsWith('http'),isBase64:n.image.startsWith('data:image/'),length:n.image.length}:null}),console.log('🚀 调用generate');const r=await generate(n);console.log('🤖 收到AI回复:',r),this.hideTypingIndicator(await t),this.handleAIResponse(r,e[e.length-1]).catch(e=>{console.error('❌ 处理AI回复失败:',e)}),console.log('✅ generate调用完成，processSingleChatSend即将返回')}catch(e){throw t&&this.hideTypingIndicator(await t),e}}clearSentMessages(e){const t=new Set(e.map(e=>e.id));this.sendQueue=this.sendQueue.filter(e=>!t.has(e.id)),console.log(`🧹 已清空 ${e.length} 条消息，队列剩余 ${this.sendQueue.length} 条`)}extractImageFileFromMessages(e){console.log('🔍 [DEBUG] extractImageFileFromMessages 开始，消息数量:',e.length);for(const t of e)if(console.log('🔍 [DEBUG] 检查消息:',{id:t.id,messageType:t.messageType,hasData:!!t.data,hasUploadedFile:!!t.data?.uploadedFile,hasBase64Image:!!t.data?.base64Image,hasImageUrl:!!t.data?.imageUrl,uploadedFileType:t.data?.uploadedFile?.constructor?.name}),'image'===t.messageType){if(t.data?.uploadedFile){const e=t.data.uploadedFile;return console.log('🔍 [DEBUG] 找到图片文件:',{name:e.name,size:e.size,type:e.type,isFile:e instanceof File}),e}if(t.data?.base64Image){const e=t.data.base64Image;return console.log('🔍 [DEBUG] 找到base64图片数据:',{length:e.length,isBase64:e.startsWith('data:image/')}),e}if(t.data?.imageUrl){const e=t.data.imageUrl;return console.log('🔍 [DEBUG] 找到图片URL:',{url:e,isHttpUrl:e.startsWith('http://')||e.startsWith('https://')}),e}}return console.log('🔍 [DEBUG] 未找到图片文件或base64数据'),null}processMessageContent(e,t){console.log('🔍 [DEBUG] processMessageContent 开始:',{messageId:e.id,messageType:e.messageType,hasImageData:t,hasUploadedFile:!!e.data?.uploadedFile,hasBase64Image:!!e.data?.base64Image,contentPreview:e.content.substring(0,100)+(e.content.length>100?'...':'')});let a=e.content;if('image'===e.messageType&&t&&(e.data?.uploadedFile||e.data?.base64Image||e.data?.imageUrl)){const t=/^图片URL：.*?\n图片描述：(.*?)$/,s=a.match(t);if(s){return s[1]||''}const n=/^图片文件：.*?(?:\n图片描述：(.*?))?$/,r=a.match(n);if(r){return r[1]||''}return(e.data?.base64Image||e.data?.imageUrl)&&a&&!a.includes('╒═════')?(console.log('🔍 [DEBUG] 图片消息，直接使用内容作为描述:',a),a):''}return'text'!==e.messageType&&(a=`${e.messageType}:${a}`),'string'!=typeof a?(console.error('🚨 [ERROR] processMessageContent返回了非字符串:',typeof a,a),''):a}buildCombinedPrompt(e,t=!1){if(0===e.length)return'';const a=e[0],s=this.chatData.get(a.chatId);let n='';if('group'===s?.type){n=`回复和${s.chatName||a.chatId}的聊天：`}else{const e=s?.chatName||a.chatId;n=`回复和${this.extractCharacterNameFromChatName(e)}的聊天：`}if(1===e.length){return`${n}${this.processMessageContent(e[0],t)}`}return`${n}\n${e.map((e,a)=>`${a+1}. ${this.processMessageContent(e,t)}`).join('\n')}`}buildCrossChatPrompt(e){const t=[];let a=!1;for(const[t,s]of e)if(this.extractImageFileFromMessages(s)){a=!0;break}for(const[s,n]of e){if(0===n.length)continue;const e=this.chatData.get(s);let r='';if('group'===e?.type){r=`回复和${e.chatName||s}的聊天：`}else{const t=e?.chatName||s;r=`回复和${this.extractCharacterNameFromChatName(t)}的聊天：`}if(1===n.length){r+=this.processMessageContent(n[0],a)}else{r+=n.map((e,t)=>`${t+1}. ${this.processMessageContent(e,a)}`).join('')}t.push(r)}return t.join('\n')}async handleCrossChatAIResponse(e,t){try{const a=this.cleanAIInternalTags(e);console.log('🧹 已清理AI内部思考标签');const s=this.extractLastBearContent(a);if(s)console.log('🐻 检测到 Bear 标签，开始跨聊天数据处理流程...'),await this.updateCurrentMessageWithBearContent(s);else{console.log('📝 未找到Bear标签，使用/sendas输出到新楼层...');const e=Array.from(t.keys()).pop(),s=t.get(e);s&&s.length>0&&await this.sendAIResponseToNewFloor(a,s[s.length-1])}}catch(e){throw console.error('❌ 处理跨聊天AI回复失败:',e),e}}clearSendQueue(){this.sendQueue=[],console.log('🧹 发送队列已清空')}async handleAIResponse(e,t){try{const a=this.cleanAIInternalTags(e);console.log('🧹 已清理AI内部思考标签');const s=this.extractLastBearContent(a);s?(console.log('🐻 检测到 Bear 标签，开始完整的数据处理流程...'),await this.updateCurrentMessageWithBearContent(s)):(console.log('📝 未找到Bear标签，使用/sendas输出到新楼层...'),await this.sendAIResponseToNewFloor(a,t))}catch(e){throw console.error('❌ 处理AI回复失败:',e),e}}async updateCurrentMessageWithBearContent(e){try{console.log('📝 开始更新Bear内容');const t=getChatMessages(-1)[0];if(!t)return void console.error('❌ 无法获取最新楼层消息');const a=t.message_id;console.log('📝 [DEBUG] 当前楼层ID:',a),console.log('📝 [DEBUG] 当前楼层原始内容长度:',t.message?.length||0),console.log('�  [DEBUG] 开始检测新消息...');const s=await this.detectNewMessagesBeforeMerge(e);console.log('🔄 [DEBUG] 开始数据处理阶段...');const n=await this.mergeBearContentToExistingData(e),r=t.message||'',o=this.replaceOnlyBearTagContent(r,n);console.log('💾 保存数据到SillyTavern...'),await setChatMessages([{message_id:a,message:o}],{refresh:'none'}),console.log('✅ 已使用setChatMessages更新当前楼层的Bear内容（保留标签外内容）'),console.log('🧹 清空发送队列...'),this.clearSendQueue(),console.log('🎨 开始前端界面渲染...'),await this.renderDetectedNewMessages(s),this.lastBearContent=n,console.log('✅ AI回复处理完成（数据已安全保存）')}catch(e){throw console.error('❌ 更新Bear内容失败:',e),e}}replaceOnlyBearTagContent(e,t){const a=e.match(/<bear>([\s\S]*?)<\/bear>/);if(a){return`${e.substring(0,a.index)}<bear>${t}</bear>${e.substring(a.index+a[0].length)}`}return console.log('📝 未找到现有bear标签，直接添加新内容'),`${e}<bear>${t}</bear>`}async mergeBearContentToExistingData(e){try{console.log('🔄 开始合并Bear内容');const t=b.getInstance().isFeatureEnabled();console.log('🔄 迁移功能状态:',t?'启用':'禁用');const a=await this.messageParser.parseBearContent(e);if(t){console.log('🔄 合并新消息到现有数据中');for(const[e,t]of a){const a=this.chatData.get(e);if(a){const s=this.mergeMessages(a.messages,t.messages);a.messages=s,a.lastMessage=s.length>0?this.messageParser.formatLastMessage(s[s.length-1]):'',console.log(`📝 合并聊天 ${e}，现有 ${s.length} 条消息`)}else this.chatData.set(e,t),console.log(`🆕 添加新聊天 ${e}，包含 ${t.messages.length} 条消息`)}const e=this.messageParser.buildBearContent(this.chatData);return console.log('✅ Bear内容合并完成（包含历史消息）'),e.replace('<bear>','').replace('</bear>','')}{console.log('🔄 只使用新消息，不合并历史数据');const e=this.messageParser.buildBearContent(a);return console.log('✅ Bear内容处理完成（仅新消息）'),e.replace('<bear>','').replace('</bear>','')}}catch(t){return console.error('❌ 合并Bear内容失败:',t),e}}mergeMessages(e,t){console.log(`🔄 合并消息: 现有 ${e.length}, 新增 ${t.length}`);const a=new Set;for(const t of e){const e=this.generateMessageFingerprint(t);a.add(e)}const s=[];for(const e of t){const t=this.generateMessageFingerprint(e),n=!a.has(t);console.log(`🔄 [DEBUG] ${n?'添加新消息':'跳过重复消息'}: "${t}", 发送者: "${e.sender}", 内容: "${e.content.substring(0,30)}..."`),n&&s.push(e)}s.sort((e,t)=>this.compareMessageTimestamps(e.timestamp,t.timestamp));const n=[...e,...s];return console.log(`🔄 合并完成，最终消息数量: ${n.length}，新增: ${s.length}`),n}compareMessageTimestamps(e,t){const a=e=>{const[t,a]=e.split(':').map(Number);return{hours:t,minutes:a}},s=a(e),n=a(t),r=new Date,o=new Date(r.getFullYear(),r.getMonth(),r.getDate(),s.hours,s.minutes),i=new Date(r.getFullYear(),r.getMonth(),r.getDate(),n.hours,n.minutes);r.getHours();return s.hours>=20&&n.hours<12?i.setDate(i.getDate()+1):n.hours>=20&&s.hours<12&&o.setDate(o.getDate()+1),o.getTime()-i.getTime()}async detectAndRenderNewMessages(e){try{let t=[];if(this.lastBearContent){console.log('🔍 进行Bear内容差异检测');const a=this.messageParser.parseBearContent(this.lastBearContent),s=this.messageParser.parseBearContent(e);t=this.findNewMessages(await a,await s)}else{console.log('🔍 首次解析Bear内容，检查是否有新的AI回复');const a=this.messageParser.parseBearContent(e),s=this.getExistingMessagesFromInterface();console.log('🔍 [DEBUG] 现有消息指纹集合:',Array.from(s)),console.log('🔍 [DEBUG] 当前聊天ID:',this.currentChat);for(const[e,n]of await a){console.log(`🔍 [DEBUG] 检查聊天 "${e}" 的消息`);for(const e of n.messages){const a=this.generateMessageFingerprint(e);console.log(`🔍 [DEBUG] 消息指纹: "${a}", 发送者: "${e.sender}", 内容: "${e.content.substring(0,30)}..."`),'{{user}}'!==e.sender&&'user'!==e.sender?(console.log('🔍 [DEBUG] 这是AI消息，检查是否已存在'),s.has(a)?console.log('🔍 [DEBUG] ❌ AI消息已存在，跳过'):(console.log('🔍 [DEBUG] ✅ 发现新AI消息，添加到渲染队列'),t.push(e))):console.log('🔍 [DEBUG] 这是用户消息，跳过')}}}if(console.log(`🔍 [DEBUG] 最终新消息数量: ${t.length}`),0===t.length)return void console.log('🔍 未发现新消息');console.log(`🆕 发现 ${t.length} 条新消息`),await this.renderNewMessagesForCurrentChat(t)}catch(e){console.error('❌ 检测和渲染新消息失败:',e)}}findNewMessages(e,t){const a=[],s=new Set;for(const[,t]of e)for(const e of t.messages){const t=this.generateMessageFingerprint(e);s.add(t)}for(const[,e]of t)for(const t of e.messages){const e=this.generateMessageFingerprint(t);s.has(e)||'{{user}}'!==t.sender&&'user'!==t.sender&&a.push(t)}return a}generateMessageFingerprint(e){return`${e.chatId}_${e.sender}_${e.content}_${e.timestamp}`}async renderNewMessagesForCurrentChat(e){if(console.log(`🔍 界面状态检查: currentInterface = "${this.currentInterface}"`),'chat'!==this.currentInterface)return void console.log('🔍 当前不在聊天界面，跳过消息渲染');if(this.isRenderingMessages)for(console.log('🛑 检测到新的渲染请求，中断之前的渲染'),this.shouldStopRendering=!0;this.isRenderingMessages;)await this.delay(50);console.log(`🔍 当前聊天ID: "${this.currentChat}"`),console.log('🔍 新消息的聊天ID:',e.map(e=>`"${e.chatId}"`));const t=e.filter(e=>{if(e.chatId===this.currentChat)return console.log(`✅ 直接匹配: ${e.chatId} === ${this.currentChat}`),!0;const t=this.normalizeChatIdForComparison(e.chatId),a=this.normalizeChatIdForComparison(this.currentChat);if(t===a)return console.log(`✅ 标准化匹配: "${e.chatId}" -> "${t}" === "${this.currentChat}" -> "${a}"`),!0;if(this.currentChat.startsWith('群聊')){const e=a===t;return console.log(`🔍 群聊匹配检查: "${a}" === "${t}" = ${e}`),e}return console.log(`❌ 不匹配: ${e.chatId} (${t}) !== ${this.currentChat} (${a})`),!1});console.log(`🔍 过滤后的当前聊天消息数量: ${t.length}`),0!==t.length?(console.log(`🎨 开始渲染 ${t.length} 条当前聊天的新消息（带打字动画）`),await this.showMessagesSequentially(t),console.log('✅ 新消息渲染完成'),console.log('🎨 [主应用] 新消息渲染完成，准备触发聊天迁移检查'),await this.triggerChatMigrationCheck()):console.log('🔍 当前聊天没有新消息')}async showMessagesSequentially(e){if(this.isRenderingMessages=!0,this.shouldStopRendering=!1,console.log(`🎨 开始渲染 ${e.length} 条消息`),this.typingSpeedManager.shouldShowAll()){console.log('⚡ 全部模式：直接显示所有消息');try{for(const t of e)this.addNewMessageToInterface(t);this.soundManager.playSound('newMessage')}finally{this.isRenderingMessages=!1,this.shouldStopRendering=!1}}else try{for(let t=0;t<e.length;t++){if(this.shouldStopRendering){console.log(`🛑 渲染被中断，已渲染 ${t}/${e.length} 条消息`);break}const a=e[t];try{this.addNewMessageToInterface(a);const s=document.querySelectorAll('.message'),n=s[s.length-1];if(n&&await this.typeMessage(n,a),this.shouldStopRendering){console.log(`🛑 渲染被中断，已渲染 ${t+1}/${e.length} 条消息`);break}t<e.length-1&&await this.delay(this.getRandomDelay())}catch(e){console.error('❌ 渲染消息失败:',a,e)}}}finally{this.isRenderingMessages=!1,this.shouldStopRendering=!1,console.log('🎨 消息渲染流程结束')}}async typeMessage(e,t){const a=e.querySelector('.message-content');if(!a)return;const s=a.innerHTML;if(this.shouldStopRendering)return void(a.innerHTML=s);if(this.typingSpeedManager.shouldSkipTyping())return a.innerHTML=s,void this.soundManager.playSound('newMessage');if(this.hasSpecialContent(s))return a.innerHTML=s,void this.soundManager.playSound('newMessage');const n=document.createElement('div');n.className='typing-indicator',n.innerHTML='<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>',a.textContent='',a.appendChild(n);const r=this.getRandomTypingTime();return new Promise(e=>{const t=setTimeout(()=>{if(this.shouldStopRendering)return n.remove(),a.innerHTML=s,void e();n.style.transition='opacity 0.5s',n.style.opacity='0';const t=setTimeout(()=>{if(this.shouldStopRendering)return n.remove(),a.innerHTML=s,void e();n.remove(),a.textContent='',this.typeCharacters(a,s,()=>{e()})},500);this.shouldStopRendering&&(clearTimeout(t),n.remove(),a.innerHTML=s,e())},r);this.shouldStopRendering&&(clearTimeout(t),n.remove(),a.innerHTML=s,e())})}typeCharacters(e,t,a){let s=0,n=!1,r=null;if(this.hasSpecialContent(t))return e.innerHTML=t,n||this.soundManager.playSound('newMessage'),void a();const o=document.createElement('div');o.innerHTML=t;const i=o.textContent||o.innerText||t,l=()=>{if(this.shouldStopRendering)return e.innerHTML=t,r&&clearTimeout(r),void a();0!==s||n||(this.soundManager.playSound('newMessage'),n=!0),s<i.length?(e.textContent+=i.charAt(s),s++,r=setTimeout(l,50)):(t!==i&&(e.innerHTML=t),a())};l()}hasSpecialContent(e){return e.includes('random-image-container')||e.includes('typing-indicator')||e.includes('<div')||e.includes('<img')||e.includes('<audio')||e.includes('<video')||e.includes('sticker-container')||e.includes('transfer-container')}getRandomTypingTime(){return this.typingSpeedManager.getTypingTime()}getRandomDelay(){return this.typingSpeedManager.getMessageDelay()}getExistingMessagesFromInterface(){const e=new Set;if(b.getInstance().isFeatureEnabled()){const t=this.chatData.get(this.currentChat);if(t){console.log(`🔍 找到当前聊天数据，包含 ${t.messages.length} 条消息`);for(const a of t.messages){const t=this.generateMessageFingerprint(a);e.add(t)}}}else console.log('🔍 迁移功能禁用，不使用历史消息');for(const t of this.sendQueue)if(t.chatId===this.currentChat){const a=this.generateMessageFingerprint(t);e.add(a)}return console.log(`🔍 收集到 ${e.size} 个现有消息指纹`),e}delay(e){return new Promise(t=>setTimeout(t,e))}async updateCurrentMessageWithContent(e){try{const t=getChatMessages(-1)[0];if(!t)return void console.error('❌ 无法获取最新楼层消息');const a=t.message_id;console.log('📝 当前楼层ID:',a),await setChatMessages([{message_id:a,message:e}],{refresh:'none'}),console.log('✅ 已使用setChatMessages更新当前楼层的普通内容')}catch(e){throw console.error('❌ 更新普通内容失败:',e),e}}async sendAIResponseToNewFloor(e,t){try{const a=`/sendas name="${t.sender||'助手'}" ${e}`;console.log('📤 使用/sendas发送AI回复到新楼层'),triggerSlash(a),console.log('✅ 已使用/sendas发送AI回复到新楼层'),console.log('🧹 清空发送队列...'),this.clearSendQueue(),console.log('✅ 非Bear格式AI回复处理完成')}catch(t){console.error('❌ 使用/sendas发送AI回复失败:',t),console.log('🔄 回退到替换当前楼层的方式...'),await this.updateCurrentMessageWithContent(e),console.log('🧹 清空发送队列（回退情况）...'),this.clearSendQueue()}}async parseBearContent(e){try{console.log('🔍 解析 Bear 内容:',e);const t=this.parseMessagesFromBearContent(e);for(const e of t)this.addMessageToChatData(e),this.addNewMessageToInterface(e)}catch(e){throw console.error('❌ Bear 内容解析失败:',e),e}}parseMessagesFromBearContent(e){const t=[],a=/\[([^|]+)\|([^|]+)\|([^\]]+)\]/g;let s;for(;null!==(s=a.exec(e));){const[,e,a,n]=s,r={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:e.trim(),avatar:this.messageParser.getDefaultAvatar(e.trim()),messageType:'text',content:a.trim(),timestamp:n.trim()};t.push(r)}return t}async showTypingIndicator(){const e=document.getElementById('chatMessages');if(!e)return null;let t='https://files.catbox.moe/u8ccy5.jpg';try{const e=this.chatData.get(this.currentChat),s=e?.chatName||this.currentChat;if(this.currentChat&&this.currentChat.startsWith('群聊'))if(e&&e.avatar)t=e.avatar;else{const{GroupChatStorage:e}=await Promise.resolve().then(a.bind(a,663));t=e.getDefaultGroupAvatar(this.currentChat)}else if(this.currentChat&&!this.currentChat.startsWith('群聊')){let e=s.replace(/^和|的聊天$/g,'');if(e&&e!==s||(e=s),e){const a=this.messageParser.getDefaultAvatar(e);if(a&&'https://files.catbox.moe/u8ccy5.jpg'!==a)t=a;else try{if('function'==typeof getCharAvatarPath){const a=getCharAvatarPath(e,!0);a&&(t=a)}}catch(e){}}}}catch(e){}const s=document.createElement('div');s.className='message received typing-message',s.innerHTML=`\n      <img src="${t}" class="avatar" alt="角色头像" />\n      <div class="message-wrapper">\n        <div class="message-content">\n          <div class="typing-indicator">\n            <span class="typing-dot"></span>\n            <span class="typing-dot"></span>\n            <span class="typing-dot"></span>\n          </div>\n        </div>\n      </div>\n    `;const n=s.querySelector('.avatar');return n&&(n.onerror=()=>{n.src='https://files.catbox.moe/u8ccy5.jpg'}),e.appendChild(s),e.scrollTop=e.scrollHeight,s}hideTypingIndicator(e){e&&e.parentNode&&e.parentNode.removeChild(e)}extractLastBearContent(e){if(!e)return null;const t=e.lastIndexOf('</bear>');if(-1===t)return console.log('❌ 未找到 </bear> 标签'),null;const a=e.substring(0,t).lastIndexOf('<bear>');if(-1===a)return console.log('❌ 未找到对应的 <bear> 标签'),null;const s=e.substring(a+6,t);return console.log('🐻 找到最后一对Bear标签'),this.hasValidChatContent(s)?(console.log('✅ Bear标签包含有效聊天内容'),s):(console.log('❌ Bear标签不包含有效聊天内容'),null)}hasValidChatContent(e){if(!e)return!1;const t=e.includes('[和')&&e.includes('的聊天]'),a=e.includes('[群聊')&&e.includes('[/群聊'),s=e.includes('[S_'),n=e.includes('[G_');if(!(t||a||s||n))return!1;let r=e.split('\n').filter(e=>e.trim().length>0);if(1!==r.length){const e=r.filter(e=>e.includes('[S_')||e.includes('[G_')||e.includes('[和')||e.includes('[群聊')).length/Math.max(r.length,1);return e<.3?(console.log(`🚫 聊天内容占比过低 (${(100*e).toFixed(1)}%)，跳过`),!1):(console.log(`✅ Bear内容通过验证，聊天内容占比: ${(100*e).toFixed(1)}%`),!0)}{const t=(e.match(/\[S_[^\]]*\]/g)||[]).length+(e.match(/\[G_[^\]]*\]/g)||[]).length,a=(e.match(/\[和[^\]]*的聊天\]/g)||[]).length+(e.match(/\[群聊[^\]]*\]/g)||[]).length;if(t>0||a>0)return console.log(`✅ Bear内容通过验证，包含 ${t} 条消息，${a} 个聊天块`),!0}return console.log('🚫 未找到有效的聊天内容格式'),!1}cleanAIInternalTags(e){if(!e)return e;let t=e;const a=['analyze','think','thinking','reasoning','internal','thought','process'];for(const e of a){const a=new RegExp(`<${e}[^>]*>[\\s\\S]*?<\\/${e}>`,'gi');t=t.replace(a,'');const s=new RegExp(`<${e}[^>]*\\/>`,'gi');t=t.replace(s,'')}return t=t.replace(/\n\s*\n\s*\n/g,'\n\n'),t=t.trim(),t.length!==e.length&&console.log(`🧹 已移除 ${e.length-t.length} 个字符的AI内部思考内容`),t}showErrorToast(e){'undefined'!=typeof toastr?toastr.error(e,'发送失败'):alert(`发送失败: ${e}`)}showChatList(){this.isRenderingMessages&&(console.log('🛑 检测到界面切换，中断消息渲染'),console.log('🛑 当前渲染状态:',{isRenderingMessages:this.isRenderingMessages,shouldStopRendering:this.shouldStopRendering}),this.shouldStopRendering=!0),this.hideChatInterface(),this.currentChat&&this.chatListManager&&(console.log('📖 返回聊天列表时标记当前聊天为已读:',this.currentChat),this.chatListManager.getUnreadMessageManager().markAsRead(this.currentChat,this.chatData)),this.chatListManager.showChatListInterface(this.chatData),this.currentInterface='list'}hideChatInterface(){const e=document.getElementById('chatInterface');e&&(e.style.display='none')}initializeChatListEvents(){document.addEventListener('chatListItemClick',e=>{const t=e,{chatId:a}=t.detail;this.switchToChat(a)}),document.addEventListener('createNewChat',e=>{const t=e,{type:a,contactIds:s}=t.detail;this.handleCreateNewChat(a,s)}),document.addEventListener('contactUpdated',e=>{const t=e,{oldName:a,newName:s,newAvatar:n}=t.detail;this.handleContactUpdated(a,s,n)}),document.addEventListener('refreshChatList',()=>{this.handleRefreshChatList()}),document.addEventListener('chatListChanged',e=>{const t=e;'groupChatCreated'===t.detail?.type&&(console.log('🎉 检测到群聊创建事件，创建群聊消息标记'),this.handleGroupChatCreated(t.detail?.groupChatData))}),document.addEventListener('deleteChatRequest',e=>{const t=e,{chatId:a}=t.detail;console.log('🗑️ 检测到删除聊天请求:',a),this.handleDeleteChatRequest(a)})}async initializeProfileModule(){try{this.profileInterface=await A(),this.profileInterface&&(this.settingsModal=this.profileInterface.getSettingsModal()),console.log('✅ 我的页面模块初始化成功')}catch(e){console.error('❌ 我的页面模块初始化失败:',e)}}initializeExtensionsModule(){try{console.log('[Extensions] 扩展功能模块已初始化'),L.getInstance(),console.log('✅ 扩展功能模块初始化成功')}catch(e){console.error('❌ 扩展功能模块初始化失败:',e)}}initializeChatMigrationManager(){try{b.getInstance().initialize(),window.ChatMigrationManager=b,console.log('🔧 [调试] ChatMigrationManager 已暴露到全局:',window.ChatMigrationManager),console.log('✅ 聊天迁移管理器初始化成功')}catch(e){console.error('❌ 聊天迁移管理器初始化失败:',e)}}async triggerChatMigrationCheck(){console.log('🔔 [主应用] 触发聊天迁移检查');try{const e=b.getInstance();console.log('📋 [主应用] 获取到 ChatMigrationManager 实例'),await e.checkAndMigrate(),console.log('✅ [主应用] 聊天迁移检查完成')}catch(e){console.error('❌ [主应用] 聊天迁移检查失败:',e)}}async initializeChatWallpaperManager(){try{this.chatWallpaperManager=k.getInstance(),console.log('✅ 聊天壁纸管理器初始化成功')}catch(e){console.error('❌ 聊天壁纸管理器初始化失败:',e)}}switchToChat(e){if(console.log(`🔄 尝试切换到聊天: ${e}`),this.chatListManager.hideChatListInterface(),e.startsWith('群聊'))return void this.switchToGroupChat(e);let t=this.chatData.get(e),a=e;if(!t){console.log('🔍 直接查找失败，尝试其他格式...');const a=this.messageParser.generateGroupChatId(e);if(t=this.chatData.get(a),t)return console.log(`✅ 找到群聊数据，使用ID: ${a}`),void this.switchToGroupChat(a)}if(!t)return console.error('❌ 找不到聊天数据:',e),console.log('🔍 可用的聊天数据:',Array.from(this.chatData.keys())),void this.showToast('聊天不存在','error');this.showChatInterface(),this.currentChat=a,this.renderCurrentChat(),this.chatListManager&&(console.log('📖 标记聊天为已读:',a),this.chatListManager.getUnreadMessageManager().markAsRead(a,this.chatData)),this.chatWallpaperManager&&(console.log('[BearChatManager] 通知壁纸管理器聊天切换:',a),this.chatWallpaperManager.setCurrentChatId(a)),this.currentInterface='chat'}switchToGroupChat(e){if(console.log(`🔄 切换到群聊: ${e}`),!this.chatData.get(e))return console.error('❌ 群聊数据不存在:',e),console.log('🔍 可用的聊天数据:',Array.from(this.chatData.keys())),void this.showToast('群聊不存在','error');this.showChatInterface(),this.currentChat=e,this.renderCurrentChat(),this.chatListManager&&(console.log('📖 标记群聊为已读:',e),this.chatListManager.getUnreadMessageManager().markAsRead(e,this.chatData)),this.chatWallpaperManager&&(console.log('[BearChatManager] 通知壁纸管理器群聊切换:',e),this.chatWallpaperManager.setCurrentChatId(e)),this.currentInterface='chat'}cleanupDuplicateChatData(){}showChatInterface(){this.shouldStopRendering=!1,console.log('🎨 进入聊天界面，重置渲染中断标志');const e=document.getElementById('chatInterface');e&&(e.style.display='flex')}handleCreateNewChat(e,t){console.log(`创建新聊天: ${e}, 联系人:`,t);const a=this.chatListManager.getContactManager(),s=t.map(e=>a.getContactById(e)).filter(Boolean);if(0===s.length)return void this.showToast('未找到有效联系人','error');if('single'===e&&1===s.length){const e=s[0].name,t=this.findExistingChatWithContact(e);if(t)return console.log(`找到已存在的聊天: ${t}`),this.switchToChat(t),void this.showToast(`已切换到与${e}的聊天`,'info')}let n,r;if('single'===e&&1===s.length){n=`和${s[0].name}的聊天`,r=n;const e={chatId:r,chatName:n,avatar:s[0].avatar,messages:[],lastMessage:'开始聊天吧~',type:'S'};this.chatData.set(r,e),this.createSingleChatBlock(e).then(()=>{console.log('✅ 单聊块创建成功，切换到新聊天'),this.switchToChat(r),this.showToast('已创建单聊','info')}).catch(e=>{console.error('❌ 创建单聊块失败:',e),this.chatListManager&&this.chatListManager.refreshChatList(this.chatData),this.switchToChat(r),this.showToast('已创建单聊（本地模式）','warning')})}else console.log('🔄 使用GroupChatManager创建群聊'),this.groupChatManager.createGroupChat(t)}handleContactUpdated(e,t,a){console.log(`🔄 处理联系人更新: ${e} -> ${t}`);try{if(this.updateChatDataForContact(e,t,a),this.updateCurrentChatInterface(e,t,a),this.currentChat){const a=this.chatData.get(this.currentChat);a&&this.isChatRelatedToContact(a,e,t)&&this.renderCurrentChat()}console.log(`✅ 联系人更新处理完成: ${e} -> ${t}`)}catch(e){console.error('❌ 处理联系人更新失败:',e)}}updateChatDataForContact(e,t,a){this.chatData.forEach((s,n)=>{let r=!1;s.chatName===`和${e}的聊天`&&(s.chatName=`和${t}的聊天`,r=!0),s.chatName.includes(t)&&!s.chatName.includes('群聊')&&(s.avatar=a,r=!0),s.messages.forEach(s=>{s.sender===e&&(s.sender=t,s.avatar=a,r=!0)}),r&&console.log(`🔄 更新聊天数据: ${n}`)})}updateCurrentChatInterface(e,t,a){const s=document.getElementById('chatTitle');s&&s.textContent===`和${e}的聊天`&&(s.textContent=`和${t}的聊天`);const n=document.getElementById('headerAvatar');n&&(n.src='https://files.catbox.moe/u8ccy5.jpg',n.alt='默认头像');document.querySelectorAll('.message').forEach(s=>{const n=s.querySelector('.avatar'),r=s.querySelector('.message-sender, .sender-name');!n||n.alt!==e&&n.alt!==t||(n.src=a,n.alt=t),r&&r.textContent===e&&(r.textContent=t)})}isChatRelatedToContact(e,t,a){return e.chatName===`和${t}的聊天`||e.chatName===`和${a}的聊天`||e.messages.some(e=>e.sender===t||e.sender===a)}async createSingleChatBlock(e){try{console.log('🔄 开始创建单聊块:',e.chatName),console.log('📝 单聊数据:',{chatId:e.chatId,chatName:e.chatName});const t=`[${e.chatName}]\n[/${e.chatName}]`;console.log('📝 构建的单聊标记:',t);const a=getChatMessages(-1)||[];if(a.length>0){const e=a[0];let s,n=e.message||'';if(n.includes('<bear>')){const a=n.replace('</bear>',`${t}\n</bear>`).replace('<bear>','').replace('</bear>','');s=this.replaceOnlyBearTagContent(e.message||'',a)}else{s=`<bear>\n${t}\n</bear>${e.message||''}`}await setChatMessages([{message_id:e.message_id,message:s}],{refresh:'none'}),console.log('✅ 已添加单聊块到现有bear标签内')}else{const e=`<bear>\n${t}\n</bear>`;await setChatMessages([{message_id:Date.now(),message:e}],{refresh:'none'}),console.log('✅ 已创建新消息包含单聊块')}await this.initializeFromExistingData();const s=this.chatData.get(e.chatId);s&&s.messages.length>0?console.log('✅ 单聊块创建完成，包含消息:',s.messages.length):console.warn('⚠️ 单聊块创建完成，但未检测到消息')}catch(t){console.error('❌ 创建单聊块失败:',t),this.chatListManager&&(this.chatListManager.refreshChatList(this.chatData),console.log(`✅ 已刷新聊天列表，新增单聊: ${e.chatName}`))}}async handleDeleteChatRequest(e){try{console.log('🗑️ 开始处理删除聊天请求:',e);const t=this.chatData.get(e);t?(this.chatData.delete(e),console.log('✅ 已从内存中删除聊天数据:',e)):console.warn('⚠️ 未在内存中找到要删除的聊天数据:',e),await this.deleteChatBlockFromBear(e,t),this.currentChat===e&&(console.log('🔄 当前正在查看被删除的聊天，返回聊天列表'),this.showChatList()),console.log('✅ 删除聊天请求处理完成')}catch(e){console.error('❌ 处理删除聊天请求失败:',e),this.showToast('删除聊天失败','error')}}async deleteChatBlockFromBear(e,t){try{console.log('🗑️ 开始从bear标签中删除聊天块:',e);const a=getChatMessages(-1)||[];if(0===a.length)return void console.log('⚠️ 没有找到当前消息，无法删除聊天块');const s=a[0];let n=s.message||'';if(!n.includes('<bear>'))return void console.log('⚠️ 当前消息不包含bear标签，无法删除聊天块');const r=n.match(/<bear>([\s\S]*?)<\/bear>/);if(!r)return void console.log('⚠️ 无法解析bear标签内容');let o=r[1];console.log('📝 开始删除聊天块');o='group'===t?.type||e.startsWith('群聊')?this.removeGroupChatBlock(o,e):this.removeSingleChatBlock(o,e),console.log('📝 聊天块删除完成');const i=this.replaceOnlyBearTagContent(n,o);await setChatMessages([{message_id:s.message_id,message:i}],{refresh:'none'}),console.log('✅ 已从bear标签中删除聊天块'),await this.initializeFromExistingData()}catch(e){throw console.error('❌ 从bear标签中删除聊天块失败:',e),e}}removeSingleChatBlock(e,t){const a=t,s=new RegExp(`\\[${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]([\\s\\S]*?)\\[\\/${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]`,'g'),n=e.length,r=e.replace(s,'');return r.length<n?console.log(`✅ 已删除单聊块: ${a}`):console.warn(`⚠️ 未找到要删除的单聊块: ${a}`),r}removeGroupChatBlock(e,t){const a=t.replace(/^群聊/,''),s=new RegExp(`\\[群聊${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]\\s*\\n?\\s*\\[成员[：:]([^\\]]+)\\]\\s*\\n?([\\s\\S]*?)\\n?\\s*\\[/群聊${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\]`,'g'),n=e.length,r=e.replace(s,'');return r.length<n?console.log(`✅ 已删除群聊块: ${a}`):console.warn(`⚠️ 未找到要删除的群聊块: ${a}`),r}async handleGroupChatCreated(e){try{console.log('🔄 开始处理群聊创建');let t=e;if(!t)try{const e=this.groupChatManager.getAllGroupChats();e.length>0&&(t=e.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())[0])}catch(e){console.warn('⚠️ 从localStorage获取群聊数据失败:',e)}if(!t){console.warn('⚠️ 没有找到群聊数据，创建默认群聊标记');const e='[群聊新建群聊]\n[成员：角色1，角色2，{{user}}]\n[/群聊新建群聊]';try{if('function'==typeof setChatMessages){const t=`<bear>\n${e}\n</bear>`;await setChatMessages([{message_id:Date.now(),message:t}],{refresh:'none'}),console.log('✅ 已创建默认群聊标记'),this.initializeFromExistingData()}}catch(e){console.error('❌ 创建默认群聊标记失败:',e)}return}console.log('📊 最新创建的群聊:',t);const a=this.chatListManager.getContactManager(),s=t.members.map(e=>{if('{{user}}'===e||'user'===e)return'{{user}}';const t=a.getContactById(e);return t?t.name:e}).join('，'),n=`[群聊${t.name}]\n[成员：${s}]\n[/群聊${t.name}]`;console.log('📝 群聊标记消息:',n);let r=[],o=null;try{'function'==typeof getChatMessages&&(r=getChatMessages(-1)||[],o=r.length>0?r[0]:null)}catch(e){console.warn('⚠️ 获取当前消息失败，将创建新消息:',e)}try{if('function'==typeof setChatMessages)if(o){let e=o.message;if(e.includes('<bear>')&&e.includes('</bear>')){const t=e.lastIndexOf('</bear>');e=e.slice(0,t)+'\n\n'+n+'\n'+e.slice(t)}else e=`<bear>\n${e}\n\n${n}\n</bear>`;await setChatMessages([{message_id:o.message_id,message:e}],{refresh:'none'}),console.log('✅ 已添加群聊标记到 bear 标签内')}else{const e=`<bear>\n${n}\n</bear>`;await setChatMessages([{message_id:Date.now(),message:e}],{refresh:'none'}),console.log('✅ 已创建新消息包含群聊标记')}else console.warn('⚠️ setChatMessages 函数不可用')}catch(e){console.error('❌ 处理消息失败:',e)}this.initializeFromExistingData(),console.log('✅ 群聊创建处理完成')}catch(e){console.error('❌ 处理群聊创建失败:',e)}}handleRefreshChatList(){console.log('🔄 刷新聊天列表');try{const e=document.getElementById('chatListInterface');e&&e.classList.contains('active')&&(this.chatListManager.renderChatList(this.chatData),console.log('✅ 聊天列表已刷新'))}catch(e){console.error('❌ 刷新聊天列表失败:',e)}}syncGroupChatData(){try{console.log('🔄 开始同步群聊数据');const e=this.groupChatManager.getAllGroupChats();console.log('📊 获取到的群聊数据:',e),e.forEach(e=>{let t=e.messages||[];t=t.map(e=>({...e,type:e.type||'G'}));const a={chatId:e.id,chatName:e.name,avatar:e.avatar,messages:t,lastMessage:t.length>0?t[t.length-1].content:'群聊已创建',type:'G',timestamp:new Date(e.createdAt).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})};this.chatData.set(a.chatId,a),console.log(`✅ 已同步群聊: ${a.chatName}，消息数: ${t.length}`)}),this.handleRefreshChatList(),console.log('✅ 群聊数据同步完成')}catch(e){console.error('❌ 同步群聊数据失败:',e)}}findExistingChatWithContact(e){for(const[t,a]of this.chatData){if(a.chatName===`和${e}的聊天`)return t;if(a.messages.some(t=>t.sender===e&&'{{user}}'!==t.sender)){const s=new Set(a.messages.filter(e=>'{{user}}'!==e.sender).map(e=>e.sender));if(1===s.size&&s.has(e))return t}}return null}showToast(e,t='info'){'undefined'!=typeof toastr?'success'===t?toastr.success(e):toastr[t](e):console.log(`[${t.toUpperCase()}] ${e}`)}showDiaryInterface(){}showCallInterface(){}async handleAvatarClick(){const e=this.chatData.get(this.currentChat);e?'group'===e.type?await this.showGroupChatModal(e):this.showSingleChatProfile(e):console.warn('当前聊天数据不存在')}async showGroupChatModal(e){const t=await this.createGroupManagementModal(e),a=document.querySelector('.interface-container');a?a.appendChild(t):document.body.appendChild(t),setTimeout(()=>{t.classList.add('show')},10)}showSingleChatProfile(e){console.log('👤 显示个人资料:',e.chatName),this.showToast(`查看 ${e.chatName} 的个人资料`,'info')}async createGroupManagementModal(e){const t=document.createElement('div');t.className='modal-overlay group-management-modal',t.id='groupManagementModal';const s=e.members||[],n=s.length,r=s.map(async(e,t)=>{let s=e.avatar,n=e.name,r='{{user}}'===e.name||'user'===e.name||'{{user}}'===e.id;if(!r)try{const{getUserNameAsync:t}=await Promise.resolve().then(a.bind(a,791)),s=await t();r=e.name===s||e.id===s}catch(e){}if(r){const{getUserAvatar:e,getUserNameAsync:t}=await Promise.resolve().then(a.bind(a,791));try{s=e(),n=await t()}catch(e){}}return`\n      <div class="member-item" data-member-id="${e.id}">\n        <img src="${s}" class="member-avatar" alt="${n}">\n        <div class="member-info">\n          <span class="member-name">${n}</span>\n          <span class="member-role">${this.getMemberRoleText(e.role)}</span>\n        </div>\n        <div class="member-actions">\n          ${'owner'!==e.role?`\n            <button class="kick-member-btn" data-member-id="${e.id}" title="移除成员">\n              <svg viewBox="0 0 24 24" width="16" height="16">\n                <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />\n              </svg>\n            </button>\n          `:''}\n        </div>\n      </div>\n    `}),o=(await Promise.all(r)).join('');return t.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-header">\n          <h3>群聊设置</h3>\n        </div>\n        \n        <div class="modal-body">\n          \x3c!-- 群基本信息 --\x3e\n          <div class="group-info-section">\n            <div class="group-avatar-section">\n              <img class="group-avatar-preview" src="${e.avatar}" alt="群头像">\n              <button class="change-avatar-btn" data-action="change-avatar">更换头像</button>\n            </div>\n            <div class="group-name-section">\n              <label>群名称</label>\n              <input type="text" class="group-name-input" value="${e.chatName}" maxlength="20">\n            </div>\n          </div>\n          \n          \x3c!-- 群成员管理 --\x3e\n          <div class="group-members-section">\n            <div class="section-header">\n              <h4>群成员 (<span class="member-count">${n}</span>)</h4>\n              <button class="invite-member-btn" data-action="invite-member">邀请成员</button>\n            </div>\n            <div class="members-list">\n              ${o}\n            </div>\n          </div>\n          \n          \x3c!-- 危险操作区域 --\x3e\n          <div class="danger-section">\n            <button class="disband-btn" data-action="disband">解散群聊</button>\n          </div>\n        </div>\n        \n        <div class="modal-footer">\n          <button class="cancel-btn" data-action="cancel">取消</button>\n          <button class="save-btn" data-action="save">保存</button>\n        </div>\n      </div>\n    `,this.bindGroupManagementModalEvents(t,e),this.registerGroupMemberAvatars(t),t}registerGroupMemberAvatars(e){try{e.querySelectorAll('.member-avatar').forEach(e=>{const t=e.closest('.member-item');if(t){const a=t.getAttribute('data-member-id');if('user'===a||'{{user}}'===a){console.log('🔗 注册群成员中的用户头像到同步系统'),this.avatarMixin.register(e,'img');const t=(0,G.oE)();e.src=t}}})}catch(e){console.warn('注册群成员头像失败:',e)}}bindGroupManagementModalEvents(e,t){[e.querySelector('[data-action="close"]'),e.querySelector('[data-action="cancel"]')].forEach(e=>{e&&e.addEventListener('click',()=>{this.hideGroupManagementModal()})});const a=e.querySelector('[data-action="save"]');a&&a.addEventListener('click',()=>{this.handleGroupSettingsSave(e,t)});const s=e.querySelector('[data-action="change-avatar"]');s&&s.addEventListener('click',()=>{this.handleGroupAvatarChange(t)});const n=e.querySelector('[data-action="invite-member"]');n&&n.addEventListener('click',()=>{this.handleGroupMemberInvite(t)});const r=e.querySelector('[data-action="disband"]');r&&r.addEventListener('click',()=>{this.handleGroupDisband(t)});e.querySelectorAll('.kick-member-btn').forEach(e=>{e.addEventListener('click',async e=>{const a=e.target.closest('[data-member-id]')?.getAttribute('data-member-id');a&&await this.handleGroupMemberKick(t,a)})}),e.addEventListener('click',t=>{t.target===e&&this.hideGroupManagementModal()})}hideGroupManagementModal(){const e=document.getElementById('groupManagementModal');e&&(this.unregisterGroupMemberAvatars(e),e.classList.remove('show'),setTimeout(()=>{e.remove()},300))}async refreshGroupManagementModal(e){try{const t=document.getElementById('groupManagementModal');if(!t)return void console.warn('⚠️ 未找到现有的群聊管理模态框');const s=t.querySelector('.members-list'),n=t.querySelector('.member-count');if(!s)throw console.warn('⚠️ 未找到成员列表容器'),new Error('成员列表容器不存在');const r=e.members||[],o=r.map(async e=>{let t=e.avatar,s=e.name;if('{{user}}'===e.id||'user'===e.id)try{const{getUserAvatar:e,getUserNameAsync:n}=await Promise.resolve().then(a.bind(a,791));t=e(),s=await n()}catch(e){}return`\n        <div class="member-item" data-member-id="${e.id}">\n          <img src="${t}" class="member-avatar" alt="${s}">\n          <div class="member-info">\n            <span class="member-name">${s}</span>\n            <span class="member-role">${this.getMemberRoleText(e.role)}</span>\n          </div>\n          <div class="member-actions">\n            ${'owner'!==e.role?`\n              <button class="kick-member-btn" data-member-id="${e.id}" title="移除成员">\n                <svg viewBox="0 0 24 24" width="16" height="16">\n                  <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />\n                </svg>\n              </button>\n            `:''}\n          </div>\n        </div>\n      `}),i=(await Promise.all(o)).join(''),l=r.length;s.innerHTML=i,n&&(n.textContent=l.toString()),this.bindMemberListEvents(s,e),console.log('✅ 群聊成员列表刷新完成')}catch(e){console.error('❌ 刷新成员列表失败:',e),this.showToast('刷新成员列表失败','error')}}bindMemberListEvents(e,t){e.querySelectorAll('.kick-member-btn').forEach(e=>{e.addEventListener('click',async e=>{e.stopPropagation();const a=e.target.closest('[data-member-id]')?.getAttribute('data-member-id');a&&await this.handleGroupMemberKick(t,a)})})}unregisterGroupMemberAvatars(e){try{e.querySelectorAll('.member-avatar').forEach(e=>{const t=e.closest('.member-item');if(t){const a=t.getAttribute('data-member-id');'user'!==a&&'{{user}}'!==a||(console.log('🔗 取消注册群成员中的用户头像'),this.avatarMixin.unregister(e))}})}catch(e){console.warn('取消注册群成员头像失败:',e)}}async handleGroupSettingsSave(e,t){const a=e.querySelector('.group-name-input'),s=a?.value.trim();if(s){if(s!==t.chatName){const e=t.chatName;N.saveGroupNameOverride(t.chatId,s),t.chatName=s,console.log(`📝 群名称已更新: ${e} -> ${t.chatName}`),this.updateGroupChatDisplay(t)}this.showToast('群信息已保存','success'),this.hideGroupManagementModal()}else this.showToast('群名称不能为空','error')}handleGroupAvatarChange(e){const t=document.createElement('input');t.type='file',t.accept='image/*',t.style.display='none',document.body.appendChild(t),t.addEventListener('change',async s=>{const n=s.target.files?.[0];if(n)try{if(!n.type.startsWith('image/'))return void this.showToast('请选择图片文件','error');if(n.size>5242880)return void this.showToast('图片文件不能超过5MB','error');this.showToast('正在上传头像...','info');const t=await s.fileToBase64(n),{GroupChatStorage:s}=await Promise.resolve().then(a.bind(a,663));await s.saveGroupAvatar(e.chatId,t),e.avatar=t;const r=document.querySelector('.group-avatar-preview');r&&(r.src=t),this.updateChatListAvatar(e.chatId,t),this.updateChatHeaderAvatar(t),this.showToast('群头像更换成功','success')}catch(e){console.error('更换群头像失败:',e),this.showToast('更换群头像失败','error')}finally{document.body.removeChild(t)}else document.body.removeChild(t)}),t.click()}updateChatListAvatar(e,t){const a=document.querySelector(`[data-chat-id="${e}"] .chat-avatar`);a&&(a.src=t)}updateChatHeaderAvatar(e){const t=document.getElementById('headerAvatar');t&&(t.src=e)}async saveChatDataToBear(){try{const e=this.messageParser.buildBearContent(this.chatData).replace('<bear>','').replace('</bear>',''),t=await getLastMessageId(),a=getChatMessages(-1)[0],s=a?.message||'',n=this.replaceOnlyBearTagContent(s,e);await setChatMessages([{message_id:t,message:n}],{refresh:'none'})}catch(e){throw console.error('保存聊天数据失败:',e),e}}saveChatDataToBear_Simple(){try{this.messageParser.buildBearContent(this.chatData);console.log('💾 Bear数据已构建，但跳过立即保存以避免错误')}catch(e){console.error('构建Bear数据失败:',e)}}handleGroupMemberInvite(e){try{const t=this.chatListManager.getContactManager().getAllContacts(),a=e.members||[],s=t.filter(e=>!a.some(t=>t.id===e.id));if(0===s.length)return void this.showToast('没有可邀请的联系人','warning');this.showInviteMemberModal(e,s)}catch(e){console.error('处理群聊成员邀请失败:',e),this.showToast('邀请成员失败','error')}}showInviteMemberModal(e,t){const a=document.createElement('div');a.className='invite-member-overlay',a.id='inviteMemberModal';const s=t.map(e=>`\n      <div class="invite-contact-item" data-contact-id="${e.id}">\n        <img class="invite-contact-avatar" src="${e.avatar}" alt="${e.name}">\n        <div class="invite-contact-info">\n          <div class="invite-contact-name">${e.name}</div>\n        </div>\n        <div class="invite-contact-checkbox">\n          <input type="checkbox" id="invite_${e.id}" value="${e.id}">\n          <label for="invite_${e.id}"></label>\n        </div>\n      </div>\n    `).join('');a.innerHTML=`\n      <div class="invite-modal-container">\n        <div class="invite-modal-header">\n          <h3>邀请成员</h3>\n          <button class="invite-close-btn" data-action="close">×</button>\n        </div>\n        \n        <div class="invite-modal-body">\n          <div class="invite-contacts-list">\n            ${s}\n          </div>\n        </div>\n        \n        <div class="invite-modal-footer">\n          <button class="invite-cancel-btn" data-action="cancel">取消</button>\n          <button class="invite-confirm-btn" data-action="confirm">邀请</button>\n        </div>\n      </div>\n    `;const n=document.querySelector('.phone-container');n?n.appendChild(a):document.body.appendChild(a),this.bindInviteMemberModalEvents(a,e)}bindInviteMemberModalEvents(e,t){[e.querySelector('[data-action="close"]'),e.querySelector('[data-action="cancel"]')].forEach(t=>{t&&t.addEventListener('click',()=>{e.parentNode&&e.parentNode.removeChild(e)})});const a=e.querySelector('[data-action="confirm"]');a&&a.addEventListener('click',()=>{this.handleInviteMemberConfirm(e,t)})}async handleInviteMemberConfirm(e,t){try{const a=e.querySelectorAll('input[type="checkbox"]:checked'),s=Array.from(a).map(e=>e.value);if(0===s.length)return void this.showToast('请选择要邀请的成员','warning');const n=this.chatListManager.getContactManager(),r=s.map(e=>{const t=n.getContactById(e);return{id:t.id,name:t.name,avatar:t.avatar}});t.members=[...t.members||[],...r],await this.syncGroupMembersToTavern(t),e.parentNode&&e.parentNode.removeChild(e),await this.refreshGroupManagementModal(t),this.showToast(`成功邀请 ${s.length} 名成员`,'success')}catch(e){console.error('邀请成员确认失败:',e),this.showToast('邀请成员失败','error')}}async handleGroupMemberKick(e,t){const a=e.members||[],s=a.find(e=>e.id===t);s?confirm(`确定要移除成员 "${s.name}" 吗？`)&&(e.members=a.filter(e=>e.id!==t),console.log(`👋 成员已移除: ${s.name}`),await this.syncGroupMembersToTavern(e),await this.refreshGroupManagementModal(e),this.showToast(`成员 "${s.name}" 已移除`,'success')):this.showToast('成员不存在','error')}async handleGroupDisband(e){try{if(!confirm(`确定要解散群聊 "${e.chatName}" 吗？\n\n解散后将删除所有群聊消息，此操作不可恢复。`))return;console.log('🗑️ 开始解散群聊:',e.chatName),this.hideGroupManagementModal(),this.groupChatManager&&this.groupChatManager.deleteGroupChat(e.chatId),await this.handleDeleteChatRequest(e.chatId),this.showToast(`群聊 "${e.chatName}" 已解散`,'success'),console.log('✅ 群聊解散完成')}catch(e){console.error('解散群聊失败:',e),this.showToast('解散群聊失败','error')}}getGroupNameById(e){const t=this.chatData.get(e);return t?t.chatName:null}updateGroupChatData(e){try{if(this.chatData.set(e.chatId,e),this.groupChatManager){const t={id:e.chatId,name:e.chatName,avatar:e.avatar,members:(e.members||[]).map(e=>e.id),userParticipation:'member',createdAt:Date.now(),messages:[],type:'group'};a(663).GroupChatStorage.saveGroupChat(t)}console.log('✅ 群聊数据已更新:',e.chatName)}catch(e){console.error('更新群聊数据失败:',e)}}updateGroupChatDisplay(e){const t=document.getElementById('chatTitle');t?(t.textContent=e.chatName,console.log(`🔄 已更新聊天标题: ${e.chatName}`)):console.warn('⚠️ 未找到聊天标题元素 #chatTitle'),this.chatListManager&&(this.chatListManager.refreshChatList(this.chatData),console.log('🔄 已刷新聊天列表'))}getMemberRoleText(e){switch(e){case'owner':return'群主';case'admin':return'管理员';default:return'成员'}}saveChatDataToBear(){try{this.messageParser.buildBearContent(this.chatData);console.log('💾 Bear数据已构建，但跳过立即保存以避免错误'),console.log('✅ 数据会在下次发送消息时自动同步')}catch(e){console.error('构建Bear数据失败:',e)}}async persistBearData(e){try{if('function'==typeof setChatMessages){const t={message:e,is_system:!1,is_user:!1,name:'System',extra:{type:'bear_data',timestamp:(new Date).toISOString()}};return setChatMessages([t]),void console.log('📤 通过setChatMessages保存数据')}if('function'==typeof setChatMessages){const t=[{message_id:Date.now(),name:'System',role:'system',is_hidden:!1,message:e,data:{type:'bear_data',timestamp:(new Date).toISOString()},extra:{}}];return await setChatMessages(t),void console.log('📤 通过setChatMessages保存数据')}const t=`bear_chat_backup_${Date.now()}`;localStorage.setItem(t,e),this.cleanupOldBackups(),console.log('💾 数据已保存到本地存储')}catch(e){throw console.error('持久化数据失败:',e),e}}cleanupOldBackups(){try{const e=[];for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);a&&a.startsWith('bear_chat_backup_')&&e.push(a)}if(e.sort((e,t)=>{const a=parseInt(e.split('_').pop()||'0');return parseInt(t.split('_').pop()||'0')-a}),e.length>10){const t=e.slice(10);t.forEach(e=>{localStorage.removeItem(e)}),console.log(`🧹 清理了 ${t.length} 个旧备份`)}}catch(e){console.warn('清理备份失败:',e)}}restoreFromBackup(){try{const e=[];for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);a&&a.startsWith('bear_chat_backup_')&&e.push(a)}if(0===e.length)return null;e.sort((e,t)=>{const a=parseInt(e.split('_').pop()||'0');return parseInt(t.split('_').pop()||'0')-a});const t=e[0],a=localStorage.getItem(t);return a?(console.log('📥 从备份恢复数据:',t),a):null}catch(e){return console.error('从备份恢复失败:',e),null}}validateBearData(e){const t=[];try{e.includes('<bear>')&&e.includes('</bear>')||t.push('缺少Bear标签');0===[...e.matchAll(/\[([^\]]+)\]([\s\S]*?)\[\/\1\]/g)].length&&t.push('没有找到有效的聊天块');const a=[...e.matchAll(/\[群聊([^\]]+)\]\s*\n?\s*\[成员[：:]([^\]]+)\]\s*\n?([\s\S]*?)\n?\s*\[\/群聊\1\]/g)];for(const e of a){const a=e[1],s=e[2];a.trim()||t.push('群聊名称不能为空'),s.trim()||t.push(`群聊"${a}"的成员列表不能为空`)}return 0===[...e.matchAll(/\[([SG])_[^\]]*\]/g)].length&&t.push('没有找到有效的消息'),{valid:0===t.length,errors:t}}catch(e){return t.push(`验证过程出错: ${e}`),{valid:!1,errors:t}}}async syncGroupMembersToTavern(e){try{console.log('🔄 开始同步群成员变更到酒馆聊天块'),console.log('📊 群聊数据:',{chatId:e.chatId,chatName:e.chatName,memberCount:(e.members||[]).length}),this.chatData.set(e.chatId,e),console.log('⚠️ 注意：只能更新当前聊天中的群聊信息');const t=getChatMessages('0-{{lastMessageId}}');let a=-1;console.log(`📝 当前聊天共有 ${t.length} 条消息`);let s=null;const n=[e.chatName];if(N.hasOverride(e.chatId)){console.log('🔍 检测到群名覆盖，将同时搜索原始名称和覆盖名称');for(let e=0;e<t.length;e++){const a=t[e];if(a.message){const e=a.message.matchAll(/\[群聊([^\]]+)\]/g);for(const t of e){const e=t[1];n.includes(e)||(n.push(e),console.log(`📝 发现可能的原始群名: ${e}`))}}}}console.log(`🔍 搜索模式: ${n.join(', ')}`);for(const e of n){const n=`[群聊${e}]`;for(let r=0;r<t.length;r++){const o=t[r];if(o.message&&o.message.includes(n)){const t=o.message;if(t.includes(`[/群聊${e}]`)||t.includes('<bear>')&&t.includes(n)){a=o.message_id,s=o,console.log(`🎯 找到目标群聊消息: ${e} (消息ID: ${a})`),s.foundGroupName=e;break}}}if(s)break}const r=(e.members||[]).map(e=>e.name).join('，'),o=`[成员：${r}]`;if(a>=0&&s){let t=s.message;const n=s.foundGroupName||e.chatName,i=new RegExp(`(\\[群聊${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\][\\s\\S]*?)\\[成员：[^\\]]*\\]`,'g');if(i.test(t))t=t.replace(i,`$1${o}`),console.log(`🎯 精确替换群聊块内的成员信息 (使用名称: ${n})`);else{const e=`[群聊${n}]`;t.includes(e)?(t=t.replace(/\[成员：[^\]]*\]/,o),console.log(`📝 降级替换成员信息 (使用名称: ${n})`)):console.warn('⚠️ 未找到合适的成员信息替换位置')}await setChatMessages([{message_id:a,message:t}],{refresh:'none'}),console.log(`✅ 已更新群聊成员信息到消息 ${a}`),console.log(`📝 新成员列表: ${r}`)}else{console.log('🔄 未找到目标群聊消息，更新整个Bear内容');const e=this.messageParser.buildBearContent(this.chatData),t=getChatMessages(-1)[0];if(t){const a=t.message||'',s=e.replace('<bear>','').replace('</bear>',''),n=this.replaceOnlyBearTagContent(a,s);await setChatMessages([{message_id:t.message_id,message:n}],{refresh:'none'}),console.log('✅ 已更新Bear内容包含群聊成员信息'),console.log(`📝 新成员列表: ${r}`)}else console.warn('⚠️ 没有找到可更新的消息')}this.updateGroupDataInBear(e),console.log('✅ 群成员同步完成')}catch(t){console.error('❌ 同步群成员到酒馆失败:',t),console.error('错误详情:',t),this.showToast('同步成员信息失败','error'),this.updateGroupDataInBear(e)}}async debugSyncAllGroupMembers(){console.log('🔧 开始调试同步所有群聊成员信息');for(const[e,t]of this.chatData)'group'===t.type&&(console.log(`🔄 同步群聊: ${t.chatName}`),await this.syncGroupMembersToTavern(t));console.log('✅ 所有群聊成员信息同步完成'),this.showToast('所有群聊成员信息已同步','success')}updateGroupDataInBear(e){try{this.chatData.set(e.chatId,e);const t=this.messageParser.buildBearContent(this.chatData),a=this.validateBearData(t);if(!a.valid)return console.error('Bear数据验证失败:',a.errors),void this.showToast('数据验证失败: '+a.errors.join(', '),'error');console.log('✅ 群聊数据已更新到内存')}catch(e){console.error('更新群聊数据失败:',e),this.showToast('更新失败，请重试','error')}}initializeDoubleClickHandlers(){}renderCurrentChat(){const e=this.chatData.get(this.currentChat);if(!e){console.error('❌ 找不到当前聊天数据:',this.currentChat);return void Array.from(this.chatData.keys()).filter(e=>e.includes(this.currentChat)||this.currentChat.includes(e)).length}this.updateChatHeader(e),this.renderMessages(e)}updateChatHeader(e){const t=document.getElementById('chatTitle'),a=document.getElementById('headerAvatar'),s=document.querySelector('.header-status');if(t){let a=e.chatName;const s=e.chatName.match(/^和(.+)的聊天$/);s&&(a=s[1]),t.textContent=a}if(a&&(a.src=this.messageParser.processImageUrl(e.avatar),a.alt=e.chatName),s){const t=e.chatId.startsWith('群聊')||e.chatId.startsWith('G_')||e.chatName.includes('群聊')||e.messages.some(e=>'G'===e.type);s.style.display=t?'none':'flex'}}renderMessages(e){const t=document.getElementById('chatMessages');if(!t)return void console.error('找不到消息容器 #chatMessages');t.innerHTML='',e.messages.forEach(e=>{const a=this.createMessageElement(e);t.appendChild(a)});this.sendQueue.filter(e=>e.chatId===this.currentChat).forEach(e=>{const a=this.createMessageElement(e);t.appendChild(a)}),this.scrollToBottom(t)}addMessageToChatData(e){const t=this.chatData.get(e.chatId);if(t)t.messages.push(e),t.lastMessage=this.messageParser.formatLastMessage(e),t.timestamp=e.timestamp;else{const t={chatId:e.chatId,chatName:e.chatId,avatar:e.avatar,messages:[e],lastMessage:this.messageParser.formatLastMessage(e),timestamp:e.timestamp,type:e.type};this.chatData.set(e.chatId,t)}}addNewMessageToInterface(e){const t=document.getElementById('chatMessages');if(!t)return;const a=this.createMessageElement(e);t.appendChild(a),requestAnimationFrame(()=>{this.ensureVoiceMessageInteractions(a,e)}),this.scrollToBottom(t)}createMessageElement(e){const t=document.createElement('div'),a='{{user}}'===e.sender||'user'===e.sender,s='G'===e.type;t.className=`message ${a?'sent':'received'}${s?' group-message':''}`,t.dataset.messageId=e.id;const n=this.createAvatar(e,a);t.appendChild(n);const r=this.createMessageWrapper(e,s);return t.appendChild(r),this.addMessageAnimation(t),this.addMessageInteractions(t,e),t}createMessageContent(e){const t=document.createElement('div');switch(t.className='message-content',e.messageType){case'text':default:this.renderTextMessage(t,e);break;case'image':this.renderImageMessage(t,e);break;case'voice':this.renderVoiceMessage(t,e);break;case'sticker':this.renderStickerMessage(t,e);break;case'location':this.renderLocationMessage(t,e);break;case'transfer':this.renderTransferMessage(t,e)}return t}createAvatar(e,t){if(t){const e=document.createElement('div');e.className='user_avatar avatar avatar-hover';const t=(0,G.oE)();return e.style.backgroundImage=`url(${t})`,this.avatarMixin.register(e,'background'),e}{const t=document.createElement('img');return t.className='avatar',t.src=this.messageParser.processImageUrl(e.avatar)||'https://files.catbox.moe/u8ccy5.jpg',t.alt=e.sender,t}}createMessageWrapper(e,t=!1){const a=document.createElement('div');if(a.className='message-wrapper',a.dataset.messageId=e.id,t&&'{{user}}'!==e.sender&&'user'!==e.sender){const t=document.createElement('div');t.className='message-sender',t.textContent=e.senderDisplayName||e.sender,a.appendChild(t)}const s=this.createMessageContent(e);a.appendChild(s);const n=document.createElement('div');return n.className='message-time',n.textContent=e.timestamp,a.appendChild(n),a}renderTextMessage(e,t){const a=document.createElement('span');a.textContent=t.content,e.appendChild(a)}renderFileImage(e,t,a){const s=URL.createObjectURL(t),n=document.createElement('img');n.src=s,n.className='message-image',n.alt=t.name,n.onload=()=>{URL.revokeObjectURL(s)},n.onerror=()=>{n.classList.add('hidden');const t=document.createElement('span');t.textContent='[图片加载失败]',t.className='error-text',e.appendChild(t),URL.revokeObjectURL(s)},e.appendChild(n)}renderImageMessage(e,t){if(t.data?.uploadedFile)return void this.renderFileImage(e,t.data.uploadedFile,t.content);if(t.data?.base64Image){const a=document.createElement('img');return a.src=t.data.base64Image,a.className='message-image',a.alt=t.content||'图片',a.onerror=()=>{a.classList.add('hidden');const t=document.createElement('span');t.textContent='[图片加载失败]',t.className='error-text',e.appendChild(t)},void e.appendChild(a)}if(t.data?.imageUrl){const a=document.createElement('img');return a.src=t.data.imageUrl,a.className='message-image',a.alt=t.content||'图片',a.onerror=()=>{a.classList.add('hidden');const t=document.createElement('span');t.textContent='[图片加载失败]',t.className='error-text',e.appendChild(t)},void e.appendChild(a)}const a=t.content.match(/^图片URL：(.*?)\n图片描述：(.*?)$/);if(a){const t=a[1].trim(),s=a[2].trim(),n=document.createElement('img');return n.src=this.messageParser.processImageUrl(t),n.className='message-image',n.alt=s,n.onerror=()=>{n.classList.add('hidden');const t=document.createElement('span');t.textContent='[图片加载失败]',t.className='error-text',e.appendChild(t)},void e.appendChild(n)}const s=t.content.match(/╒═════\s*(.*?)\s*╘═════/);if(s)return void this.renderAttachmentMessage(e,s[1]);const n=document.createElement('img');n.src=this.messageParser.processImageUrl(t.content),n.className='message-image',n.alt='图片消息',n.onerror=()=>{n.classList.add('hidden');const t=document.createElement('span');t.textContent='[图片加载失败]',t.className='error-text',e.appendChild(t)},e.appendChild(n)}renderAttachmentMessage(e,t){const a=['https://files.catbox.moe/0g3kqu.jpg','https://files.catbox.moe/d5b7k6.jpg','https://files.catbox.moe/0yrhh6.jpg','https://files.catbox.moe/8mjvdg.jpg','https://files.catbox.moe/fvidas.jpg','https://files.catbox.moe/q6so2i.jpg','https://files.catbox.moe/5a96cp.jpg','https://files.catbox.moe/0mp6h0.jpg','https://files.catbox.moe/epcn03.jpg','https://files.catbox.moe/7jzdp7.jpg','https://files.catbox.moe/jrmu6w.jpg','https://files.catbox.moe/c0bwhn.jpg','https://files.catbox.moe/0blxme.jpg','https://files.catbox.moe/qicobr.jpg','https://files.catbox.moe/n94ztu.jpg'],s=a[Math.floor(Math.random()*a.length)],n=document.createElement('div');n.className='random-image-container dynamic-bg',n.style.backgroundImage=`url('${s}')`;const r=document.createElement('details'),o=document.createElement('summary'),i=document.createElement('div');i.className='attachment-content';const l=document.createElement('div');l.className='attachment-text';const c=document.createElement('p');c.textContent=t,l.appendChild(c),i.appendChild(l),r.appendChild(o),r.appendChild(i),n.appendChild(r),e.appendChild(n)}renderVoiceMessage(e,t){const a=t.content.split('|'),s=a[0]||'语音消息',n=a[1]||'0',r=document.createElement('div');r.className='voice-message';const o=document.createElement('div');o.className='voice-icon';const i=document.getElementById('voiceIconTemplate');i?o.innerHTML=i.innerHTML:(console.warn('语音图标模板未找到，使用默认图标'),o.innerHTML='\n        <svg class="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n          <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" />\n        </svg>\n        <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none">\n          <path d="M14,19H18V5H14M6,19H10V5H6V19Z" />\n        </svg>\n      ');const l=document.createElement('div');l.className='voice-wave-container';for(let e=0;e<5;e++){const t=document.createElement('div');t.className='voice-wave',t.style.animationDelay=.1*e+'s',l.appendChild(t)}const c=document.createElement('span');c.className='voice-duration',c.textContent=`${n}"`,r.appendChild(o),r.appendChild(l),r.appendChild(c),e.appendChild(r);const h=document.createElement('div');h.className='voice-transcript',h.textContent=s,h.style.display='none',r.setAttribute('data-voice-content',s),r.setAttribute('data-duration',n),e.appendChild(h)}addVoiceMessageInteractions(e,t,a,s){let n=!1;e.addEventListener('click',a=>{a.stopPropagation(),n=!n,n?(e.classList.add('expanded'),t.style.display='block',t.classList.add('show')):(e.classList.remove('expanded'),t.style.display='none',t.classList.remove('show')),this.soundManager.playSound('click')})}renderStickerMessage(e,t){const a=document.createElement('img');a.src=this.messageParser.processImageUrl(t.content)||t.content,a.className='message-sticker',a.alt='表情包',a.onerror=()=>{a.classList.add('hidden');const t=document.createElement('span');t.textContent='[表情包加载失败]',t.className='error-text',e.appendChild(t)},e.appendChild(a)}renderLocationMessage(e,t){const a=document.createElement('div');a.className='location-message';const s=document.createElement('div');s.className='location-icon';const n=document.getElementById('locationIconTemplate');n&&(s.innerHTML=n.innerHTML);const r=document.createElement('span');r.className='location-text',r.textContent=t.content||'位置信息',a.appendChild(s),a.appendChild(r),e.appendChild(a)}renderTransferMessage(e,t){const a=t.content.split('|'),s=a[0]||'0',n=a[1]||'等待接收',r=document.createElement('div');r.className='transfer-bubble';const o=document.createElement('div');o.className='transfer-content';const i=document.createElement('div');i.className='transfer-icon';const l=document.getElementById('transferIconTemplate');l&&(i.innerHTML=l.innerHTML);const c=document.createElement('div');c.className='transfer-info';const h=document.createElement('div');h.className='transfer-amount',h.textContent=`￥${s}`;const d=document.createElement('div');d.className='transfer-status','已接收'===n?d.classList.add('completed'):'已退回'===n||'已拒绝'===n?d.classList.add('failed'):'待接收'===n&&d.classList.add('pending'),d.textContent=n,c.appendChild(h),c.appendChild(d),o.appendChild(i),o.appendChild(c),r.appendChild(o),'{{user}}'===t.sender||'user'===t.sender?r.classList.add('user-transfer'):r.addEventListener('click',()=>{this.handleTransferClick(t,d),this.soundManager.playSound('click')}),e.appendChild(r)}addMessageAnimation(e){e.classList.add('message-animation'),requestAnimationFrame(()=>{e.classList.add('show')})}addMessageInteractions(e,t){this.addBubbleInteractions(e,t),this.addAvatarInteractions(e,t),this.addTimestampInteractions(e,t),this.addSpecialMessageInteractions(e,t),t.isPending&&this.addDoubleClickEdit(e,t)}addBubbleInteractions(e,t){e.querySelector('.message-wrapper');const a=e.querySelector('.message-content');a&&'transfer'!==t.messageType&&a.addEventListener('click',e=>{e.stopPropagation(),this.soundManager.playSound('click'),this.addClickFeedback(a)})}addAvatarInteractions(e,t){const a=e.querySelector('.avatar');if(a){a.addEventListener('click',e=>{e.stopPropagation(),this.soundManager.playSound('avatar'),this.addAvatarClickEffect(a)});('{{user}}'===t.sender||'user'===t.sender)&&a.addEventListener('dblclick',a=>{this.isBatchDeleteMode||(a.stopPropagation(),this.showUserMessageContextMenu(a,t,e))}),a.classList.add('avatar-hover')}}addTimestampInteractions(e,t){}addSpecialMessageInteractions(e,t){switch(t.messageType){case'image':case'transfer':break;case'voice':this.addVoiceInteractions(e,t);break;case'sticker':this.addStickerInteractions(e,t)}}addDoubleClickEdit(e,t){const a=e.querySelector('.message-content');if(!a)return;a.addEventListener('dblclick',e=>{this.handleMessageEdit(t),this.soundManager.playSound('click'),e.stopPropagation(),e.preventDefault()},!0)}addClickFeedback(e){e.classList.add('click-feedback'),setTimeout(()=>{e.classList.remove('click-feedback')},100)}addAvatarClickEffect(e){e.classList.add('avatar-click-effect'),setTimeout(()=>{e.classList.remove('avatar-click-effect')},150)}addVoiceInteractions(e,t){const a=e.querySelector('.voice-message'),s=e.querySelector('.voice-transcript');if(a&&s){let e=!1;const t=a.querySelector('.mic-icon'),n=a.querySelector('.pause-icon');a.addEventListener('click',r=>{r.stopPropagation(),e=!e,e?(a.classList.add('expanded'),s.style.display='block',s.classList.add('show'),t&&(t.style.display='none'),n&&(n.style.display='block')):(a.classList.remove('expanded'),s.style.display='none',s.classList.remove('show'),t&&(t.style.display='block'),n&&(n.style.display='none')),this.soundManager.playSound('click')})}}ensureVoiceMessageInteractions(e,t){if('voice'!==t.messageType)return;const a=e.querySelector('.voice-message'),s=e.querySelector('.voice-transcript');if(a&&!a.hasAttribute('data-voice-bound')){a.setAttribute('data-voice-bound','true');const e=()=>{const t=a.querySelector('.mic-icon'),n=a.querySelector('.pause-icon');if(t&&n&&s){let e=!1;const t=a.cloneNode(!0);a.parentNode?.replaceChild(t,a);const n=t.querySelector('.mic-icon'),r=t.querySelector('.pause-icon');t.addEventListener('click',a=>{a.stopPropagation(),e=!e,e?(t.classList.add('expanded'),s.style.display='block',s.classList.add('show'),n&&(n.style.display='none'),r&&(r.style.display='block')):(t.classList.remove('expanded'),s.style.display='none',s.classList.remove('show'),n&&(n.style.display='block'),r&&(r.style.display='none')),this.soundManager.playSound('click')}),console.log('✅ 语音消息事件绑定成功')}else setTimeout(e,50)};e()}}addStickerInteractions(e,t){const a=e.querySelector('.message-sticker');a&&a.addEventListener('click',()=>{this.soundManager.playSound('emoji'),this.addStickerAnimation(a)})}addStickerAnimation(e){e.classList.remove('sticker-animation','reset'),e.offsetHeight,e.classList.add('sticker-animation'),setTimeout(()=>{e.classList.add('reset'),setTimeout(()=>{e.classList.remove('sticker-animation','reset')},100)},300)}scrollToBottom(e){e.scrollTop=e.scrollHeight}createModalOverlay(){const e=document.createElement('div');return e.className='modal-overlay',e.addEventListener('click',t=>{t.target===e&&this.hideModal()}),e}createModalContainer(e,t){const a=document.createElement('div');a.className='modal-container';const s=document.createElement('div');s.className='modal-title',s.textContent=e;const n=document.createElement('div');return n.className='modal-content',n.appendChild(t),a.appendChild(s),a.appendChild(n),a}showModal(e,t,a=!0){const s=this.createModalOverlay(),n=this.createModalContainer(e,t);s.appendChild(n);(document.querySelector('.interface-container')||document.body).appendChild(s),setTimeout(()=>{s.classList.add('show')},10);const r=e=>{'Escape'===e.key&&(this.hideModal(),document.removeEventListener('keydown',r))};return document.addEventListener('keydown',r),a&&this.soundManager.playSound('click'),s}hideModal(){const e=document.querySelector('.modal-overlay');e&&(e.classList.remove('show'),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)),this.soundManager.playSound('click')}handleModalConfirm(e){e&&e(),this.hideModal()}handleModalCancel(e){e&&e(),this.hideModal()}createModalWithButtons(e,t,a,s=!0,n='确认',r='取消'){const o=document.createElement('div');o.appendChild(e);const i=document.createElement('div');i.className='modal-buttons';const l=document.createElement('button');if(l.className='modal-btn cancel-btn',l.textContent=r,l.addEventListener('click',()=>{this.handleModalCancel(a)}),i.appendChild(l),s&&t){const e=document.createElement('button');e.className='modal-btn confirm-btn',e.textContent=n,e.addEventListener('click',()=>{this.handleModalConfirm(t)}),i.appendChild(e)}return o.appendChild(i),o}playVoiceMessage(e){console.log('播放语音:',e)}handleTransferClick(e,t){if('{{user}}'===e.sender||'user'===e.sender)return;const a=e.content.split('|')[0]||'0',s=e.data?.originalNote||'';this.showTransferModal(e.sender,a,s,s=>{const n=s?'已接收':'已退回';t&&(t.textContent=n,t.classList.remove('completed','failed'),t.classList.add(s?'completed':'failed')),e.content=`${a}|${n}`,this.sendTransferResponse(e.sender,a,s)})}showTransferModal(e,t,a,s){const n=document.createElement('div');n.className='modal-overlay';const r=document.createElement('div'),o=document.getElementById('transferModalTemplate');if(o){r.innerHTML=o.innerHTML,r.className='transfer-modal';const s=r.querySelector('.sender-name'),n=r.querySelector('.amount-value'),i=r.querySelector('.transfer-note');s&&(s.textContent=e),n&&(n.textContent=t),i&&(i.textContent=a||'转账')}n.appendChild(r),setTimeout(()=>{n.classList.add('show')},10);const i=document.querySelector('.interface-container');if(i)i.appendChild(n);else{const e=document.querySelector('.chat-container');e?e.appendChild(n):document.body.appendChild(n)}const l=r.querySelector('.accept-btn'),c=r.querySelector('.reject-btn'),h=()=>{n.parentNode&&n.parentNode.removeChild(n)};l.addEventListener('click',()=>{s(!0),h(),this.soundManager.playSound('click')}),c.addEventListener('click',()=>{s(!1),h(),this.soundManager.playSound('click')}),n.addEventListener('click',e=>{e.target===n&&h()})}sendTransferResponse(e,t,a){const s=`transfer_response_${e}_${t}`,n=a?'已接收':'已退回',r={id:s,type:this.currentChat.startsWith('G_')?'G':'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'transfer',content:`${t}|${n}`,timestamp:(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})},o=this.sendQueue.findIndex(e=>e.id===s||e.content.includes(t)&&'{{user}}'===e.sender&&'transfer'===e.messageType);-1!==o?(this.sendQueue[o]=r,console.log('替换转账响应消息:',r)):(this.sendQueue.push(r),console.log('添加转账响应消息:',r)),this.renderCurrentChat()}handleMessageEdit(e){e.isPending?this.showEditDialog(e):console.log('只能编辑待发送的消息')}showEditDialog(e){const t=document.createElement('div');t.className='edit-modal-overlay';const a=document.createElement('div');a.className='edit-modal-dialog';const s=document.createElement('h3');s.textContent='编辑消息',s.className='edit-modal-title';const n=document.createElement('textarea');n.value=e.content,n.className='edit-modal-textarea';const r=document.createElement('div');r.className='edit-modal-buttons';const o=document.createElement('button');o.textContent='取消',o.className='edit-modal-cancel-btn';const i=document.createElement('button');i.textContent='确认',i.className='edit-modal-confirm-btn';const l=()=>{t.parentNode&&t.parentNode.removeChild(t)};o.addEventListener('click',()=>{l(),this.soundManager.playSound('click')}),i.addEventListener('click',()=>{const t=n.value.trim();t&&t!==e.content&&(this.updateMessageInQueue(e.id,t),console.log(`消息已更新: ${e.content} -> ${t}`)),l(),this.soundManager.playSound('send')}),r.appendChild(o),r.appendChild(i),a.appendChild(s),a.appendChild(n),a.appendChild(r),t.appendChild(a);const c=document.querySelector('.interface-container');if(c)c.appendChild(t);else{const e=document.querySelector('.chat-interface');e?e.appendChild(t):document.body.appendChild(t)}n.focus(),n.select();t.addEventListener('click',e=>{e.target===t&&(t.parentNode&&t.parentNode.removeChild(t),this.soundManager.playSound('click'))})}updateMessageInQueue(e,t){const a=this.sendQueue.findIndex(t=>t.id===e);-1!==a&&(this.sendQueue[a].content=t,this.updateSingleMessage(e,this.sendQueue[a]),console.log(`队列中的消息已更新，消息ID: ${e}`))}updateSingleMessage(e,t){const a=document.querySelector(`[data-message-id="${e}"]`);if(!a)return void console.warn(`找不到消息元素，ID: ${e}`);const s=this.createMessageElement(t);a.parentNode?.replaceChild(s,a),console.log(`单条消息已更新显示，ID: ${e}`)}addToSendQueue(e){const t=this.sendQueue.findIndex(t=>t.id===e.id);-1!==t?this.sendQueue[t]=e:this.sendQueue.push(e),console.log(`消息已添加到队列，当前待发送消息: ${this.sendQueue.length}`)}removeFromSendQueue(e){const t=this.sendQueue.findIndex(t=>t.id===e);-1!==t&&(this.sendQueue.splice(t,1),console.log('消息已从队列移除'))}getPendingMessagesForCurrentChat(){return this.sendQueue.filter(e=>e.chatId===this.currentChat)}generateChatId(e){return e.replace(/\s+/g,'_').toLowerCase()}generateMessageId(){return'msg_'+Date.now()+'_'+Math.random().toString(36).substring(2,9)}getCurrentTime(){const e=this.chatData.get(this.currentChat);if(e&&e.messages&&e.messages.length>0){const t=e.messages[e.messages.length-1];if(t.timestamp)try{const e=this.parseTimeString(t.timestamp);if(e)return e.setMinutes(e.getMinutes()+1),e.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}catch(e){console.warn('解析最新消息时间失败，使用当前时间:',e)}}return(new Date).toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}parseTimeString(e){try{const t=e.match(/^(\d{1,2}):(\d{2})$/);if(t){const e=parseInt(t[1],10),a=parseInt(t[2],10);if(e>=0&&e<=23&&a>=0&&a<=59){const t=new Date;return t.setHours(e,a,0,0),t}}return null}catch(t){return console.warn('解析时间字符串失败:',e,t),null}}cleanupTempImages(){try{const e=Object.keys(localStorage).filter(e=>e.startsWith('temp_image_'));if(e.length>50){e.sort((e,t)=>(parseInt(e.split('_')[2])||0)-(parseInt(t.split('_')[2])||0));const t=e.slice(0,Math.floor(e.length/2));t.forEach(e=>{localStorage.removeItem(e)}),console.log(`清理了 ${t.length} 个临时图片数据`)}}catch(e){console.warn('清理临时图片数据失败:',e)}}createImageInputModal(){const e=document.getElementById('imageInputModalTemplate');if(e){const t=document.createElement('div');t.innerHTML=e.innerHTML;const a=t.firstElementChild;return this.setupImageUploadEvents(a),a}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <div class="image-upload-section">\n        <label class="modal-label">选择图片：</label>\n        <div class="upload-options">\n          <div class="upload-row">\n            <button type="button" class="upload-btn local-upload-btn" id="localUploadBtn">\n              选择本地文件\n            </button>\n            <span class="upload-divider">或</span>\n          </div>\n          <div class="upload-row">\n            <input type="text" class="modal-input url-input" placeholder="输入图片链接..." id="imageUrlInput" />\n          </div>\n        </div>\n        <div class="file-preview" id="filePreview" style="display: none;">\n          <img id="previewImage" alt="预览图片" />\n          <div class="file-info">\n            <span id="fileName"></span>\n            <button type="button" class="remove-file-btn" id="removeFileBtn">✕</button>\n          </div>\n        </div>\n      </div>\n      \n      <label class="modal-label modal-label-spaced">图片描述：</label>\n      <input type="text" class="modal-input" placeholder="请输入图片描述（可选）..." id="imageDescInput" />\n      \n      <input type="file" id="fileInput" accept="image/*" style="display: none;" />\n    ',this.setupImageUploadEvents(t),t}setupImageUploadEvents(e){const t=e.querySelector('#localUploadBtn'),a=e.querySelector('#fileInput'),s=e.querySelector('#filePreview'),n=e.querySelector('#previewImage'),r=e.querySelector('#fileName'),o=e.querySelector('#removeFileBtn'),i=e.querySelector('#imageUrlInput');t&&a&&t.addEventListener('click',()=>{a.click()}),a&&a.addEventListener('change',e=>{const t=e.target,a=t.files?.[0];a&&this.handleFileSelection(a,s,n,r,i)}),o&&o.addEventListener('click',()=>{this.clearFileSelection(a,s,i)}),i&&i.addEventListener('input',()=>{i.value.trim()&&a&&this.clearFileSelection(a,s,null)})}handleFileSelection(e,t,a,s,n){if(!e.type.startsWith('image/'))return void this.showToast('请选择图片文件','error');if(e.size>5242880)return void this.showToast('图片文件大小不能超过5MB','error');const r=new FileReader;r.onload=r=>{const o=r.target?.result;a&&s&&t&&(a.src=o,s.textContent=e.name,t.style.display='flex',n&&(n.value=''))},r.readAsDataURL(e)}clearFileSelection(e,t,a){e&&(e.value=''),t&&(t.style.display='none'),a&&(a.value='')}createVoiceInputModal(){const e=document.getElementById('voiceInputModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">语音内容：</label>\n      <input type="text" class="modal-input" placeholder="请输入语音内容..." id="voiceContentInput" />\n      \n      <label class="modal-label modal-label-spaced">语音时长：</label>\n      <input type="number" class="modal-input" placeholder="请输入时长（秒）..." id="voiceDurationInput" min="1" max="300" />\n    ',t}createLocationInputModal(){const e=document.getElementById('locationInputModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">位置描述：</label>\n      <input type="text" class="modal-input" placeholder="请输入位置描述..." id="locationDescInput" />\n    ',t}createTransferInputModal(){const e=document.getElementById('transferInputModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">转账金额：</label>\n      <input type="number" class="modal-input" placeholder="请输入转账金额..." id="transferAmountInput" min="0.01" step="0.01" />\n      \n      <label class="modal-label modal-label-spaced">转账备注：</label>\n      <input type="text" class="modal-input" placeholder="请输入转账备注（可选）..." id="transferNoteInput" />\n    ',t}showImageInputModal(){const e=this.createImageInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('imageUrlInput'),t=document.getElementById('imageDescInput'),a=document.getElementById('fileInput'),s=document.getElementById('filePreview');if(e&&t&&a){const n=e.value.trim(),r=t.value.trim(),o=a.files&&a.files.length>0,i=s&&'none'!==s.style.display;if(!(n||o||i||r))return void this.showToast('请选择图片文件、输入图片URL或图片描述','warning');if(o&&a.files){const e=a.files[0];this.createImageMessageFromFile(e,r)}else if(i){const e=document.getElementById('previewImage');e&&e.src&&this.createImageMessage(e.src,r)}else this.createImageMessage(n,r);this.hideModal()}},()=>{this.hideModal()});this.showModal('发送图片',t,!1)}showVoiceInputModal(){const e=this.createVoiceInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('voiceContentInput'),t=document.getElementById('voiceDurationInput');if(e&&t){const a=e.value.trim(),s=t.value.trim();if(!a)return void this.showToast('请输入语音内容','warning');if(!s)return void this.showToast('请输入语音时长','warning');const n=parseFloat(s);if(isNaN(n)||n<=0||n>300)return void this.showToast('请输入有效的时长（1-300秒）','warning');this.createVoiceMessage(a,n),this.hideModal()}},()=>{this.hideModal()});this.showModal('发送语音',t,!1)}showLocationInputModal(){const e=this.createLocationInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('locationDescInput');if(e){const t=e.value.trim();if(!t)return void this.showToast('请输入位置描述','warning');this.createLocationMessage(t),this.hideModal()}},()=>{this.hideModal()});this.showModal('分享位置',t,!1)}showTransferInputModal(){const e=this.createTransferInputModal(),t=this.createModalWithButtons(e,()=>{const e=document.getElementById('transferAmountInput'),t=document.getElementById('transferNoteInput');if(e&&t){const a=e.value.trim(),s=t.value.trim();if(!a)return void this.showToast('请输入转账金额','warning');const n=parseFloat(a);if(isNaN(n)||n<=0)return void this.showToast('请输入有效的转账金额','warning');this.createTransferMessage(n,s),this.hideModal()}},()=>{this.hideModal()});this.showModal('发起转账',t,!1)}createImageMessage(e,t){let a,s={};if(console.log('🔍 [DEBUG] createImageMessage 调用:',{url:e.substring(0,100)+(e.length>100?'...':''),description:t,isBase64:e.startsWith('data:image/'),isHttpUrl:e.startsWith('http://')||e.startsWith('https://')}),e.startsWith('data:image/'))console.log('🖼️ 检测到base64数据'),a=t||'',s.base64Image=e;else if(e.startsWith('http://')||e.startsWith('https://'))console.log('🖼️ 检测到图片URL'),a=t||'',s.imageUrl=e;else if(e&&t)a=`╒═════${t}╘═════\n补充信息：${e}`;else if(e)a=`╒═════${e}╘═════`;else{if(!t)return void this.showToast('请输入图片URL或描述','warning');a=`╒═════${t}╘═════`}const n={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'image',content:a,timestamp:this.getCurrentTime(),isPending:!0,data:s};console.log('🔍 [DEBUG] 创建图片消息:',{id:n.id,content:n.content,hasBase64Image:!!n.data?.base64Image,hasUploadedFile:!!n.data?.uploadedFile}),this.addToSendQueue(n),this.addNewMessageToInterface(n)}createImageMessageFromFile(e,t){if(e.size>5242880)return void this.showToast('图片文件过大，请选择小于5MB的图片','error');const a=new FileReader;a.onload=a=>{const s=a.target?.result,n=`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;this.cleanupTempImages();try{localStorage.setItem(`temp_image_${n}`,s)}catch(a){console.warn('无法存储图片到本地存储，直接使用File对象:',a);const s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'image',content:t?`图片文件：${e.name}\n图片描述：${t}`:`图片文件：${e.name}`,timestamp:this.getCurrentTime(),isPending:!0,data:{uploadedFile:e}};return console.log('🔍 [DEBUG] 创建图片消息（localStorage失败）:',{id:s.id,content:s.content,hasUploadedFile:!!s.data?.uploadedFile,uploadedFileName:s.data?.uploadedFile?.name}),this.addToSendQueue(s),void this.addNewMessageToInterface(s)}let r;r=t?`图片URL：temp://${n}\n图片描述：${t}`:`图片URL：temp://${n}\n图片描述：${e.name}`;const o={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'image',content:r,timestamp:this.getCurrentTime(),isPending:!0,data:{uploadedFile:e,tempFileId:n}};console.log('🔍 [DEBUG] 创建图片消息:',{id:o.id,content:o.content,hasUploadedFile:!!o.data?.uploadedFile,uploadedFileName:o.data?.uploadedFile?.name,tempFileId:o.data?.tempFileId}),this.addToSendQueue(o),this.addNewMessageToInterface(o)},a.onerror=()=>{this.showToast('读取图片文件失败','error')},a.readAsDataURL(e)}createVoiceMessage(e,t){const a=`${e}|${t}`,s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'voice',content:a,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(s),this.addNewMessageToInterface(s)}createLocationMessage(e){const t={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'location',content:e,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(t),this.addNewMessageToInterface(t)}createTransferMessage(e,t){const a=t?`${e}|${t}`:`${e}|`,s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'transfer',content:a,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(s),this.addNewMessageToInterface(s)}async initializeGroupNameOverrideManager(){try{console.log('🚀 开始初始化群名覆盖管理器...'),N.initialize(),console.log('✅ 群名覆盖管理器初始化完成');const e=N.getDebugInfo();console.log('🔧 群名覆盖管理器调试信息:',e)}catch(e){console.error('❌ 群名覆盖管理器初始化失败:',e)}}async initializeStickerSystem(){try{const e=await this.getCurrentLorebook();if(!e)return void this.showToast('调用世界书失败，请检查世界书绑定','warning');this.stickerLorebookName=e,console.log(`🎯 确定使用世界书: ${e}`),this.loadStickerOrder(),await this.loadStickersFromLorebook(),console.log(`✅ 表情包系统初始化完成，使用世界书: ${e}，加载了 ${this.stickerData.length} 个表情包`)}catch(e){console.error('❌ 初始化表情包系统失败:',e),this.showToast('调用世界书失败，请检查世界书绑定','error')}}async getOrCreateStickerLorebook(){try{return console.log('=== 表情包世界书操作开始 ==='),console.log(`直接使用现有的表情包世界书: ${this.stickerLorebookName}`),this.stickerLorebookName}catch(e){throw console.error('获取或创建表情包世界书失败:',e),new Error(`创建表情包世界书失败: ${e.message||e}`)}}async loadStickersFromLorebook(){try{if(console.log('🎯 开始从世界书加载表情包数据...'),'function'!=typeof window.getLorebookEntries)return console.log('❌ 全局getLorebookEntries函数不存在，尝试从本地存储加载...'),void await this.loadStickersFromLocalStorage();let e=null,t='';const a=await this.getCharacterLorebook();if(a){console.log(`📖 尝试从角色世界书搜索表情包: ${a}`);try{e=(await window.getLorebookEntries(a)).find(e=>'表情包'===e.comment||e.comment.includes('表情包')),e?(t=`角色世界书: ${a}`,console.log('✅ 在角色世界书中找到表情包条目')):console.log('❌ 角色世界书中未找到表情包条目')}catch(e){console.warn('⚠️ 访问角色世界书失败:',e)}}if(!e){const a=await this.getGlobalLorebooks();for(const s of a){console.log(`🌍 尝试从全局世界书搜索表情包: ${s}`);try{if(e=(await window.getLorebookEntries(s)).find(e=>'表情包'===e.comment||e.comment.includes('表情包')),e){t=`全局世界书: ${s}`,console.log('✅ 在全局世界书中找到表情包条目');break}console.log(`❌ 全局世界书 ${s} 中未找到表情包条目`)}catch(e){console.warn(`⚠️ 访问全局世界书 ${s} 失败:`,e)}}}e?(console.log(`🎉 找到表情包条目，来源: ${t}`),await this.parseStickerEntry(e)):(console.log('❌ 在所有世界书中都未找到表情包条目，使用空数据'),this.stickerData=[],this.stickerCache.clear()),this.sortStickersByOrder(),console.log(`✅ 表情包数据加载完成，共 ${this.stickerData.length} 个表情包`)}catch(e){console.error('❌ 从世界书加载表情包失败:',e),await this.loadStickersFromLocalStorage()}}async getCharacterLorebook(){try{if('function'==typeof getCurrentCharPrimaryLorebook)return getCurrentCharPrimaryLorebook();console.warn('getCurrentCharPrimaryLorebook 函数不可用')}catch(e){console.warn('获取角色世界书失败:',e)}return null}async getGlobalLorebooks(){try{if('function'==typeof getLorebookSettings){return getLorebookSettings().selected_global_lorebooks||[]}return console.warn('getLorebookSettings 函数不可用'),[]}catch(e){console.warn('获取全局世界书设置失败:',e)}return[]}async parseStickerEntry(e){this.stickerData=[],this.stickerCache.clear();const t=(e.content||'').split('\n').filter(e=>e.trim());for(let e=0;e<t.length;e++){const a=t[e].trim();if(a){const t=this.parseStickerLine(a,e+1);t&&(this.stickerData.push(t),this.stickerCache.set(t.uid,t))}}console.log(`📦 从世界书条目解析了 ${this.stickerData.length} 个表情包`)}async loadStickersFromLocalStorage(){try{const e=localStorage.getItem('bear_stickers');if(e){this.stickerData=JSON.parse(e),console.log(`💾 从本地存储加载了 ${this.stickerData.length} 个表情包`),this.stickerCache.clear();for(const e of this.stickerData)this.stickerCache.set(e.uid,e);this.sortStickersByOrder()}else console.log('💾 本地存储中没有表情包数据'),this.stickerData=[],this.stickerCache.clear()}catch(e){console.error('❌ 从本地存储加载表情包失败:',e),this.stickerData=[],this.stickerCache.clear()}}parseStickerLine(e,t){try{const a=e.trim();if(!a)return null;let s='',n='';const r=a.match(/^(.+?)([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);if(r&&r[1].trim()&&r[2]){s=r[1].trim();const e=r[2];n=this.messageParser.processImageUrl(e)}else n=this.messageParser.processImageUrl(a),s=`表情包${t}`;return console.log(`解析表情包: "${a}" -> 备注: "${s}", URL: "${n}"`),{uid:t,url:n,note:s,rawContent:a}}catch(t){return console.error('解析表情包行失败:',t,e),null}}parseStickerFromEntry(e){try{const t=e.content?.trim();if(!t)return null;let a=e.comment?.trim()||'',s='';if(s=this.messageParser.processImageUrl(t),!a){const e=t.match(/^(.+?)([a-zA-Z0-9._-]+\.[a-zA-Z0-9]+)$/);e&&e[1].trim()&&(a=e[1].trim())}return a||(a='表情包'),{uid:e.uid,url:s,note:a,rawContent:t}}catch(t){return console.error('解析表情包条目失败:',t,e),null}}sortStickersByOrder(){this.stickerData.sort((e,t)=>(this.stickerOrder[e.uid]||999999)-(this.stickerOrder[t.uid]||999999))}loadStickerOrder(){try{const e=localStorage.getItem('sticker_order');e&&(this.stickerOrder=JSON.parse(e))}catch(e){console.error('加载表情包排序失败:',e),this.stickerOrder={}}}saveStickerOrder(){try{localStorage.setItem('sticker_order',JSON.stringify(this.stickerOrder))}catch(e){console.error('保存表情包排序失败:',e)}}async addStickerToLorebook(e,t){try{if(console.log('尝试添加表情包到世界书:',e,t),'function'==typeof window.getLorebookEntries&&'function'==typeof window.setLorebookEntries){console.log('使用全局函数操作世界书');const t=(await window.getLorebookEntries(this.stickerLorebookName)).find(e=>'表情包'===e.comment||e.comment.includes('表情包'));if(t){console.log('找到表情包条目，准备更新');const a=t.content||'',s=a?`${a}\n${e.trim()}`:e.trim(),n={...t,content:s};return await window.setLorebookEntries(this.stickerLorebookName,[n]),await this.loadStickersFromLorebook(),console.log('成功添加表情包到世界书'),!0}return console.log('未找到表情包条目，无法添加'),!1}{console.log('世界书API不可用，添加到本地缓存');const a={uid:Date.now(),comment:t||'',content:e.trim(),enabled:!0,url:'',note:'',rawContent:e.trim()};return this.stickerData.push(a),this.stickerCache.set(a.uid,a),localStorage.setItem('bear_stickers',JSON.stringify(this.stickerData)),console.log('成功添加表情包到本地缓存'),!0}}catch(a){console.error('添加表情包失败:',a);try{const a={uid:Date.now(),comment:t||'',content:e.trim(),enabled:!0,url:'',note:'',rawContent:e.trim()};return this.stickerData.push(a),this.stickerCache.set(a.uid,a),localStorage.setItem('bear_stickers',JSON.stringify(this.stickerData)),console.log('备用方案：成功添加表情包到本地缓存'),!0}catch(e){return console.error('备用添加也失败:',e),!1}}}async removeStickerFromLorebook(e){try{if(console.log(`🗑️ 开始删除表情包，uid: ${e}`),'function'==typeof window.getLorebookEntries&&'function'==typeof window.setLorebookEntries){console.log('使用全局函数操作世界书');const t=(await window.getLorebookEntries(this.stickerLorebookName)).find(e=>'表情包'===e.comment||e.comment.includes('表情包'));if(t){console.log('✅ 找到表情包条目，准备删除指定行');const a=(t.content||'').split('\n').filter(e=>e.trim());if(console.log(`📝 当前表情包条目有 ${a.length} 行`),console.log(`🎯 要删除第 ${e} 行`),!(e>0&&e<=a.length))return console.error(`❌ 无效的行号: ${e}，总行数: ${a.length}`),!1;a.splice(e-1,1),console.log(`✅ 成功删除第 ${e} 行，剩余 ${a.length} 行`);const s=a.join('\n'),n={uid:t.uid,content:s};return await window.setLorebookEntries(this.stickerLorebookName,[n]),await this.loadStickersFromLorebook(),console.log('✅ 成功从世界书删除表情包'),!0}return console.error('❌ 未找到表情包条目'),!1}return console.error('❌ 世界书全局函数不可用'),!1}catch(e){return console.error('❌ 从世界书删除表情包失败:',e),!1}}showStickerEditModal(e){const t=this.stickerCache.get(e);if(!t)return void this.showToast('表情包不存在','error');const a=document.createElement('div');a.className='modal-overlay';const s=document.createElement('div');s.className='modal-container';const n=document.getElementById('editStickerModalTemplate');if(n){s.innerHTML=n.innerHTML;const e=s.querySelector('#editStickerUrl'),a=s.querySelector('#editStickerNote');e&&(e.value=t.url),a&&(a.value=t.note)}a.appendChild(s),document.body.appendChild(a),setTimeout(()=>a.classList.add('show'),10);const r=s.querySelector('#editStickerUrl'),o=s.querySelector('#editStickerNote'),i=s.querySelector('.cancel-btn'),l=s.querySelector('.confirm-btn');i.addEventListener('click',()=>{this.hideModal()}),l.addEventListener('click',async()=>{const t=r.value.trim(),a=o.value.trim();if(t)try{if(await this.updateStickerInLorebook(e,t,a)){this.showToast('表情包更新成功','success'),this.hideModal();const e=document.getElementById('stickerSelector');e&&this.renderStickerGrid(e)}else this.showToast('表情包更新失败','error')}catch(e){console.error('更新表情包失败:',e),this.showToast('表情包更新失败','error')}else this.showToast('请输入表情包URL','warning')}),a.addEventListener('click',e=>{e.target===a&&this.hideModal()})}async updateStickerInLorebook(e,t,a){try{if(console.log(`🔄 开始更新表情包，uid: ${e}`),'function'==typeof window.getLorebookEntries&&'function'==typeof window.setLorebookEntries){console.log('✅ 使用全局函数更新表情包');const s=(await window.getLorebookEntries(this.stickerLorebookName)).find(e=>'表情包'===e.comment||e.comment.includes('表情包'));if(s){console.log('✅ 找到表情包条目，准备更新指定行');const n=(s.content||'').split('\n').filter(e=>e.trim());if(console.log(`📝 当前表情包条目有 ${n.length} 行`),console.log(`🎯 要更新第 ${e} 行`),!(e>0&&e<=n.length))return console.error(`❌ 无效的行号: ${e}，总行数: ${n.length}`),!1;{const s=a?`${a}${t}`:t;n[e-1]=s,console.log(`✅ 成功更新第 ${e} 行为: ${s}`)}const r=n.join('\n'),o={uid:s.uid,content:r};return await window.setLorebookEntries(this.stickerLorebookName,[o]),await this.loadStickersFromLorebook(),console.log('✅ 成功更新世界书中的表情包'),!0}return console.error('❌ 未找到表情包条目'),!1}return console.error('❌ 世界书全局函数不可用'),!1}catch(e){return console.error('❌ 更新世界书中的表情包失败:',e),!1}}updateStickerOrder(e){e.forEach((e,t)=>{this.stickerOrder[e]=t}),this.saveStickerOrder(),this.sortStickersByOrder()}showStickerSelector(){if(this.isStickerSelectorVisible)return;this.hidePlusMenu();const e=document.getElementById('stickerSelector');e&&(this.renderStickerGrid(e),e.classList.add('active'),this.isStickerSelectorVisible=!0,requestAnimationFrame(()=>{e.classList.add('show')}),setTimeout(()=>{this.setupStickerSelectorClickOutside()},100))}hideStickerSelector(){if(!this.isStickerSelectorVisible)return;const e=document.getElementById('stickerSelector');e&&(this.isDeleteMode=!1,this.selectedStickers.clear(),e.classList.remove('active','show'),this.isStickerSelectorVisible=!1,this.removeStickerSelectorClickOutside())}setupStickerSelectorClickOutside(){this.removeStickerSelectorClickOutside(),this.stickerSelectorClickOutsideHandler=e=>{const t=e.target,a=document.getElementById('stickerSelector'),s=document.getElementById('plusBtn'),n=document.getElementById('plusMenu'),r=document.querySelector('[data-type="sticker"]');!a||a.contains(t)||s?.contains(t)||n?.contains(t)||r?.contains(t)||this.hideStickerSelector()},setTimeout(()=>{this.stickerSelectorClickOutsideHandler&&document.addEventListener('click',this.stickerSelectorClickOutsideHandler)},300)}removeStickerSelectorClickOutside(){this.stickerSelectorClickOutsideHandler&&(document.removeEventListener('click',this.stickerSelectorClickOutsideHandler),this.stickerSelectorClickOutsideHandler=null)}renderStickerGrid(e){const t=e.querySelector('#stickerGrid');if(!t)return;t.innerHTML='';const a=this.createAddStickerButton();t.appendChild(a);const s=this.createDeleteModeButton();if(t.appendChild(s),this.isDeleteMode){const e=this.createDeleteConfirmButton();t.appendChild(e)}if(0===this.stickerData.length){const e=document.createElement('div');e.className='empty-state',e.style.gridColumn='span 2';const a=document.getElementById('stickerEmptyStateTemplate');return a&&(e.innerHTML=a.innerHTML),void t.appendChild(e)}this.stickerData.forEach((e,a)=>{const s=this.createStickerItem(e,a);t.appendChild(s)})}createStickerItem(e,t){const a=document.createElement('div');a.className='sticker-item',a.dataset.uid=e.uid.toString(),a.dataset.index=t.toString(),this.isDeleteMode&&a.classList.add('delete-mode'),this.selectedStickers.has(e.uid)&&a.classList.add('selected');const s=document.createElement('div');s.className='sticker-image';const n=document.createElement('img');n.src=e.url,n.alt=e.note,n.title=e.note;const r=document.createElement('div');r.className='sticker-note',r.textContent=e.note||'表情包';const o=document.createElement('div');return o.className='delete-checkbox',this.selectedStickers.has(e.uid)&&o.classList.add('checked'),a.addEventListener('click',t=>{t.stopPropagation(),this.isDeleteMode?this.toggleStickerSelection(e.uid):this.handleStickerSelection(e)}),this.isDeleteMode||this.addStickerEditEvents(a),s.appendChild(n),a.appendChild(s),a.appendChild(r),a.appendChild(o),a}createAddStickerButton(){const e=document.createElement('button');return e.className='add-sticker-btn',e.id='addStickerBtn',e.innerHTML='<span class="add-icon">+</span>',e.title='添加表情包',e.addEventListener('click',e=>{e.stopPropagation(),this.hideStickerSelector(),this.showAddStickerModal()}),e}createDeleteModeButton(){const e=document.createElement('button');e.className='delete-mode-btn',e.id='deleteModeBtn',this.isDeleteMode&&e.classList.add('active');const t=document.getElementById('deleteModeButtonTemplate');if(t){e.innerHTML=t.innerHTML;const a=e.querySelector('.delete-text');a&&(a.textContent=this.isDeleteMode?'取消':'删除')}return e.title=this.isDeleteMode?'取消删除模式':'进入删除模式',e.addEventListener('click',e=>{e.stopPropagation(),this.toggleDeleteMode()}),e}createDeleteConfirmButton(){const e=document.createElement('button');e.className='delete-confirm-btn show';const t=this.selectedStickers.size>0;t||e.classList.add('disabled');const a=document.getElementById('confirmDeleteButtonTemplate');return a&&(e.innerHTML=a.innerHTML),e.title=t?`删除选中的 ${this.selectedStickers.size} 个表情包`:'请先选择要删除的表情包',e.addEventListener('click',e=>{e.stopPropagation(),this.selectedStickers.size>0?this.handleDeleteSelectedStickers():this.showToast('请先选择要删除的表情包','warning')}),e}toggleDeleteMode(){this.isDeleteMode=!this.isDeleteMode,this.isDeleteMode||this.selectedStickers.clear();const e=document.getElementById('stickerSelector');e&&this.renderStickerGrid(e),this.soundManager.playSound('click')}toggleStickerSelection(e){this.selectedStickers.has(e)?this.selectedStickers.delete(e):this.selectedStickers.add(e),this.updateDeleteConfirmButton();const t=document.getElementById('stickerSelector');t&&this.renderStickerGrid(t),this.soundManager.playSound('click')}updateDeleteConfirmButton(){const e=document.querySelector('.delete-confirm-btn');if(!e)return;this.selectedStickers.size>0?(e.classList.remove('disabled'),e.title=`删除选中的 ${this.selectedStickers.size} 个表情包`):(e.classList.add('disabled'),e.title='请先选择要删除的表情包')}async handleDeleteSelectedStickers(){if(0===this.selectedStickers.size)return;if(confirm(`确定要删除选中的 ${this.selectedStickers.size} 个表情包吗？此操作不可撤销。`))try{const e=Array.from(this.selectedStickers).map(e=>this.removeStickerFromLorebook(e)),t=(await Promise.all(e)).filter(e=>e).length;t===this.selectedStickers.size?this.showToast(`成功删除 ${t} 个表情包`,'success'):t>0?this.showToast(`删除了 ${t}/${this.selectedStickers.size} 个表情包`,'warning'):this.showToast('表情包删除失败','error'),this.selectedStickers.clear(),this.isDeleteMode=!1;const a=document.getElementById('stickerSelector');a&&this.renderStickerGrid(a)}catch(e){console.error('删除选中表情包失败:',e),this.showToast('删除表情包时发生错误','error')}}showAddStickerModal(){const e=this.createAddStickerModal(),t=this.createModalWithButtons(e,()=>{this.handleAddStickerConfirm()},()=>{this.hideModal(),setTimeout(()=>this.showStickerSelector(),100)});this.showModal('添加表情包',t)}createAddStickerModal(){const e=document.getElementById('addStickerModalTemplate');if(e){const t=document.createElement('div');return t.innerHTML=e.innerHTML,t.firstElementChild}const t=document.createElement('div');return t.className='modal-content',t.innerHTML='\n      <label class="modal-label">表情包内容：</label>\n      <input type="text" class="modal-input" placeholder="输入URL、文件名或备注+文件名..." id="stickerContentInput" />\n      \n      <label class="modal-label modal-label-spaced">表情包备注：</label>\n      <input type="text" class="modal-input" placeholder="输入表情包备注（可选）..." id="stickerNoteInput" />\n      \n      <div class="input-help">\n        <p>支持格式：</p>\n        <ul>\n          <li>完整URL：https://example.com/image.jpg</li>\n          <li>文件名：ei6coi.jpeg</li>\n          <li>备注+文件名：我是败犬ei6coi.jpeg</li>\n        </ul>\n      </div>\n    ',t}async handleAddStickerConfirm(){const e=document.getElementById('stickerContentInput'),t=document.getElementById('stickerNoteInput');if(!e||!t)return;const a=e.value.trim(),s=t.value.trim();if(a)try{await this.addStickerToLorebook(a,s)?(this.showToast('表情包添加成功','success'),this.hideModal(),setTimeout(()=>this.showStickerSelector(),100)):this.showToast('表情包添加失败','error')}catch(e){console.error('添加表情包失败:',e),this.showToast('表情包添加失败','error')}else this.showToast('请输入表情包内容','warning')}handleStickerSelection(e){this.createStickerMessage(e),this.hideStickerSelector(),this.soundManager.playSound('emoji')}async handleStickerDelete(e){try{if(await this.removeStickerFromLorebook(e)){this.showToast('表情包删除成功','success');const e=document.getElementById('stickerSelector');e&&this.renderStickerGrid(e)}else this.showToast('表情包删除失败','error')}catch(e){console.error('删除表情包失败:',e),this.showToast('表情包删除失败','error')}}createStickerMessage(e){const t=this.extractFileNameFromUrl(e.url),a=e.note+t;console.log(`📝 表情包发送格式: ${a} (原URL: ${e.url})`);const s={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'sticker',content:a,timestamp:this.getCurrentTime(),isPending:!0,data:{stickerUrl:e.url,stickerNote:e.note,stickerFileName:t}};this.addToSendQueue(s),this.addNewMessageToInterface(s)}extractFileNameFromUrl(e){try{const t=e.split('/'),a=t[t.length-1].split('?')[0];return console.log(`🔍 从URL提取文件名: ${e} -> ${a}`),a}catch(e){console.warn('提取文件名失败:',e);return`${Math.random().toString(36).substr(2,6)}.jpg`}}addStickerEditEvents(e){let t,a=!1;const s=()=>{t=setTimeout(()=>{a=!0;const t=parseInt(e.dataset.uid||'0');this.showStickerEditModal(t)},500)},n=()=>{t&&clearTimeout(t),a=!1};e.addEventListener('mousedown',s),e.addEventListener('touchstart',s),e.addEventListener('mouseup',n),e.addEventListener('mouseleave',n),e.addEventListener('touchend',n),e.addEventListener('touchcancel',n),e.addEventListener('click',e=>{a&&(e.preventDefault(),e.stopPropagation(),a=!1)})}handleInputChange(e){if(!this.settingsModal||!this.settingsModal.getCurrentSettings().emojiSuggestionsEnabled)return void this.hideStickerSuggestionsImmediately();const t=e.target.value.trim();this.inputChangeTimer&&clearTimeout(this.inputChangeTimer),t?this.inputChangeTimer=setTimeout(()=>{this.searchAndShowSuggestions(t)},300):this.hideStickerSuggestionsImmediately()}searchAndShowSuggestions(e){const t=this.findMatchingStickers(e);t.length>0?this.showStickerSuggestions(t):this.hideStickerSuggestionsImmediately()}findMatchingStickers(e){if(!e||0===this.stickerData.length)return[];const t=e.toLowerCase(),a=[];for(const e of this.stickerData){const s=e.note.toLowerCase();let n=0;s===t?n=100:s.startsWith(t)?n=80:s.includes(t)?n=60:this.fuzzyMatch(s,t)?n=40:this.pinyinMatch(s,t)&&(n=30),n>0&&a.push({sticker:e,score:n})}return a.sort((e,t)=>t.score-e.score).slice(0,6).map(e=>e.sticker)}fuzzyMatch(e,t){let a=0,s=0;for(;a<e.length&&s<t.length;)e[a]===t[s]&&s++,a++;return s===t.length}pinyinMatch(e,t){const a={a:['啊','阿'],b:['不','白','被','本','比','别','把'],c:['出','从','才','成','长','常','吃'],d:['的','到','都','大','对','但','得','打'],e:['额','恶'],f:['发','放','非','分','风','服'],g:['个','给','过','国','公','高','感'],h:['和','很','好','还','会','后','黑','红'],j:['就','进','见','叫','家','今','几'],k:['可','看','开','快','哭'],l:['了','来','里','老','两','路','绿'],m:['没','么','们','面','美','猫'],n:['你','那','能','年','女'],p:['跑','怕','朋'],q:['去','前','起','请'],r:['人','让','如','然'],s:['是','说','所','三','上','时','生'],t:['他','她','它','太','天','听','头'],w:['我','为','问','王','五','万'],x:['想','小','心','新','笑','下'],y:['一','有','要','也','用','又','眼'],z:['在','这','中','自','走','最','做']};for(const s of t)if(a[s])for(const t of a[s])if(e.includes(t))return!0;return!1}showStickerSuggestions(e){if(!document.getElementById('inputField'))return;this.suggestionContainer&&this.suggestionContainer.parentNode&&this.suggestionContainer.parentNode.removeChild(this.suggestionContainer),this.suggestionContainer=document.createElement('div'),this.suggestionContainer.className='sticker-suggestions',this.suggestionContainer.innerHTML=`\n      <div class="suggestions-header">\n        <span class="suggestions-title">表情包建议</span>\n        <span class="suggestions-count">${e.length}</span>\n      </div>\n      <div class="suggestions-grid"></div>\n    `;const t=document.querySelector('.chat-input');if(!t)return;t.appendChild(this.suggestionContainer);const a=this.suggestionContainer.querySelector('.suggestions-grid');e.forEach(e=>{const t=document.createElement('div');t.className='suggestion-item',t.title=e.note||'表情包';const s=document.createElement('img');s.src=e.url,s.alt=e.note||'表情包',s.onerror=()=>{t.style.display='none'},t.appendChild(s),a.appendChild(t),t.addEventListener('click',t=>{t.preventDefault(),t.stopPropagation(),this.sendStickerFromSuggestion(e)})}),this.isSuggestionVisible=!0,setTimeout(()=>{this.suggestionContainer&&this.suggestionContainer.classList.add('show')},10)}hideStickerSuggestions(){this.suggestionContainer?(this.suggestionContainer.classList.remove('show'),setTimeout(()=>{this.suggestionContainer&&this.suggestionContainer.parentNode&&this.suggestionContainer.parentNode.removeChild(this.suggestionContainer),this.suggestionContainer=null,this.isSuggestionVisible=!1},200)):this.isSuggestionVisible=!1}hideStickerSuggestionsImmediately(){this.suggestionContainer?(this.suggestionContainer.classList.remove('show'),this.suggestionContainer.parentNode&&this.suggestionContainer.parentNode.removeChild(this.suggestionContainer),this.suggestionContainer=null,this.isSuggestionVisible=!1):this.isSuggestionVisible=!1}sendStickerFromSuggestion(e){const t=document.getElementById('inputField');t&&(t.value='');const a=this.extractFileNameFromUrl(e.url),s=e.note?`${e.note}${a}`:a,n={id:this.generateMessageId(),type:'S',chatId:this.currentChat,sender:'{{user}}',avatar:'',messageType:'sticker',content:s,timestamp:this.getCurrentTime(),isPending:!0};this.addToSendQueue(n),this.addNewMessageToInterface(n),this.hideStickerSuggestionsImmediately(),this.soundManager.playSound('click'),console.log('从建议发送表情包:',e.note,'→',s)}showUserMessageContextMenu(e,t,a){const s=document.createElement('div');s.className='modal-overlay user-message-context-modal',s.innerHTML='\n      <div class="modal-container">\n        <div class="modal-header">\n          <h3>消息操作</h3>\n          <button class="modal-close-btn">&times;</button>\n        </div>\n        <div class="modal-body">\n          <button class="modal-btn delete-btn" data-action="batch-delete">\n            删除消息\n          </button>\n          <button class="modal-btn reroll-btn" data-action="reroll">\n            重新生成\n          </button>\n        </div>\n      </div>\n    ';const n=document.querySelector('.phone-container');n?n.appendChild(s):document.body.appendChild(s),setTimeout(()=>{s.classList.add('show')},10);const r=s.querySelector('[data-action="batch-delete"]'),o=s.querySelector('[data-action="reroll"]'),i=s.querySelector('.modal-close-btn');r&&r.addEventListener('click',()=>{this.enterBatchDeleteMode(),s.remove()}),o&&o.addEventListener('click',()=>{this.handleRerollMessage(t,a),s.remove()}),i&&i.addEventListener('click',()=>{s.remove()}),s.addEventListener('click',e=>{e.target===s&&s.remove()})}enterBatchDeleteMode(){this.isBatchDeleteMode=!0,this.selectedMessages.clear(),this.showBatchDeleteToolbar(),this.enableMessageSelection();const e=document.querySelector('.chat-container');e&&e.classList.add('batch-delete-mode')}exitBatchDeleteMode(){this.isBatchDeleteMode=!1,this.selectedMessages.clear(),this.hideBatchDeleteToolbar(),this.disableMessageSelection();const e=document.querySelector('.chat-container');e&&e.classList.remove('batch-delete-mode')}showBatchDeleteToolbar(){this.batchDeleteToolbar&&this.batchDeleteToolbar.remove(),this.batchDeleteToolbar=document.createElement('div'),this.batchDeleteToolbar.className='batch-delete-toolbar',this.batchDeleteToolbar.innerHTML='\n      <div class="toolbar-content">\n        <span class="selected-count">已选择 0 条消息</span>\n        <div class="toolbar-buttons">\n          <button class="toolbar-btn cancel-btn">取消</button>\n          <button class="toolbar-btn delete-btn" disabled>删除</button>\n        </div>\n      </div>\n    ';const e=document.querySelector('.chat-container');e&&e.appendChild(this.batchDeleteToolbar),this.bindBatchDeleteToolbarEvents()}hideBatchDeleteToolbar(){this.batchDeleteToolbar&&(this.batchDeleteToolbar.remove(),this.batchDeleteToolbar=null)}bindBatchDeleteToolbarEvents(){if(!this.batchDeleteToolbar)return;const e=this.batchDeleteToolbar.querySelector('.cancel-btn'),t=this.batchDeleteToolbar.querySelector('.delete-btn');e.addEventListener('click',()=>{this.exitBatchDeleteMode()}),t.addEventListener('click',async()=>{await this.confirmBatchDelete()})}enableMessageSelection(){document.querySelectorAll('.message').forEach(e=>{e.classList.add('selectable');const t=document.createElement('div');t.className='message-checkbox',t.innerHTML='<div class="checkbox-inner"></div>',e.insertBefore(t,e.firstChild);const a=e=>this.handleMessageSelection(e);e.addEventListener('click',a),e._selectionHandler=a})}disableMessageSelection(){document.querySelectorAll('.message').forEach(e=>{e.classList.remove('selectable','selected');const t=e.querySelector('.message-checkbox');t&&t.remove();const a=e._selectionHandler;a&&(e.removeEventListener('click',a),delete e._selectionHandler)})}handleMessageSelection(e){if(!this.isBatchDeleteMode)return;const t=e.currentTarget;this.soundManager.playSound('click');const a=document.getElementById('chatMessages');if(!a)return;const s=Array.from(a.children).indexOf(t);if(-1===s)return;const n=s.toString();this.selectedMessages.has(n)?(this.selectedMessages.delete(n),t.classList.remove('selected')):(this.selectedMessages.add(n),t.classList.add('selected')),this.updateBatchDeleteToolbar()}updateBatchDeleteToolbar(){if(!this.batchDeleteToolbar)return;const e=this.selectedMessages.size,t=this.batchDeleteToolbar.querySelector('.selected-count'),a=this.batchDeleteToolbar.querySelector('.delete-btn');t.textContent=`已选择 ${e} 条消息`,a.disabled=0===e}async confirmBatchDelete(){if(0===this.selectedMessages.size)return;const e=this.selectedMessages.size;confirm(`确定要删除选中的 ${e} 条消息吗？此操作不可撤销。`)&&await this.executeBatchDelete()}async executeBatchDelete(){console.log('🗑️ === 开始批量删除调试 ===');const e=this.chatData.get(this.currentChat);if(e){console.log('📋 批量删除状态:'),console.log('  - 当前聊天:',this.currentChat),console.log('  - 选中的消息位置索引:',Array.from(this.selectedMessages)),console.log('  - 消息总数:',e.messages.length);try{const t=Array.from(this.selectedMessages).map(e=>parseInt(e,10));if(console.log('📊 选中的DOM位置索引:',t),console.log('  - 消息总数:',e.messages.length),0===t.length)return console.warn('⚠️ 没有选中要删除的消息'),void this.showToast('没有选中要删除的消息','warning');const a=t.filter(t=>t>=0&&t<e.messages.length);if(a.length!==t.length&&(console.warn('⚠️ 部分选中的消息索引无效'),console.log('  - 原始索引:',t),console.log('  - 有效索引:',a)),0===a.length)return console.warn('⚠️ 没有有效的消息索引'),void this.showToast('选中的消息无效','warning');await this.deleteSelectedMessages(a),this.exitBatchDeleteMode(),console.log('✅ 批量删除完成')}catch(e){console.error('❌ 批量删除失败:',e),this.showToast('批量删除失败','error')}finally{console.log('🗑️ === 批量删除调试结束 ===')}}else console.error('❌ 当前聊天数据不存在')}renderChatMessages(){const e=document.getElementById('chatMessages');if(!e)return;e.innerHTML='';const t=this.chatData.get(this.currentChat);t&&(t.messages.forEach(t=>{const a=this.createMessageElement(t);e.appendChild(a)}),this.isBatchDeleteMode&&this.enableMessageSelection(),this.scrollToBottom(e))}showDeleteMessageModal(){const e=this.chatData.get(this.currentChat);if(!e)return;const t=e.messages;if(0===t.length)return;const a=document.createElement('div');a.className='modal-overlay delete-message-modal',a.innerHTML=`\n      <div class="modal-container">\n        <div class="modal-header">\n          <h3>删除消息</h3>\n          <button class="modal-close-btn">&times;</button>\n        </div>\n        \n        <div class="modal-body">\n          <div class="delete-options">\n            <label class="delete-option">\n              <input type="radio" name="deleteType" value="single" checked>\n              <span>删除单条消息</span>\n            </label>\n            <label class="delete-option">\n              <input type="radio" name="deleteType" value="batch">\n              <span>批量删除消息</span>\n            </label>\n          </div>\n          \n          <div class="message-list" id="deleteMessageList">\n            ${t.map((e,t)=>`\n              <div class="message-item" data-message-index="${t}">\n                <label class="message-checkbox">\n                  <input type="checkbox" value="${t}">\n                  <span class="checkmark"></span>\n                </label>\n                <div class="message-preview">\n                  <div class="message-sender">${e.sender}</div>\n                  <div class="message-content-preview">${this.truncateText(e.content,50)}</div>\n                  <div class="message-time">${e.timestamp}</div>\n                </div>\n              </div>\n            `).join('')}\n          </div>\n        </div>\n        \n        <div class="modal-footer">\n          <button class="modal-btn cancel-btn">取消</button>\n          <button class="modal-btn delete-btn">删除选中</button>\n        </div>\n      </div>\n    `;const s=document.querySelector('.phone-container');s?s.appendChild(a):document.body.appendChild(a),setTimeout(()=>{a.classList.add('show')},10),this.bindDeleteMessageModalEvents(a,t)}bindDeleteMessageModalEvents(e,t){const a=e.querySelectorAll('input[name="deleteType"]'),s=(e.querySelector('#deleteMessageList'),e.querySelectorAll('.message-checkbox input[type="checkbox"]')),n=e.querySelector('.delete-btn'),r=e.querySelector('.cancel-btn'),o=e.querySelector('.modal-close-btn');a.forEach(e=>{e.addEventListener('change',e=>{'single'===e.target.value?s.forEach((e,t)=>{const a=e;a.checked=0===t}):s.forEach(e=>{e.checked=!1})})}),s.forEach((t,a)=>{t.addEventListener('change',t=>{const n=t.target;'single'===e.querySelector('input[name="deleteType"]:checked').value&&n.checked&&s.forEach((e,t)=>{t!==a&&(e.checked=!1)})})}),n.addEventListener('click',async()=>{const t=[];s.forEach((e,a)=>{e.checked&&t.push(a)}),0!==t.length?(await this.deleteSelectedMessages(t),e.remove()):this.showToast('请选择要删除的消息','warning')}),[r,o].forEach(t=>{t.addEventListener('click',()=>{e.remove()})}),e.addEventListener('click',t=>{t.target===e&&e.remove()})}async deleteSelectedMessages(e){console.log('🗑️ === 开始删除消息调试 ==='),console.log('📋 要删除的消息索引:',e);try{const t=this.chatData.get(this.currentChat);if(!t)return void console.error('❌ 当前聊天数据不存在:',this.currentChat);console.log('📊 删除前聊天数据状态:'),console.log('  - 当前聊天:',this.currentChat),console.log('  - 消息总数:',t.messages.length),console.log('  - 要删除的消息数量:',e.length);e.map(e=>{const a=t.messages[e];return console.log(`  - 索引 ${e}: ${a?'消息存在':'消息不存在'}`),a});console.log('📨 SillyTavern 楼层状态检查:');const a='function'==typeof getLastMessageId?getLastMessageId():0;console.log('  - 最后楼层ID:',a),console.log('  - 说明: 所有消息都存储在同一楼层中，使用 bear 标签格式'),console.log('🔄 从前端数据中移除消息...'),e.sort((e,t)=>t-e),e.forEach(e=>{const a=t.messages.splice(e,1)[0];console.log(`  - 移除索引 ${e}:`,a?a.content.substring(0,30)+'...':'空消息')}),console.log('📊 删除后前端数据状态:'),console.log('  - 剩余消息数:',t.messages.length),console.log('🔄 重新构建 bear 日志内容...');const s=this.messageParser.buildSingleChatBearContent(t);if(console.log('📝 bear 内容已更新'),'function'!=typeof setChatMessages)return console.error('❌ setChatMessages 函数不可用'),void this.showToast('删除功能不可用','error');{console.log('🚀 调用 setChatMessages API 更新楼层内容...');const e='function'==typeof getLastMessageId?getLastMessageId():0;console.log('  - 目标楼层ID:',e);const t=getChatMessages(-1)[0],a=t?.message||'',n=s.replace('<bear>','').replace('</bear>',''),r=[{message_id:e,message:this.replaceOnlyBearTagContent(a,n)}];if(console.log('  - 更新的消息数据:',{message_id:e,content_length:s.length}),await setChatMessages(r,{refresh:'none'}),console.log('✅ setChatMessages API 调用成功 - 楼层内容已更新'),'function'==typeof getChatMessages)try{const t=getChatMessages(`${e}`);if(t&&t.length>0){t[0];console.log('📊 SillyTavern 楼层已更新')}}catch(e){console.error('❌ 验证更新结果失败:',e)}}console.log('🎨 重新渲染聊天界面...'),this.renderCurrentChat(),console.log('✅ 消息删除完成'),this.showToast(`已删除 ${e.length} 条消息`,'success')}catch(t){console.error('❌ 删除消息失败:',t),console.error('错误详情:',{message:t.message,stack:t.stack,messageIndices:e,currentChat:this.currentChat}),this.showToast('删除消息失败','error')}finally{console.log('🗑️ === 删除消息调试结束 ===')}}async handleRerollMessage(e,t){try{console.log('🔄 开始重新生成消息，从消息:',e);const a=this.chatData.get(this.currentChat);if(!a)return void this.showToast('未找到当前聊天数据','error');let s=-1;if(t){console.log('🔍 通过DOM元素位置查找消息...');const e=document.getElementById('chatMessages');if(e){const n=Array.from(e.children),r=n.indexOf(t);console.log('📍 DOM位置信息:'),console.log('  - 消息元素在DOM中的索引:',r),console.log('  - DOM中总消息元素数:',n.length),console.log('  - 聊天数据中的消息数:',a.messages.length),-1!==r&&r<a.messages.length&&(s=r,console.log('✅ 通过DOM位置找到消息，索引:',s))}}if(-1===s)return console.log('❌ 无法通过DOM位置找到消息，请从聊天列表重新进入后再试'),void this.showToast('无法定位消息，请从聊天列表重新进入后再试','warning');console.log(`📍 找到消息位置: ${s}, 总消息数: ${a.messages.length}`);const n=a.messages.slice(s+1);if(console.log(`🗑️ 需要删除 ${n.length} 条消息`),n.length>0){if(a.messages=a.messages.slice(0,s+1),a.messages.length>0){const e=a.messages[a.messages.length-1];a.lastMessage=this.messageParser.formatLastMessage(e)}console.log('🔄 重新构建 bear 日志内容...');const e=this.messageParser.buildSingleChatBearContent(a);if('function'!=typeof setChatMessages)return console.error('❌ setChatMessages 函数不可用'),void this.showToast('删除功能不可用','error');{console.log('🚀 调用 setChatMessages API 更新楼层内容...');const t='function'==typeof getLastMessageId?getLastMessageId():0,a=getChatMessages(-1)[0],s=a?.message||'',n=e.replace('<bear>','').replace('</bear>',''),r=[{message_id:t,message:this.replaceOnlyBearTagContent(s,n)}];await setChatMessages(r,{refresh:'none'}),console.log('✅ setChatMessages API 调用成功 - 楼层内容已更新')}console.log('✅ 已删除后续消息并更新楼层'),console.log('🎨 精确删除DOM中的后续消息元素...'),this.removeMessagesFromDOM(s+1)}const r=this.chatData.get(e.chatId);let o='';if('group'===r?.type){o=`回复和${r.chatName||e.chatId}的聊天：`}else{const t=r?.chatName||e.chatId;o=`回复和${this.extractCharacterNameFromChatName(t)}的聊天：`}let i=e.content;'text'!==e.messageType&&(i=`${e.messageType}:${e.content}`);const l=`${o}${i}`;console.log('📝 构建的提示词:',l),this.showToast('正在重新生成回复...','info');const c=await this.showTypingIndicator(),h=await generate({user_input:l,should_stream:!1});console.log('🤖 收到AI回复:',h),this.hideTypingIndicator(c),await this.handleAIResponse(h,e)}catch(e){console.error('❌ 重新生成消息失败:',e),this.showToast('重新生成失败，请重试','error'),this.soundManager.playSound('error')}}removeMessagesFromDOM(e){try{const t=document.getElementById('chatMessages');if(!t)return void console.error('找不到消息容器 #chatMessages');const a=Array.from(t.children);console.log(`🗑️ 准备删除DOM中索引 ${e} 之后的消息元素`),console.log(`  - DOM中总消息元素数: ${a.length}`),console.log('  - 需要删除的元素数: '+(a.length-e));for(let t=a.length-1;t>=e;t--){const e=a[t];e&&(console.log(`  - 删除DOM元素索引: ${t}`),e.remove())}console.log('✅ DOM消息元素删除完成')}catch(e){console.error('❌ 删除DOM消息元素失败:',e),console.log('🔄 回退到重新渲染整个界面...'),this.renderCurrentChat()}}truncateText(e,t){return e.length<=t?e:e.substring(0,t)+'...'}debugCharacterInfo(){console.log('=== 详细角色信息调试 ===');const e={角色信息获取:{},缓存状态:{},联系人数据:{}};if(console.log('🔍 检查 TavernHelper...'),e.角色信息获取.TavernHelper存在='undefined'!=typeof TavernHelper,'undefined'!=typeof TavernHelper&&(e.角色信息获取.getCharData方法存在='function'==typeof TavernHelper.getCharData,'function'==typeof TavernHelper.getCharData))try{const t=TavernHelper.getCharData();e.角色信息获取.getCharData结果=t,console.log('📋 TavernHelper.getCharData() 结果:',t)}catch(t){e.角色信息获取.getCharData错误=t.message,console.error('❌ TavernHelper.getCharData() 错误:',t)}if(console.log('🔍 检查全局函数...'),e.角色信息获取.getCharData函数存在='function'==typeof getCharData,'function'==typeof getCharData)try{const t=getCharData();e.角色信息获取.getCharData结果=t,console.log('📋 getCharData() 结果:',t)}catch(t){e.角色信息获取.getCharData错误=t.message,console.error('❌ getCharData() 错误:',t)}if(e.角色信息获取.this_chid=void 0!==window.this_chid?window.this_chid:'未定义',e.角色信息获取.name2=void 0!==window.name2?window.name2:'未定义',e.角色信息获取.characters存在=void 0!==window.characters,void 0!==window.characters&&void 0!==window.this_chid){const t=window.characters[window.this_chid];e.角色信息获取.当前角色数据=t,console.log('📋 当前角色数据 (characters[this_chid]):',t)}const t=this.getCurrentCharacterId();e.角色信息获取.最终使用的角色ID=t,console.log(`🎭 最终使用的角色ID: ${t}`);const a=[],s=[],n=[];for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&(a.push(t),t.includes('bear_chat_isolated_')&&(s.push(t),t.includes('_contacts')&&n.push(t)))}e.缓存状态.所有localStorage键数量=a.length,e.缓存状态.角色隔离键=s,e.缓存状态.联系人缓存键=n,console.log('🔐 所有角色隔离的缓存键:',s),console.log('👥 所有联系人缓存键:',n),n.forEach(t=>{try{const a=localStorage.getItem(t),s=a?JSON.parse(a):null;e.缓存状态[t]={有数据:!!a,联系人数量:s?.contacts?.length||0,联系人名称:s?.contacts?.map(e=>e.name)||[]},console.log(`📦 ${t}:`,{联系人数量:s?.contacts?.length||0,联系人名称:s?.contacts?.map(e=>e.name)||[]})}catch(a){e.缓存状态[t]={错误:a.message},console.error(`❌ 解析 ${t} 失败:`,a)}});const r=this.chatListManager.getContactManager().getAllContacts();return e.联系人数据.内存中的联系人数量=r.length,e.联系人数据.内存中的联系人名称=r.map(e=>e.name),console.log('💾 内存中的联系人:',r.map(e=>({name:e.name,id:e.id}))),e}testCharacterIsolation(){return this.debugCharacterInfo()}getScaleManager(){return this.scaleManager}getTypingSpeedManager(){return this.typingSpeedManager}getSendQueueStatus(){const e={};for(const t of this.sendQueue)e[t.chatId]=(e[t.chatId]||0)+1;return{totalMessages:this.sendQueue.length,messagesByChat:e,crossChatSendEnabled:this.crossChatSendEnabled}}triggerCharacterChange(){console.log('🔄 手动触发角色切换处理...'),this.handleCharacterChange()}checkCharacterChange(){const e=this.getCurrentCharacterId();console.log(`🔍 当前角色ID: ${e}`),this.handleCharacterChange()}normalizeChatIdForComparison(e){return e.trim().replace(/\s+/g,'_').toLowerCase()}extractCharacterNameFromChatName(e){const t=e.match(/^和(.+)的聊天$/);return t?t[1]:e}async detectNewMessagesBeforeMerge(e){try{let t=[];if(this.lastBearContent){console.log('🔍 进行Bear内容差异检测');const a=this.messageParser.parseBearContent(this.lastBearContent),s=this.messageParser.parseBearContent(e);t=this.findNewMessages(await a,await s)}else{console.log('🔍 首次解析Bear内容，检查是否有新的AI回复');const a=this.messageParser.parseBearContent(e),s=this.getExistingMessagesFromInterface();console.log('🔍 [DEBUG] 现有消息指纹集合:',Array.from(s)),console.log('🔍 [DEBUG] 当前聊天ID:',this.currentChat);for(const[e,n]of await a){console.log(`🔍 [DEBUG] 检查聊天 "${e}" 的消息`);for(const e of n.messages){const a=this.generateMessageFingerprint(e);console.log(`🔍 [DEBUG] 消息指纹: "${a}", 发送者: "${e.sender}", 内容: "${e.content.substring(0,30)}..."`),'{{user}}'!==e.sender&&'user'!==e.sender?(console.log('🔍 [DEBUG] 这是AI消息，检查是否已存在'),s.has(a)?console.log('🔍 [DEBUG] ❌ AI消息已存在，跳过'):(console.log('🔍 [DEBUG] ✅ 发现新AI消息，添加到渲染队列'),t.push(e))):console.log('🔍 [DEBUG] 这是用户消息，跳过')}}}return console.log(`🔍 [DEBUG] 最终新消息数量: ${t.length}`),t.length>0&&(console.log(`🆕 发现 ${t.length} 条新消息`),t.forEach((e,t)=>{console.log(`🆕 [DEBUG] 新消息${t+1}: 发送者="${e.sender}", 内容="${e.content.substring(0,50)}..."`)})),t}catch(e){return console.error('❌ 检测新消息失败:',e),[]}}async renderDetectedNewMessages(e){if(0!==e.length){if(this.chatListManager&&e.length>0){console.log('📊 立即更新未读消息计数...',e.length,'条新消息'),this.chatListManager.updateChatData(this.chatData);const t='chat'===this.currentInterface?this.currentChat:void 0;this.chatListManager.onNewMessages(e,t);const a=[...new Set(e.map(e=>e.chatId))];console.log('📊 涉及的聊天:',a),console.log('📖 当前聊天ID:',t)}await this.renderNewMessagesForCurrentChat(e),console.log('🎨 [主应用] 消息渲染完成，准备触发聊天迁移检查'),await this.triggerChatMigrationCheck()}else console.log('🔍 未发现新消息')}getRenderingStatus(){return{isRenderingMessages:this.isRenderingMessages,shouldStopRendering:this.shouldStopRendering}}}let H=null;$(()=>{if(!H){try{window.avatarSourceService=G.OK,console.log('✅ AvatarSourceService已初始化')}catch(e){console.error('❌ AvatarSourceService初始化失败:',e)}H=new F,window.bearChatManager=H,window.scaleManager=H.getScaleManager(),window.typingSpeedManager=H.getTypingSpeedManager(),window.debugSyncGroupMembers=()=>H.debugSyncAllGroupMembers(),console.log('多云熊聊天界面已初始化'),window.testIsolation=()=>{if(H)return H.testCharacterIsolation();console.error('❌ BearChatManager 未初始化')},window.debugCharInfo=()=>{if(H)return H.debugCharacterInfo();console.error('❌ BearChatManager 未初始化')},window.debugUnreadMessages=()=>{if(H&&H.chatListManager){const e=H.chatListManager.getUnreadMessageManager();return console.log('📊 未读消息调试信息:'),console.log('- 总未读数:',e.getTotalUnreadCount()),console.log('- 所有未读计数:',Object.fromEntries(e.getAllUnreadCounts())),{totalUnread:e.getTotalUnreadCount(),allCounts:Object.fromEntries(e.getAllUnreadCounts())}}console.error('❌ 未读消息管理器未初始化')},window.triggerCharacterChange=()=>{if(H)return H.triggerCharacterChange();console.error('❌ BearChatManager 未初始化')},window.checkCharacterChange=()=>{if(H)return H.checkCharacterChange();console.error('❌ BearChatManager 未初始化')},window.checkCharacter=()=>{console.log('=== 简单角色检查 ===');const e={'typeof TavernHelper':typeof TavernHelper,getCharData函数存在:'function'==typeof getCharData,deleteChatMessages函数存在:'function'==typeof deleteChatMessages,setChatMessages函数存在:'function'==typeof setChatMessages,this_chid:window.this_chid,name2:window.name2,characters存在:void 0!==window.characters};if(console.table(e),'function'==typeof getCharData)try{const e=getCharData();console.log('getCharData() 结果:',e)}catch(e){console.error('getCharData() 错误:',e)}return e}}}),$(window).on('unload',()=>{const e=window.bearChatManager;e&&e.soundManager&&e.soundManager.destroy(),console.log('多云熊聊天界面已卸载')});class q{validateGroupData(e){const t=[];try{e.chatId&&'string'==typeof e.chatId||t.push('群聊ID不能为空且必须为字符串'),e.chatName&&'string'==typeof e.chatName?0===e.chatName.trim().length?t.push('群聊名称不能为空白字符'):e.chatName.length>50&&t.push('群聊名称不能超过50个字符'):t.push('群聊名称不能为空且必须为字符串'),'group'!==e.type&&t.push('数据类型必须为群聊');const a=e.members;if(Array.isArray(a)){0===a.length?t.push('群成员列表不能为空'):a.length>100&&t.push('群成员数量不能超过100人'),a.forEach((e,a)=>{const s=this.validateGroupMember(e,a);t.push(...s)});const e=a.map(e=>e.name).filter(Boolean),s=new Set(e);e.length!==s.size&&t.push('群成员名称不能重复')}else t.push('群成员列表必须为数组');Array.isArray(e.messages)?e.messages.forEach((e,a)=>{const s=this.validateGroupMessage(e,a);t.push(...s)}):t.push('消息列表必须为数组'),e.avatar&&!this.isValidUrl(e.avatar)&&t.push('群头像URL格式无效')}catch(e){t.push(`验证过程出错: ${e}`)}return{valid:0===t.length,errors:t}}validateGroupMember(e,t){const a=[];return e&&'object'==typeof e?(e.id&&'string'==typeof e.id||a.push(`第${t+1}个成员的ID不能为空且必须为字符串`),e.name&&'string'==typeof e.name?0===e.name.trim().length?a.push(`第${t+1}个成员的名称不能为空白字符`):e.name.length>20&&a.push(`第${t+1}个成员的名称不能超过20个字符`):a.push(`第${t+1}个成员的名称不能为空且必须为字符串`),e.role&&!['owner','admin','member'].includes(e.role)&&a.push(`第${t+1}个成员的角色必须为owner、admin或member之一`),e.avatar&&!this.isValidUrl(e.avatar)&&a.push(`第${t+1}个成员的头像URL格式无效`),a):(a.push(`第${t+1}个成员数据格式无效`),a)}validateGroupMessage(e,t){const a=[];return e&&'object'==typeof e?('G'!==e.type&&a.push(`第${t+1}条消息的类型必须为G（群聊消息）`),e.sender&&'string'==typeof e.sender||a.push(`第${t+1}条消息的发送者不能为空且必须为字符串`),e.messageType&&['text','image','voice','sticker','location','transfer'].includes(e.messageType)||a.push(`第${t+1}条消息的类型无效`),void 0!==e.content&&null!==e.content||a.push(`第${t+1}条消息的内容不能为空`),e.timestamp&&'string'==typeof e.timestamp||a.push(`第${t+1}条消息的时间戳不能为空且必须为字符串`),a):(a.push(`第${t+1}条消息数据格式无效`),a)}validateBearFormat(e){const t=[];try{if(!e||'string'!=typeof e)return t.push('Bear内容必须为非空字符串'),{valid:!1,errors:t};e.includes('<bear>')&&e.includes('</bear>')||t.push('缺少Bear标签');const a=[...e.matchAll(/\[群聊([^\]]+)\]\s*\[成员[：:]([^\]]+)\]([\s\S]*?)\[\/群聊\1\]/g)];a.forEach((e,a)=>{const s=e[1],n=e[2],r=e[3];if(s&&0!==s.trim().length||t.push(`第${a+1}个群聊的名称不能为空`),n&&0!==n.trim().length){0===n.split(/[，,]/).map(e=>e.trim()).filter(e=>e.length>0).length&&t.push(`第${a+1}个群聊的成员列表格式无效`)}else t.push(`第${a+1}个群聊的成员列表不能为空`);[...r.matchAll(/\[G_[^|]*\|([^|]+)\|([^|]+)\|([^\]]+)\]/g)].forEach((e,s)=>{const n=e[1],r=e[2],o=e[3];n&&0!==n.trim().length||t.push(`第${a+1}个群聊的第${s+1}条消息发送者不能为空`),r&&0!==r.trim().length||t.push(`第${a+1}个群聊的第${s+1}条消息内容不能为空`),o&&0!==o.trim().length||t.push(`第${a+1}个群聊的第${s+1}条消息时间戳不能为空`)})});const s=[...e.matchAll(/\[([^\/][^\]]*?)\]([\s\S]*?)\[\/\1\]/g)],n=a.map(e=>`群聊${e[1]}`);s.forEach((e,a)=>{const s=e[1];if(n.includes(s))return;[...e[2].matchAll(/\[G_[^\]]*\]/g)].length>0&&t.push(`单聊块"${s}"中不应包含群聊消息`)})}catch(e){t.push(`Bear格式验证过程出错: ${e}`)}return{valid:0===t.length,errors:t}}isValidUrl(e){try{return new URL(e),!0}catch{return/^[a-zA-Z0-9._-]+\.(jpg|jpeg|png|gif|webp)$/i.test(e)||e.startsWith('/')||e.startsWith('./')||e.startsWith('../')}}}class z{errorCounts=new Map;MAX_ERROR_COUNT=10;increment(e){const t=this.errorCounts.get(e)||0;this.errorCounts.set(e,t+1),t+1>=this.MAX_ERROR_COUNT&&console.warn(`错误类型 "${e}" 发生次数过多 (${t+1}次)，请检查代码逻辑`)}getStats(){const e={};return this.errorCounts.forEach((t,a)=>{e[a]=t}),e}reset(){this.errorCounts.clear()}getTotalErrors(){let e=0;return this.errorCounts.forEach(t=>{e+=t}),e}}window.testTypingSpeed={setSpeed:e=>{if(H){H.getTypingSpeedManager().setSpeed(e);const t=H.getTypingSpeedManager().getCurrentSpeedConfig();console.log(`⚡ 打字速度已设置为: ${t.name}`)}},getCurrentSpeed:()=>{if(H){const e=H.getTypingSpeedManager().getCurrentSpeed(),t=H.getTypingSpeedManager().getCurrentSpeedConfig();return console.log(`📏 当前打字速度: ${t.name} (档位${e})`),{speed:e,config:t}}},reset:()=>{H&&(H.getTypingSpeedManager().resetSpeed(),console.log('🔄 打字速度已重置为正常'))},testAll:()=>{const e=[1,2,3,4],t=['正常','快速','瞬间','全部'];let a=0;const s=()=>{if(a<e.length){const n=e[a],r=t[a];console.log(`🧪 测试打字速度: ${r} (档位${n})`),window.testTypingSpeed.setSpeed(n),a++,setTimeout(s,2e3)}else console.log('✅ 打字速度测试完成'),window.testTypingSpeed.reset()};s()}},console.log('⚡ 打字速度测试函数已添加到 window.testTypingSpeed'),console.log('🔧 群成员同步调试函数已添加到 window.debugSyncGroupMembers'),console.log('📖 使用方法:'),console.log('  - testTypingSpeed.setSpeed(1) // 设置正常速度'),console.log('  - debugSyncGroupMembers() // 手动同步所有群聊成员信息到酒馆'),console.log('  - testTypingSpeed.setSpeed(2) // 设置快速速度'),console.log('  - testTypingSpeed.setSpeed(3) // 设置瞬间速度'),console.log('  - testTypingSpeed.setSpeed(4) // 设置全部速度'),console.log('  - testTypingSpeed.getCurrentSpeed() // 获取当前速度'),console.log('  - testTypingSpeed.reset() // 重置为正常速度'),console.log('  - testTypingSpeed.testAll() // 自动测试所有速度');</script></body></html>